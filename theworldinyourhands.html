<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Artimotion - Live Loop Station</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; user-select: none; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            color: #0ff; font-size: 14px; letter-spacing: 2px;
            background: rgba(0, 10, 20, 0.9); padding: 20px 40px; border-radius: 4px;
            border: 1px solid #0ff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            pointer-events: none; z-index: 10; text-align: center;
        }

        /* --- PEDALERA VIRTUAL --- */
        #pedalboard {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 5;
        }

        .pedal {
            width: 80px; height: 100px;
            background: linear-gradient(145deg, #222, #111);
            border: 2px solid #444; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 15px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .pedal:active { transform: scale(0.95); }

        .pedal-light {
            width: 15px; height: 15px; border-radius: 50%; background: #333;
            margin-bottom: 20px; box-shadow: 0 0 5px rgba(0,0,0,0.5) inset;
            transition: all 0.2s;
        }
        .pedal-label { color: #888; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .pedal-key { color: #555; font-size: 9px; margin-top: 5px; }

        /* Estados de los pedales */
        #pedal-sustain.active .pedal-light { background: #0f0; box-shadow: 0 0 10px #0f0; }
        #pedal-sustain.active { border-color: #0f0; }

        #pedal-loop.recording .pedal-light { background: #f00; box-shadow: 0 0 10px #f00; }
        #pedal-loop.playing .pedal-light { background: #0f0; box-shadow: 0 0 10px #0f0; }
        #pedal-loop.recording { border-color: #f00; }
        #pedal-loop.playing { border-color: #0f0; }

        #pedal-clear:hover { border-color: #f80; }
        #pedal-clear:hover .pedal-light { background: #f80; }

        /* UI Superior */
        #top-ui {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .hud-text { color: rgba(255,255,255,0.7); font-size: 11px; font-family: monospace; }
        .lil-gui { --background-color: rgba(5, 5, 10, 0.9); }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';
        import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.17.0/dist/lil-gui.esm.min.js';

        // --- PARÁMETROS ---
        const params = {
            key: 'A',
            trailStyle: 'Ribbon', 
            lineWidth: 0.8,
            bloomStrength: 1.8,
            colorSpeed: 1.5,
            opacity: 0.85,
            particleSize: 1.0, 
            mode: 'Spectral',
            inputSensitivity: 1.5,
            soundEnabled: true,
            reset: () => resetCanvas()
        };

        // --- TEORÍA MUSICAL ---
        const NOTES = { 'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88 };
        const PENTA_INTERVALS = [0, 3, 5, 7, 10]; 

        function getFrequency(baseFreq, semitones) { return baseFreq * Math.pow(2, semitones / 12); }

        function generateScale(rootKey) {
            const base = NOTES[rootKey] / 2;
            const scale = [];
            for (let oct = 0; oct < 3; oct++) {
                PENTA_INTERVALS.forEach(interval => scale.push(getFrequency(base * Math.pow(2, oct), interval)));
            }
            return scale;
        }

        function generateChords(rootKey) {
            const base = NOTES[rootKey] / 4;
            // Acordes más abiertos para acompañamiento (Root - 5th - 10th)
            const chord1 = [getFrequency(base, 0), getFrequency(base, 7), getFrequency(base, 15)]; // i
            const chord2 = [getFrequency(base, 8), getFrequency(base, 15), getFrequency(base, 24)]; // VI
            const chord3 = [getFrequency(base, 10), getFrequency(base, 17), getFrequency(base, 26)]; // VII
            return [chord1, chord2, chord3];
        }

        let currentScale = generateScale(params.key);
        let currentChords = generateChords(params.key);

        // --- MOTOR DE AUDIO AVANZADO (LOOPER + SUSTAIN) ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.masterGain = null;
                this.destNode = null; // Para grabar
                
                // Sintetizadores
                this.melodyOsc = null;
                this.chordOscs = [];
                this.gainMelody = null;
                this.gainChord = null;
                
                // Efectos
                this.delay = null;
                this.filter = null;

                // Estados
                this.isInit = false;
                this.sustainActive = false;
                this.lastChordIndex = -1; // Para recordar qué acorde sostener

                // Looper
                this.mediaRecorder = null;
                this.chunks = [];
                this.loopBuffer = null;
                this.loopSource = null;
                this.loopState = 'IDLE'; // IDLE, RECORDING, PLAYING
            }

            init() {
                if (this.isInit) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();

                // 1. Master y Grabación
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.8;
                this.masterGain.connect(this.ctx.destination); // A altavoces

                // Nodo de destino para el Looper (Graba lo que sale del Master)
                this.destNode = this.ctx.createMediaStreamDestination();
                this.masterGain.connect(this.destNode);

                // 2. Canal Melodía
                this.melodyOsc = this.ctx.createOscillator();
                this.melodyOsc.type = 'triangle';
                this.gainMelody = this.ctx.createGain();
                this.gainMelody.gain.value = 0;
                
                // Delay Melodía
                this.delay = this.ctx.createDelay();
                this.delay.delayTime.value = 0.3;
                const delayFeedback = this.ctx.createGain();
                delayFeedback.gain.value = 0.4;
                
                this.melodyOsc.connect(this.gainMelody);
                this.gainMelody.connect(this.masterGain);
                this.gainMelody.connect(this.delay);
                this.delay.connect(delayFeedback);
                delayFeedback.connect(this.delay);
                this.delay.connect(this.masterGain);
                this.melodyOsc.start();

                // 3. Canal Acordes
                this.gainChord = this.ctx.createGain();
                this.gainChord.gain.value = 0;
                this.filter = this.ctx.createBiquadFilter();
                this.filter.type = 'lowpass';
                this.filter.frequency.value = 600; // Pad suave
                
                this.gainChord.connect(this.filter);
                this.filter.connect(this.masterGain);

                for(let i=0; i<3; i++) {
                    const osc = this.ctx.createOscillator();
                    osc.type = 'sawtooth'; // Diente de sierra para más cuerpo
                    osc.connect(this.gainChord);
                    osc.start();
                    this.chordOscs.push(osc);
                }

                this.isInit = true;
                updateHud(`AUDIO LISTO | Key: ${params.key}m`);
            }

            setKey(newKey) {
                params.key = newKey;
                currentScale = generateScale(newKey);
                currentChords = generateChords(newKey);
                updateHud(`Key: ${newKey}m`);
            }

            updateMelody(normX, normY, active) {
                if (!this.isInit || !params.soundEnabled) return;
                const t = this.ctx.currentTime;

                if (active) {
                    const index = Math.floor(normX * currentScale.length);
                    const safeIndex = Math.min(Math.max(index, 0), currentScale.length - 1);
                    this.melodyOsc.frequency.setTargetAtTime(currentScale[safeIndex], t, 0.05);
                    this.gainMelody.gain.setTargetAtTime(Math.max(0, (1-normY)*0.3), t, 0.1);
                } else {
                    this.gainMelody.gain.setTargetAtTime(0, t, 0.1);
                }
            }

            updateChords(normX, normY, active) {
                if (!this.isInit || !params.soundEnabled) return;
                const t = this.ctx.currentTime;

                if (active) {
                    // Determinar acorde
                    let chordIndex = 0;
                    if (normX < 0.33) chordIndex = 0;
                    else if (normX < 0.66) chordIndex = 1;
                    else chordIndex = 2;

                    // Si cambió el acorde o estábamos en silencio, actualizamos frecuencias
                    if (chordIndex !== this.lastChordIndex || this.gainChord.gain.value < 0.01) {
                         const targetChord = currentChords[chordIndex];
                         this.chordOscs.forEach((osc, i) => {
                             osc.frequency.setTargetAtTime(targetChord[i], t, 0.1);
                         });
                         this.lastChordIndex = chordIndex;
                    }
                    
                    // Volumen
                    const vol = Math.max(0, (1.0 - normY) * 0.2);
                    this.gainChord.gain.setTargetAtTime(vol, t, 0.3);

                } else {
                    // Si no hay mano, chequeamos si el Sustain está activo
                    if (this.sustainActive) {
                        // Mantenemos el volumen actual (no bajamos a 0)
                        // Si el volumen estaba bajo, lo subimos un poco para mantener el "Pad"
                        if(this.gainChord.gain.value < 0.1) {
                            this.gainChord.gain.setTargetAtTime(0.15, t, 0.5);
                        }
                    } else {
                        // Fade out normal
                        this.gainChord.gain.setTargetAtTime(0, t, 0.5);
                    }
                }
            }

            toggleSustain() {
                this.sustainActive = !this.sustainActive;
                const el = document.getElementById('pedal-sustain');
                if(this.sustainActive) el.classList.add('active');
                else el.classList.remove('active');
                
                // Si desactivamos y no hay mano, cortar sonido
                if(!this.sustainActive) this.gainChord.gain.setTargetAtTime(0, this.ctx.currentTime, 0.5);
            }

            // --- LÓGICA DEL LOOPER ---
            toggleLoop() {
                if(!this.isInit) return;

                if (this.loopState === 'IDLE' || this.loopState === 'PLAYING') {
                    // EMPEZAR A GRABAR
                    this.startRecording();
                } else if (this.loopState === 'RECORDING') {
                    // PARAR DE GRABAR Y REPRODUCIR
                    this.stopRecordingAndPlay();
                }
            }

            startRecording() {
                // Si ya hay algo sonando (loop anterior), lo detenemos para grabar uno nuevo
                this.clearLoop(false); 

                this.chunks = [];
                this.mediaRecorder = new MediaRecorder(this.destNode.stream);
                
                this.mediaRecorder.ondataavailable = (e) => this.chunks.push(e.data);
                this.mediaRecorder.start();
                
                this.loopState = 'RECORDING';
                updatePedalUI('loop', 'recording');
                updateHud("GRABANDO LOOP...");
            }

            stopRecordingAndPlay() {
                if(this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.onstop = async () => {
                        const blob = new Blob(this.chunks, { 'type' : 'audio/ogg; codecs=opus' });
                        const arrayBuffer = await blob.arrayBuffer();
                        const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);
                        
                        this.loopBuffer = audioBuffer;
                        this.playLoop();
                    };
                }
            }

            playLoop() {
                if(!this.loopBuffer) return;
                
                // Crear Source
                this.loopSource = this.ctx.createBufferSource();
                this.loopSource.buffer = this.loopBuffer;
                this.loopSource.loop = true;
                
                // Conectar a Master
                this.loopSource.connect(this.masterGain);
                this.loopSource.start();
                
                this.loopState = 'PLAYING';
                updatePedalUI('loop', 'playing');
                updateHud("REPRODUCIENDO LOOP");
            }

            clearLoop(updateUI = true) {
                if (this.loopSource) {
                    this.loopSource.stop();
                    this.loopSource.disconnect();
                    this.loopSource = null;
                }
                this.loopBuffer = null;
                this.loopState = 'IDLE';
                if(updateUI) {
                    updatePedalUI('loop', 'idle');
                    updateHud("LOOP BORRADO");
                }
            }
        }
        
        const audioSys = new AudioEngine();

        // --- VISUALES (Simplificado del anterior) ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 12;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Bloom
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.strength = params.bloomStrength;
        composer.addPass(bloomPass);

        // Ribbon Class
        class RibbonTrail {
            constructor(idx) {
                this.length = 40; this.points = []; this.target = new THREE.Vector3(0,-1000,0); this.current = new THREE.Vector3(0,-1000,0);
                for(let i=0; i<this.length; i++) this.points.push(new THREE.Vector3(0,-1000,0));
                
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(this.length * 6);
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                this.material = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: params.opacity, blending: THREE.AdditiveBlending });
                this.mesh = new THREE.Mesh(geometry, this.material);
                scene.add(this.mesh);
                this.idx = idx;
            }
            setTarget(x,y,z) { this.target.set(x,y,z); }
            tick(time) {
                this.current.lerp(this.target, 0.2);
                this.points.shift(); this.points.push(this.current.clone());
                const curve = new THREE.CatmullRomCurve3(this.points, false, 'catmullrom', 0.5);
                const spline = curve.getPoints(this.length - 1);
                const pos = this.mesh.geometry.attributes.position.array;
                
                for(let i=0; i<spline.length; i++) {
                    const p = spline[i];
                    const w = params.lineWidth * (i/this.length);
                    pos[i*6]=p.x-w; pos[i*6+1]=p.y; pos[i*6+2]=p.z;
                    pos[i*6+3]=p.x+w; pos[i*6+4]=p.y; pos[i*6+5]=p.z;
                }
                this.mesh.geometry.attributes.position.needsUpdate = true;
                const hue = (time * 0.1 + (this.idx * 0.05)) % 1;
                this.material.color.setHSL(hue, 1.0, 0.5);
            }
        }
        const ribbons = Array(10).fill().map((_,i) => new RibbonTrail(i));

        // --- MEDIAPIPE ---
        const videoElement = document.createElement('video');
        let visibleWidth = 10, visibleHeight = 10;
        
        function onResults(results) {
            document.getElementById('loading').style.display = 'none';
            let melodyActive = false, chordActive = false;

            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    if (index > 1) return;
                    
                    // Visuales
                    [4,8,12,16,20].forEach((fid, i) => {
                        const lm = landmarks[fid];
                        const x = (lm.x - 0.5) * -visibleWidth * 1.5;
                        const y = (lm.y - 0.5) * -visibleHeight * 1.5;
                        ribbons[index*5+i].setTarget(x,y,-lm.z*20);
                    });

                    // Audio
                    const idxFinger = landmarks[8];
                    if (index === 0) {
                        melodyActive = true;
                        audioSys.updateMelody(idxFinger.x, idxFinger.y, true);
                    } else {
                        chordActive = true;
                        audioSys.updateChords(idxFinger.x, idxFinger.y, true);
                    }
                });
            }
            if(!melodyActive) audioSys.updateMelody(0,0,false);
            if(!chordActive) audioSys.updateChords(0,0,false);
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5});
        hands.onResults(onResults);
        
        const cameraFeed = new Camera(videoElement, { onFrame: async () => await hands.send({image: videoElement}), width: 1280, height: 720 });
        cameraFeed.start();

        // --- CONTROLES Y EVENTOS ---
        function updateHud(text) { document.getElementById('hud-status').innerText = text; }
        function updatePedalUI(pedal, state) {
            const p = document.getElementById(`pedal-${pedal}`);
            p.className = `pedal ${state}`;
            if(state === 'idle') p.className = 'pedal';
        }

        // GUI
        const gui = new GUI({ title: 'Config Banda' });
        gui.add(params, 'key', Object.keys(NOTES)).name('Tonalidad').onChange(v => audioSys.setKey(v));
        gui.add(params, 'soundEnabled').name('Audio Master');
        gui.add(params, 'lineWidth', 0.1, 2.0);

        // Teclado
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); // Evitar scroll
                audioSys.toggleLoop();
            }
            if (e.key.toLowerCase() === 's') audioSys.toggleSustain();
            if (e.key.toLowerCase() === 'x') audioSys.clearLoop();
        });

        // Click en pedales
        document.getElementById('pedal-sustain').onclick = () => audioSys.toggleSustain();
        document.getElementById('pedal-loop').onclick = () => audioSys.toggleLoop();
        document.getElementById('pedal-clear').onclick = () => audioSys.clearLoop();
        
        // Init Audio
        window.addEventListener('click', () => {
            if(!audioSys.isInit) audioSys.init();
            if(audioSys.ctx.state === 'suspended') audioSys.ctx.resume();
        });

        // Resize
        function resize() {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
            const vFOV = camera.fov * Math.PI/180;
            visibleHeight = 2 * Math.tan(vFOV/2) * camera.position.z; visibleWidth = visibleHeight * camera.aspect;
        }
        window.addEventListener('resize', resize); resize();

        // Animación Loop
        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001;
            ribbons.forEach(r => r.tick(t));
            composer.render();
        }
        animate();
    </script>

    <div id="loading">CARGANDO LOOP STATION...</div>
    
    <div id="top-ui">
        <div class="hud-text">ARTIMOTION BAND TOOL</div>
        <div id="hud-status" class="hud-text">CLICK PARA ACTIVAR</div>
    </div>

    <div id="pedalboard">
        <div id="pedal-sustain" class="pedal">
            <div class="pedal-light"></div>
            <div class="pedal-label">Sustain</div>
            <div class="pedal-key">[ Tecla S ]</div>
        </div>

        <div id="pedal-loop" class="pedal">
            <div class="pedal-light"></div>
            <div class="pedal-label">Looper</div>
            <div class="pedal-key">[ Espacio ]</div>
        </div>

        <div id="pedal-clear" class="pedal">
            <div class="pedal-light" style="background:#555"></div>
            <div class="pedal-label">Clear</div>
            <div class="pedal-key">[ Tecla X ]</div>
        </div>
    </div>
</body>
</html>
