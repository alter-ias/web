<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUENTOS INUSUALES</title>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Limelight&family=Rye&display=swap');

        :root {
            --color-fondo: rgb(22, 24, 28);
            --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218);
            --color-pastel-cyan: rgb(190, 225, 218);
            --color-pastel-orange: #ffb347;
            --color-pastel-yellow: #fdfd96;
            --font-principal: 'Courier New', Courier, monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { font-family: var(--font-principal); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }
        
        .hero-section {
            position: sticky;
            top: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header, .hero-description { position: absolute; left: 50%; transform: translateX(-50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-header { top: 25%; transform: translate(-50%, -50%); }
        .hero-description { bottom: 5%; max-width: 700px; }
        
        .scroll-container { 
            position: relative; 
            z-index: 2;
            background-color: var(--color-fondo);
        }
        
        .content-container { padding: 0 2rem; max-width: 95%; margin: 0 auto; }

        .interactive-project-block { 
            position: relative;
            width: 100%;
            display: flex;
            gap: 4rem;
            align-items: flex-start;
            padding: 10vh 0;
            min-height: 100vh;
        }

        .layout-reversed {
            flex-direction: row-reverse;
        }
        
        .project-col { flex: 1; }
        .project-col-visuals { position: sticky; top: 10vh; height: 80vh; }
        .project-col-text { min-height: 80vh; padding-top: 5vh; }

        @media (max-width: 900px) {
            .interactive-project-block, .layout-reversed {
                flex-direction: column; 
                padding: 5vh 0;
            }
            .project-col-visuals { position: static; width: 100%; height: auto; }
            .visual-canvas-container { padding-top: 56.25%; height: 0; }
            .project-col-text { padding-top: 2vh; }
        }
        
        /* Estilos de texto y formato */
        .active-text-display {
            font-size: 1.15rem;
            line-height: 1.8;
            text-align: justify;
            hyphens: auto;
            -webkit-hyphens: auto;
            word-wrap: break-word;
        }
        .active-text-display p { margin-bottom: 1.5rem; }
        
        /* Título Color Naranja (Columna D) */
        .active-text-display h2 {
            font-family: 'Limelight', cursive;
            color: var(--color-pastel-orange);
            font-size: 2.8rem;
            margin-bottom: 1.5rem;
            text-align: left;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 179, 71, 0.3);
        }
        
        /* Diseño para el Quote (Columna E) */
        .project-quote {
            font-family: 'Limelight', cursive;
            color: var(--color-pastel-cyan);
            font-size: 1.6rem;
            margin: 3rem 0;
            padding: 1rem 0 1rem 1.5rem;
            border-left: 4px solid var(--color-pastel-orange);
            line-height: 1.4;
            text-align: left;
            text-shadow: 0 0 8px rgba(190, 225, 218, 0.4);
            background: linear-gradient(90deg, rgba(190, 225, 218, 0.05) 0%, transparent 100%);
        }

        .hidden { display: none; }
        
        .visual-canvas-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .visual-display { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; }
        
        h1 { font-family: var(--font-principal); font-size: 2.5rem; text-transform: uppercase; }
        h1 span { font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); text-transform: none; }
        
        @media (max-width: 768px) {
             h1 { font-size: 1.8rem; }
             .hero-header { top: 18%; }
             .hero-description { bottom: 2%; font-size: 0.9rem; max-width: 90%; }
             .active-text-display { font-size: 1.05rem; }
             .active-text-display h2 { font-size: 2.2rem; }
             .project-quote { font-size: 1.3rem; margin: 2rem 0; }
        }

        .erasure-pin-container { position: relative; height: 200vh; width: 100%; }
        .erasure-pin-container .erasure-block-wrapper { position: sticky; top: 0; left: 0; width: 100%; height: 100vh; z-index: 15; }
        .erasure-block { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 20; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: var(--color-fondo); will-change: transform; transform: translateX(100%); }
        .erasure-text { text-align: center; font-size: 6vw; font-weight: bold; text-transform: uppercase; padding: 2rem; }
        .erasure-text span { display: block; line-height: 1.1; margin-bottom: 0.5rem; }
        .font-rye { font-family: 'Rye', cursive; }
        .font-limelight { font-family: 'Limelight', cursive; }
        .font-bitcount-alt { font-family: var(--font-principal); font-size: 5.5vw; letter-spacing: -2px; }
        .text-cyan { color: var(--color-pastel-cyan); text-shadow: 0 0 15px rgba(190, 225, 218, 0.7); }
        .text-orange { color: var(--color-pastel-orange); text-shadow: 0 0 15px rgba(255, 179, 71, 0.7); }
        .text-yellow { color: var(--color-pastel-yellow); text-shadow: 0 0 15px rgba(253, 253, 150, 0.7); }
        @media (max-width: 768px) {
            .erasure-text { font-size: 10vw; }
            .font-bitcount-alt { font-size: 9vw; }
            .erasure-pin-container { height: 150vh; }
        }

        #audio-unlock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        #audio-unlock-btn {
            background-color: transparent; border: 2px solid var(--color-acento); color: var(--color-acento);
            font-family: var(--font-principal); font-size: 1.5rem; padding: 1rem 2rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        #audio-unlock-btn:hover { background-color: var(--color-acento); color: var(--color-fondo); }
    </style>
</head>
<body>
    <div id="audio-unlock-overlay">
        <button id="audio-unlock-btn">ENTRAR</button>
    </div>

    <div class="hero-section">
        <div id="hero-canvas-container"></div>
        <header class="hero-header"><h1>CUENTOS INUSUALES<span>Escritos por Omar Durán Guerra</span></h1></header>
        <section class="hero-description"><p style="line-height: 1.6; font-size: 1.1rem;">Este es un mensaje en una botella, arrojado al vasto océano digital. Un recordatorio de que en la creación deliberada y en la vulnerabilidad, encontramos una forma de salvación.</p></section>
    </div>

    <main class="scroll-container">
        <div class="content-container"></div>
    </main>
    
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/" } }</script>
    
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        const heroParams = { desktopModelScale: 2.9, desktopModelPositionY: 0.2, mobileModelScale: 2.0, mobileModelPositionY: 0.7, initialRotationY: -1.57, mouseIntensity: 0.51, smoothingFactor: 0.088, cameraDistance: 4.4, ambientIntensity: 5.0, directionalIntensity: 4.5, };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5); heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina2.glb', (gltf) => { heroModel = gltf.scene; heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3())); updateHeroModelTransform(); heroScene.add(heroModel); });

        // NUEVO ORIGEN DE DATOS
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIQwSB6tUFLal0lG8c7YRStbOWGAhWm-wcRQz-X00rIQEuoT2rAEY9Q8O0cM7EAHmU7nAZNjxndJdc/pub?output=csv';
        const contentContainer = document.querySelector('.content-container');

        function initProject() {
            Papa.parse(CSV_URL, {
                download: true, 
                header: false, // Usamos false para guiarnos exactamente por el orden de las columnas (A, B, C, D, E)
                skipEmptyLines: true,
                complete: (results) => {
                    let data = results.data;
                    
                    // Si la primera fila es encabezado (lo sabemos si no es una url o un texto muy largo), la quitamos
                    if (data.length > 0 && !data[0][0].includes('http') && !data[0][0].includes('./')) {
                        data.shift();
                    }

                    const projectData = data.map(row => {
                        // Por seguridad, aseguramos que audio y video queden bien mapeados aunque se inviertan A y C
                        let col0 = row[0] || '';
                        let col2 = row[2] || '';
                        let videoUrl = col0.includes('.mp4') ? col0 : (col2.includes('.mp4') ? col2 : col0);
                        let audioUrl = col2.includes('.mp3') ? col2 : (col0.includes('.mp3') ? col0 : col2);

                        return {
                            video: videoUrl,
                            texto: row[1] || '',  // Columna B: Textos principales
                            audio: audioUrl,
                            titulo: row[3] || '', // Columna D: Títulos
                            quote: row[4] || ''   // Columna E: Quotes
                        };
                    }).filter(p => p.texto && p.video); // Filtramos para usar solo filas válidas

                    if (projectData.length > 0) {
                        buildProjectBlocks(projectData);
                    } else {
                        contentContainer.innerHTML = `<p>No se encontraron proyectos en el CSV.</p>`;
                    }
                },
                error: (error) => console.error("Error al parsear CSV:", error),
            });
        }

        function fadeAudio(audio, direction, duration) {
            clearInterval(audio.fadeInterval);
            const targetVolume = (direction === 'in') ? 1 : 0;
            const steps = 50;
            const stepTime = duration / steps;
            const volStep = 1 / steps;
            
            if (direction === 'in' && audio.paused) {
                 audio.volume = 0;
                 audio.play().catch(e => console.error("Error al iniciar audio:", e));
            }

            audio.fadeInterval = setInterval(() => {
                let currentVolume = audio.volume;
                if (direction === 'in') {
                    if (currentVolume < targetVolume - volStep) { audio.volume += volStep; } 
                    else { audio.volume = 1; clearInterval(audio.fadeInterval); }
                } else {
                    if (currentVolume > targetVolume + volStep) { audio.volume -= volStep; } 
                    else { audio.volume = 0; clearInterval(audio.fadeInterval); audio.pause(); }
                }
            }, stepTime);
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const audio = entry.target.querySelector('.project-audio-player');
                if (!audio) return;
                fadeAudio(audio, entry.isIntersecting ? 'in' : 'out', 1500);
            });
        }, { root: null, threshold: [0.2, 0.8] });

        function buildProjectBlocks(data) {
            contentContainer.innerHTML = '';
            
            data.forEach((project, index) => {
                const projectBlock = document.createElement('div');
                const isReversed = index % 2 !== 0;
                
                const visualAos = isReversed ? "fade-right" : "fade-left";
                const textAos = isReversed ? "fade-left" : "fade-right";

                projectBlock.className = `interactive-project-block ${isReversed ? 'layout-reversed' : ''}`;
                
                // --- LÓGICA DE FORMATEO AUTOMÁTICO ---
                // Dividimos el texto largo en párrafos separados por los saltos de línea de la celda
                let paragraphs = project.texto.split(/\n+/).filter(p => p.trim() !== '');
                let midIndex = Math.floor(paragraphs.length / 2); // Calculamos la mitad exacta
                
                let formattedHtml = '';
                
                // Si existe un título en la columna D, lo inyectamos al inicio
                if (project.titulo) {
                    formattedHtml += `<h2>${project.titulo}</h2>`;
                }

                // Construimos los párrafos
                paragraphs.forEach((p, i) => {
                    formattedHtml += `<p>${p}</p>`;
                    
                    // Si llegamos a la mitad y existe un Quote en la columna E, lo inyectamos
                    if (i === midIndex && project.quote) {
                        formattedHtml += `<blockquote class="project-quote">"${project.quote}"</blockquote>`;
                    }
                });
                
                projectBlock.innerHTML = `
                    <div class="project-col project-col-visuals" data-aos="${visualAos}">
                        <div class="visual-canvas-container">
                            <video class="visual-display" loop muted playsinline src="${project.video}"></video>
                        </div>
                    </div>
                    <div class="project-col project-col-text" data-aos="${textAos}" data-aos-delay="200">
                        <div class="active-text-display">
                            ${formattedHtml}
                        </div>
                    </div>
                    <audio class="project-audio-player hidden" loop src="${project.audio}"></audio>
                `;
                
                contentContainer.appendChild(projectBlock);
                observer.observe(projectBlock);
                projectBlock.querySelector('.visual-display').play().catch(()=>{});
            });

            const erasureContainer = document.createElement('div');
            erasureContainer.className = 'erasure-pin-container';
            erasureContainer.innerHTML = `
                <div class="erasure-block-wrapper">
                    <section class="erasure-block">
                        <div class="erasure-text">
                            <span class="font-rye text-cyan">Las</span>
                            <span class="font-limelight text-orange">Redes</span>
                            <span class="font-bitcount-alt text-yellow">Sociales</span>
                            <span class="font-rye text-cyan">Nos</span>
                            <span class="font-limelight text-orange">Están</span>
                            <span class="font-bitcount-alt text-yellow">Exterminando</span>
                        </div>
                    </section>
                </div>`;
            contentContainer.appendChild(erasureContainer);
            initErasureAnimation(erasureContainer);
            
            // Inicializamos AOS de manera tardía asegurando que el DOM exista
            setTimeout(() => {
                AOS.init({
                    duration: 1200,
                    offset: 150,
                    once: true,
                    easing: 'ease-out-cubic'
                });
            }, 100);
            
            const overlay = document.getElementById('audio-unlock-overlay');
            const unlockBtn = document.getElementById('audio-unlock-btn');
            unlockBtn.addEventListener('click', () => {
                const players = document.querySelectorAll('.project-audio-player');
                let unlockPromise = players[0]?.play();
                if (unlockPromise !== undefined) {
                    unlockPromise.then(() => { players[0].pause(); }).catch(error => {});
                }
                overlay.style.display = 'none';
            }, { once: true });
        }

        // --- FUNCIONES DE UTILIDAD Y ANIMACIÓN ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', e => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 - 1; });
        function updateHeroModelTransform() { if (!heroModel) return; const isMobile = window.innerWidth <= 768; const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale; heroModel.scale.setScalar(scale); heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY; }
        function handleResize() { const heroRect = document.querySelector('.hero-section').getBoundingClientRect(); heroCamera.aspect = heroRect.width / heroRect.height; heroCamera.updateProjectionMatrix(); heroRenderer.setSize(heroRect.width, heroRect.height); updateHeroModelTransform(); }
        function animate() { requestAnimationFrame(animate); if (heroModel) { const targetHeroRotY = heroParams.initialRotationY + (mouseX * heroParams.mouseIntensity); heroModel.rotation.y += (targetHeroRotY - heroModel.rotation.y) * heroParams.smoothingFactor; } heroRenderer.render(heroScene, heroCamera); }
        window.addEventListener('resize', handleResize);
        handleResize();
        initProject();
        animate();

        function initErasureAnimation(container) {
            const erasureBlock = container.querySelector('.erasure-block');
            let isTicking = false;
            function updateAnimation() {
                const rect = container.getBoundingClientRect();
                const scrollableDistance = container.offsetHeight - window.innerHeight;
                if (scrollableDistance <= 0) return;
                let progress = -rect.top / scrollableDistance;
                progress = Math.max(0, Math.min(1, progress));
                const transformX = 100 - (progress * 100);
                if (rect.top > 0) { erasureBlock.style.visibility = 'hidden'; } 
                else { erasureBlock.style.visibility = 'visible'; erasureBlock.style.transform = `translateX(${transformX}%)`; }
                isTicking = false;
            }
            function onScroll() { if (!isTicking) { window.requestAnimationFrame(updateAnimation); isTicking = true; } }
            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('resize', onScroll);
            onScroll();
        }
    </script>
</body>
</html>
