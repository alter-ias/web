<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que la ternura nos salve</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@500&family=Roboto+Mono&family=Work+Sans:wght@300;400&display=swap');
        :root {
            --color-fondo: rgb(22, 24, 28); --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218); --color-acento-hover: white;
            --font-titulos: 'Lora', serif; --font-cuerpo: 'Work Sans', sans-serif; --font-mono: 'Roboto Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-cuerpo); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }

        .fixed-hero-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header { position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-description { position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); width: 100%; max-width: 700px; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .scroll-container { position: relative; z-index: 3; }
        .scroll-spacer { height: 100vh; }
        .content-block { padding: 4rem 2rem; max-width: 1200px; margin: 0 auto; background-color: var(--color-fondo); min-height: 100vh; }

        .interactive-project-block { display: flex; gap: 2rem; align-items: flex-start; }
        .project-col-model { flex: 0 0 25%; }
        .project-col-text { flex: 0 0 25%; }
        .project-col-visuals { flex: 1; }

        #ramona-canvas-container { width: 100%; height: 40vh; cursor: move; margin-bottom: 2rem; }
        
        #playlist-controls audio { width: 100%; margin-top: 1rem; }
        .track-list { list-style: none; padding: 0; }
        .track-item { padding: 0.75rem 0; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); transition: color 0.3s; }
        .track-item:hover { color: var(--color-acento-hover); }
        .track-item.active { color: var(--color-acento); font-weight: bold; }

        .visual-canvas-container { position: relative; width: 100%; padding-top: 56.25%; background-color: black; }
        #visual-display { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        h1 { font-family: var(--font-titulos); font-size: 3rem; }
        h1 span { font-family: var(--font-mono); font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); }
        p { line-height: 1.8; }
        
        @media (max-width: 900px) {
            .interactive-project-block { flex-direction: column; }
            .project-col-visuals { order: 1; } .project-col-model { order: 2; } .project-col-text { order: 3; }
            #ramona-canvas-container { height: 50vh; }
        }
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            .hero-header { top: 18%; }
            .hero-description { bottom: 2%; font-size: 0.9rem; max-width: 90%; }
        }
    </style>
</head>
<body>

    <div class="fixed-hero-container">
        <div id="hero-canvas-container"></div>
        <header class="hero-header">
            <h1>Que la ternura nos salve<span>Un manifiesto que florece entre el artificio y el oficio</span></h1>
        </header>
        <section class="hero-description">
            <p>Este es un mensaje en una botella, arrojado al vasto océano digital...</p>
        </section>
    </div>

    <main class="scroll-container">
        <div class="scroll-spacer"></div>
        <section class="content-block">
            <div class="interactive-project-block">
                <div class="project-col-model">
                    <div id="ramona-canvas-container"></div>
                    <div id="playlist-controls">
                        <ul class="track-list"></ul>
                        <audio id="audio-player" controls></audio>
                    </div>
                </div>
                <div class="project-col-text">
                    <div id="active-text-display">
                        <p>Cargando proyecto...</p>
                    </div>
                </div>
                <div class="project-col-visuals">
                    <div class="visual-canvas-container">
                        <video id="visual-display" autoplay loop muted playsinline></video>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // ... El código de la ESCENA 1 (HERO) permanece exactamente igual ...
        const heroParams = {
            desktopModelScale: 2.9, desktopModelPositionY: 0.2,
            mobileModelScale: 2.0, mobileModelPositionY: 0.7,
            initialRotationY: -1.57, mouseIntensity: 0.51, smoothingFactor: 0.088,
            cameraDistance: 4.4, ambientIntensity: 5.0, directionalIntensity: 4.5,
        };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, heroContainer.clientWidth / heroContainer.clientHeight, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio);
        heroRenderer.setSize(heroContainer.clientWidth, heroContainer.clientHeight);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5);
        heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina.glb', (gltf) => {
            heroModel = gltf.scene;
            heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3()));
            updateHeroModelTransform();
            heroScene.add(heroModel);
        });

        // =================================================================
        // ESCENA 2: PROYECTO INTERACTIVO (RAMONA)
        // =================================================================
        const ramonaParams = { mouseIntensity: 0.4, smoothingFactor: 0.05 };
        const ramonaContainer = document.getElementById('ramona-canvas-container');
        const ramonaScene = new THREE.Scene();
        const ramonaCamera = new THREE.PerspectiveCamera(75, ramonaContainer.clientWidth / ramonaContainer.clientHeight, 0.1, 1000);
        ramonaCamera.position.z = 2.5;
        const ramonaRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        ramonaRenderer.setPixelRatio(window.devicePixelRatio);
        ramonaRenderer.setSize(ramonaContainer.clientWidth, ramonaContainer.clientHeight);
        ramonaContainer.appendChild(ramonaRenderer.domElement);
        ramonaScene.add(new THREE.AmbientLight(0xffffff, 4.0));
        const ramonaDirectionalLight = new THREE.DirectionalLight(0xffffff, 3.0);
        ramonaDirectionalLight.position.set(2, 5, 3);
        ramonaScene.add(ramonaDirectionalLight);
        let ramonaModel;
        new GLTFLoader().load('./assets/3d/ramona.glb', (gltf) => {
            ramonaModel = gltf.scene;
            ramonaModel.position.sub(new THREE.Box3().setFromObject(ramonaModel).getCenter(new THREE.Vector3()));
            ramonaScene.add(ramonaModel);
        });

        // =================================================================
        // LÓGICA DE DATOS Y PLAYLIST (ACTUALIZADA)
        // =================================================================
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7mEJYUb9ErUmolsxLzhTxuimxOolr0bTp-uQjgJ6RDAw61ryHkqt0X5OF2V002Vq1NMnc9hyHhoU6/pub?gid=0&single=true&output=csv';
        const audioPlayer = document.getElementById('audio-player');
        const visualDisplay = document.getElementById('visual-display');
        const textDisplay = document.getElementById('active-text-display');
        const trackList = document.querySelector('.track-list');

        async function initProject() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                // Parseamos el CSV, omitiendo la cabecera (slice(1))
                const data = csvText.split('\r\n').slice(1).map(row => {
                    // CUIDADO: Esta división simple puede fallar si el texto contiene comas.
                    // Para este caso, asumimos que no las contiene o que se manejarán.
                    const [titulo, audio, texto, video] = row.split(',');
                    return {
                        titulo: titulo ? titulo.trim().replace(/"/g, '') : "Sin título",
                        audio: audio ? audio.trim() : "",
                        text: texto ? texto.trim().replace(/"/g, '') : "",
                        video: video ? video.trim() : ""
                    };
                });

                populatePlaylist(data);
            } catch (error) {
                console.error("Error al cargar los datos del proyecto:", error);
                textDisplay.innerHTML = `<p>No se pudo cargar el contenido del proyecto.</p>`;
            }
        }

        function populatePlaylist(data) {
            trackList.innerHTML = '';
            data.forEach((track, index) => {
                const li = document.createElement('li');
                li.className = 'track-item';
                li.textContent = track.titulo; // Usamos la columna 'titulo'
                li.dataset.index = index;
                trackList.appendChild(li);
            });

            trackList.addEventListener('click', (e) => {
                if (e.target.classList.contains('track-item')) {
                    const index = parseInt(e.target.dataset.index);
                    updateContent(index, data);
                }
            });

            if (data.length > 0) {
                updateContent(0, data);
            }
        }

        function updateContent(index, data) {
            const track = data[index];
            // Asignamos las URLs públicas directamente
            audioPlayer.src = track.audio; 
            visualDisplay.src = track.video;
            textDisplay.innerHTML = `<p>${track.text}</p>`;

            document.querySelectorAll('.track-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.track-item[data-index="${index}"]`).classList.add('active');
        }

        initProject();

        // ... El resto del código (LÓGICA GENERAL, ANIMACIÓN Y EVENTOS) permanece igual ...
        let mouseX = 0, mouseY = 0;
        function handlePointerMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }
        window.addEventListener('mousemove', handlePointerMove);
        function updateHeroModelTransform() {
            if (!heroModel) return;
            const isMobile = window.innerWidth < 768;
            const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale;
            heroModel.scale.set(scale, scale, scale);
            heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY;
        }
        function animate() {
            requestAnimationFrame(animate);
            if (heroModel) {
                const targetRotationY = mouseX * heroParams.mouseIntensity + heroParams.initialRotationY;
                heroModel.rotation.y += (targetRotationY - heroModel.rotation.y) * heroParams.smoothingFactor;
            }
            heroRenderer.render(heroScene, heroCamera);
            if (ramonaModel) {
                const targetRotationX = mouseY * ramonaParams.mouseIntensity;
                const targetRotationY = mouseX * ramonaParams.mouseIntensity;
                ramonaModel.rotation.x += (targetRotationX - ramonaModel.rotation.x) * ramonaParams.smoothingFactor;
                ramonaModel.rotation.y += (targetRotationY - ramonaModel.rotation.y) * ramonaParams.smoothingFactor;
            }
            ramonaRenderer.render(ramonaScene, ramonaCamera);
        }
        window.addEventListener('resize', () => {
            heroCamera.aspect = heroContainer.clientWidth / heroContainer.clientHeight;
            heroCamera.updateProjectionMatrix();
            heroRenderer.setSize(heroContainer.clientWidth, heroContainer.clientHeight);
            updateHeroModelTransform();
            ramonaCamera.aspect = ramonaContainer.clientWidth / ramonaContainer.clientHeight;
            ramonaCamera.updateProjectionMatrix();
            ramonaRenderer.setSize(ramonaContainer.clientWidth, ramonaContainer.clientHeight);
        });
        animate();
    </script>
</body>
</html>
