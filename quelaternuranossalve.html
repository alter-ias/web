<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que la ternura nos salve</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Limelight&family=Rye&display=swap');

        :root {
            --color-fondo: rgb(22, 24, 28);
            --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218);
            --color-pastel-cyan: rgb(190, 225, 218);
            --color-pastel-orange: #ffb347;
            --color-pastel-yellow: #fdfd96;
            --font-principal: 'Courier New', Courier, monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-principal); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }
        .fixed-hero-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header, .hero-description { position: absolute; left: 50%; transform: translateX(-50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-header { top: 25%; transform: translate(-50%, -50%); }
        .hero-description { bottom: 5%; max-width: 700px; }
        .scroll-container { position: relative; z-index: 3; }
        .scroll-spacer { height: 100vh; }
        .content-block { padding: 4rem 2rem; max-width: 95%; margin: 0 auto; background-color: var(--color-fondo); }
        
        /* --- NUEVO LAYOUT DINÁMICO --- */
        .interactive-project-block { 
            position: relative;
            /* height: 100vh; -- ELIMINADO: La altura ahora es automática */
            width: 100%;
            display: flex;
            gap: 3rem; /* Más espacio entre columnas */
            align-items: flex-start; /* Alineamos al inicio, no al centro */
            padding: 10vh 0; /* Espacio vertical para que no se pegue a los bordes */
        }
        
        .project-col {
            flex: 1;
            /* height: 80vh; -- ELIMINADO */
        }

        #col-visuals {
            position: sticky; /* ¡LA CLAVE! Se queda fijo al hacer scroll */
            top: 10vh; /* Margen superior cuando está fijo */
            height: 80vh; /* Le damos una altura fija al contenedor del video */
        }
        
        #col-text {
            min-height: 80vh; /* Aseguramos una altura mínima para textos cortos */
        }

        @media (max-width: 900px) {
            .interactive-project-block {
                position: static;
                height: auto;
                flex-direction: column;
                gap: 2rem;
                padding: 5vh 0;
            }
            #col-visuals {
                position: static; /* Desactivamos el sticky en móvil */
                width: 100%;
                height: auto; /* La altura se adaptará al aspect-ratio del video */
            }
            .visual-canvas-container { padding-top: 56.25%; height: 0; }
        }
        
        #active-text-display p { white-space: pre-wrap; }
        
        .hidden { display: none; }
        .visual-canvas-container { position: relative; width: 100%; height: 100%; background-color: black; }
        #visual-display { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; }
        
        h1 { font-family: var(--font-principal); font-size: 2.5rem; text-transform: uppercase; }
        h1 span { font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); text-transform: none; }
        p { line-height: 1.6; font-size: 1.1rem; }
        
        @media (max-width: 768px) {
             h1 { font-size: 1.8rem; }
             .hero-header { top: 18%; }
             .hero-description { bottom: 2%; font-size: 0.9rem; max-width: 90%; }
             p { font-size: 1rem; }
        }

        .pin-container { position: relative; height: auto; width: 100%; }
        /* El pin-container ya no necesita una altura fija, se la dará el contenido */

        .pin-container .interactive-project-block { position: sticky; top: 0; left: 0; z-index: 10; }
        
        /* El resto de estilos para erasure-block y tipografías permanece igual */
        .erasure-block { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 20; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: var(--color-fondo); will-change: transform; transform: translateX(100%); }
        .erasure-text { text-align: center; font-size: 6vw; font-weight: bold; text-transform: uppercase; padding: 2rem; }
        .erasure-text span { display: block; line-height: 1.1; margin-bottom: 0.5rem; }
        .font-rye { font-family: 'Rye', cursive; }
        .font-limelight { font-family: 'Limelight', cursive; }
        .font-bitcount-alt { font-family: var(--font-principal); font-size: 5.5vw; letter-spacing: -2px; }
        .text-cyan { color: var(--color-pastel-cyan); text-shadow: 0 0 15px rgba(190, 225, 218, 0.7); }
        .text-orange { color: var(--color-pastel-orange); text-shadow: 0 0 15px rgba(255, 179, 71, 0.7); }
        .text-yellow { color: var(--color-pastel-yellow); text-shadow: 0 0 15px rgba(253, 253, 150, 0.7); }
        @media (max-width: 768px) {
            .erasure-text { font-size: 10vw; }
            .font-bitcount-alt { font-size: 9vw; }
        }
    </style>
</head>
<body>
    <div class="fixed-hero-container">
        <div id="hero-canvas-container"></div>
        <header class="hero-header"><h1>Que la ternura nos salve<span>Un manifiesto que florece entre el artificio y el oficio</span></h1></header>
        <section class="hero-description"><p>Este es un mensaje en una botella, arrojado al vasto océano digital. Un experimento que mezcla escritos, música, dibujos y animaciones. Todo está permitido aquí, conectado por hilos invisibles que forman una única obra de arte digital. Un recordatorio de que en la creación deliberada y en la vulnerabilidad, encontramos una forma de salvación.</p></section>
    </div>
    <main class="scroll-container">
        <div class="scroll-spacer"></div>
        <section class="content-block">
            <!-- El pin-container ahora envuelve todo el bloque dinámico -->
            <div class="pin-container">
                <div class="interactive-project-block">
                    <div id="col-visuals" class="project-col">
                        <div class="visual-canvas-container">
                            <video id="visual-display" autoplay loop muted playsinline></video>
                        </div>
                    </div>
                    <div id="col-text" class="project-col">
                        <div id="active-text-display"><p>Cargando proyecto...</p></div>
                    </div>
                    <audio id="audio-player" loop class="hidden"></audio>
                </div>
                <!-- El erasure-block sigue funcionando igual, pero ahora se activa al final de este bloque dinámico -->
                <section class="erasure-block">
                    <div class="erasure-text">
                        <span class="font-rye text-cyan">Las</span>
                        <span class="font-limelight text-orange">Redes</span>
                        <span class="font-bitcount-alt text-yellow">Sociales</span>
                        <span class="font-rye text-cyan">Nos</span>
                        <span class="font-limelight text-orange">Están</span>
                        <span class="font-bitcount-alt text-yellow">Exterminando</span>
                    </div>
                </section>
            </div>
        </section>
    </main>
    
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // --- CÓDIGO DEL HERO (MODELO MÁQUINA) PERMANECE IGUAL ---
        const heroParams = {
            desktopModelScale: 2.9, desktopModelPositionY: 0.2, mobileModelScale: 2.0, mobileModelPositionY: 0.7,
            initialRotationX: 0.05, initialRotationY: -1.57, initialRotationZ: 0,
            mouseIntensity: 0.51, smoothingFactor: 0.088, cameraDistance: 4.4,
            ambientIntensity: 5.0, directionalIntensity: 4.5,
        };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5); heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina.glb', (gltf) => { heroModel = gltf.scene; heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3())); updateHeroModelTransform(); heroScene.add(heroModel); });

        // --- CÓDIGO DEL BLOQUE INTERACTIVO (SIMPLIFICADO) ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7mEJYUb9ErUmolsxLzhTxuimxOolr0bTp-uQjgJ6RDAw61ryHkqt0X5OF2V002Vq1NMnc9hyHhoU6/pub?gid=0&single=true&output=csv';
        const audioPlayer = document.getElementById('audio-player');
        const visualDisplay = document.getElementById('visual-display');
        const textDisplay = document.getElementById('active-text-display');
        
        function initProject() {
             Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const projectData = results.data.filter(p => p.audio && p.video && p.texto);
                    if (projectData.length > 0) {
                        const firstProject = projectData[0];
                        audioPlayer.src = firstProject.audio;
                        visualDisplay.src = firstProject.video;
                        textDisplay.innerHTML = `<p>${firstProject.texto}</p>`;
                    } else {
                        textDisplay.innerHTML = `<p>No se encontraron proyectos.</p>`;
                    }
                },
                error: (error) => console.error("Error al parsear CSV:", error),
            });
        }
        
        // --- LÓGICA DE INTERSECTION OBSERVER MEJORADA ---
        const projectBlock = document.querySelector('.interactive-project-block');

        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.2 // Se activa cuando el 20% del elemento es visible
        };

        const observerCallback = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // El bloque es visible, intentamos reproducir
                    visualDisplay.play(); // El video está muteado, no dará problemas
                    if (audioPlayer.src && audioPlayer.paused) {
                        const playPromise = audioPlayer.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.error("La reproducción automática de audio falló:", error);
                                // El usuario podría necesitar hacer clic en algún lugar para iniciar el audio.
                            });
                        }
                    }
                } else {
                    // El bloque ya no es visible, pausamos para ahorrar recursos
                    if (!audioPlayer.paused) {
                        audioPlayer.pause();
                    }
                }
            });
        };

        const observer = new IntersectionObserver(observerCallback, observerOptions);
        observer.observe(projectBlock);

        // --- FUNCIONES DE UTILIDAD Y ANIMACIÓN ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', e => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 - 1; });
        
        function updateHeroModelTransform() {
            if (!heroModel) return;
            const isMobile = window.innerWidth <= 768;
            const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale;
            heroModel.scale.setScalar(scale);
            heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY;
        }

        function handleResize() {
            const heroRect = heroContainer.getBoundingClientRect();
            heroCamera.aspect = heroRect.width / heroRect.height;
            heroCamera.updateProjectionMatrix();
            heroRenderer.setSize(heroRect.width, heroRect.height);
            updateHeroModelTransform();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (heroModel) {
                const targetHeroRotY = heroParams.initialRotationY + (mouseX * heroParams.mouseIntensity);
                heroModel.rotation.y += (targetHeroRotY - heroModel.rotation.y) * heroParams.smoothingFactor;
            }
            heroRenderer.render(heroScene, heroCamera);
        }
        
        window.addEventListener('resize', handleResize);
        handleResize();
        initProject();
        animate();
    </script>

    <!-- El script de animación del erasure-block necesita un ajuste para funcionar con la altura dinámica -->
    <script type="module">
        const pinContainer = document.querySelector('.pin-container');
        const erasureBlock = document.querySelector('.erasure-block');
        let isTicking = false;

        function updateAnimation() {
            const rect = pinContainer.getBoundingClientRect();
            // La distancia scrolleable ahora es la altura total del bloque de texto menos la altura de la ventana.
            const scrollableDistance = pinContainer.offsetHeight - window.innerHeight;

            // Evitamos división por cero si el contenido es más corto que la ventana
            if (scrollableDistance <= 0) {
                erasureBlock.style.transform = `translateX(100%)`;
                erasureBlock.style.visibility = 'hidden';
                return;
            }

            let progress = -rect.top / scrollableDistance;
            progress = Math.max(0, Math.min(1, progress));

            const transformX = 100 - (progress * 100);
            
            if (rect.top > 0) {
                 erasureBlock.style.visibility = 'hidden';
            } else {
                 erasureBlock.style.visibility = 'visible';
                 erasureBlock.style.transform = `translateX(${transformX}%)`;
            }
            
            isTicking = false;
        }

        function onScroll() {
            if (!isTicking) {
                window.requestAnimationFrame(updateAnimation);
                isTicking = true;
            }
        }
        
        onScroll();
        window.addEventListener('scroll', onScroll, { passive: true });
        
        // También necesitamos re-calcular en el resize, por si cambia el layout
        window.addEventListener('resize', onScroll);

    </script>
</body>
</html>
