<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que la ternura nos salve</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Limelight&family=Rye&display=swap');

        :root {
            --color-fondo: rgb(22, 24, 28);
            --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218);
            --color-pastel-cyan: rgb(190, 225, 218);
            --color-pastel-orange: #ffb347;
            --color-pastel-yellow: #fdfd96;
            --font-principal: 'Courier New', Courier, monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-principal); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }
        
        /* --- CAMBIO #1: HERO AHORA ES "STICKY" --- */
        .hero-section {
            position: sticky;
            top: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header, .hero-description { position: absolute; left: 50%; transform: translateX(-50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-header { top: 25%; transform: translate(-50%, -50%); }
        .hero-description { bottom: 5%; max-width: 700px; }
        
        .scroll-container { 
            position: relative; 
            z-index: 2; /* Para que se renderice sobre el hero al hacer scroll */
            background-color: var(--color-fondo); /* Fondo sólido para el contenido */
        }
        
        .content-container { padding: 0 2rem; max-width: 95%; margin: 0 auto; }

        .interactive-project-block { 
            position: relative;
            width: 100%;
            display: flex;
            gap: 3rem;
            align-items: flex-start;
            padding: 10vh 0;
            min-height: 100vh;
        }
        
        .project-col { flex: 1; }
        .project-col-visuals { position: sticky; top: 10vh; height: 80vh; }
        .project-col-text { min-height: 80vh; }

        @media (max-width: 900px) {
            .interactive-project-block { flex-direction: column; padding: 5vh 0; }
            .project-col-visuals { position: static; width: 100%; height: auto; }
            .visual-canvas-container { padding-top: 56.25%; height: 0; }
        }
        
        .active-text-display p { white-space: pre-wrap; }
        .hidden { display: none; }
        
        /* --- CAMBIO #2: FONDO DEL VIDEO TRANSPARENTE --- */
        .visual-canvas-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            /* background-color: black; -- ¡ELIMINADO! */
        }
        .visual-display { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; }
        
        h1 { font-family: var(--font-principal); font-size: 2.5rem; text-transform: uppercase; }
        h1 span { font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); text-transform: none; }
        p { line-height: 1.6; font-size: 1.1rem; }
        
        @media (max-width: 768px) {
             h1 { font-size: 1.8rem; }
             .hero-header { top: 18%; }
             .hero-description { bottom: 2%; font-size: 0.9rem; max-width: 90%; }
             p { font-size: 1rem; }
        }

        .erasure-pin-container { position: relative; height: 200vh; width: 100%; }
        .erasure-pin-container .erasure-block-wrapper { position: sticky; top: 0; left: 0; width: 100%; height: 100vh; z-index: 15; }
        .erasure-block { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 20; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: var(--color-fondo); will-change: transform; transform: translateX(100%); }
        .erasure-text { text-align: center; font-size: 6vw; font-weight: bold; text-transform: uppercase; padding: 2rem; }
        .erasure-text span { display: block; line-height: 1.1; margin-bottom: 0.5rem; }
        .font-rye { font-family: 'Rye', cursive; }
        .font-limelight { font-family: 'Limelight', cursive; }
        .font-bitcount-alt { font-family: var(--font-principal); font-size: 5.5vw; letter-spacing: -2px; }
        .text-cyan { color: var(--color-pastel-cyan); text-shadow: 0 0 15px rgba(190, 225, 218, 0.7); }
        .text-orange { color: var(--color-pastel-orange); text-shadow: 0 0 15px rgba(255, 179, 71, 0.7); }
        .text-yellow { color: var(--color-pastel-yellow); text-shadow: 0 0 15px rgba(253, 253, 150, 0.7); }
        @media (max-width: 768px) {
            .erasure-text { font-size: 10vw; }
            .font-bitcount-alt { font-size: 9vw; }
            .erasure-pin-container { height: 150vh; }
        }

        /* --- CAMBIO #3: ESTILOS PARA EL BOTÓN DE DESBLOQUEO DE AUDIO --- */
        #audio-unlock-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #audio-unlock-btn {
            background-color: transparent;
            border: 2px solid var(--color-acento);
            color: var(--color-acento);
            font-family: var(--font-principal);
            font-size: 1.5rem;
            padding: 1rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #audio-unlock-btn:hover {
            background-color: var(--color-acento);
            color: var(--color-fondo);
        }
    </style>
</head>
<body>
    <!-- Overlay para desbloquear el audio -->
    <div id="audio-unlock-overlay">
        <button id="audio-unlock-btn">ENTRAR</button>
    </div>

    <div class="hero-section">
        <div id="hero-canvas-container"></div>
        <header class="hero-header"><h1>Que la ternura nos salve<span>Un manifiesto que florece entre el artificio y el oficio</span></h1></header>
        <section class="hero-description"><p>Este es un mensaje en una botella, arrojado al vasto océano digital. Un experimento que mezcla escritos, música, dibujos y animaciones. Todo está permitido aquí, conectado por hilos invisibles que forman una única obra de arte digital. Un recordatorio de que en la creación deliberada y en la vulnerabilidad, encontramos una forma de salvación.</p></section>
    </div>

    <main class="scroll-container">
        <!-- Ya no hay spacer, el contenido empieza aquí -->
        <div class="content-container"></div>
    </main>
    
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // --- CÓDIGO DEL HERO (SIN CAMBIOS) ---
        const heroParams = { desktopModelScale: 2.9, desktopModelPositionY: 0.2, mobileModelScale: 2.0, mobileModelPositionY: 0.7, initialRotationY: -1.57, mouseIntensity: 0.51, smoothingFactor: 0.088, cameraDistance: 4.4, ambientIntensity: 5.0, directionalIntensity: 4.5, };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5); heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina.glb', (gltf) => { heroModel = gltf.scene; heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3())); updateHeroModelTransform(); heroScene.add(heroModel); });

        // --- LÓGICA DE PROYECTO DINÁMICO Y AUDIO FADE (CON DESBLOQUEO) ---

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7mEJYUb9ErUmolsxLzhTxuimxOolr0bTp-uQjgJ6RDAw61ryHkqt0X5OF2V002Vq1NMnc9hyHhoU6/pub?gid=0&single=true&output=csv';
        const contentContainer = document.querySelector('.content-container');

        function fadeAudio(audio, direction, duration) {
            clearInterval(audio.fadeInterval);
            const targetVolume = (direction === 'in') ? 1 : 0;
            const steps = 50;
            const stepTime = duration / steps;
            const volStep = 1 / steps;
            
            if (direction === 'in' && audio.paused) {
                 audio.volume = 0; // Asegurarse de empezar desde 0
                 audio.play().catch(e => console.error("Error al iniciar audio:", e));
            }

            audio.fadeInterval = setInterval(() => {
                let currentVolume = audio.volume;
                if (direction === 'in') {
                    if (currentVolume < targetVolume - volStep) { audio.volume += volStep; } 
                    else { audio.volume = 1; clearInterval(audio.fadeInterval); }
                } else {
                    if (currentVolume > targetVolume + volStep) { audio.volume -= volStep; } 
                    else { audio.volume = 0; clearInterval(audio.fadeInterval); audio.pause(); }
                }
            }, stepTime);
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const audio = entry.target.querySelector('.project-audio-player');
                if (!audio) return;
                fadeAudio(audio, entry.isIntersecting ? 'in' : 'out', 1500);
            });
        }, { root: null, threshold: [0.2, 0.8] });

        function buildProjectBlocks(data) {
            contentContainer.innerHTML = '';
            
            data.forEach(project => {
                const projectBlock = document.createElement('div');
                projectBlock.className = 'interactive-project-block';
                projectBlock.innerHTML = `
                    <div class="project-col project-col-visuals">
                        <div class="visual-canvas-container">
                            <video class="visual-display" loop muted playsinline src="${project.video}"></video>
                        </div>
                    </div>
                    <div class="project-col project-col-text">
                        <div class="active-text-display"><p>${project.texto}</p></div>
                    </div>
                    <audio class="project-audio-player hidden" loop src="${project.audio}"></audio>
                `;
                contentContainer.appendChild(projectBlock);
                observer.observe(projectBlock);
                projectBlock.querySelector('.visual-display').play().catch(()=>{});
            });

            const erasureContainer = document.createElement('div');
            erasureContainer.className = 'erasure-pin-container';
            erasureContainer.innerHTML = `
                <div class="erasure-block-wrapper">
                    <section class="erasure-block">
                        <div class="erasure-text">
                            <span class="font-rye text-cyan">Las</span>
                            <span class="font-limelight text-orange">Redes</span>
                            <span class="font-bitcount-alt text-yellow">Sociales</span>
                            <span class="font-rye text-cyan">Nos</span>
                            <span class="font-limelight text-orange">Están</span>
                            <span class="font-bitcount-alt text-yellow">Exterminando</span>
                        </div>
                    </section>
                </div>`;
            contentContainer.appendChild(erasureContainer);
            initErasureAnimation(erasureContainer);
            
            // --- LÓGICA PARA DESBLOQUEAR EL AUDIO ---
            const overlay = document.getElementById('audio-unlock-overlay');
            const unlockBtn = document.getElementById('audio-unlock-btn');
            unlockBtn.addEventListener('click', () => {
                const players = document.querySelectorAll('.project-audio-player');
                let unlockPromise = players[0]?.play(); // Intentar reproducir el primero
                if (unlockPromise !== undefined) {
                    unlockPromise.then(() => {
                        players[0].pause(); // Pausarlo de inmediato
                        console.log("Audio context desbloqueado.");
                    }).catch(error => {
                        console.error("Desbloqueo de audio falló:", error);
                    });
                }
                overlay.style.display = 'none';
            }, { once: true }); // El evento solo se dispara una vez
        }

        function initProject() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const projectData = results.data.filter(p => p.audio && p.video && p.texto);
                    if (projectData.length > 0) {
                        buildProjectBlocks(projectData);
                    } else {
                        contentContainer.innerHTML = `<p>No se encontraron proyectos.</p>`;
                    }
                },
                error: (error) => console.error("Error al parsear CSV:", error),
            });
        }
        
        // --- FUNCIONES DE UTILIDAD Y ANIMACIÓN (SIN CAMBIOS) ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', e => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 - 1; });
        function updateHeroModelTransform() { if (!heroModel) return; const isMobile = window.innerWidth <= 768; const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale; heroModel.scale.setScalar(scale); heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY; }
        function handleResize() { const heroRect = document.querySelector('.hero-section').getBoundingClientRect(); heroCamera.aspect = heroRect.width / heroRect.height; heroCamera.updateProjectionMatrix(); heroRenderer.setSize(heroRect.width, heroRect.height); updateHeroModelTransform(); }
        function animate() { requestAnimationFrame(animate); if (heroModel) { const targetHeroRotY = heroParams.initialRotationY + (mouseX * heroParams.mouseIntensity); heroModel.rotation.y += (targetHeroRotY - heroModel.rotation.y) * heroParams.smoothingFactor; } heroRenderer.render(heroScene, heroCamera); }
        window.addEventListener('resize', handleResize);
        handleResize();
        initProject();
        animate();

        // --- SCRIPT DE ANIMACIÓN DE SCROLL (SIN CAMBIOS) ---
        function initErasureAnimation(container) {
            const erasureBlock = container.querySelector('.erasure-block');
            let isTicking = false;
            function updateAnimation() {
                const rect = container.getBoundingClientRect();
                const scrollableDistance = container.offsetHeight - window.innerHeight;
                if (scrollableDistance <= 0) return;
                let progress = -rect.top / scrollableDistance;
                progress = Math.max(0, Math.min(1, progress));
                const transformX = 100 - (progress * 100);
                if (rect.top > 0) { erasureBlock.style.visibility = 'hidden'; } 
                else { erasureBlock.style.visibility = 'visible'; erasureBlock.style.transform = `translateX(${transformX}%)`; }
                isTicking = false;
            }
            function onScroll() { if (!isTicking) { window.requestAnimationFrame(updateAnimation); isTicking = true; } }
            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('resize', onScroll);
            onScroll();
        }
    </script>

</body>
</html>
