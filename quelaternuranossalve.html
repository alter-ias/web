<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que la ternura nos salve</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@500&family=Roboto+Mono&family=Work+Sans:wght@300;400&display=swap');
        :root {
            --color-fondo: rgb(22, 24, 28); --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218); --color-acento-hover: white;
            --font-titulos: 'Lora', serif; --font-cuerpo: 'Work Sans', sans-serif; --font-mono: 'Roboto Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-cuerpo); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }

        .fixed-hero-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header { position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-description { position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); width: 100%; max-width: 700px; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .scroll-container { position: relative; z-index: 3; }
        .scroll-spacer { height: 100vh; }
        .content-block { padding: 4rem 2rem; max-width: 1400px; margin: 0 auto; background-color: var(--color-fondo); min-height: 100vh; }

        .interactive-project-block { display: flex; gap: 2.5rem; align-items: flex-start; }
        .project-col-model { flex: 0 0 30%; } .project-col-text { flex: 0 0 20%; } .project-col-visuals { flex: 1; }

        #ramona-canvas-container { width: 100%; height: 50vh; cursor: move; margin-bottom: 2rem; }
        
        /* --- Reproductor y Controles de Navegación --- */
        #track-title-display { font-family: var(--font-mono); color: var(--color-acento); margin-bottom: 1rem; height: 1.2em; }
        .player-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .player-wrapper audio { flex-grow: 1; }
        .nav-button { background: none; border: 1px solid var(--color-texto); color: var(--color-texto); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; transition: background-color 0.2s; }
        .nav-button:hover { background-color: rgba(255,255,255,0.1); }
        
        .visual-canvas-container { position: relative; width: 100%; padding-top: 56.25%; background-color: black; }
        #visual-display { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        h1 { font-family: var(--font-titulos); font-size: 3rem; }
        h1 span { font-family: var(--font-mono); font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); }
        p { line-height: 1.8; }
        
        .lil-gui { z-index: 1000 !important; }
        
        @media (max-width: 900px) { /* etc. */ }
    </style>
</head>
<body>

    <div class="fixed-hero-container">
        <div id="hero-canvas-container"></div>
        <header class="hero-header">
            <h1>Que la ternura nos salve<span>Un manifiesto que florece entre el artificio y el oficio</span></h1>
        </header>
        <section class="hero-description">
            <p>Este es un mensaje en una botella, arrojado al vasto océano digital. Un experimento que mezcla escritos, música, dibujos y animaciones. Todo está permitido aquí, conectado por hilos invisibles que forman una única obra de arte digital. Un recordatorio de que en la creación deliberada y en la vulnerabilidad, encontramos una forma de salvación.</p>
        </section>
    </div>

    <main class="scroll-container">
        <div class="scroll-spacer"></div>
        <section class="content-block">
            <div class="interactive-project-block">
                <div class="project-col-model">
                    <div id="ramona-canvas-container"></div>
                    <div id="playlist-controls">
                        <h4 id="track-title-display"></h4>
                        <div class="player-wrapper">
                            <button id="prev-track-btn" class="nav-button">◄</button>
                            <audio id="audio-player" controls></audio>
                            <button id="next-track-btn" class="nav-button">►</button>
                        </div>
                    </div>
                </div>
                <div class="project-col-text">
                    <div id="active-text-display"><p>Cargando proyecto...</p></div>
                </div>
                <div class="project-col-visuals">
                    <div class="visual-canvas-container">
                        <video id="visual-display" autoplay loop muted playsinline></video>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/", "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { GUI } from 'lil-gui';

        // --- ESCENA 1 (HERO) - Sin cambios ---
        const heroParams = { desktopModelScale: 2.9, desktopModelPositionY: 0.2, mobileModelScale: 2.0, mobileModelPositionY: 0.7, initialRotationY: -1.57, mouseIntensity: 0.51, smoothingFactor: 0.088, cameraDistance: 4.4, ambientIntensity: 5.0, directionalIntensity: 4.5 };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, heroContainer.clientWidth / heroContainer.clientHeight, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio); heroRenderer.setSize(heroContainer.clientWidth, heroContainer.clientHeight);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5); heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina.glb', (gltf) => { heroModel = gltf.scene; heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3())); updateHeroModelTransform(); heroScene.add(heroModel); });

        // --- ESCENA 2 (RAMONA) CON CONTROLES ---
        const ramonaParams = { mouseIntensity: 0.4, smoothingFactor: 0.05, scale: 3.5, cameraDistance: 2.5, initialRotationX: 0, initialRotationY: 0, initialRotationZ: 0 };
        const ramonaContainer = document.getElementById('ramona-canvas-container');
        const ramonaScene = new THREE.Scene();
        const ramonaCamera = new THREE.PerspectiveCamera(75, ramonaContainer.clientWidth / ramonaContainer.clientHeight, 0.1, 1000);
        ramonaCamera.position.z = ramonaParams.cameraDistance;
        const ramonaRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        ramonaRenderer.setPixelRatio(window.devicePixelRatio); ramonaRenderer.setSize(ramonaContainer.clientWidth, ramonaContainer.clientHeight);
        ramonaContainer.appendChild(ramonaRenderer.domElement);
        ramonaScene.add(new THREE.AmbientLight(0xffffff, 4.0));
        const ramonaDirectionalLight = new THREE.DirectionalLight(0xffffff, 3.0);
        ramonaDirectionalLight.position.set(2, 5, 3); ramonaScene.add(ramonaDirectionalLight);
        let ramonaModel;
        new GLTFLoader().load('./assets/3d/ramona.glb', (gltf) => { ramonaModel = gltf.scene; updateRamonaModelTransform(); ramonaScene.add(ramonaModel); });

        const gui = new GUI();
        gui.title("Control Ramona").close();
        gui.add(ramonaParams, 'scale', 0.1, 10, 0.1).name('Escala').onChange(updateRamonaModelTransform);
        const rotFolder = gui.addFolder('Rotación Inicial');
        rotFolder.add(ramonaParams, 'initialRotationX', -Math.PI, Math.PI, 0.01).name('Rotación X');
        rotFolder.add(ramonaParams, 'initialRotationY', -Math.PI, Math.PI, 0.01).name('Rotación Y');
        rotFolder.add(ramonaParams, 'initialRotationZ', -Math.PI, Math.PI, 0.01).name('Rotación Z');

        // --- LÓGICA DE DATOS Y PLAYLIST (CORREGIDA) ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7mEJYUb9ErUmolsxLzhTxuimxOolr0bTp-uQjgJ6RDAw61ryHkqt0X5OF2V002Vq1NMnc9hyHhoU6/pub?gid=0&single=true&output=csv';
        const audioPlayer = document.getElementById('audio-player');
        const visualDisplay = document.getElementById('visual-display');
        const textDisplay = document.getElementById('active-text-display');
        const titleDisplay = document.getElementById('track-title-display');
        let projectData = [];
        let currentIndex = 0;

        async function initProject() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                projectData = csvText.trim().split('\n').slice(1).map(row => {
                    // Parser de CSV robusto
                    const values = []; let current = ''; let inQuotes = false;
                    for (const char of row) {
                        if (char === '"' && inQuotes) { inQuotes = false; }
                        else if (char === '"') { inQuotes = true; }
                        else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
                        else { current += char; }
                    }
                    values.push(current.trim());
                    const [audio, text, video, titulo] = values;
                    return { audio, text, video, titulo };
                }).filter(p => p.audio); // Filtrar filas vacías

                if (projectData.length > 0) updateContent(currentIndex);
                else textDisplay.innerHTML = `<p>No se encontraron proyectos.</p>`;

            } catch (error) { console.error("Error al cargar los datos:", error); }
        }

        function updateContent(index) {
            const track = projectData[index];
            if (!track) return;
            audioPlayer.src = track.audio;
            visualDisplay.src = track.video;
            textDisplay.innerHTML = `<p>${track.text}</p>`;
            titleDisplay.textContent = track.titulo;

            visualDisplay.load();
            visualDisplay.play().catch(e => console.warn("Video play interrupted"));
        }

        document.getElementById('next-track-btn').addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % projectData.length;
            updateContent(currentIndex);
        });

        document.getElementById('prev-track-btn').addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + projectData.length) % projectData.length;
            updateContent(currentIndex);
        });
        
        initProject();

        // --- LÓGICA GENERAL ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', e => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 + 1; });
        function updateHeroModelTransform() { if (!heroModel) return; const isMobile = window.innerWidth < 768; const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale; heroModel.scale.setScalar(scale); heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY; }
        function updateRamonaModelTransform() { if (!ramonaModel) return; ramonaModel.scale.setScalar(ramonaParams.scale); }
        
        function animate() {
            requestAnimationFrame(animate);
            if (heroModel) { heroModel.rotation.y += ((mouseX * heroParams.mouseIntensity + heroParams.initialRotationY) - hero.rotation.y) * heroParams.smoothingFactor; }
            heroRenderer.render(heroScene, heroCamera);
            if (ramonaModel) {
                ramonaModel.rotation.x += (((mouseY * ramonaParams.mouseIntensity) + ramonaParams.initialRotationX) - ramonaModel.rotation.x) * ramonaParams.smoothingFactor;
                ramonaModel.rotation.y += (((mouseX * ramonaParams.mouseIntensity) + ramonaParams.initialRotationY) - ramonaModel.rotation.y) * ramonaParams.smoothingFactor;
                ramonaModel.rotation.z += (ramonaParams.initialRotationZ - ramonaModel.rotation.z) * ramonaParams.smoothingFactor;
            }
            ramonaRenderer.render(ramonaScene, ramonaCamera);
        }
        
        window.addEventListener('resize', () => {
            // Hero
            heroCamera.aspect = heroContainer.clientWidth / heroContainer.clientHeight; heroCamera.updateProjectionMatrix();
            heroRenderer.setSize(heroContainer.clientWidth, heroContainer.clientHeight); updateHeroModelTransform();
            // Ramona
            ramonaCamera.aspect = ramonaContainer.clientWidth / ramonaContainer.clientHeight; ramonaCamera.updateProjectionMatrix();
            ramonaRenderer.setSize(ramonaContainer.clientWidth, ramonaContainer.clientHeight);
        });
        
        animate();
    </script>
</body>
</html>
