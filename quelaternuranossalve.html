<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que la ternura nos salve</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* ... El CSS permanece sin cambios ... */
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@500&family=Roboto+Mono&family=Work+Sans:wght@300;400&display=swap');
        :root {
            --color-fondo: rgb(22, 24, 28); --color-texto: rgb(230, 230, 230);
            --color-acento: rgb(190, 225, 218); --color-acento-hover: white;
            --font-titulos: 'Lora', serif; --font-cuerpo: 'Work Sans', sans-serif; --font-mono: 'Roboto Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-cuerpo); background-color: var(--color-fondo); color: var(--color-texto); overflow-x: hidden; }
        .fixed-hero-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        #hero-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
        .hero-header, .hero-description { position: absolute; left: 50%; transform: translateX(-50%); width: 100%; padding: 2rem; text-align: center; pointer-events: none; z-index: 2; }
        .hero-header { top: 25%; transform: translate(-50%, -50%); }
        .hero-description { bottom: 5%; max-width: 700px; }
        .scroll-container { position: relative; z-index: 3; }
        .scroll-spacer { height: 100vh; }
        .content-block { padding: 4rem 2rem; max-width: 95%; margin: 0 auto; background-color: var(--color-fondo); }
        .interactive-project-block { position: relative; height: 100vh; }
        .project-col { position: absolute; transition: all 0.3s ease; }
        .project-col-text { white-space: pre-wrap; overflow-y: auto; }
        #ramona-canvas-container, .player-and-title { width: 100%; }
        #ramona-canvas-container { height: 80%; cursor: move; }
        #track-title-display { font-family: var(--font-mono); color: var(--color-acento); margin-bottom: 1rem; height: 1.2em; text-align: center;}
        .custom-player { display: flex; justify-content: center; align-items: center; gap: 1rem; }
        .player-button { background: none; border: 1px solid var(--color-texto); color: var(--color-texto); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; padding: 0; }
        .player-button:hover { background-color: rgba(255,255,255,0.1); }
        .player-button svg { width: 18px; height: 18px; fill: var(--color-texto); }
        .hidden { display: none; }
        .visual-canvas-container { position: relative; width: 100%; height: 100%; background-color: black; }
        #visual-display { width: 100%; height: 100%; object-fit: cover; }
        h1 { font-family: var(--font-titulos); font-size: 3rem; }
        h1 span { font-family: var(--font-mono); font-size: 1rem; display: block; margin-top: 10px; color: var(--color-acento); }
        p { line-height: 1.8; }
        .lil-gui { z-index: 1000 !important; }
    </style>
</head>
<body>
    <div class="fixed-hero-container">
        <div id="hero-canvas-container"></div>
        <header class="hero-header"><h1>Que la ternura nos salve<span>Un manifiesto que florece entre el artificio y el oficio</span></h1></header>
        <section class="hero-description"><p>Este es un mensaje en una botella, arrojado al vasto océano digital. Un experimento que mezcla escritos, música, dibujos y animaciones. Todo está permitido aquí, conectado por hilos invisibles que forman una única obra de arte digital. Un recordatorio de que en la creación deliberada y en la vulnerabilidad, encontramos una forma de salvación.</p></section>
    </div>
    <main class="scroll-container">
        <div class="scroll-spacer"></div>
        <section class="content-block">
            <div class="interactive-project-block">
                <div id="col-model" class="project-col"><div id="ramona-canvas-container"></div><div class="player-and-title"><h4 id="track-title-display"></h4><div class="custom-player"><button id="prev-btn" class="player-button"><svg viewBox="0 0 24 24"><path d="M18 18V6l-8.5 6 8.5 6Zm-9-6 8.5-6v12L9 12Z"/></svg></button><button id="play-pause-btn" class="player-button"><svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><svg id="pause-icon" class="hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button><button id="next-btn" class="player-button"><svg viewBox="0 0 24 24"><path d="m6 6 8.5 6L6 18V6Zm9 12v-12L15 6l-8.5 6 8.5 6Z"/></svg></button><button id="mute-btn" class="player-button"><svg id="unmute-icon" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg><svg id="mute-icon" class="hidden" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg></button></div><audio id="audio-player" class="hidden"></audio></div></div>
                <div id="col-text" class="project-col"><div id="active-text-display"><p>Cargando proyecto...</p></div></div>
                <div id="col-visuals" class="project-col"><div class="visual-canvas-container"><video id="visual-display" autoplay loop muted playsinline></video></div></div>
            </div>
        </section>
    </main>
    
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.163.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/", "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { GUI } from 'lil-gui';

        // --- ESCENA 1 (HERO) - PARÁMETROS RESTAURADOS ---
        const heroParams = {
            desktopModelScale: 2.9,
            desktopModelPositionY: 0.2,
            mobileModelScale: 2.0,
            mobileModelPositionY: 0.7,
            initialRotationX: 0.05,
            initialRotationY: -1.57,
            initialRotationZ: 0,
            mouseIntensity: 0.51,
            smoothingFactor: 0.088,
            cameraDistance: 4.4,
            ambientIntensity: 5.0,
            directionalIntensity: 4.5,
        };
        const heroContainer = document.getElementById('hero-canvas-container');
        const heroScene = new THREE.Scene();
        const heroCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        heroCamera.position.z = heroParams.cameraDistance;
        const heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setPixelRatio(window.devicePixelRatio);
        heroContainer.appendChild(heroRenderer.domElement);
        heroScene.add(new THREE.AmbientLight(0xffffff, heroParams.ambientIntensity));
        const heroDirectionalLight = new THREE.DirectionalLight(0xffffff, heroParams.directionalIntensity);
        heroDirectionalLight.position.set(5, 10, 7.5); heroScene.add(heroDirectionalLight);
        let heroModel;
        new GLTFLoader().load('./assets/3d/maquina.glb', (gltf) => { heroModel = gltf.scene; heroModel.position.sub(new THREE.Box3().setFromObject(heroModel).getCenter(new THREE.Vector3())); updateHeroModelTransform(); heroScene.add(heroModel); });

        // --- ESCENA 2 (RAMONA) ---
        const ramonaParams = { mouseIntensity: 0.4, smoothingFactor: 0.05, scale: 2.7, cameraDistance: 2.5, initialRotationX: 0.84, initialRotationY: -1.63, initialRotationZ: 0 };
        const layoutParams = {
            desktop: { model: {x: 0, y: 0, w: 34, h: 91}, text: {x: 36, y: 69, w: 63, h: 25}, visuals: {x: 36, y: 3, w: 61, h: 63} },
            mobile:  { model: {x: 10, y: 48, w: 80, h: 35}, text: {x: 10, y: 85, w: 80, h: 15}, visuals: {x: 10, y: 2, w: 80, h: 45} }
        };
        const ramonaContainer = document.getElementById('ramona-canvas-container');
        const ramonaScene = new THREE.Scene();
        const ramonaCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        ramonaCamera.position.z = ramonaParams.cameraDistance;
        const ramonaRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        ramonaRenderer.setPixelRatio(window.devicePixelRatio);
        ramonaContainer.appendChild(ramonaRenderer.domElement);
        ramonaScene.add(new THREE.AmbientLight(0xffffff, 4.0));
        const ramonaDirectionalLight = new THREE.DirectionalLight(0xffffff, 3.0);
        ramonaDirectionalLight.position.set(2, 5, 3); ramonaScene.add(ramonaDirectionalLight);
        let ramonaModel;
        new GLTFLoader().load('./assets/3d/ramona.glb', (gltf) => { ramonaModel = gltf.scene; updateRamonaModelTransform(); ramonaScene.add(ramonaModel); });

        const gui = new GUI();
        gui.title("Controles del Bloque").close();
        const ramonaFolder = gui.addFolder('Modelo 3D (Ramona)');
        ramonaFolder.add(ramonaParams, 'scale', 0.1, 10, 0.1).name('Escala').onChange(updateRamonaModelTransform);
        const rotFolder = ramonaFolder.addFolder('Rotación Inicial');
        rotFolder.add(ramonaParams, 'initialRotationX', -Math.PI, Math.PI, 0.01).name('Rotación X').onChange(updateRamonaModelTransform);
        rotFolder.add(ramonaParams, 'initialRotationY', -Math.PI, Math.PI, 0.01).name('Rotación Y').onChange(updateRamonaModelTransform);
        rotFolder.add(ramonaParams, 'initialRotationZ', -Math.PI, Math.PI, 0.01).name('Rotación Z').onChange(updateRamonaModelTransform);
        const layoutDesktopFolder = gui.addFolder('Layout Escritorio');
        ['model', 'text', 'visuals'].forEach(key => { const folder = layoutDesktopFolder.addFolder(key); folder.add(layoutParams.desktop[key], 'x', 0, 100, 1).onChange(updateLayout); folder.add(layoutParams.desktop[key], 'y', 0, 100, 1).onChange(updateLayout); folder.add(layoutParams.desktop[key], 'w', 5, 100, 1).onChange(updateLayout); folder.add(layoutParams.desktop[key], 'h', 5, 100, 1).onChange(updateLayout); });
        const layoutMobileFolder = gui.addFolder('Layout Móvil');
        ['model', 'text', 'visuals'].forEach(key => { const folder = layoutMobileFolder.addFolder(key); folder.add(layoutParams.mobile[key], 'x', 0, 100, 1).onChange(updateLayout); folder.add(layoutParams.mobile[key], 'y', 0, 100, 1).onChange(updateLayout); folder.add(layoutParams.mobile[key], 'w', 5, 100, 1).onChange(updateLayout); folder.add(layoutParams.mobile[key], 'h', 5, 100, 1).onChange(updateLayout); });

        // --- LÓGICA DE DATOS Y REPRODUCTOR ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7mEJYUb9ErUmolsxLzhTxuimxOolr0bTp-uQjgJ6RDAw61ryHkqt0X5OF2V002Vq1NMnc9hyHhoU6/pub?gid=0&single=true&output=csv';
        const audioPlayer = document.getElementById('audio-player'), visualDisplay = document.getElementById('visual-display'), textDisplay = document.getElementById('active-text-display'), titleDisplay = document.getElementById('track-title-display');
        let projectData = [], currentIndex = 0;
        initProject();
        function initProject() {
             Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    projectData = results.data.filter(p => p.audio && p.video && p.texto && p.titulo);
                    if (projectData.length > 0) updateContent(currentIndex);
                    else textDisplay.innerHTML = `<p>No se encontraron proyectos completos.</p>`;
                },
                error: (error) => console.error("Error al parsear CSV:", error),
            });
        }
        function updateContent(index) { const track = projectData[index]; if (!track) return; audioPlayer.src = track.audio; visualDisplay.src = track.video; textDisplay.innerHTML = `<p>${track.texto}</p>`; titleDisplay.textContent = track.titulo; visualDisplay.load(); visualDisplay.play().catch(e => {}); }
        const playPauseBtn = document.getElementById('play-pause-btn'), playIcon = document.getElementById('play-icon'), pauseIcon = document.getElementById('pause-icon'), muteBtn = document.getElementById('mute-btn'), muteIcon = document.getElementById('mute-icon'), unmuteIcon = document.getElementById('unmute-icon');
        playPauseBtn.addEventListener('click', () => audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause());
        audioPlayer.addEventListener('play', () => { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); });
        audioPlayer.addEventListener('pause', () => { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); });
        document.getElementById('next-btn').addEventListener('click', () => { currentIndex = (currentIndex + 1) % projectData.length; updateContent(currentIndex); audioPlayer.play(); });
        document.getElementById('prev-btn').addEventListener('click', () => { currentIndex = (currentIndex - 1 + projectData.length) % projectData.length; updateContent(currentIndex); audioPlayer.play(); });
        muteBtn.addEventListener('click', () => { audioPlayer.muted = !audioPlayer.muted; });
        audioPlayer.addEventListener('volumechange', () => { muteIcon.classList.toggle('hidden', !audioPlayer.muted); unmuteIcon.classList.toggle('hidden', audioPlayer.muted); });

        // --- LÓGICA GENERAL ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', e => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 - 1; });
        function updateHeroModelTransform() { if (!heroModel) return; const isMobile = window.innerWidth < 768; const scale = isMobile ? heroParams.mobileModelScale : heroParams.desktopModelScale; heroModel.scale.setScalar(scale); heroModel.position.y = isMobile ? heroParams.mobileModelPositionY : heroParams.desktopModelPositionY; heroModel.rotation.set(heroParams.initialRotationX, heroParams.initialRotationY, heroParams.initialRotationZ); }
        function updateRamonaModelTransform() { if (!ramonaModel) return; ramonaModel.scale.setScalar(ramonaParams.scale); ramonaModel.rotation.set(ramonaParams.initialRotationX, ramonaParams.initialRotationY, ramonaParams.initialRotationZ); }
        function updateLayout() { const isMobile = window.innerWidth <= 900; const currentLayout = isMobile ? layoutParams.mobile : layoutParams.desktop; Object.keys(currentLayout).forEach(key => { const el = document.getElementById(`col-${key}`); const params = currentLayout[key]; if (el) { el.style.left = `${params.x}%`; el.style.top = `${params.y}%`; el.style.width = `${params.w}%`; el.style.height = `${params.h}%`; } }); }
        
        function handleResize() {
            updateLayout();
            const heroRect = heroContainer.getBoundingClientRect();
            heroCamera.aspect = heroRect.width / heroRect.height;
            heroCamera.updateProjectionMatrix();
            heroRenderer.setSize(heroRect.width, heroRect.height);
            updateHeroModelTransform();

            const ramonaRect = ramonaContainer.getBoundingClientRect();
            ramonaCamera.aspect = ramonaRect.width / ramonaRect.height;
            ramonaCamera.updateProjectionMatrix();
            ramonaRenderer.setSize(ramonaRect.width, ramonaRect.height);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (heroModel) {
                const targetHeroRotY = heroParams.initialRotationY + (mouseX * heroParams.mouseIntensity);
                heroModel.rotation.y += (targetHeroRotY - heroModel.rotation.y) * heroParams.smoothingFactor;
            }
            heroRenderer.render(heroScene, heroCamera);
            if (ramonaModel) {
                const targetRotX = ramonaParams.initialRotationX + (mouseY * ramonaParams.mouseIntensity);
                const targetRotY = ramonaParams.initialRotationY + (mouseX * ramonaParams.mouseIntensity);
                ramonaModel.rotation.x += (targetRotX - ramonaModel.rotation.x) * ramonaParams.smoothingFactor;
                ramonaModel.rotation.y += (targetRotY - ramonaModel.rotation.y) * ramonaParams.smoothingFactor;
            }
            ramonaRenderer.render(ramonaScene, ramonaCamera);
        }
        
        window.addEventListener('resize', handleResize);
        
        handleResize();
        initProject();
        animate();
    </script>
</body>
</html>
