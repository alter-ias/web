<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 7.2</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS "ZEN" (v5.8 Base) --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME (MEN) --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
            -webkit-overflow-scrolling: touch;
        }

        .home-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }

        /* DATOS Y VIDEO */
        .db-section {
            margin-top: 40px; padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        
        .video-box {
            width: 100%; margin-bottom: 20px; border: 1px solid #444; 
            border-radius: 8px; overflow: hidden; background: #000;
        }
        .video-box video { width: 100%; display: block; max-height: 400px; }

        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }

        /* NUEVO: FOOTER ALTERLAB */
        .alterlab-footer {
            margin-top: 40px; padding: 30px; background: rgba(0,0,0,0.4); border-radius: 12px;
            max-width: 900px; margin-left: auto; margin-right: auto; width: 100%;
            text-align: center; border: 1px solid #333;
        }
        .alterlab-footer h3 { color: #fff; margin-bottom: 15px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .alterlab-footer p { color: #aaa; font-size: 0.95rem; line-height: 1.6; margin-bottom: 25px; text-align: justify; }
        .footer-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-lab { padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.9rem; border: 2px solid transparent; transition: 0.3s; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-donate { background: transparent; border-color: var(--accent); color: var(--accent); }
        .btn-donate:hover { background: var(--accent); color: #000; }
        .btn-project { background: #fff; color: #000; }
        .btn-project:hover { background: #e0e0e0; transform: translateY(-2px); }

        /* --- VISTA: BOARD (JUEGO) --- */
        #view-board {
            flex: 1; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
            overflow: hidden;
        }
        #view-board.active { display: flex; }

        /* HEADER FLOTANTE JUEGO */
        .game-header {
            width: 100%; max-width: 600px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20,20,20,0.8); border-bottom: 1px solid #333;
            position: absolute; top: 0; z-index: 50; height: 50px;
        }
        .gh-info { display: flex; flex-direction: column; }
        .gh-title { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .gh-subtitle { font-size: 0.75rem; color: #888; }
        
        .btn-exit {
            background: transparent; border: 1px solid #444; color: #ccc;
            padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
        }

        /* Layout del Tablero */
        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 60px 10px 10px 10px; 
            justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #263238; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background-size: contain; 
        }

        /* Panel Info */
        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }
        .tag.end { background: #fff; color: #000; border: 2px solid var(--accent); }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:active { background: #444; color: #fff; }
        .ctrl-btn.sol { background: var(--warn); color: #000; border: none; }
        .ctrl-btn.next { background: var(--success); color: #000; border: none; }

        /* Feedback */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        /* Modal Tutorial */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1e1e1e; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; color: #eee; }
        .close-modal { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- VISTA: HOME -->
<div id="view-home">
    <div class="home-header">
        <a href="index.html" style="text-decoration:none;">
            <h1>AlterDrez</h1>
        </a>
        <p>Entrenamiento de Ajedrez Profesional v7.2</p>
    </div>

    <div class="cards-container">
        <!-- CARD JUGAR -->
        <div class="card play">
            <div class="card-title"><i class="bi bi-joystick"></i> Jugar</div>
            <div class="config-row">
                <select id="cfg-play-color">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
                <select id="cfg-play-level">
                    <option value="0">Novato (800)</option>
                    <option value="3">Aficionado (1100)</option>
                    <option value="6">Club (1400)</option>
                    <option value="9">Intermedio (1700)</option>
                    <option value="12">Experto (2000)</option>
                    <option value="15">Maestro (2300)</option>
                    <option value="20">Gran Maestro (2600+)</option>
                </select>
            </div>
            <button class="btn-action" onclick="App.startPlay()">Jugar vs IA</button>
        </div>

        <!-- CARD APERTURAS -->
        <div class="card learn">
            <div class="card-title"><i class="bi bi-book"></i> Aperturas</div>
            <select id="cfg-opening-select">
                <option value="">-- Selecciona Apertura --</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-opening-count" style="color:var(--success)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startOpening()">Estudiar</button>
        </div>

        <!-- CARD TCTICA -->
        <div class="card tactics">
            <div class="card-title"><i class="bi bi-lightning-fill"></i> T谩ctica</div>
            <select id="cfg-tactics-elo">
                <option value="800">Principiante (800)</option>
                <option value="1100">Aficionado (1100)</option>
                <option value="1400">Intermedio (1400)</option>
                <option value="1700">Club (1700)</option>
                <option value="2000">Avanzado (2000)</option>
                <option value="2300">Maestro (2300)</option>
                <option value="2500">Elite (2500+)</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-tactics-count" style="color:var(--tactics)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startTactics()">Resolver</button>
        </div>
    </div>

    <!-- SECCIN DATOS Y VIDEO INTEGRADO -->
    <div class="db-section">
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px;">Gesti贸n de Datos & Tutorial</h3>
        
        <!-- VIDEO VISIBLE -->
        <div class="video-box">
            <video controls playsinline preload="auto" muted>
                <source src="assets/alterdrez/tutorial.mp4" type="video/mp4">
                Tu navegador no soporta la reproducci贸n de video.
            </video>
        </div>

        <button class="db-btn" onclick="document.getElementById('modal-help').classList.add('active')">
            <i class="bi bi-question-circle"></i> 驴C贸mo usar?
        </button>
        <button class="db-btn" onclick="document.getElementById('file-openings').click()">
            <i class="bi bi-upload"></i> Cargar Aperturas (.tsv)
        </button>
        <button class="db-btn" onclick="document.getElementById('file-tactics').click()">
            <i class="bi bi-upload"></i> Cargar T谩ctica (.csv)
        </button>
        <button class="db-btn" onclick="Storage.clear()" style="color:var(--error); border-color:var(--error);">
            <i class="bi bi-trash"></i> Borrar Datos Guardados
        </button>
        
        <input type="file" id="file-openings" accept=".tsv,.txt,.csv" style="display:none" onchange="DB.loadOpenings(this)">
        <input type="file" id="file-tactics" accept=".csv" style="display:none" onchange="DB.loadTactics(this)">
    </div>

    <!-- SECCIN FOOTER ALTERLAB (NUEVA) -->
    <div class="alterlab-footer">
        <h3><i class="bi bi-people-fill"></i> Colectivo AlterLab</h3>
        <p>
            Este proyecto ha sido desarrollado bajo la filosof铆a del <b>C贸digo Abierto y Libre</b>. Creemos firmemente que el conocimiento y las herramientas para el desarrollo cognitivo no deben tener barreras de pago. 
            El ajedrez no es solo un juego; es una herramienta poderosa para el pensamiento cr铆tico, la paciencia y la resiliencia social. 
            Si compartes nuestra visi贸n de una tecnolog铆a 茅tica y accesible para todos, considera apoyar nuestro trabajo.
        </p>
        <div class="footer-btns">
            <button class="btn-lab btn-donate" onclick="alert('隆Gracias por tu intenci贸n! Pronto habilitaremos la plataforma de donaciones.')"><i class="bi bi-heart-fill"></i> Apoyo Mutuo</button>
            <a href="co-laboratorio.html" class="btn-lab btn-project"><i class="bi bi-arrow-right-circle-fill"></i> Conoce m谩s proyectos</a>
        </div>
    </div>

</div>

<!-- VISTA: JUEGO -->
<div id="view-board">
    <!-- HEADER FLOTANTE -->
    <div class="game-header">
        <div class="gh-info">
            <div class="gh-title" id="gh-title">Modo Juego</div>
            <div class="gh-subtitle" id="gh-subtitle">VS Stockfish</div>
        </div>
        <button class="btn-exit" onclick="App.goHome()"><i class="bi bi-x-lg"></i> Salir</button>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

    <div class="game-layout">
        <!-- BARRA ANLISIS -->
        <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
        
        <div class="board-container">
            <div id="board"></div>
        </div>

        <div class="game-info">
            <div class="coach-tags" id="coach-display">
                <span class="tag book">Listo</span>
            </div>

            <div class="controls">
                <button class="ctrl-btn" onclick="Game.undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="ctrl-btn" onclick="Game.redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="ctrl-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
                
                <button class="ctrl-btn sol hidden" id="btn-solution" title="Ver Soluci贸n" onclick="Game.showSolution()"><i class="bi bi-eye-fill"></i></button>
                <button class="ctrl-btn next hidden" id="btn-next" title="Siguiente" onclick="App.next()"><i class="bi bi-skip-forward-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TUTORIAL -->
<div id="modal-help" class="modal">
    <div class="modal-box">
        <h2>Gu铆a R谩pida</h2>
        <p>1. Descarga el pack de bases de datos.</p>
        <p>2. Carga los archivos para habilitar miles de ejercicios.</p>
        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="color:var(--accent);">Ir a Google Drive</a>
        <button class="close-modal" onclick="document.getElementById('modal-help').classList.remove('active')">Entendido</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
// --- DATOS BASE ---
const BaseOpenings = [
    {eco:"C50", name:"Italiana", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4"},
    {eco:"C60", name:"Ruy Lopez", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
    {eco:"B20", name:"Siciliana", pgn:"1. e4 c5"},
    {eco:"B01", name:"Escandinava", pgn:"1. e4 d5"},
    {eco:"C00", name:"Francesa", pgn:"1. e4 e6"},
    {eco:"B10", name:"Caro-Kann", pgn:"1. e4 c6"},
    {eco:"D00", name:"Pe贸n Dama", pgn:"1. d4 d5"},
    {eco:"D06", name:"Gambito Dama", pgn:"1. d4 d5 2. c4"},
    {eco:"A45", name:"Trompowsky", pgn:"1. d4 Nf6 2. Bg5"},
    {eco:"E60", name:"India de Rey", pgn:"1. d4 Nf6 2. c4 g6"},
    {eco:"A02", name:"Bird", pgn:"1. f4"},
    {eco:"A00", name:"Orangut谩n", pgn:"1. b4"},
    {eco:"C42", name:"Petrov", pgn:"1. e4 e5 2. Nf3 Nf6"},
    {eco:"C41", name:"Philidor", pgn:"1. e4 e5 2. Nf3 d6"},
    {eco:"C20", name:"Apertura de Rey", pgn:"1. e4 e5"},
    {eco:"B00", name:"Nimzowitsch", pgn:"1. e4 Nc6"},
    {eco:"A04", name:"Reti", pgn:"1. Nf3"},
    {eco:"A10", name:"Inglesa", pgn:"1. c4"},
    {eco:"C45", name:"Escocesa", pgn:"1. e4 e5 2. Nf3 Nc6 3. d4"},
    {eco:"C55", name:"Dos Caballos", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4 Nf6"}
];

const BaseTactics = {
    "800": [{id:"1", fen:"6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves:["Rd8#"], theme:"Mate Pasillo"}, {id:"2", fen:"r1bqkb1r/pppp1ppp/2n5/4P3/2B1n3/5Q2/PPP2PPP/RNB1K1NR w KQkq - 0 6", moves:["Qxf7#"], theme:"Pastor"}, {id:"3", fen:"8/8/8/8/8/5k2/8/6QK w - - 0 1", moves:["Qg2#"], theme:"Mate Dama"}, {id:"4", fen:"4k3/8/8/8/8/8/4N3/2K3r1 w - - 0 1", moves:["Nxg1"], theme:"Come Torre"}, {id:"5", fen:"rnbqkbnr/pppp1ppp/8/4p3/6P4/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 2", moves:["Qh4#"], theme:"Mate Loco"}],
    "1100": [{id:"6", fen:"k7/8/K7/8/8/8/1R6/7R w - - 0 1", moves:["Rh8#"], theme:"Escalera"}, {id:"7", fen:"7k/5N2/8/8/8/8/8/6RK w - - 0 1", moves:["Rh6#"], theme:"rabe"}, {id:"8", fen:"rnbqkbnr/pppp1ppp/2n5/4p3/3P4/5N2/PPP1PPPP/RNBQKB1R w KQkq - 0 1", moves:["dxe5"], theme:"Pe贸n gratis"}, {id:"9", fen:"rnbqkbnr/pppp1ppp/8/8/4p3/2N5/PPPPPPPP/R1BQKBNR w KQkq - 0 1", moves:["Nxe4"], theme:"Caballo"}, {id:"10", fen:"k7/P7/K7/8/8/8/8/8 w - - 0 1", moves:["Kb6"], theme:"Ahogado"}],
    "1400": [{id:"11", fen:"4k3/8/8/3N4/8/8/8/4K3 w - - 0 1", moves:["Nc7+","Kd8","Nxa8"], theme:"Horquilla"}, {id:"12", fen:"rnbqkb1r/pppppppp/5n2/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 1 2", moves:["e5"], theme:"Ataque"}, {id:"13", fen:"3r4/8/8/3R4/3K4/8/8/8 w - - 0 1", moves:["Rxd8"], theme:"Rayos X"}, {id:"14", fen:"r1b1k1nr/ppppqppp/2n5/2b5/2B1P3/2N2N2/PPPP1PPP/R1BQK2R w KQkq - 4 5", moves:["O-O"], theme:"Clavada"}, {id:"15", fen:"rnbqkbnr/pppp1ppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq - 0 1", moves:["e5"], theme:"Control"}],
    "1700": [{id:"16", fen:"rnbqkbnr/pp1ppppp/8/2p5/4P3/5N2/PPPP1PPP/RNBQKB1R b KQkq - 1 2", moves:["Nc6"], theme:"Siciliana"}, {id:"17", fen:"2r3k1/1p3ppp/p3p3/3pP3/P2P1P2/1Pq5/2r3PP/1R1Q1RK1 b - - 0 1", moves:["Rd2"], theme:"Invasi贸n"}, {id:"18", fen:"r5rk/5p1p/1p1p1P2/p2P1R2/7Q/8/P5PP/4q1BK w - - 0 1", moves:["Qxh7+","Kxh7","Rh5#"], theme:"Mate 3"}, {id:"19", fen:"7k/6p1/8/8/8/8/6R1/6BK w - - 0 1", moves:["Bd4"], theme:"Molino"}, {id:"20", fen:"r1bqkbnr/pppp1ppp/2n5/4p2Q/2B1P3/8/PPPP1PPP/RNB1K1NR w KQkq - 2 3", moves:["Qxf7#"], theme:"Pastor 2"}],
    "2000": [{id:"21", fen:"8/8/8/8/p7/P7/2k5/7K w - - 0 1", moves:["Kg1"], theme:"Zugzwang"}, {id:"22", fen:"8/8/8/8/8/8/4K3/4k3 w - - 0 1", moves:["Ke3"], theme:"Oposici贸n"}, {id:"23", fen:"7k/8/7K/8/8/8/8/Q7 w - - 0 1", moves:["Qa8#"], theme:"Mate Dama"}, {id:"24", fen:"8/8/8/5Q2/8/8/5K2/6qk w - - 0 1", moves:["Qh3+"], theme:"Tablas"}, {id:"25", fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", moves:["e4"], theme:"Best Move"}],
    "2300": [{id:"26", fen:"8/8/8/8/8/8/3k4/3Q4 b - - 0 1", moves:["Kxd1"], theme:"Simplificaci贸n"}, {id:"27", fen:"8/8/8/8/8/8/5K2/5k2 w - - 0 1", moves:["Kf3"], theme:"Opo Distante"}, {id:"28", fen:"rnbqk2r/pppp1ppp/5n2/2b1p3/2B1P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 4 4", moves:["O-O"], theme:"Giuoco Piano"}, {id:"29", fen:"r1bqkbnr/pppp1ppp/2n5/1B2p3/4P3/5N2/PPPP1PPP/RNBQK2R b KQkq - 3 3", moves:["Nf6"], theme:"Berlin"}, {id:"30", fen:"rnbqkb1r/pppp1ppp/5n2/4p3/4P3/2N5/PPPP1PPP/R1BQKBNR w KQkq - 2 3", moves:["f4"], theme:"Vienna"}],
    "2500": [{id:"31", fen:"rnbqkb1r/pppp1ppp/8/4p3/3Pn3/2N5/PPP2PPP/R1BQKBNR w KQkq - 0 4", moves:["Nxe4"], theme:"Stafford Refutation"}, {id:"32", fen:"r1bq1rk1/ppp2ppp/2n2n2/2bpp3/2B1P3/2NP1N2/PPP2PPP/R1BQ1RK1 w - - 0 7", moves:["Nxd5"], theme:"Central"}, {id:"33", fen:"r1bq1rk1/ppp1bppp/2n2n2/3pp3/3P4/2N1PN2/PPP1BPPP/R1BQ1RK1 w - - 0 7", moves:["dxe5"], theme:"Tensi贸n"}, {id:"34", fen:"2kr3r/ppp2ppp/2n5/2b1p3/4q3/2P5/PP1PQ1PP/RNB1K2R w KQ - 0 12", moves:["Qxe4"], theme:"Colgada GM"}, {id:"35", fen:"8/8/8/8/8/1k6/1P6/K7 w - - 0 1", moves:["Kb1"], theme:"Tablas Teor铆a"}]
};

// --- GESTIN DE ESTADO ---
let State = { mode: 'menu', openings: [], tactics: {}, game: new Chess(), board: null, engine: null, redoStack: [], currentLesson: { moves: [], index: 0 }, currentPuzzle: { moves: [], index: 0 }, lastScore: 0 };

// --- MOTOR ---
const Engine = {
    init: function() {
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');`], {type: 'application/javascript'});
        State.engine = new Worker(URL.createObjectURL(blob));
        State.engine.onmessage = this.onMessage;
        State.engine.postMessage('uci');
    },
    go: function(depth) {
        if(State.mode === 'tactics') return; 
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage(`go depth ${depth}`);
    },
    stop: function() { State.engine.postMessage('stop'); },
    onMessage: function(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) {
            State.game.move(msg.split(' ')[1], {sloppy:true});
            State.board.position(State.game.fen());
            Game.checkStatus(); // CHECAR SI TERMIN DESPUS DE IA
            Engine.analyze();
        }
        if(msg.includes('score cp')) {
            const m = msg.match(/score cp (-?\d+)/);
            if(m) {
                let score = parseInt(m[1]);
                if(State.game.turn() === 'b') score = -score;
                // FRMULA SIGMOIDE SUAVIZADA
                let evalPerc = 100 / (1 + Math.exp(-0.003 * score));
                evalPerc = Math.max(2, Math.min(98, evalPerc));
                $('#eval-fill').css('width', evalPerc + '%');
                if(State.mode !== 'tactics') UI.updateCoach(score);
            }
        }
        if(msg.includes('score mate')) {
             const m = msg.match(/score mate (-?\d+)/);
             if(m) {
                 let mate = parseInt(m[1]);
                 if(State.game.turn() === 'b') mate = -mate;
                 let evalPerc = mate > 0 ? 100 : 0;
                 $('#eval-fill').css('width', evalPerc + '%');
             }
        }
    },
    analyze: function() {
        State.engine.postMessage('stop');
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage('go depth 10');
    }
};

// --- LGICA JUEGO ---
const Game = {
    checkStatus: function() {
        if(State.game.in_checkmate()) {
            let winner = State.game.turn() === 'w' ? 'Negras' : 'Blancas';
            UI.feedback("隆Jaque Mate!", "success");
            $('#coach-display').html(`<span class="tag end"> Ganan ${winner}</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        if(State.game.in_draw() || State.game.in_stalemate() || State.game.in_threefold_repetition()) {
            UI.feedback("隆Tablas!", "warn");
            $('#coach-display').html(`<span class="tag end">陆 - 陆 Tablas</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        return false;
    },
    onDragStart: function(s, p) {
        if(State.game.game_over()) return false;
        if(State.mode === 'opening') return false; 
        if(State.mode === 'play') {
            const myColor = $('#cfg-play-color').val();
            if((myColor==='w' && p.startsWith('b')) || (myColor==='b' && p.startsWith('w'))) return false;
        }
        if(State.mode === 'tactics') {
            if((State.game.turn()==='w' && p.startsWith('b')) || (State.game.turn()==='b' && p.startsWith('w'))) return false;
        }
        return true;
    },
    onDrop: function(s, t) {
        if(State.mode === 'tactics') {
            const temp = new Chess(State.game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'});
            if(m) {
                // TACTICA: Compara con index 1 (tu respuesta)
                const correct = State.currentPuzzle.moves[State.currentPuzzle.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    State.game.move({from:s, to:t, promotion:'q'});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++; 
                    UI.feedback("隆Bien!", "success");
                    
                    // Respuesta Rival
                    if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                        setTimeout(() => {
                            State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                            State.board.position(State.game.fen());
                            State.currentPuzzle.index++; 
                        }, 500);
                    } else {
                        UI.feedback("隆Resuelto!", "success");
                    }
                    return;
                }
            }
            UI.feedback("Incorrecto", "error");
            return 'snapback';
        }

        if(State.mode === 'play') {
            const m = State.game.move({from:s, to:t, promotion:'q'});
            if(!m) return 'snapback';
            State.board.position(State.game.fen());
            State.redoStack = [];
            
            if(Game.checkStatus()) return; 

            setTimeout(() => {
                const lvl = parseInt($('#cfg-play-level').val());
                let depth = 5; if(lvl > 5) depth = 10; if(lvl > 15) depth = 15;
                State.engine.postMessage(`setoption name Skill Level value ${lvl}`);
                Engine.go(depth);
            }, 250);
        }
    },
    undo: function() {
        if(State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) return; 
        if(State.mode === 'opening') {
            State.game.undo(); State.board.position(State.game.fen());
            if(State.currentLesson.index > 0) State.currentLesson.index--;
            Engine.analyze();
            return;
        }
        let m = State.game.undo();
        if(m) {
            State.redoStack.push(m);
            if(State.mode === 'play') { let m2 = State.game.undo(); if(m2) State.redoStack.push(m2); }
            State.board.position(State.game.fen());
            Engine.analyze();
        }
    },
    redo: function() {
        if(State.mode === 'opening') {
            if(State.currentLesson.index < State.currentLesson.moves.length) {
                State.game.move(State.currentLesson.moves[State.currentLesson.index]);
                State.board.position(State.game.fen());
                State.currentLesson.index++;
                Engine.analyze();
            }
            return;
        }
        if(State.redoStack.length > 0) {
            let m = State.redoStack.pop();
            State.game.move(m);
            State.board.position(State.game.fen());
            if(State.mode === 'play' && State.redoStack.length > 0) {
                State.game.move(State.redoStack.pop());
                State.board.position(State.game.fen());
            }
            Engine.analyze();
        }
    },
    showSolution: function() {
        if(State.mode !== 'tactics') return;
        const move = State.currentPuzzle.moves[State.currentPuzzle.index];
        if(move) {
            State.game.move(move, {sloppy:true});
            State.board.position(State.game.fen());
            State.currentPuzzle.index++;
            if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                setTimeout(() => {
                    State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++;
                }, 500);
            }
        }
    }
};

// --- APP CONTROLLER ---
const App = {
    init: function() {
        State.openings = JSON.parse(JSON.stringify(BaseOpenings));
        State.tactics = JSON.parse(JSON.stringify(BaseTactics));
        DB.loadFromMemory();
        
        State.board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: Game.onDragStart,
            onDrop: Game.onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        
        Engine.init();
        UI.refreshSelects();
    },
    goHome: function() {
        $('#view-board').removeClass('active');
        $('#view-home').show();
        State.mode = 'menu';
        State.engine.postMessage('stop');
    },
    enterBoard: function(mode) {
        State.mode = mode;
        $('#view-home').hide();
        $('#view-board').addClass('active');
        setTimeout(() => State.board.resize(), 100);
        $('#btn-solution').addClass('hidden');
        $('#btn-next').addClass('hidden');
    },
    next: function() {
        if(State.mode === 'tactics') this.startTactics();
        if(State.mode === 'opening') {
            let currentIdx = parseInt($('#cfg-opening-select').val()) || 0;
            let nextIdx = (currentIdx + 1) % State.openings.length;
            $('#cfg-opening-select').val(nextIdx);
            this.startOpening();
        }
    },
    startPlay: function() {
        this.enterBoard('play');
        State.game.reset(); State.board.start(); State.redoStack = [];
        const color = $('#cfg-play-color').val();
        State.board.orientation(color === 'w' ? 'white' : 'black');
        
        $('#gh-title').text("Partida vs Stockfish");
        $('#gh-subtitle').text("Nivel: " + $('#cfg-play-level option:selected').text());
        $('#coach-display').html('<span class="tag book">Nueva Partida</span>');
        
        if(color === 'b') setTimeout(() => Engine.go(5), 500);
        else Engine.analyze();
    },
    startOpening: function() {
        const idx = $('#cfg-opening-select').val();
        if(idx === "") return alert("Selecciona una apertura");
        
        const op = State.openings[idx];
        this.enterBoard('opening');
        State.game.reset(); State.board.start(); State.board.orientation('white');
        
        const clean = op.pgn.replace(/\d+\./g,'').replace(/\*/g,'').split(/\s+/).filter(x => x);
        State.currentLesson = { moves: clean, index: 0 };
        
        $('#gh-title').text(op.name);
        $('#gh-subtitle').text(`ECO: ${op.eco}`);
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Estudiando</span>`);
        Engine.analyze();
    },
    startTactics: function() {
        const elo = $('#cfg-tactics-elo').val();
        const puzzles = State.tactics[elo] || [];
        if(puzzles.length === 0) return alert("No hay puzzles de este nivel.");
        
        const p = puzzles[Math.floor(Math.random() * puzzles.length)];
        this.enterBoard('tactics');
        
        // 1. Cargar FEN
        State.game.load(p.fen);
        
        // 2. JUGAR MOVIMIENTO DEL RIVAL (Index 0)
        if(p.moves && p.moves.length > 0) {
            State.game.move(p.moves[0], {sloppy:true});
        }
        
        // 3. Orientar al jugador
        State.board.position(State.game.fen());
        const userColor = State.game.turn() === 'w' ? 'white' : 'black';
        State.board.orientation(userColor);
        
        // 4. Esperar respuesta (Index 1)
        State.currentPuzzle = { moves: p.moves, index: 1 };
        
        $('#gh-title').text(`T谩ctica [${elo}]`);
        $('#gh-subtitle').text(p.theme ? `Tema: ${p.theme}` : `ID: ${p.id}`);
        $('#btn-solution').removeClass('hidden');
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Juegan ${userColor==='white'?'Blancas':'Negras'}</span>`);
    }
};

const UI = {
    refreshSelects: function() {
        const s = $('#cfg-opening-select').empty().append('<option value="">-- Selecciona --</option>');
        State.openings.forEach((o, i) => s.append(new Option(`[${o.eco}] ${o.name}`, i)));
        $('#lbl-opening-count').text(State.openings.length);
        let totalP = 0;
        Object.values(State.tactics).forEach(arr => totalP += arr.length);
        $('#lbl-tactics-count').text(totalP);
    },
    feedback: function(msg, type) {
        const el = $('#feedback');
        el.text(msg).removeClass('success error').addClass('show ' + type);
        setTimeout(() => el.removeClass('show'), 1000);
    },
    updateCoach: function(score) {
        let delta = score - State.lastScore;
        if(State.game.turn() === 'w') delta = -delta; 
        let tag = "";
        if(delta < -200) tag = "<span class='tag bad'>Error Grave</span>";
        else if(delta < -80) tag = "<span class='tag bad'>Error</span>";
        else if(delta < -30) tag = "<span class='tag warn'>Imprecisi贸n</span>";
        else if(delta > 30) tag = "<span class='tag good'>Buena</span>";
        else tag = "<span class='tag book'>Normal</span>";
        $('#coach-display').html(tag);
        State.lastScore = score;
    },
    updateEval: function(score) {
        let p = 100 / (1 + Math.exp(-0.003 * score));
        if(State.game.turn() === 'b') p = 100 - p;
        p = Math.max(2, Math.min(98, p));
        $('#eval-fill').css('width', p + '%');
    }
};

const DB = {
    loadOpenings: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); let c = 0;
            lines.forEach(l => {
                const p = l.split('\t');
                if(p.length >= 3) {
                    State.openings.push({eco:p[0], name:p[1], pgn:p[p.length-1].trim()});
                    c++;
                }
            });
            Storage.save(); UI.refreshSelects(); alert(`+${c} Aperturas`);
        };
        reader.readAsText(file);
    },
    loadTactics: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); let c = 0; const isComma = lines[0].includes(',');
            
            const MAX_PUZZLES = 20000;
            let currentTotal = 0;
            Object.values(State.tactics).forEach(arr => currentTotal += arr.length);
            if(currentTotal >= MAX_PUZZLES) return alert("L铆mite de 20,000 ejercicios alcanzado.");

            for(let i=0; i < lines.length; i++) {
                if(currentTotal >= MAX_PUZZLES) break;
                if(!lines[i]) continue;
                const cols = lines[i].split(isComma ? ',' : '\t');
                if(cols.length > 3) {
                    const r = parseInt(cols[3]);
                    if(!isNaN(r)) {
                        let k = "800";
                        if(r >= 2500) k = "2500";
                        else if(r >= 2300) k = "2300";
                        else if(r >= 2000) k = "2000";
                        else if(r >= 1700) k = "1700";
                        else if(r >= 1400) k = "1400";
                        else if(r >= 1100) k = "1100";
                        
                        if(!State.tactics[k]) State.tactics[k] = [];
                        let th = cols[7] ? cols[7].trim() : "";
                        State.tactics[k].push({id:cols[0], fen:cols[1], moves:cols[2].split(' '), theme: th});
                        c++; currentTotal++;
                    }
                }
            }
            Storage.save(); UI.refreshSelects(); alert(`+${c} Puzzles`);
        };
        reader.readAsText(file);
    },
    loadFromMemory: function() {
        const op = localStorage.getItem('ad_openings');
        const tac = localStorage.getItem('ad_tactics');
        if(op) State.openings = JSON.parse(op);
        if(tac) State.tactics = JSON.parse(tac);
    }
};

const Storage = {
    save: function() {
        try {
            localStorage.setItem('ad_openings', JSON.stringify(State.openings));
            localStorage.setItem('ad_tactics', JSON.stringify(State.tactics));
        } catch(e) { alert("Memoria llena."); }
    },
    clear: function() { localStorage.clear(); location.reload(); }
};

$(document).ready(function() { App.init(); });
</script>
</body>
</html>
