<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alter.Drez - Plataforma Completa</title>

    <!-- FUENTES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ESTILOS TABLERO -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS GENERALES Y TEMA DARK --- */
        :root {
            --bg-color: #0F121B;
            --panel-bg: rgba(22, 26, 38, 0.9);
            --text-color: #FFFFFF;
            --accent-color: #4db8ff; /* Azul neón */
            --danger-color: #ff4d4d;
            --highlight-selected: rgba(77, 184, 255, 0.6);
            --highlight-move: rgba(170, 215, 166, 0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            /* Fondo degradado elegante */
            background: radial-gradient(circle at 50% 30%, #1b2030 0%, #000000 100%);
            min-height: 100vh;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chess-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(77, 184, 255, 0.3);
        }

        .chess-layout {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            width: 100%;
            flex-wrap: wrap;
        }

        /* --- TABLERO (MAGIA PARA MÓVIL) --- */
        .board-container {
            /* Sombra para que destaque */
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            border-radius: 4px;
            overflow: hidden;
        }

        .board {
            width: 90vw;
            max-width: 600px;
            /* PROHIBIDO EL SCROLL EN EL TABLERO */
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- PANELES DE CONTROL --- */
        .controls-sidebar {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background-color: var(--panel-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 20px;
            backdrop-filter: blur(5px);
        }

        .panel h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--accent-color);
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
            letter-spacing: 1px;
        }

        /* --- STATUS E INDICADORES --- */
        .status-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .turn-indicator { font-size: 0.9rem; color: #ccc; }
        
        .thinking {
            color: var(--accent-color);
            font-style: italic;
            font-size: 0.9rem;
            display: none; /* Se activa con JS */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- BARRA DE EVALUACIÓN --- */
        .eval-container {
            height: 8px;
            width: 100%;
            background: #444;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            display: flex;
        }
        .eval-bar {
            height: 100%;
            background: #fff;
            width: 50%; /* Empieza al medio */
            transition: width 0.8s ease, background-color 0.3s;
        }
        .eval-text { font-size: 0.9rem; line-height: 1.4; color: #d1d1d1; }
        .eval-score { color: var(--accent-color); font-weight: bold; }

        /* --- BOTONES Y FORMULARIOS --- */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        
        button {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--accent-color);
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: 0.3s;
        }
        button:hover { background: var(--accent-color); color: #000; }
        
        select {
            width: 100%;
            padding: 8px;
            background: #1a1e2e;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            font-family: inherit;
        }

        /* --- CLASES VISUALES PARA EL TABLERO --- */
        .highlight-selected { box-shadow: inset 0 0 3px 3px var(--highlight-selected) !important; }
        .highlight-move { box-shadow: inset 0 0 3px 3px var(--highlight-move) !important; }
        
        /* PGN Scroll */
        #pgn { font-family: monospace; font-size: 0.85rem; color: #aaa; max-height: 80px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; margin-top: 5px; }

    </style>
</head>
<body>

    <div class="container">
        <h1 class="chess-title">Alter.Drez</h1>

        <div class="chess-layout">
            <!-- TABLERO -->
            <div class="board-container">
                <div id="chessBoard" class="board"></div>
            </div>

            <!-- CONTROLES -->
            <div class="controls-sidebar">
                
                <!-- Panel 1: Estado -->
                <div class="panel">
                    <h3>Estado del Juego</h3>
                    <div class="status-text" id="status">Cargando motor...</div>
                    <div class="turn-indicator" id="fenStatus">Juegan blancas</div>
                    <div class="thinking" id="thinkingIndicator">Stockfish está calculando...</div>
                </div>

                <!-- Panel 2: Análisis IA -->
                <div class="panel">
                    <h3>Análisis en Vivo</h3>
                    <div class="eval-container">
                        <div id="evalBar" class="eval-bar"></div>
                    </div>
                    <div class="eval-text" id="analysisText">
                        Haz tu primer movimiento para ver el análisis.
                    </div>
                </div>

                <!-- Panel 3: Configuración -->
                <div class="panel">
                    <h3>Configuración</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 0.8rem; color:#aaa;">Nivel de la IA</label>
                        <select id="skillLevel">
                            <option value="0">Nivel 0 (Principiante - 800)</option>
                            <option value="5">Nivel 5 (Intermedio - 1400)</option>
                            <option value="10">Nivel 10 (Avanzado - 1800)</option>
                            <option value="15">Nivel 15 (Experto - 2200)</option>
                            <option value="20" selected>Nivel 20 (Gran Maestro - 3000+)</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="startBtn">Nueva Partida</button>
                        <button id="undoBtn">Deshacer</button>
                    </div>
                </div>
                
                <!-- Panel 4: Historial -->
                <div class="panel">
                    <h3>Historial (PGN)</h3>
                    <div id="pgn"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- SCRIPTS NECESARIOS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- 1. VARIABLES GLOBALES ---
        const game = new Chess();
        let board = null;
        let engine = null;
        let isEngineThinking = false;
        let selectedSquare = null; // Para Click-to-move
        let playerColor = 'w';     // Humano siempre blancas en este modo

        // UI Elements
        const statusEl = document.getElementById('status');
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        const analysisTextEl = document.getElementById('analysisText');
        const evalBarEl = document.getElementById('evalBar');
        const pgnEl = document.getElementById('pgn');

        // --- 2. INICIALIZAR STOCKFISH (Via Blob/CDN) ---
        function initStockfish() {
            fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
                .then(res => res.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    engine = new Worker(url);
                    
                    // Escuchar mensajes del motor
                    engine.onmessage = (event) => {
                        handleEngineMessage(event.data);
                    };
                    
                    engine.postMessage('uci');
                    updateStatusDisplay("Motor Listo. ¡Tu turno!", false);
                })
                .catch(err => {
                    console.error(err);
                    updateStatusDisplay("Error cargando Stockfish.", false);
                });
        }

        // --- 3. MANEJO DE MENSAJES DEL MOTOR ---
        function handleEngineMessage(msg) {
            // A) LA IA MUEVE
            if (msg.startsWith('bestmove')) {
                const moveData = msg.split(' ');
                const bestMove = moveData[1];
                
                game.move(bestMove, { sloppy: true });
                board.position(game.fen());
                
                // Fin del pensamiento
                isEngineThinking = false;
                thinkingIndicator.style.display = 'none';
                
                updateGameState();
                
                // Pedir análisis de la posición final
                requestAnalysis();
            }
            
            // B) ANÁLISIS (INFO)
            // Filtramos solo cuando hay score y depth decente para no parpadear
            if (msg.startsWith('info') && msg.includes('score')) {
                const scoreMatch = msg.match(/score (cp|mate) (-?\d+)/);
                if (scoreMatch) {
                    const type = scoreMatch[1];
                    let value = parseInt(scoreMatch[2]);
                    
                    // Stockfish da score desde el punto de vista del que mueve.
                    // Para la UI, normalizamos a: Positivo = Ventaja Blanca.
                    if (game.turn() === 'b') {
                        value = -value;
                    }
                    
                    renderAnalysis(type, value);
                }
            }
        }

        // --- 4. RENDERIZADO DEL ANÁLISIS (BARRA + TEXTO) ---
        function renderAnalysis(type, value) {
            let percent = 50;
            let text = "";
            let color = "";

            if (type === 'mate') {
                // Si es mate, la barra se llena o vacía por completo
                percent = value > 0 ? 100 : 0;
                text = `Mate en ${Math.abs(value)}`;
                color = value > 0 ? "#4db8ff" : "#ff4d4d";
            } else {
                // CP (Centipeones)
                // Limitamos visualmente entre -5 y +5 peones ( -500 a 500 cp)
                const clamped = Math.max(-500, Math.min(500, value));
                // Convertir rango -500..500 a 0..100%
                percent = 50 + (clamped / 10);
                
                const score = (value / 100).toFixed(2);
                const sign = value > 0 ? "+" : "";
                
                // Generar explicación
                let explanation = "Posición igualada.";
                if (value > 100) explanation = "Ventaja blanca.";
                if (value > 300) explanation = "Blanco ganando.";
                if (value < -100) explanation = "Ventaja negra.";
                if (value < -300) explanation = "Negro ganando.";

                text = `<span class="eval-score">${sign}${score}</span> - ${explanation}`;
                
                if (value > 50) color = "#fff"; // Blanco va ganando
                else if (value < -50) color = "#555"; // Negro va ganando
                else color = "#888"; // Tablas
            }

            evalBarEl.style.width = `${percent}%`;
            evalBarEl.style.backgroundColor = color;
            analysisTextEl.innerHTML = text;
        }

        // --- 5. LÓGICA DE JUEGO (HUMANO) ---

        // Función A: Arrastrar (PC)
        function onDragStart(source, piece) {
            if (game.game_over() || isEngineThinking) return false;
            if (piece.search(/^b/) !== -1) return false; // Solo mover blancas

            // Al empezar a arrastrar, seleccionamos visualmente
            removeHighlights();
            selectedSquare = source;
            highlightSquare(source, 'highlight-selected');
        }

        function onDrop(source, target) {
            removeHighlights();
            selectedSquare = null;

            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            updateGameState();
            triggerEngine();
        }

        // Función B: Tocar (Móvil / Click)
        function initClickInput() {
            $('#chessBoard').on('click', '.square-55d63', function() {
                if (isEngineThinking || game.game_over()) return;

                const square = $(this).attr('data-square');
                const piece = game.get(square);
                
                // 1. Si ya elegí origen, intento mover al destino
                if (selectedSquare) {
                    const move = game.move({
                        from: selectedSquare,
                        to: square,
                        promotion: 'q'
                    });

                    if (move !== null) {
                        // Movimiento válido
                        board.position(game.fen());
                        removeHighlights();
                        selectedSquare = null;
                        updateGameState();
                        triggerEngine();
                    } else {
                        // Movimiento inválido. 
                        // Si clicó en otra pieza propia, cambiamos selección
                        if (piece && piece.color === playerColor) {
                            removeHighlights();
                            selectedSquare = square;
                            highlightSquare(square, 'highlight-selected');
                        } else {
                            // Clic en vacío o enemigo sin poder comer: cancelar
                            removeHighlights();
                            selectedSquare = null;
                        }
                    }
                } 
                // 2. Primer clic (Selección)
                else {
                    if (piece && piece.color === playerColor) {
                        selectedSquare = square;
                        highlightSquare(square, 'highlight-selected');
                    }
                }
            });
        }

        // --- 6. COMUNICACIÓN CON IA ---

        function triggerEngine() {
            if (game.game_over()) return;

            isEngineThinking = true;
            thinkingIndicator.style.display = 'block';
            updateStatusDisplay("Esperando a la IA...", false);
            
            const skill = document.getElementById('skillLevel').value;
            // Ajustar profundidad según nivel (Nivel 20 = depth 15-18 para web)
            let depth = 5;
            if (skill >= 5) depth = 8;
            if (skill >= 10) depth = 12;
            if (skill >= 15) depth = 15;
            if (skill >= 20) depth = 16; 

            // Pequeño delay para que se sienta natural
            setTimeout(() => {
                engine.postMessage(`setoption name Skill Level value ${skill}`);
                engine.postMessage(`position fen ${game.fen()}`);
                engine.postMessage(`go depth ${depth}`);
            }, 300);
        }

        function requestAnalysis() {
            // Análisis rápido pasivo (sin jugar)
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage('go depth 10');
        }

        // --- 7. UTILIDADES UI ---

        function updateGameState() {
            updateStatusDisplay();
            pgnEl.textContent = game.pgn();
        }

        function updateStatusDisplay(customMsg = null, isCheckCheck = true) {
            let status = customMsg;
            
            if (!status) {
                if (game.in_checkmate()) status = "Jaque Mate. Fin del juego.";
                else if (game.in_draw()) status = "Tablas. Empate.";
                else {
                    status = (game.turn() === 'w') ? "Tu turno (Blancas)" : "Turno de IA (Negras)";
                    if (isCheckCheck && game.in_check()) status += " ¡JAQUE!";
                }
            }
            statusEl.textContent = status;
        }

        function highlightSquare(square, cssClass) {
            $('#chessBoard .square-' + square).addClass(cssClass);
        }

        function removeHighlights() {
            $('#chessBoard .square-55d63').removeClass('highlight-selected');
            $('#chessBoard .square-55d63').removeClass('highlight-move');
        }

        // --- 8. CONFIGURACIÓN E INICIO ---

        const config = {
            draggable: true, 
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            // Piezas SVG de Wikipedia (alta calidad y sin archivos locales)
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };

        board = Chessboard('chessBoard', config);
        
        // Handlers de botones
        document.getElementById('startBtn').addEventListener('click', () => {
            game.reset();
            board.start();
            removeHighlights();
            selectedSquare = null;
            isEngineThinking = false;
            thinkingIndicator.style.display = 'none';
            evalBarEl.style.width = "50%";
            analysisTextEl.textContent = "Nueva partida.";
            updateStatusDisplay("¡Nueva partida! Juegan blancas.");
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (isEngineThinking) return;
            // Deshacer IA y Humano
            game.undo(); 
            game.undo();
            board.position(game.fen());
            removeHighlights();
            selectedSquare = null;
            updateGameState();
            requestAnalysis();
        });

        // Responsividad
        window.addEventListener('resize', board.resize);

        // INICIAR TODO
        initStockfish();
        initClickInput(); // Activar sistema táctil
    });
    </script>
</body>
</html>
