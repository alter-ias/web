<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Academia</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS (Optimizados) --- */
        :root {
            --bg: #0F121B;
            --panel: #1A1E29;
            --accent: #4db8ff;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        header { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); text-align: center; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 1.6rem; letter-spacing: 2px; font-weight: 800; color: var(--accent); }

        .main-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
            width: 100%; max-width: 1300px; padding: 20px;
        }

        /* TABLERO */
        .board-section { flex: 1; min-width: 300px; max-width: 600px; }
        .board-container {
            width: 100%; touch-action: none;
            border: 5px solid #222; border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Notificaciones sobre el tablero (Feedback de lección) */
        .lesson-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: #fff; padding: 15px 25px; border-radius: 8px;
            text-align: center; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 10; border: 1px solid var(--accent);
        }
        .lesson-feedback.show { opacity: 1; }
        .lesson-feedback.error { border-color: var(--error); color: var(--error); }
        .lesson-feedback.success { border-color: var(--success); color: var(--success); }

        .eval-bar-wrapper { height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 5px; }
        .eval-fill { height: 100%; width: 50%; background: #fff; transition: width 0.5s ease, background 0.3s; }

        /* PANELES */
        .sidebar { flex: 1; min-width: 300px; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 10px; padding: 15px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 0.8rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* ENTRENADOR */
        .coach-msg { font-size: 0.9rem; line-height: 1.4; color: #fff; margin-bottom: 10px; min-height: 40px; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; }
        .tag.good { background: rgba(0,230,118,0.1); color: var(--success); border-color: var(--success); }
        .tag.bad { background: rgba(255,23,68,0.1); color: var(--error); border-color: var(--error); }
        .tag.info { background: rgba(77,184,255,0.1); color: var(--accent); border-color: var(--accent); }

        /* FORMULARIOS */
        select, button {
            width: 100%; padding: 10px; background: #252a36; border: 1px solid #444; color: #fff;
            border-radius: 5px; font-family: inherit; margin-bottom: 10px; cursor: pointer;
        }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }
        
        .btn-row { display: flex; gap: 10px; }
        .hidden { display: none; }

        /* Indicador de turno en lección */
        .lesson-status { font-size: 0.9rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Alter.Drez <i class="bi bi-book-half"></i></h1>
</header>

<div class="main-container">
    
    <!-- IZQUIERDA: TABLERO -->
    <div class="board-section">
        <div class="eval-bar-wrapper">
            <div id="evalFill" class="eval-fill"></div>
        </div>
        
        <div class="board-container">
            <div id="board"></div>
            <!-- Feedback flotante para lecciones -->
            <div id="lessonFeedback" class="lesson-feedback"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.85rem; color:#aaa;">
            <span id="statusText">Esperando...</span>
            <span id="thinkingIndicator" style="display:none; color:var(--accent);">IA Pensando...</span>
        </div>
    </div>

    <!-- DERECHA: CONTROLES -->
    <div class="sidebar">

        <!-- 1. MÓDULO DE LECCIONES -->
        <div class="panel" style="border-left: 3px solid var(--success);">
            <h3><i class="bi bi-mortarboard"></i> Aprender Aperturas</h3>
            
            <div id="lessonControls">
                <select id="openingCategory">
                    <option value="all">Todas las Categorías</option>
                    <option value="open">Juegos Abiertos (1. e4 e5)</option>
                    <option value="semi">Semi-Abiertos (1. e4 ...)</option>
                    <option value="closed">Juegos Cerrados (1. d4 ...)</option>
                </select>
                
                <select id="openingSelect">
                    <option value="">-- Selecciona una Apertura --</option>
                </select>
                
                <div id="lessonActiveUI" class="hidden">
                    <div class="lesson-status" id="lessonInstruction">Tu turno...</div>
                    <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="background: #333; border-color: #555;">Salir de la Lección</button>
                </div>
            </div>
        </div>

        <!-- 2. ENTRENADOR (Solo visible en juego libre) -->
        <div class="panel" id="coachPanel">
            <h3><i class="bi bi-robot"></i> Entrenador Virtual</h3>
            <div class="coach-msg" id="coachMsg">Juega libremente o selecciona una lección.</div>
            <div class="coach-tags" id="coachTags"></div>
        </div>

        <!-- 3. CONFIGURACIÓN JUEGO LIBRE -->
        <div class="panel">
            <h3>Juego Libre / Análisis</h3>
            <div class="btn-row">
                <select id="gameMode">
                    <option value="pvc">Jugar vs IA</option>
                    <option value="analysis">Análisis Libre</option>
                </select>
                <select id="playerColor">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
            </div>
            <div class="btn-row">
                <button id="btnNewGame">Nueva Partida</button>
                <button id="btnUndo"><i class="bi bi-arrow-left"></i></button>
                <button id="btnRedo"><i class="bi bi-arrow-right"></i></button>
            </div>
            <button id="btnFlip">Girar Tablero</button>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- DATOS DE APERTURAS (BASE DE DATOS) ---
    const openingsDB = [
        { 
            id: "ruy_lopez", 
            name: "Ruy López (Española)", 
            cat: "open", 
            moves: ["e4", "e5", "Nf3", "Nc6", "Bb5"], 
            desc: "Una de las aperturas más antiguas. Las blancas desarrollan el alfil para presionar al caballo que defiende el centro." 
        },
        { 
            id: "italian", 
            name: "Apertura Italiana", 
            cat: "open", 
            moves: ["e4", "e5", "Nf3", "Nc6", "Bc4"], 
            desc: "Apunta directamente al punto débil f7. Busca un desarrollo rápido y control central." 
        },
        { 
            id: "sicilian", 
            name: "Defensa Siciliana", 
            cat: "semi", 
            moves: ["e4", "c5", "Nf3", "d6", "d4", "cxd4", "Nxd4", "Nf6", "Nc3"], 
            desc: "La respuesta más combativa contra e4. Las negras luchan por el centro desde el flanco c." 
        },
        { 
            id: "french", 
            name: "Defensa Francesa", 
            cat: "semi", 
            moves: ["e4", "e6", "d4", "d5"], 
            desc: "Sólida y resistente. Las negras ceden espacio al inicio para contraatacar la cadena de peones después." 
        },
        { 
            id: "caro_kann", 
            name: "Defensa Caro-Kann", 
            cat: "semi", 
            moves: ["e4", "c6", "d4", "d5"], 
            desc: "Similar a la Francesa pero permite sacar el alfil de casillas blancas antes de cerrar la cadena." 
        },
        { 
            id: "scandinavian", 
            name: "Defensa Escandinava", 
            cat: "semi", 
            moves: ["e4", "d5", "exd5", "Qxd5"], 
            desc: "Desafía el centro inmediatamente. Saca la dama pronto, lo cual es arriesgado pero dinámico." 
        },
        { 
            id: "queens_gambit", 
            name: "Gambito de Dama", 
            cat: "closed", 
            moves: ["d4", "d5", "c4"], 
            desc: "Ofrece un peón lateral (c4) para desviar al peón central negro y dominar el centro." 
        },
        { 
            id: "kings_indian", 
            name: "Defensa India de Rey", 
            cat: "closed", 
            moves: ["d4", "Nf6", "c4", "g6", "Nc3", "Bg7", "e4", "d6"], 
            desc: "Hipermoderna. Las negras permiten a las blancas ocupar el centro para luego atacarlo a distancia." 
        },
        { 
            id: "london", 
            name: "Sistema Londres", 
            cat: "closed", 
            moves: ["d4", "d5", "Bf4", "Nf6", "e3", "e6", "Nf3"], 
            desc: "Un sistema sólido y universal para las blancas donde el desarrollo de piezas es prioritario." 
        }
    ];

    // --- VARIABLES GLOBALES ---
    const game = new Chess();
    let board = null;
    let engine = null;
    let redoStack = [];
    
    // Estados
    let currentMode = 'pvc'; // 'pvc', 'analysis', 'lesson'
    let lessonState = { active: false, moves: [], index: 0, currentOpening: null };
    let isEnginePlaying = false; // Bloqueo mientras piensa

    // --- MÓDULO DE LECCIONES ---
    const LessonSystem = {
        start: function(openingId) {
            const opening = openingsDB.find(op => op.id === openingId);
            if (!opening) return;

            // Configurar estado
            lessonState = {
                active: true,
                moves: opening.moves, // Array de movimientos SAN ['e4', 'e5'...]
                index: 0,
                currentOpening: opening
            };
            currentMode = 'lesson';
            
            // UI
            $('#lessonActiveUI').removeClass('hidden');
            $('#openingSelect').val(''); // Reset selector
            $('#lessonDescription').text(opening.desc);
            
            // Reset Tablero
            game.reset();
            board.position('start');
            board.orientation('white'); // Por defecto empezamos estudiando blancas (se puede mejorar)
            
            this.nextStep();
        },

        nextStep: function() {
            if (lessonState.index >= lessonState.moves.length) {
                this.finish();
                return;
            }

            const nextMoveSan = lessonState.moves[lessonState.index];
            const turnColor = game.turn() === 'w' ? 'Blancas' : 'Negras';
            
            // Decidir si juega el usuario o la "IA" (script)
            // En este modo, el usuario siempre juega el turno actual para aprender
            // O podemos hacerlo automático si es respuesta.
            // MEJOR UX: El usuario juega TODO para memorizar ambos lados, 
            // O juega el bando "protagonista". Vamos a hacer que el usuario juegue el turno que toca.
            
            $('#lessonInstruction').html(`<span style="color:var(--accent)">${turnColor}:</span> Juega <b>${nextMoveSan}</b>`);
            $('#statusText').text("Modo Lección Activo");
        },

        checkMove: function(moveObj) {
            const expectedSan = lessonState.moves[lessonState.index];
            
            // Comprobamos si el movimiento realizado coincide con el esperado
            if (moveObj.san === expectedSan) {
                // CORRECTO
                this.showFeedback("¡Correcto!", "success");
                lessonState.index++;
                
                // Si la lección sigue
                if (lessonState.index < lessonState.moves.length) {
                    // Opción: Auto-jugar respuesta del rival para fluidez
                    // Si el usuario acaba de mover blancas, hacemos que negras muevan solas rápido
                    setTimeout(() => {
                        this.playAutoMove();
                    }, 500);
                } else {
                    this.finish();
                }
                return true;
            } else {
                // INCORRECTO
                this.showFeedback(`Incorrecto. La línea es ${expectedSan}`, "error");
                return false; // Esto hará snapback
            }
        },

        playAutoMove: function() {
            if (!lessonState.active || lessonState.index >= lessonState.moves.length) return;
            
            const moveSan = lessonState.moves[lessonState.index];
            game.move(moveSan);
            board.position(game.fen());
            lessonState.index++;
            
            if (lessonState.index < lessonState.moves.length) {
                this.nextStep(); // Pedir al usuario el siguiente
            } else {
                this.finish();
            }
        },

        finish: function() {
            $('#lessonInstruction').html(`<span style="color:#00e676">¡Lección Completada!</span>`);
            this.showFeedback("¡Muy bien! Línea aprendida.", "success");
            // Dejar en modo análisis para que explore
            currentMode = 'analysis';
            $('#statusText').text("Ahora puedes explorar variantes libremente.");
        },

        stop: function() {
            lessonState.active = false;
            $('#lessonActiveUI').addClass('hidden');
            currentMode = 'analysis'; // Volver a modo seguro
            $('#statusText').text("Lección cancelada.");
        },

        showFeedback: function(text, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(text).removeClass('success error').addClass('show ' + type);
            setTimeout(() => $fb.removeClass('show'), 2000);
        }
    };

    // --- MÓDULO ENTRENADOR (OBSERVER) ---
    const Observer = {
        lastScore: 0,
        evaluate: function(game, score, playerColor) {
            // Solo evaluar en modo libre
            if (currentMode === 'lesson') return;

            let delta = score - this.lastScore; // Simplificado
            if (game.turn() === 'b') delta = -delta; // Ajuste perspectiva

            let tags = [];
            let msg = "";

            // Lógica simple de etiquetas
            if (Math.abs(score) < 50) tags.push({text:"Igualdad", type:"info"});
            else if (score > 100) tags.push({text:"Ventaja Blanca", type: (playerColor==='w'?'good':'bad')});
            else if (score < -100) tags.push({text:"Ventaja Negra", type: (playerColor==='b'?'good':'bad')});

            // Consejos básicos
            const fen = game.fen();
            const moveCount = parseInt(fen.split(' ')[5]);
            
            // Desarrollo
            if (moveCount < 10 && Math.abs(score) < 100) {
                msg = "En la apertura: Controla el centro, desarrolla piezas menores y enrócate.";
            } else if (Math.abs(delta) > 200) {
                msg = "¡Hubo un cambio drástico en la evaluación! Revisa tácticas.";
                tags.push({text:"Error Táctico", type:"warn"});
            } else {
                msg = "Busca mejorar la posición de tus piezas y atacar debilidades.";
            }

            $('#coachMsg').text(msg);
            $('#coachTags').empty();
            tags.forEach(t => $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`));
            
            this.lastScore = score;
        }
    };

    // --- LÓGICA PRINCIPAL ---
    
    function init() {
        // Cargar Stockfish
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
            .then(r => r.blob()).then(blob => {
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('uci');
                engine.onmessage = handleEngine;
                $('#statusText').text("Sistema Listo.");
            });

        // Poblar selectores de lecciones
        populateOpenings('all');

        // Event Listeners
        $('#openingCategory').change(function() {
            populateOpenings($(this).val());
        });

        $('#openingSelect').change(function() {
            const id = $(this).val();
            if (id) LessonSystem.start(id);
        });

        $('#btnQuitLesson').click(() => LessonSystem.stop());

        // Botones de juego
        $('#btnNewGame').click(newGame);
        $('#btnFlip').click(() => board.flip());
        $('#btnUndo').click(undo);
        $('#btnRedo').click(redo);
    }

    function populateOpenings(cat) {
        const $sel = $('#openingSelect');
        $sel.empty().append('<option value="">-- Selecciona una Apertura --</option>');
        
        openingsDB.forEach(op => {
            if (cat === 'all' || op.cat === cat) {
                $sel.append(new Option(op.name, op.id));
            }
        });
    }

    // --- MOTOR DE AJEDREZ ---
    function handleEngine(e) {
        const msg = e.data;
        if (msg.startsWith('bestmove') && isEnginePlaying) {
            game.move(msg.split(' ')[1], {sloppy:true});
            board.position(game.fen());
            isEnginePlaying = false;
            $('#thinkingIndicator').hide();
            triggerAnalysis();
        }
        if (msg.startsWith('info') && msg.includes('score') && !msg.includes('lowerbound')) {
            const match = msg.match(/score (cp|mate) (-?\d+)/);
            if (match) {
                let val = parseInt(match[2]);
                if (game.turn() === 'b') val = -val; // Absoluto
                updateEval(val, match[1]);
                Observer.evaluate(game, val, $('#playerColor').val());
            }
        }
    }

    function triggerAnalysis() {
        if (currentMode === 'lesson') return;
        engine.postMessage('stop');
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage('go depth 10');
    }

    function triggerAI() {
        if (currentMode !== 'pvc' || game.game_over()) return;
        isEnginePlaying = true;
        $('#thinkingIndicator').show();
        let level = $('#skillLevel').val() || 10;
        let depth = level < 5 ? 5 : 12;
        engine.postMessage(`setoption name Skill Level value ${level}`);
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage(`go depth ${depth}`);
    }

    function updateEval(val, type) {
        let per = 50;
        if (type === 'mate') per = val > 0 ? 100 : 0;
        else per = 50 + (Math.max(-500, Math.min(500, val)) / 10);
        $('#evalFill').css('width', per + '%');
    }

    // --- INTERACCIÓN TABLERO ---
    function onDragStart(src, piece) {
        if (game.game_over() || isEnginePlaying) return false;
        
        // Reglas según modo
        if (currentMode === 'pvc') {
            const pColor = $('#playerColor').val();
            if ((pColor === 'w' && piece.search(/^b/) !== -1) ||
                (pColor === 'b' && piece.search(/^w/) !== -1)) return false;
        }
        // En Lesson mode, solo permitimos mover si es nuestro turno (o el turno que pide la lección)
        if (currentMode === 'lesson') {
            // Permitir drag siempre que la lección esté activa, validaremos en onDrop
            if (!lessonState.active) return false;
        }
    }

    function onDrop(src, tgt) {
        // 1. MODO LECCIÓN (Lógica Especial)
        if (currentMode === 'lesson') {
            // Simulamos el movimiento para obtener el SAN (Standard Algebraic Notation)
            const tempMove = new Chess(game.fen());
            const moveAttempt = tempMove.move({from: src, to: tgt, promotion: 'q'});
            
            if (!moveAttempt) return 'snapback'; // Ilegal
            
            // Validar contra la lección
            const correct = LessonSystem.checkMove(moveAttempt);
            
            if (correct) {
                game.move({from: src, to: tgt, promotion: 'q'});
                board.position(game.fen());
                return;
            } else {
                return 'snapback'; // Movimiento erróneo para la lección
            }
        }

        // 2. MODO NORMAL
        const move = game.move({from: src, to: tgt, promotion: 'q'});
        if (!move) return 'snapback';

        board.position(game.fen());
        redoStack = []; // Borrar historia futura
        
        if (currentMode === 'pvc' && game.turn() !== $('#playerColor').val()) {
            setTimeout(triggerAI, 400);
        } else {
            triggerAnalysis();
        }
    }

    // --- CONTROLES JUEGO ---
    function newGame() {
        LessonSystem.stop();
        game.reset();
        redoStack = [];
        const pColor = $('#playerColor').val();
        board.orientation(pColor === 'w' ? 'white' : 'black');
        board.start();
        currentMode = $('#gameMode').val();
        
        if (currentMode === 'pvc' && pColor === 'b') triggerAI();
        else triggerAnalysis();
        
        $('#statusText').text("Nueva Partida");
    }

    function undo() {
        if (isEnginePlaying || currentMode === 'lesson') return;
        let m = game.undo();
        if (m) {
            redoStack.push(m);
            if (currentMode === 'pvc') {
                let m2 = game.undo(); 
                if(m2) redoStack.push(m2);
            }
            board.position(game.fen());
            triggerAnalysis();
        }
    }

    function redo() {
        if (isEnginePlaying || redoStack.length === 0 || currentMode === 'lesson') return;
        let m = redoStack.pop();
        game.move(m);
        if (currentMode === 'pvc' && redoStack.length > 0) game.move(redoStack.pop());
        board.position(game.fen());
        triggerAnalysis();
    }

    // INIT
    $(document).ready(function() {
        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        $(window).resize(board.resize);
        init();
    });

</script>
</body>
</html>
