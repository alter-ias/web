<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez - Suite Profesional</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- CORE LAYOUT --- */
        :root {
            --bg: #161512; /* Tono Chess.com dark */
            --panel: #262421;
            --accent: #81b64c; /* Verde Ajedrez */
            --text: #eeeeee;
            --text-muted: #bababa;
            --success: #81b64c;
            --error: #fa412d;
            --warn: #ffa400;
            --tactics: #a06ceb;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            /* PC por defecto: App fija */
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        header { 
            height: 60px; padding: 0 20px; width: 100%; flex-shrink: 0;
            background: #211f1c; border-bottom: 1px solid #383531;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .logo-link { text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .logo-link h1 { margin: 0; font-size: 1.3rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        .logo-span { font-size: 0.65rem; background: #383531; padding: 2px 5px; border-radius: 3px; color: #999; }

        .nav-menu { display: flex; gap: 10px; align-items: center; }
        .nav-btn {
            background: transparent; border: none; color: #aaa; font-size: 0.85rem; font-weight: 600; 
            cursor: pointer; padding: 8px 12px; transition: 0.2s;
        }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); border-radius: 4px; }
        
        .btn-help {
            background: #383531; color: #ccc; border: none; width: 32px; height: 32px; 
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-help:hover { background: #4d4d4d; color: #fff; }

        /* MAIN CONTAINER */
        .main-container {
            display: flex; flex: 1; height: calc(100vh - 60px); width: 100%;
            overflow: hidden; /* Fijo en PC */
        }

        /* --- ZONA TABLERO --- */
        .board-section {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            padding: 10px; background: #161512; position: relative;
        }

        .board-wrapper {
            width: 100%; max-width: 600px; /* Tama√±o controlado */
            display: flex; flex-direction: column; gap: 0;
        }

        /* BARRA DE AN√ÅLISIS (FIX PC) */
        .eval-bar-wrapper { 
            height: 20px; /* Altura fija visible */
            width: 100%;
            background: #403d39; 
            border-radius: 3px 3px 0 0; 
            overflow: hidden; 
            display: flex; 
            margin-bottom: 0;
            border: 1px solid #222;
        }
        .eval-fill { 
            height: 100%; width: 50%; 
            background: #fff; 
            transition: width 0.4s ease;
        }

        .board-container {
            width: 100%; aspect-ratio: 1/1;
            position: relative;
            /* Sin bordes extra√±os, limpio como chess.com */
        }

        /* CONTROLES DE NAVEGACI√ìN (ESTILO CHESS.COM) */
        .game-controls {
            display: flex; width: 100%; background: #262421; 
            border-radius: 0 0 4px 4px; overflow: hidden; height: 45px;
            margin-top: -2px; z-index: 5;
        }
        .control-btn {
            flex: 1; background: #262421; border: none; color: #999; font-size: 1.2rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #383531;
        }
        .control-btn:last-child { border-right: none; }
        .control-btn:hover { background: #302e2c; color: #fff; }
        .control-btn:active { background: #1f1d1b; }
        .control-btn i { pointer-events: none; }

        /* SIDEBAR */
        .sidebar {
            width: 400px; min-width: 350px;
            background: #211f1c; border-left: 1px solid #383531;
            overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
        }

        /* --- MEDIA QUERY: M√ìVIL (SCROLL HABILITADO) --- */
        @media (max-width: 900px) {
            body { height: auto; overflow: auto; display: block; }
            .main-container { height: auto; overflow: visible; flex-direction: column; display: block; }
            .board-section { min-height: auto; padding: 10px 0; }
            .board-wrapper { max-width: 95vw; margin: 0 auto; }
            .sidebar { width: 100%; overflow: visible; height: auto; border-left: none; }
            header { padding: 0 10px; }
            .nav-menu { display: none; } /* Ocultar men√∫ en m√≥vil */
            .logo-link h1 { font-size: 1.1rem; }
        }

        /* --- UI ELEMENTS --- */
        .lesson-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 15px 25px; border-radius: 8px;
            text-align: center; font-weight: 700; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 20; border: 2px solid var(--accent); font-size: 1.2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .lesson-feedback.show { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        .lesson-feedback.error { border-color: var(--error); color: var(--error); }
        .lesson-feedback.success { border-color: var(--success); color: var(--success); }

        /* Coach Tags */
        .coach-msg { font-size: 0.9rem; color: #ccc; margin-bottom: 8px; line-height: 1.4; min-height: 38px; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 5px; }
        .tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; display: inline-flex; align-items: center; gap: 5px; }
        .tag.best { background: #81b64c; color: #fff; }
        .tag.good { background: #96bc4b; color: #fff; }
        .tag.mistake { background: #ffa400; color: #fff; }
        .tag.blunder { background: #fa412d; color: #fff; }
        .tag.info { background: #4b89bc; color: #fff; }

        /* Inputs & Buttons */
        label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        select, button, input[type="text"] {
            width: 100%; padding: 10px; background: #2b2926; border: 1px solid #3f3d3a; color: #eee;
            border-radius: 4px; font-family: inherit; margin-bottom: 10px; cursor: pointer; font-size: 0.9rem; outline: none;
        }
        select:focus, input:focus { border-color: var(--accent); }
        button:hover { background: #3f3d3a; color: #fff; }
        
        .primary-btn { background: var(--success); color: #fff; border: none; font-weight: 700; }
        .primary-btn:hover { background: #71a340; }
        
        .btn-row { display: flex; gap: 10px; }
        .hidden { display: none; }

        /* Acordeones */
        .accordion-item { background: #262421; border-radius: 6px; overflow: hidden; margin-bottom: 5px; }
        .accordion-header { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.9rem; color: #ccc; border-bottom: 1px solid #302e2c; }
        .accordion-header:hover { background: #302e2c; color: #fff; }
        .accordion-content { display: none; padding: 15px; background: #211f1c; }
        .accordion-item.active .accordion-content { display: block; }
        .accordion-item.active .accordion-header { color: var(--accent); border-bottom-color: transparent; }

        /* Modales */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: #262421; width: 95%; max-width: 800px; max-height: 90vh;
            border-radius: 8px; border: 1px solid #444; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: flex; flex-direction: column;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding: 20px; color: #ccc; line-height: 1.6; }
        .tutorial-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:700px){ .tutorial-grid{grid-template-columns:1fr;} }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo-link">
        <h1>AlterDrez</h1> <span class="logo-span">PRO v3.4</span>
    </a>
    <div class="nav-menu">
        <button class="nav-btn" onclick="openModal('facts')">üß© Curiosidades</button>
        <button class="nav-btn" onclick="openModal('benefits')">üß† Beneficios</button>
        <button class="nav-btn" onclick="openModal('news')">üì∞ Noticias</button>
    </div>
    <button class="btn-help" onclick="openModal('welcome')" title="Configuraci√≥n"><i class="bi bi-gear-fill"></i></button>
</header>

<div id="toast" style="visibility:hidden; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:4px; z-index:3000;">Notificaci√≥n</div>

<!-- MODAL BIENVENIDA -->
<div id="modal-welcome" class="modal-overlay active">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0; color:#fff;">Configuraci√≥n</h2>
            <button onclick="closeAllModals()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="modal-body">
            <div class="tutorial-grid">
                <div>
                    <h4>1. Descargas (Persistentes)</h4>
                    <p style="font-size:0.9rem;">Carga las bases de datos una sola vez. Se guardar√°n en tu navegador.</p>
                    <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="display:block; text-align:center; background:#333; padding:10px; color:#fff; text-decoration:none; border-radius:4px;">
                        <i class="bi bi-cloud-download"></i> Descargar Pack
                    </a>
                    <button onclick="StorageManager.clearDB()" style="margin-top:10px; background:#442222; border:1px solid #fa412d; width:100%;">Borrar Datos Guardados</button>
                </div>
                <div>
                    <h4>2. Tutorial</h4>
                    <video controls style="width:100%; border-radius:4px;">
                        <source src="assets/alterdrez/tutorial.mp4" type="video/mp4">
                    </video>
                </div>
            </div>
            <button onclick="closeAllModals()" class="primary-btn" style="width:100%; margin-top:20px; padding:15px;">¬°A Jugar!</button>
        </div>
    </div>
</div>

<!-- MODALES EXTRA (Iguales a v3.3 pero con el nuevo estilo) -->
<div id="modal-facts" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Curiosidades</h2><button onclick="closeAllModals()" style="background:none;border:none;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><p>El n√∫mero de Shannon (10^120) supera a los √°tomos del universo.</p></div></div></div>
<div id="modal-benefits" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Beneficios</h2><button onclick="closeAllModals()" style="background:none;border:none;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><p>Mejora la plasticidad cerebral y previene el Alzheimer.</p></div></div></div>
<div id="modal-news" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Noticias</h2><button onclick="closeAllModals()" style="background:none;border:none;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><p>Enlaces a Chess.com, Lichess y FIDE.</p></div></div></div>


<!-- LAYOUT PRINCIPAL -->
<div class="main-container">
    <div class="board-section">
        <div class="board-wrapper">
            <!-- Barra An√°lisis -->
            <div class="eval-bar-wrapper">
                <div id="evalFill" class="eval-fill"></div>
            </div>
            
            <!-- Tablero -->
            <div class="board-container">
                <div id="board"></div>
                <div id="lessonFeedback" class="lesson-feedback"></div>
            </div>

            <!-- Controles de Navegaci√≥n (Estilo Chess.com) -->
            <div class="game-controls">
                <button class="control-btn" onclick="goToStart()" title="Inicio"><i class="bi bi-skip-start-fill"></i></button>
                <button class="control-btn" onclick="undo()" title="Atr√°s"><i class="bi bi-caret-left-fill"></i></button>
                <button class="control-btn" onclick="redo()" title="Adelante"><i class="bi bi-caret-right-fill"></i></button>
                <button class="control-btn" onclick="goToEnd()" title="Final"><i class="bi bi-skip-end-fill"></i></button>
                <button class="control-btn" onclick="board.flip()" title="Rotar"><i class="bi bi-arrow-repeat"></i></button>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:5px; width:100%; font-size:0.8rem; color:#777;">
                <span id="statusText">Motor Listo</span>
                <span id="thinkingIndicator" style="display:none; color:var(--accent);">Pensando...</span>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <!-- 1. JUGAR -->
        <div class="accordion-item active" id="panel-play">
            <div class="accordion-header" onclick="toggleAccordion('panel-play')">
                <span><i class="bi bi-joystick"></i> Jugar vs Stockfish</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div class="btn-row">
                    <div style="width: 50%;">
                        <label>Color</label>
                        <select id="playerColor"><option value="w">Blancas</option><option value="b">Negras</option></select>
                    </div>
                    <div style="width: 50%;">
                        <label>Nivel</label>
                        <select id="skillLevel">
                            <option value="0">Novato (800)</option>
                            <option value="5">Intermedio (1300)</option>
                            <option value="10" selected>Club (1600)</option>
                            <option value="15">Maestro (2200)</option>
                            <option value="20">GM (3000)</option>
                        </select>
                    </div>
                </div>
                <select id="gameMode">
                    <option value="pvc">Modo Competitivo</option>
                    <option value="analysis">Modo An√°lisis</option>
                </select>
                <button id="btnNewGame" class="primary-btn"><i class="bi bi-plus-circle"></i> Nueva Partida</button>
            </div>
        </div>

        <!-- 2. ENTRENADOR (Restaurado) -->
        <div class="accordion-item active" id="panel-coach">
            <div class="accordion-header" onclick="toggleAccordion('panel-coach')">
                <span><i class="bi bi-robot"></i> Entrenador</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div class="coach-tags" id="coachTags"></div>
                <div class="coach-msg" id="coachMsg">Haz tu primer movimiento...</div>
            </div>
        </div>

        <!-- 3. APERTURAS -->
        <div class="accordion-item" id="panel-opening">
            <div class="accordion-header" onclick="toggleAccordion('panel-opening')">
                <span><i class="bi bi-book"></i> Aperturas</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div style="font-size:0.7rem; color:var(--success); margin-bottom:5px;" id="openingDbBadge">Base Inicial</div>
                <input type="text" id="openingSearch" placeholder="üîç Buscar...">
                <select id="openingSelect"><option value="">-- Seleccionar --</option></select>
                <input type="file" id="openingDbInput" accept=".csv,.tsv,.txt" style="display:none">
                <button onclick="document.getElementById('openingDbInput').click()" style="font-size:0.8rem; background:#222; border:1px dashed #555; color:#999;">Cargar DB (.tsv)</button>
                <div id="lessonActiveUI" class="hidden" style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                    <div style="color:var(--success); font-weight:bold;" id="lessonInstruction"></div>
                    <div style="font-size:0.8rem; color:#aaa;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="margin-top:5px; background:#333;">Salir</button>
                </div>
            </div>
        </div>

        <!-- 4. T√ÅCTICA -->
        <div class="accordion-item" id="panel-tactics">
            <div class="accordion-header" onclick="toggleAccordion('panel-tactics')">
                <span><i class="bi bi-lightning-fill"></i> T√°ctica</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                     <label>Nivel</label>
                     <span id="dbCountBadge" style="font-size:0.6rem; color:var(--tactics);">Base Inicial</span>
                </div>
                <select id="tacticsEloSelect">
                    <option value="">-- Elo --</option>
                    <option value="800">800</option>
                    <option value="1000">1000</option>
                    <option value="1300">1300</option>
                    <option value="1600">1600</option>
                    <option value="2000">2000</option>
                    <option value="2400">2400</option>
                </select>
                <select id="tacticsPuzzleSelect" disabled><option value="">-- Puzzle --</option></select>
                <input type="file" id="dbInput" accept=".csv" style="display:none">
                <button onclick="document.getElementById('dbInput').click()" style="font-size:0.8rem; background:#222; border:1px dashed #555; color:#999;">Cargar DB (.csv)</button>
                <div id="tacticsActiveUI" class="hidden" style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                    <div style="color:var(--tactics); font-weight:bold;" id="tacticsTurnIndicator"></div>
                    <div style="font-size:0.8rem; color:#aaa;" id="tacticsDesc"></div>
                    <button id="btnQuitTactics" style="margin-top:5px; background:#333;">Salir</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- UI HELPERS ---
    function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
    function openModal(id) { closeAllModals(); document.getElementById('modal-' + id).classList.add('active'); }
    function toggleAccordion(id) { document.getElementById(id).classList.toggle('active'); }
    function showToast(msg) { const x = document.getElementById("toast"); x.style.visibility="visible"; x.innerText = msg; setTimeout(()=>x.style.visibility="hidden", 3000); }

    // --- VARIABLES GLOBALES ---
    const game = new Chess();
    let board = null, engine = null, redoStack = [];
    let currentMode = 'pvc', isEnginePlaying = false;
    let lessonState = { active: false, moves: [], index: 0, currentOpening: null };
    let tacticsState = { active: false, puzzle: null, index: 0 };

    let openingsList = [{ eco: "C50", name: "Italian Game", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bc4" }];
    let tacticsDB = { "800": [{ id: "1", name: "Mate Pasillo", fen: "6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves: ["Rd8#"], desc: "Mate en 1." }], "1000": [], "1300": [], "1600": [], "2000": [], "2400": [] };

    // --- STORAGE MANAGER ---
    const StorageManager = {
        dbName: "AlterDrezDB", dbVersion: 1,
        init: function() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(this.dbName, this.dbVersion);
                req.onupgradeneeded = (e) => { const db=e.target.result; if(!db.objectStoreNames.contains("openings")) db.createObjectStore("openings"); if(!db.objectStoreNames.contains("tactics")) db.createObjectStore("tactics"); };
                req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            });
        },
        saveData: function(store, key, data) { const tx=this.db.transaction(store,"readwrite"); tx.objectStore(store).put(data,key); },
        loadData: function() {
            const txOp=this.db.transaction("openings","readonly"); txOp.objectStore("openings").get("main").onsuccess=(e)=>{ if(e.target.result) { openingsList=e.target.result; populateOpeningsGUI(''); $('#openingDbBadge').text("Memoria Local").css('color','lime'); }};
            const txTac=this.db.transaction("tactics","readonly"); txTac.objectStore("tactics").get("main").onsuccess=(e)=>{ if(e.target.result) { tacticsDB=e.target.result; let c=0; Object.keys(tacticsDB).forEach(k=>c+=tacticsDB[k].length); $('#dbCountBadge').text(`${c} Puzzles`).css('color','lime'); }};
        },
        clearDB: function() { indexedDB.deleteDatabase(this.dbName).onsuccess=()=>{ location.reload(); }; }
    };

    // --- COACH LOGIC (RESTAURADA) ---
    const Observer = {
        lastScore: 0,
        eval: function(game, score, playerColor) {
            if(currentMode !== 'pvc' && currentMode !== 'analysis') return;
            
            // Calcular Delta desde la perspectiva del jugador que acaba de mover
            // Stockfish da score relativo a las blancas usualmente, o relativo al turno.
            // Asumiremos score absoluto (Positivo = Blancas ganando).
            
            let turn = game.turn(); // Turno del que va a mover AHORA. El que movi√≥ fue el opuesto.
            let mover = turn === 'w' ? 'b' : 'w'; 
            
            // Delta desde perspectiva de Blancas
            let deltaRaw = score - this.lastScore;
            
            // Delta relativo al que movi√≥
            let moveQualityDelta = (mover === 'w') ? deltaRaw : -deltaRaw;

            let tags = [], msg = "";
            const absScore = Math.abs(score);

            // 1. Tags de Estado
            if(absScore < 50) tags.push({text:"Igualdad", type:"info"});
            else if((playerColor === 'w' && score > 100) || (playerColor === 'b' && score < -100)) tags.push({text:"Ventaja", type:"good"});
            else tags.push({text:"Desventaja", type:"warn"});

            // 2. Tags de Calidad de Movimiento (Basado en Delta)
            if(moveQualityDelta > -30) tags.push({text:"<i class='bi bi-check'></i> Bueno", type:"good"});
            else if(moveQualityDelta > -90) tags.push({text:"<i class='bi bi-exclamation'></i> Imprecisi√≥n", type:"mistake"});
            else tags.push({text:"<i class='bi bi-x-circle'></i> Error Grave", type:"blunder"});

            // 3. Mensaje Contextual
            const moveCount = game.history().length;
            if(moveCount < 10) msg = "Fase de Apertura: Controla el centro y desarrolla los caballos y alfiles.";
            else if(Math.abs(score) > 800) msg = "Final ganado. Simplifica y busca coronar.";
            else if(moveQualityDelta < -200) msg = "¬°Cuidado! Has dejado una pieza colgada o permitiste una t√°ctica.";
            else msg = "Busca planes a largo plazo y mejora la posici√≥n de tus piezas.";

            $('#coachMsg').text(msg);
            $('#coachTags').empty();
            tags.forEach(t => $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`));
            
            this.lastScore = score;
        }
    };

    // --- ENGINE ---
    function initEngine() {
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r=>r.blob()).then(blob=>{
            engine = new Worker(URL.createObjectURL(blob));
            engine.postMessage('uci');
            engine.onmessage = function(e) {
                const msg = e.data;
                if(msg.startsWith('bestmove') && isEnginePlaying) {
                    game.move(msg.split(' ')[1], {sloppy:true});
                    board.position(game.fen());
                    isEnginePlaying = false; $('#thinkingIndicator').hide();
                    analyze();
                }
                if(msg.includes('score cp')) {
                    const m = msg.match(/score cp (-?\d+)/);
                    if(m) {
                        let score = parseInt(m[1]); 
                        // Ajuste CP a porcentaje visual
                        let p = 50 + (Math.max(-400,Math.min(400,score))/8);
                        if(game.turn()==='b') score = -score; // Normalizar score para l√≥gica interna si SF lo invierte
                        
                        $('#evalFill').css('width', p+'%');
                        Observer.eval(game, score, $('#playerColor').val());
                    }
                }
            };
        });
    }

    function moveAI() {
        if(currentMode!=='pvc' || game.game_over()) return;
        isEnginePlaying = true; $('#thinkingIndicator').show();
        let lvl = $('#skillLevel').val();
        engine.postMessage(`setoption name Skill Level value ${lvl}`);
        engine.postMessage('position fen '+game.fen());
        engine.postMessage(`go depth 15`);
    }

    function analyze() {
        if(currentMode==='lesson'||currentMode==='tactics') return;
        engine.postMessage('stop'); engine.postMessage('setoption name Skill Level value 20');
        engine.postMessage('position fen '+game.fen()); engine.postMessage('go depth 10');
    }

    // --- BOARD INTERACTION ---
    function onDrop(s, t) {
        if(currentMode === 'lesson') {
            const temp = new Chess(game.fen());
            if(temp.move({from:s, to:t, promotion:'q'}) && LessonSystem.check({san: temp.history().pop()})) {
                game.move({from:s, to:t, promotion:'q'}); board.position(game.fen());
            } return 'snapback';
        }
        if(currentMode === 'tactics') {
            const temp = new Chess(game.fen()); const m = temp.move({from:s, to:t, promotion:'q'});
            if(m && TacticsSystem.check(m)) {
                game.move({from:s, to:t, promotion:'q'}); board.position(game.fen()); return;
            } return 'snapback';
        }
        const m = game.move({from:s, to:t, promotion:'q'});
        if(!m) return 'snapback';
        board.position(game.fen()); redoStack = [];
        if(currentMode==='pvc' && game.turn()!==$('#playerColor').val()) setTimeout(moveAI, 250);
        else analyze();
    }

    function onDragStart(s, p) {
        if(game.game_over() || isEnginePlaying) return false;
        if(currentMode==='pvc' && (($('#playerColor').val()==='w' && p.startsWith('b')) || ($('#playerColor').val()==='b' && p.startsWith('w')))) return false;
        if(currentMode==='lesson' && !lessonState.active) return false;
    }

    // --- CONTROLS ---
    function undo() { if(!isEnginePlaying && currentMode.includes('analysis') || currentMode === 'pvc') { game.undo(); if(currentMode==='pvc') game.undo(); board.position(game.fen()); analyze(); } }
    function redo() { if(!isEnginePlaying && redoStack.length) { /* Implementaci√≥n simple requerir√≠a historial complejo */ } } // Redo simplificado
    function goToStart() { if(!isEnginePlaying) { game.reset(); board.position('start'); analyze(); } } // Reset visual
    function goToEnd() { /* Requiere historial completo */ }

    // --- MODULES ---
    const LessonSystem = {
        start: function(idx) {
            const op = openingsList[idx]; if(!op) return;
            lessonState = { active: true, moves: OpeningManager.pgnToArray(op.pgn), index: 0, currentOpening: op };
            currentMode = 'lesson'; $('#lessonActiveUI').removeClass('hidden'); $('#lessonDescription').text(op.name);
            game.reset(); board.position('start'); board.orientation('white'); this.prompt();
        },
        prompt: function() {
            if(lessonState.index >= lessonState.moves.length) { $('#lessonInstruction').text("¬°Completado!"); return; }
            $('#lessonInstruction').html(`${game.turn()==='w'?'Blancas':'Negras'}: Juega <b>${lessonState.moves[lessonState.index]}</b>`);
        },
        check: function(m) {
            if(m.san === lessonState.moves[lessonState.index]) {
                lessonState.index++; setTimeout(()=>this.auto(), 500); return true;
            } return false;
        },
        auto: function() {
            if(lessonState.index < lessonState.moves.length) {
                game.move(lessonState.moves[lessonState.index]); board.position(game.fen());
                lessonState.index++; this.prompt();
            } else $('#lessonInstruction').text("¬°Completado!");
        },
        stop: function() { lessonState.active=false; $('#lessonActiveUI').addClass('hidden'); currentMode='analysis'; }
    };

    const TacticsSystem = {
        start: function(elo, idx) {
            const p = tacticsDB[elo][idx]; if(!p) return;
            tacticsState = { active:true, puzzle:p, index:0 }; currentMode = 'tactics';
            $('#tacticsActiveUI').removeClass('hidden'); $('#tacticsDesc').text(p.desc);
            game.load(p.fen); board.position(p.fen); board.orientation(game.turn()==='w'?'white':'black');
        },
        check: function(m) {
            const exp = tacticsState.puzzle.moves[tacticsState.index];
            if(m.san===exp || (m.from+m.to+(m.promotion||'')===exp)) {
                tacticsState.index++; setTimeout(()=>this.resp(), 500); return true;
            } return false;
        },
        resp: function() {
            if(tacticsState.index < tacticsState.puzzle.moves.length) {
                game.move(tacticsState.puzzle.moves[tacticsState.index], {sloppy:true}); 
                board.position(game.fen()); tacticsState.index++;
            } else $('#tacticsTurnIndicator').text("¬°Correcto!");
        },
        stop: function() { tacticsState.active=false; $('#tacticsActiveUI').addClass('hidden'); currentMode='analysis'; }
    };

    const OpeningManager = {
        importFile: function(f) { const r=new FileReader(); r.onload=e=>this.parse(e.target.result); r.readAsText(f); },
        parse: function(t) {
            let n=[]; const l=t.split('\n');
            for(let x of l) { let p=x.split(x.includes('\t')?'\t':','); if(p.length>=3 && p[p.length-1].length>2) n.push({eco:p[0],name:p[1],pgn:p[p.length-1].trim()}); }
            if(n.length){ openingsList=n; StorageManager.saveData("openings","main",n); populateOpeningsGUI(''); }
        },
        pgnToArray: function(p) {
            const t=new Chess(); const c=p.replace(/\*/g,'').replace(/1-0|0-1|1\/2-1\/2/g,'');
            const tk=c.replace(/\d+\./g,'').split(/\s+/);
            for(let k of tk) if(k) t.move(k,{sloppy:true});
            return t.history();
        }
    };
    
    const TacticsManager = {
        importCSV: function(f) { const r=new FileReader(); r.onload=e=>this.parse(e.target.result); r.readAsText(f); },
        parse: function(t) {
            const l=t.split('\n'); let db={ "800":[],"1000":[],"1300":[],"1600":[],"2000":[],"2400":[] };
            for(let i=1;i<l.length&&i<5000;i++){
                const c=l[i].split(','); if(c.length<4)continue;
                const r=parseInt(c[3]); let k="800";
                if(r>=2400)k="2400";else if(r>=2000)k="2000";else if(r>=1600)k="1600";else if(r>=1300)k="1300";else if(r>=1000)k="1000";
                db[k].push({id:c[0],fen:c[1],moves:c[2].split(' '),desc:"Juega la mejor l√≠nea"});
            }
            tacticsDB=db; StorageManager.saveData("tactics","main",db);
        }
    };

    function populateOpeningsGUI(f) { const s=$('#openingSelect').empty().append('<option>--</option>'); const t=f.toLowerCase(); openingsList.forEach((o,i)=>{ if(o.name.toLowerCase().includes(t)) s.append(new Option(o.name,i)); }); }
    function updateTacticsList() { const e=$('#tacticsEloSelect').val(); const s=$('#tacticsPuzzleSelect').empty(); if(e&&tacticsDB[e]) tacticsDB[e].slice(0,100).forEach((p,i)=>s.append(new Option(`Puzzle ${i+1}`,i))); s.prop('disabled',!e); }

    $(document).ready(async () => {
        board = Chessboard('board', { draggable:true, position:'start', onDragStart:onDragStart, onDrop:onDrop, pieceTheme:'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        $(window).resize(board.resize);
        initEngine();
        await StorageManager.init(); StorageManager.loadData();

        $('#openingDbInput').change(function(){if(this.files.length)OpeningManager.importFile(this.files[0])});
        $('#dbInput').change(function(){if(this.files.length)TacticsManager.importCSV(this.files[0])});
        $('#openingSearch').on('input', function(){populateOpeningsGUI($(this).val())});
        $('#openingSelect').change(function(){if($(this).val())LessonSystem.start($(this).val())});
        $('#tacticsEloSelect').change(updateTacticsList);
        $('#tacticsPuzzleSelect').change(function(){if($(this).val())TacticsSystem.start($('#tacticsEloSelect').val(), $(this).val())});
        
        $('#btnQuitLesson').click(()=>LessonSystem.stop());
        $('#btnQuitTactics').click(()=>TacticsSystem.stop());
        $('#btnNewGame').click(()=>{ game.reset(); board.start(); $('#statusText').text("Nueva Partida"); if($('#playerColor').val()==='b') moveAI(); });

        populateOpeningsGUI('');
        
        document.addEventListener('keydown', function(e) {
            if (e.key === "ArrowLeft") { undo(); e.preventDefault(); }
            // Redo simple no implementado sin historial completo PGN
        });
    });
</script>
</body>
</html>
