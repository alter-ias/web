<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 7.1</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- CORE STYLES (INTACTOS) --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
            -webkit-overflow-scrolling: touch;
        }

        .home-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }

        .db-section {
            margin-top: 40px; padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        
        .video-box {
            width: 100%; margin-bottom: 20px; border: 1px solid #444; 
            border-radius: 8px; overflow: hidden; background: #000;
        }
        .video-box video { width: 100%; display: block; max-height: 400px; }

        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }

        /* --- VISTA: BOARD --- */
        #view-board {
            flex: 1; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
            overflow: hidden;
        }
        #view-board.active { display: flex; }

        /* HEADER JUEGO */
        .game-header {
            width: 100%; max-width: 600px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20,20,20,0.8); border-bottom: 1px solid #333;
            position: absolute; top: 0; z-index: 50; height: 50px;
        }
        .gh-info { display: flex; flex-direction: column; }
        .gh-title { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .gh-subtitle { font-size: 0.75rem; color: #888; }
        
        .btn-exit {
            background: transparent; border: 1px solid #444; color: #ccc;
            padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
        }

        /* Layout */
        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 60px 10px 10px 10px; 
            justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #263238; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        /* Transici√≥n suavizada */
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background-size: contain; 
        }

        /* Info */
        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }
        .tag.end { background: #fff; color: #000; border: 2px solid var(--accent); }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:active { background: #444; color: #fff; }
        .ctrl-btn.sol { background: var(--warn); color: #000; border: none; }
        .ctrl-btn.next { background: var(--success); color: #000; border: none; }

        /* Feedback */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1e1e1e; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; color: #eee; }
        .close-modal { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }

        .hidden { display: none !important; }

        /* FOOTER ALTERLAB */
        .alterlab-footer {
            margin-top: 30px; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 12px;
            max-width: 900px; margin-left: auto; margin-right: auto; text-align: center; border: 1px solid #333;
        }
        .alterlab-footer h3 { color: #fff; margin-bottom: 15px; font-size: 1.5rem; }
        .alterlab-footer p { color: #aaa; font-size: 0.9rem; line-height: 1.6; margin-bottom: 20px; text-align: justify; }
        .footer-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-lab { padding: 10px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.9rem; border: 2px solid transparent; transition: 0.3s; cursor: pointer; }
        .btn-donate { background: transparent; border-color: var(--accent); color: var(--accent); }
        .btn-project { background: #fff; color: #000; }
    </style>
</head>
<body>

<!-- VISTA: HOME -->
<div id="view-home">
    <div class="home-header">
        <a href="index.html" style="text-decoration:none;">
            <h1>AlterDrez</h1>
        </a>
        <p>Entrenamiento de Ajedrez Profesional v7.1</p>
    </div>

    <div class="cards-container">
        <!-- CARD JUGAR -->
        <div class="card play">
            <div class="card-title"><i class="bi bi-joystick"></i> Jugar</div>
            <div class="config-row">
                <select id="cfg-play-color">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
                <select id="cfg-play-level">
                    <option value="0">Novato (800)</option>
                    <option value="3">Aficionado (1100)</option>
                    <option value="6">Intermedio (1400)</option>
                    <option value="9">Club (1700)</option>
                    <option value="12">Fuerte (2000)</option>
                    <option value="15">Maestro (2300)</option>
                    <option value="20">Grandmaster (2500+)</option>
                </select>
            </div>
            <button class="btn-action" onclick="App.startPlay()">Jugar vs IA</button>
        </div>

        <!-- CARD APERTURAS -->
        <div class="card learn">
            <div class="card-title"><i class="bi bi-book"></i> Aperturas</div>
            <select id="cfg-opening-select">
                <option value="">-- Selecciona Apertura --</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-opening-count" style="color:var(--success)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startOpening()">Estudiar</button>
        </div>

        <!-- CARD T√ÅCTICA -->
        <div class="card tactics">
            <div class="card-title"><i class="bi bi-lightning-fill"></i> T√°ctica</div>
            <select id="cfg-tactics-elo">
                <option value="800">Principiante (800)</option>
                <option value="1100">Aficionado (1100)</option>
                <option value="1400">Intermedio (1400)</option>
                <option value="1700">Club (1700)</option>
                <option value="2000">Avanzado (2000)</option>
                <option value="2300">Maestro (2300)</option>
                <option value="2500">Elite (2500+)</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-tactics-count" style="color:var(--tactics)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startTactics()">Resolver</button>
        </div>
    </div>

    <!-- SECCI√ìN DATOS Y VIDEO INTEGRADO -->
    <div class="db-section">
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px;">Gesti√≥n de Datos & Tutorial</h3>
        
        <!-- VIDEO VISIBLE -->
        <div class="video-box">
            <video controls playsinline preload="auto" muted>
                <source src="assets/alterdrez/tutorial.mp4" type="video/mp4">
                Tu navegador no soporta la reproducci√≥n de video.
            </video>
        </div>

        <button class="db-btn" onclick="document.getElementById('modal-help').classList.add('active')">
            <i class="bi bi-question-circle"></i> ¬øC√≥mo usar?
        </button>
        <button class="db-btn" onclick="document.getElementById('file-openings').click()">
            <i class="bi bi-upload"></i> Cargar Aperturas (.tsv)
        </button>
        <button class="db-btn" onclick="document.getElementById('file-tactics').click()">
            <i class="bi bi-upload"></i> Cargar T√°ctica (.csv)
        </button>
        <button class="db-btn" onclick="Storage.clear()" style="color:var(--error); border-color:var(--error);">
            <i class="bi bi-trash"></i> Borrar Datos Guardados
        </button>
        
        <input type="file" id="file-openings" accept=".tsv,.txt,.csv" style="display:none" onchange="DB.loadOpenings(this)">
        <input type="file" id="file-tactics" accept=".csv" style="display:none" onchange="DB.loadTactics(this)">
    </div>

    <!-- SECCI√ìN FOOTER ALTERLAB -->
    <div class="alterlab-footer">
        <h3><i class="bi bi-people-fill"></i> Colectivo AlterLab</h3>
        <p>
            Este proyecto ha sido desarrollado bajo la filosof√≠a del <b>C√≥digo Abierto y Libre</b>. Creemos firmemente que el conocimiento y las herramientas para el desarrollo cognitivo no deben tener barreras de pago. 
            El ajedrez no es solo un juego; es una herramienta poderosa para el pensamiento cr√≠tico, la paciencia y la resiliencia social. 
            Si compartes nuestra visi√≥n de una tecnolog√≠a √©tica y accesible para todos, considera apoyar nuestro trabajo.
        </p>
        <div class="footer-btns">
            <button class="btn-lab btn-donate" onclick="alert('¬°Gracias por tu intenci√≥n! Pronto habilitaremos la plataforma de donaciones.')"><i class="bi bi-heart-fill"></i> Apoyo Mutuo</button>
            <a href="co-laboratorio.html" class="btn-lab btn-project"><i class="bi bi-arrow-right-circle-fill"></i> Conoce m√°s proyectos</a>
        </div>
    </div>
</div>

<!-- VISTA: JUEGO -->
<div id="view-board">
    <div class="game-header">
        <div class="gh-info">
            <div class="gh-title" id="gh-title">Modo Juego</div>
            <div class="gh-subtitle" id="gh-subtitle">VS Stockfish</div>
        </div>
        <button class="btn-exit" onclick="App.goHome()"><i class="bi bi-x-lg"></i> Salir</button>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

    <div class="game-layout">
        <!-- BARRA AN√ÅLISIS PRO -->
        <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
        
        <div class="board-container">
            <div id="board"></div>
        </div>

        <div class="game-info">
            <div class="coach-tags" id="coach-display">
                <span class="tag book">Listo</span>
            </div>

            <div class="controls">
                <button class="ctrl-btn" onclick="Game.undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="ctrl-btn" onclick="Game.redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="ctrl-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
                
                <button class="ctrl-btn sol hidden" id="btn-solution" title="Ver Soluci√≥n" onclick="Game.showSolution()"><i class="bi bi-eye-fill"></i></button>
                <button class="ctrl-btn next hidden" id="btn-next" title="Siguiente" onclick="App.next()"><i class="bi bi-skip-forward-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TUTORIAL -->
<div id="modal-help" class="modal">
    <div class="modal-box">
        <h2>Gu√≠a R√°pida</h2>
        <p>1. Descarga el pack de bases de datos.</p>
        <p>2. Carga los archivos. <b>L√≠mite: 20,000 ejercicios</b>.</p>
        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="color:var(--accent);">Ir a Google Drive</a>
        <button class="close-modal" onclick="document.getElementById('modal-help').classList.remove('active')">Entendido</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
// --- DATOS BASE ---
const BaseOpenings = [
    {eco:"C50", name:"Italiana", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4"},
    {eco:"C60", name:"Ruy Lopez", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
    {eco:"B20", name:"Siciliana", pgn:"1. e4 c5"},
    {eco:"B01", name:"Escandinava", pgn:"1. e4 d5"},
    {eco:"C00", name:"Francesa", pgn:"1. e4 e6"},
    {eco:"B10", name:"Caro-Kann", pgn:"1. e4 c6"},
    {eco:"D00", name:"Pe√≥n Dama", pgn:"1. d4 d5"},
    {eco:"D06", name:"Gambito Dama", pgn:"1. d4 d5 2. c4"},
    {eco:"A45", name:"Trompowsky", pgn:"1. d4 Nf6 2. Bg5"},
    {eco:"E60", name:"India de Rey", pgn:"1. d4 Nf6 2. c4 g6"},
    {eco:"A02", name:"Bird", pgn:"1. f4"},
    {eco:"A00", name:"Orangut√°n", pgn:"1. b4"},
    {eco:"C42", name:"Petrov", pgn:"1. e4 e5 2. Nf3 Nf6"},
    {eco:"C41", name:"Philidor", pgn:"1. e4 e5 2. Nf3 d6"},
    {eco:"C20", name:"Apertura de Rey", pgn:"1. e4 e5"},
    {eco:"B00", name:"Nimzowitsch", pgn:"1. e4 Nc6"},
    {eco:"A04", name:"Reti", pgn:"1. Nf3"},
    {eco:"A10", name:"Inglesa", pgn:"1. c4"},
    {eco:"C45", name:"Escocesa", pgn:"1. e4 e5 2. Nf3 Nc6 3. d4"},
    {eco:"C55", name:"Dos Caballos", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4 Nf6"}
];

const BaseTactics = {
    "800": [{id:"1", fen:"6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves:["Rd8#"], theme:"Mate Pasillo"}, {id:"2", fen:"r1bqkb1r/pppp1ppp/2n5/4P3/2B1n3/5Q2/PPP2PPP/RNB1K1NR w KQkq - 0 6", moves:["Qxf7#"], theme:"Pastor"}],
    "1100": [{id:"3", fen:"8/8/8/8/8/5k2/8/6QK w - - 0 1", moves:["Qg2#"], theme:"Mate Dama"}],
    "1400": [{id:"4", fen:"4k3/8/8/8/8/8/4N3/2K3r1 w - - 0 1", moves:["Nxg1"], theme:"Come Torre"}],
    "1700": [{id:"5", fen:"rnbqkbnr/pppp1ppp/8/4p3/6P4/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 2", moves:["Qh4#"], theme:"Mate Loco"}],
    "2000": [{id:"6", fen:"4k3/8/8/3N4/8/8/8/4K3 w - - 0 1", moves:["Nc7+","Kd8","Nxa8"], theme:"Horquilla"}],
    "2300": [{id:"7", fen:"r5rk/5p1p/1p1p1P2/p2P1R2/7Q/8/P5PP/4q1BK w - - 0 1", moves:["Qxh7+","Kxh7","Rh5#"], theme:"Mate 3"}],
    "2500": [{id:"8", fen:"8/8/8/8/p7/P7/2k5/6K1 w - - 0 1", moves:["Kh1", "Kb3"], theme:"Zugzwang"}]
};

let State = { mode: 'menu', openings: [], tactics: {}, game: new Chess(), board: null, engine: null, redoStack: [], currentLesson: { moves: [], index: 0 }, currentPuzzle: { moves: [], index: 0 }, lastScore: 0 };

const Engine = {
    init: function() {
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');`], {type: 'application/javascript'});
        State.engine = new Worker(URL.createObjectURL(blob));
        State.engine.onmessage = this.onMessage;
        State.engine.postMessage('uci');
    },
    go: function(depth) {
        if(State.mode === 'tactics') return; 
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage(`go depth ${depth}`);
    },
    stop: function() { State.engine.postMessage('stop'); },
    onMessage: function(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) {
            State.game.move(msg.split(' ')[1], {sloppy:true});
            State.board.position(State.game.fen());
            Game.checkStatus();
            Engine.analyze();
        }
        if(msg.includes('score cp')) {
            const m = msg.match(/score cp (-?\d+)/);
            if(m) {
                let score = parseInt(m[1]);
                if(State.game.turn() === 'b') score = -score;
                // F√ìRMULA SIGMOIDE SUAVIZADA (Math Fix)
                // 100 / (1 + e^-0.003x)
                let evalPerc = 100 / (1 + Math.exp(-0.003 * score));
                evalPerc = Math.max(2, Math.min(98, evalPerc));
                $('#eval-fill').css('width', evalPerc + '%');
                if(State.mode !== 'tactics') UI.updateCoach(score);
            }
        }
        if(msg.includes('score mate')) {
             const m = msg.match(/score mate (-?\d+)/);
             if(m) {
                 let mate = parseInt(m[1]);
                 if(State.game.turn() === 'b') mate = -mate;
                 let evalPerc = mate > 0 ? 100 : 0;
                 $('#eval-fill').css('width', evalPerc + '%');
             }
        }
    },
    analyze: function() {
        State.engine.postMessage('stop');
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage('go depth 10');
    }
};

const Game = {
    checkStatus: function() {
        if(State.game.in_checkmate()) {
            let winner = State.game.turn() === 'w' ? 'Negras' : 'Blancas';
            UI.feedback("¬°Jaque Mate!", "success");
            $('#coach-display').html(`<span class="tag end">üèÜ Ganan ${winner}</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        if(State.game.in_draw() || State.game.in_stalemate() || State.game.in_threefold_repetition()) {
            UI.feedback("¬°Tablas!", "warn");
            $('#coach-display').html(`<span class="tag end">¬Ω - ¬Ω Tablas</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        return false;
    },
    onDragStart: function(s, p) {
        if(State.game.game_over()) return false;
        if(State.mode === 'opening') return false; 
        if(State.mode === 'play') {
            const myColor = $('#cfg-play-color').val();
            if((myColor==='w' && p.startsWith('b')) || (myColor==='b' && p.startsWith('w'))) return false;
        }
        if(State.mode === 'tactics') {
            if((State.game.turn()==='w' && p.startsWith('b')) || (State.game.turn()==='b' && p.startsWith('w'))) return false;
        }
        return true;
    },
    onDrop: function(s, t) {
        if(State.mode === 'tactics') {
            const temp = new Chess(State.game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'});
            if(m) {
                // TACTICA: Compara con index 1 (tu respuesta)
                const correct = State.currentPuzzle.moves[State.currentPuzzle.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    State.game.move({from:s, to:t, promotion:'q'});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++; 
                    UI.feedback("¬°Bien!", "success");
                    
                    // Respuesta Rival
                    if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                        setTimeout(() => {
                            State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                            State.board.position(State.game.fen());
                            State.currentPuzzle.index++; 
                        }, 500);
                    } else {
                        UI.feedback("¬°Resuelto!", "success");
                    }
                    return;
                }
            }
            UI.feedback("Incorrecto", "error");
            return 'snapback';
        }

        if(State.mode === 'play') {
            const m = State.game.move({from:s, to:t, promotion:'q'});
            if(!m) return 'snapback';
            State.board.position(State.game.fen());
            State.redoStack = [];
            
            if(Game.checkStatus()) return; 

            setTimeout(() => {
                const lvl = parseInt($('#cfg-play-level').val());
                let depth = 5; if(lvl > 5) depth = 10; if(lvl > 15) depth = 15;
                State.engine.postMessage(`setoption name Skill Level value ${lvl}`);
                Engine.go(depth);
            }, 250);
        }
    },
    undo: function() {
        if(State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) return; 
        if(State.mode === 'opening') {
            State.game.undo(); State.board.position(State.game.fen());
            if(State.currentLesson.index > 0) State.currentLesson.index--;
            Engine.analyze();
            return;
        }
        let m = State.game.undo();
        if(m) {
            State.redoStack.push(m);
            if(State.mode === 'play') { let m2 = State.game.undo(); if(m2) State.redoStack.push(m2); }
            State.board.position(State.game.fen());
            Engine.analyze();
        }
    },
    redo: function() {
        if(State.mode === 'opening') {
            if(State.currentLesson.index < State.currentLesson.moves.length) {
                State.game.move(State.currentLesson.moves[State.currentLesson.index]);
                State.board.position(State.game.fen());
                State.currentLesson.index++;
                Engine.analyze();
            }
            return;
        }
        if(State.redoStack.length > 0) {
            let m = State.redoStack.pop();
            State.game.move(m);
            State.board.position(State.game.fen());
            if(State.mode === 'play' && State.redoStack.length > 0) {
                State.game.move(State.redoStack.pop());
                State.board.position(State.game.fen());
            }
            Engine.analyze();
        }
    },
    showSolution: function() {
        if(State.mode !== 'tactics') return;
        const move = State.currentPuzzle.moves[State.currentPuzzle.index];
        if(move) {
            State.game.move(move, {sloppy:true});
            State.board.position(State.game.fen());
            State.currentPuzzle.index++;
            if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                setTimeout(() => {
                    State.game.move(State.currentPuzzle.moves[State.currentPuzzle.ind
