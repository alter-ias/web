<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 7.5 H铆brido</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS "ZEN" --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
            -webkit-overflow-scrolling: touch;
        }

        .home-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }

        /* DATOS Y VIDEO */
        .db-section {
            margin-top: 40px; padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        
        .video-box {
            width: 100%; margin-bottom: 20px; border: 1px solid #444; 
            border-radius: 8px; overflow: hidden; background: #000;
        }
        .video-box video { width: 100%; display: block; max-height: 400px; }

        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }
        .db-btn i { font-size: 1.1rem; }

        /* FOOTER ALTERLAB */
        .alterlab-footer {
            margin-top: 40px; padding: 30px; background: rgba(0,0,0,0.4); border-radius: 12px;
            max-width: 900px; margin-left: auto; margin-right: auto; width: 100%;
            text-align: center; border: 1px solid #333;
        }
        .alterlab-footer h3 { color: #fff; margin-bottom: 15px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .alterlab-footer p { color: #aaa; font-size: 0.95rem; line-height: 1.6; margin-bottom: 25px; text-align: justify; }
        .footer-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-lab { padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.9rem; border: 2px solid transparent; transition: 0.3s; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-donate { background: transparent; border-color: var(--accent); color: var(--accent); }
        .btn-donate:hover { background: var(--accent); color: #000; }
        .btn-project { background: #fff; color: #000; }
        .btn-project:hover { background: #e0e0e0; transform: translateY(-2px); }

        /* --- VISTA: BOARD --- */
        #view-board {
            flex: 1; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
            overflow: hidden;
        }
        #view-board.active { display: flex; }

        .game-header {
            width: 100%; max-width: 600px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20,20,20,0.8); border-bottom: 1px solid #333;
            position: absolute; top: 0; z-index: 50; height: 50px;
        }
        .gh-info { display: flex; flex-direction: column; }
        .gh-title { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .gh-subtitle { font-size: 0.75rem; color: #888; }
        
        .btn-exit {
            background: transparent; border: 1px solid #444; color: #ccc;
            padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
        }

        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 60px 10px 10px 10px; 
            justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #263238; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background-size: contain; 
        }

        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }
        .tag.end { background: #fff; color: #000; border: 2px solid var(--accent); }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:active { background: #444; color: #fff; }
        .ctrl-btn.sol { background: var(--warn); color: #000; border: none; }
        .ctrl-btn.next { background: var(--success); color: #000; border: none; }

        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        /* Modal Tutorial */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1e1e1e; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; color: #eee; border: 1px solid #444; }
        .close-modal { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }

        .hidden { display: none !important; }
        
        .mode-badge {
            background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; color: var(--accent);
        }
    </style>
</head>
<body>

<!-- VISTA: HOME -->
<div id="view-home">
    <div class="home-header">
        <a href="index.html" style="text-decoration:none;">
            <h1>AlterDrez</h1>
        </a>
        <p>Entrenamiento de Ajedrez Profesional v7.5</p>
    </div>

    <div class="cards-container">
        <!-- CARD JUGAR -->
        <div class="card play">
            <div class="card-title"><i class="bi bi-joystick"></i> Jugar</div>
            <div class="config-row">
                <select id="cfg-play-color">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
                <select id="cfg-play-level">
                    <option value="0">Novato (800)</option>
                    <option value="3">Aficionado (1100)</option>
                    <option value="6">Intermedio (1400)</option>
                    <option value="9">Club (1700)</option>
                    <option value="12">Fuerte (2000)</option>
                    <option value="15">Maestro (2300)</option>
                    <option value="20">Grand Maestro (2600+)</option>
                </select>
            </div>
            <button class="btn-action" onclick="App.startPlay()">Jugar vs IA</button>
        </div>

        <!-- CARD APERTURAS -->
        <div class="card learn">
            <div class="card-title"><i class="bi bi-book"></i> Aperturas</div>
            <select id="cfg-opening-select">
                <option value="">-- Selecciona Apertura --</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-opening-count" style="color:var(--success)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startOpening()">Estudiar</button>
        </div>

        <!-- CARD TCTICA -->
        <div class="card tactics">
            <div class="card-title"><i class="bi bi-lightning-fill"></i> T谩ctica</div>
            <select id="cfg-tactics-elo">
                <option value="800">Principiante (800)</option>
                <option value="1100">Aficionado (1100)</option>
                <option value="1400">Intermedio (1400)</option>
                <option value="1700">Club (1700)</option>
                <option value="2000">Avanzado (2000)</option>
                <option value="2300">Maestro (2300)</option>
                <option value="2500">Elite (2500+)</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-tactics-count" style="color:var(--tactics)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startTactics()">Resolver</button>
        </div>
    </div>

    <!-- SECCIN DATOS Y VIDEO INTEGRADO -->
    <div class="db-section">
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px;">Gesti贸n de Datos & Tutorial</h3>
        
        <div class="video-box">
            <video controls playsinline preload="auto" muted>
                <source src="assets/alterdrez/tutorial.mp4" type="video/mp4">
                Tu navegador no soporta la reproducci贸n de video.
            </video>
        </div>

        <button class="db-btn" onclick="document.getElementById('modal-help').classList.add('active')">
            <i class="bi bi-question-circle"></i> 驴C贸mo usar?
        </button>
        <button class="db-btn" onclick="document.getElementById('file-openings').click()">
            <i class="bi bi-upload"></i> Cargar Aperturas (.tsv)
        </button>
        <button class="db-btn" onclick="document.getElementById('file-tactics').click()">
            <i class="bi bi-upload"></i> Cargar T谩ctica (.csv)
        </button>
        <button class="db-btn" onclick="Storage.clear()" style="color:var(--error); border-color:var(--error);">
            <i class="bi bi-trash"></i> Borrar Datos Guardados
        </button>
        
        <input type="file" id="file-openings" accept=".tsv,.txt,.csv" style="display:none" onchange="DB.loadOpenings(this)">
        <input type="file" id="file-tactics" accept=".csv" style="display:none" onchange="DB.loadTactics(this)">
    </div>

    <div class="alterlab-footer">
        <h3><i class="bi bi-people-fill"></i> Colectivo AlterLab</h3>
        <p>
            Este proyecto ha sido desarrollado bajo la filosof铆a del <b>C贸digo Abierto y Libre</b>. Creemos firmemente que el conocimiento no debe tener barreras. 
            El ajedrez es una herramienta poderosa para el pensamiento cr铆tico.
        </p>
        <div class="footer-btns">
            <button class="btn-lab btn-donate" onclick="alert('隆Gracias por tu intenci贸n! Pronto habilitaremos la plataforma de donaciones.')"><i class="bi bi-heart-fill"></i> Apoyo Mutuo</button>
            <a href="co-laboratorio.html" class="btn-lab btn-project"><i class="bi bi-arrow-right-circle-fill"></i> Conoce m谩s proyectos</a>
        </div>
    </div>

</div>

<!-- VISTA: JUEGO -->
<div id="view-board">
    <div class="game-header">
        <div class="gh-info">
            <div class="gh-title" id="gh-title">Modo Juego</div>
            <div class="gh-subtitle" id="gh-subtitle">VS Stockfish</div>
        </div>
        <button class="btn-exit" onclick="App.goHome()"><i class="bi bi-x-lg"></i> Salir</button>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

    <div class="game-layout">
        <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
        
        <div class="board-container">
            <div id="board"></div>
        </div>

        <div class="game-info">
            <div class="coach-tags" id="coach-display">
                <span class="tag book">Listo</span>
            </div>

            <div class="controls">
                <button class="ctrl-btn" onclick="Game.undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="ctrl-btn" onclick="Game.redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="ctrl-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
                
                <button class="ctrl-btn sol hidden" id="btn-solution" title="Ver Soluci贸n" onclick="Game.showSolution()"><i class="bi bi-eye-fill"></i></button>
                <button class="ctrl-btn next hidden" id="btn-next" title="Siguiente" onclick="App.next()"><i class="bi bi-skip-forward-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TUTORIAL (ACTUALIZADO) -->
<div id="modal-help" class="modal">
    <div class="modal-box">
        <h2><i class="bi bi-info-circle"></i> Gu铆a de Uso</h2>
        
        <div class="mode-badge"> Modo M贸vil (Lite)</div>
        <p>La App ya incluye <b>40 ejercicios y aperturas</b> listos para usar sin internet. Si cargas archivos, el l铆mite se ajusta a <b>2.000 ejercicios</b> para proteger tu tel茅fono.</p>
        
        <div class="mode-badge"> Modo PC (Pro)</div>
        <p>En computadora puedes cargar bases de datos masivas de hasta <b>20.000 ejercicios</b>.</p>

        <hr style="border-color:#333; margin:15px 0;">
        
        <p style="font-size:0.9rem; color:#aaa;">驴Quieres m谩s ejercicios? Descarga el pack completo para PC:</p>
        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="color:var(--accent); display:block; margin-bottom:15px;">Ir a Google Drive (Bases de Datos)</a>
        
        <button class="close-modal" onclick="document.getElementById('modal-help').classList.remove('active')">Entendido</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
// --- 1. BASE DE DATOS PRE-CARGADA (LITE) ---
// Se carga autom谩ticamente si no hay datos del usuario.
const BaseOpenings = [
    {eco:"B00", name:"Defensa Siciliana", pgn:"1. e4 c5"},
    {eco:"B30", name:"Siciliana Sveshnikov", pgn:"1. e4 c5 2. Nf3 Nc6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 e5"},
    {eco:"B90", name:"Siciliana Najdorf", pgn:"1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6"},
    {eco:"C60", name:"Ruy Lopez (Espa帽ola)", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
    {eco:"C50", name:"Giuoco Piano (Italiana)", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4 Bc5"},
    {eco:"C00", name:"Defensa Francesa", pgn:"1. e4 e6 2. d4 d5"},
    {eco:"B10", name:"Defensa Caro-Kann", pgn:"1. e4 c6 2. d4 d5"},
    {eco:"D00", name:"Pe贸n de Dama", pgn:"1. d4 d5"},
    {eco:"D30", name:"Gambito de Dama", pgn:"1. d4 d5 2. c4 e6"},
    {eco:"D06", name:"Gambito de Dama Aceptado", pgn:"1. d4 d5 2. c4 dxc4"},
    {eco:"A45", name:"Sistema Londres", pgn:"1. d4 d5 2. Bf4 Nf6 3. e3"},
    {eco:"A80", name:"Defensa Holandesa", pgn:"1. d4 f5"},
    {eco:"E60", name:"Defensa India de Rey", pgn:"1. d4 Nf6 2. c4 g6 3. Nc3 Bg7"},
    {eco:"E20", name:"Defensa Nimzo-India", pgn:"1. d4 Nf6 2. c4 e6 3. Nc3 Bb4"},
    {eco:"D80", name:"Defensa Grunfeld", pgn:"1. d4 Nf6 2. c4 g6 3. Nc3 d5"},
    {eco:"C42", name:"Defensa Petrov", pgn:"1. e4 e5 2. Nf3 Nf6"},
    {eco:"C41", name:"Defensa Philidor", pgn:"1. e4 e5 2. Nf3 d6"},
    {eco:"B01", name:"Defensa Escandinava", pgn:"1. e4 d5"},
    {eco:"B06", name:"Defensa Moderna", pgn:"1. e4 g6 2. d4 Bg7"},
    {eco:"A02", name:"Apertura Bird", pgn:"1. f4"},
    {eco:"A01", name:"Apertura Larsen", pgn:"1. b3"},
    {eco:"A00", name:"Apertura Sokolsky", pgn:"1. b4"},
    {eco:"C25", name:"Apertura Vienesa", pgn:"1. e4 e5 2. Nc3"},
    {eco:"C45", name:"Apertura Escocesa", pgn:"1. e4 e5 2. Nf3 Nc6 3. d4"},
    {eco:"C30", name:"Gambito de Rey", pgn:"1. e4 e5 2. f4"}
];

const BaseTactics = {
    "800": [
        {id:"101", fen:"6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves:["Rd8#"], theme:"Mate Pasillo"},
        {id:"102", fen:"rnbqkbnr/pppp1ppp/8/4p3/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 2", moves:["h3", "Qh4#"], theme:"Mate Loco"},
        {id:"103", fen:"3r2k1/5ppp/8/8/8/8/5PPP/6K1 b - - 0 1", moves:["Rd1#"], theme:"Mate Pasillo (Negras)"},
        {id:"104", fen:"8/8/8/8/8/8/5Q1p/7K b - - 0 1", moves:["g1=Q#"], theme:"Coronaci贸n Mate"},
        {id:"105", fen:"k7/P7/1K6/8/8/8/8/8 w - - 0 1", moves:["Ka6"], theme:"Ahogado (Tablas)"}
    ],
    "1100": [
        {id:"201", fen:"r1bqkbnr/pppp1ppp/2n5/4p3/2B1P3/5Q2/PPPP1PPP/RNB1K1NR b KQkq - 3 3", moves:["Qf6"], theme:"Defensa Mate Pastor"},
        {id:"202", fen:"r1bqk1nr/pppp1ppp/2n5/2b1p3/2B1P3/5Q2/PPPP1PPP/RNB1K1NR w KQkq - 4 4", moves:["Qxf7#"], theme:"Mate Pastor"},
        {id:"203", fen:"rn1qkbnr/pp2pppp/2p5/5b2/2BP4/4P3/PP3PPP/RNBQK1NR b KQkq - 0 1", moves:["e6"], theme:"Solidez"},
        {id:"204", fen:"rnbqkb1r/pp2pppp/3p1n2/2p5/2B1P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 0 1", moves:["d3"], theme:"Desarrollo"},
        {id:"205", fen:"8/8/8/4k3/3R4/3K4/8/8 w - - 0 1", moves:["Re3"], theme:"Oposici贸n"}
    ],
    "1400": [
        {id:"301", fen:"4k3/8/8/8/8/8/4N3/2K3r1 w - - 0 1", moves:["Nxg1"], theme:"Pieza Colgada"},
        {id:"302", fen:"r1b1k2r/ppppqppp/2n2n2/4p3/1b2P3/2NP1N2/PPP1BPPP/R1BQK2R w KQkq - 1 6", moves:["Bd2"], theme:"Desclavada"},
        {id:"303", fen:"r1bqk2r/pppp1ppp/2n2n2/4p3/1b2P3/2NP1N2/PPP1BPPP/R1BQK2R b KQkq - 0 1", moves:["Bxc3+"], theme:"Doblar Peones"},
        {id:"304", fen:"2r3k1/1p3ppp/p7/3r4/P7/1P6/5PPP/2R3K1 b - - 0 1", moves:["Rxc1#"], theme:"Mate Pasillo Desviaci贸n"},
        {id:"305", fen:"r2q1rk1/ppp2ppp/2n2n2/3p4/3P2b1/2NBPN2/PP3PPP/R2Q1RK1 b - - 0 1", moves:["Nb4"], theme:"Reagrupaci贸n"}
    ],
    "1700": [
        {id:"401", fen:"4k3/8/8/3N4/8/8/8/4K3 w - - 0 1", moves:["Nc7+","Kd8","Nxa8"], theme:"Doble (Horquilla)"},
        {id:"402", fen:"rnbqkb1r/pppppppp/5n2/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 1 2", moves:["e5"], theme:"Ataque Temprano"},
        {id:"403", fen:"r2q1rk1/1pp2ppp/p1nb1n2/3p4/3P2b1/P1NBP3/1P2NPPP/R1BQ1RK1 w - - 1 10", moves:["f3"], theme:"Expulsar Alfil"},
        {id:"404", fen:"3rr1k1/pp3ppp/2n5/2bq4/3p4/1P3N2/PBP2PPP/R2QR1K1 w - - 0 1", moves:["Rxe8+"], theme:"Simplificaci贸n"},
        {id:"405", fen:"8/5k2/8/8/5PK1/8/8/8 w - - 0 1", moves:["Kg5"], theme:"Rey Activo"}
    ],
    "2000": [
        {id:"501", fen:"8/8/8/8/p7/P7/2k5/7K w - - 0 1", moves:["Kg1"], theme:"Zugzwang"},
        {id:"502", fen:"r1bq1rk1/pp2ppbp/2np1np1/8/2PNP3/2N1B3/PP2BPPP/R2Q1RK1 w - - 0 1", moves:["f3"], theme:"Estructura Mar贸czy"},
        {id:"503", fen:"r4rk1/pp1n1ppp/1qp1pn2/3p4/3P1B2/P1NQPN2/1PP2PPP/R4RK1 b - - 0 1", moves:["Nh5"], theme:"Cambio Estrat茅gico"},
        {id:"504", fen:"2kr3r/ppqn1ppp/2pbpn2/8/3P4/2N1BB1P/PPP1QPP1/R3R1K1 w - - 1 1", moves:["a4"], theme:"Ataque Flanco"},
        {id:"505", fen:"8/8/1p6/1P6/2k5/8/1K6/8 w - - 0 1", moves:["Kc2","Kxb5"], theme:"Oposici贸n Distante"}
    ],
    "2300": [
        {id:"601", fen:"r5rk/5p1p/1p1p1P2/p2P1R2/7Q/8/P5PP/4q1BK w - - 0 1", moves:["Qxh7+","Kxh7","Rh5#"], theme:"Sacrificio Dama"},
        {id:"602", fen:"r1bq1rk1/pp3pbp/2np1np1/2p1p3/2P1P3/2NP1N2/PP2BPPP/R1BQ1RK1 w - - 0 1", moves:["Bg5"], theme:"Clavada Posicional"},
        {id:"603", fen:"rnb2rk1/ppq2pbp/2p3p1/4p3/2P1P3/2N2N2/PPQ1BPPP/R4RK1 w - - 0 1", moves:["Rad1"], theme:"Dominio Columna"},
        {id:"604", fen:"2r3k1/1p3ppp/pq6/3pP3/3n4/1P1Q4/P4PPP/3R2K1 w - - 0 1", moves:["Qxd4","Qxd4","Rxd4","Rc1+"], theme:"Celada Final"},
        {id:"605", fen:"r4rk1/1bq1bppp/p3pn2/1p2P3/8/P1NBB3/1PP1Q1PP/R4R1K b - - 0 1", moves:["Qxe5"], theme:"Pe贸n Central"}
    ],
    "2500": [
        {id:"701", fen:"8/8/8/8/8/1k6/1P6/K7 w - - 0 1", moves:["Kb1"], theme:"Tablas Teor铆a"},
        {id:"702", fen:"rnbq1rk1/pp2ppbp/2p2np1/3p4/2PP4/2N1PN2/PP2BPPP/R1BQK2R w KQ - 0 1", moves:["O-O"], theme:"Sutileza Apertura"},
        {id:"703", fen:"r1b2rk1/ppqn1ppp/2pbpn2/8/2PP4/2NB1N2/PP2QPPP/R1B1R1K1 b - - 0 1", moves:["e5"], theme:"Ruptura Central"},
        {id:"704", fen:"8/5p2/4p3/3kP3/3P4/3K4/8/8 w - - 0 1", moves:["Kc3"], theme:"Triangulaci贸n"},
        {id:"705", fen:"rnbqk2r/ppp1bppp/4pn2/3p4/2PP4/2N1PN2/PP3PPP/R1BQKB1R b KQkq - 0 1", moves:["O-O"], theme:"Teor铆a GM"}
    ]
};

// --- ESTADO Y MOTOR ---
let State = { mode: 'menu', openings: [], tactics: {}, game: new Chess(), board: null, engine: null, redoStack: [], currentLesson: { moves: [], index: 0 }, currentPuzzle: { moves: [], index: 0 }, lastScore: 0 };

const Engine = {
    init: function() {
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');`], {type: 'application/javascript'});
        State.engine = new Worker(URL.createObjectURL(blob));
        State.engine.onmessage = this.onMessage;
        State.engine.postMessage('uci');
    },
    go: function(depth) {
        if(State.mode === 'tactics') return; 
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage(`go depth ${depth}`);
    },
    stop: function() { State.engine.postMessage('stop'); },
    onMessage: function(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) {
            State.game.move(msg.split(' ')[1], {sloppy:true});
            State.board.position(State.game.fen());
            Game.checkStatus();
            Engine.analyze();
        }
        if(msg.includes('score cp')) {
            const m = msg.match(/score cp (-?\d+)/);
            if(m) {
                let score = parseInt(m[1]);
                if(State.game.turn() === 'b') score = -score;
                let evalPerc = 100 / (1 + Math.exp(-0.003 * score));
                evalPerc = Math.max(2, Math.min(98, evalPerc));
                $('#eval-fill').css('width', evalPerc + '%');
                if(State.mode !== 'tactics') UI.updateCoach(score);
            }
        }
        if(msg.includes('score mate')) {
             const m = msg.match(/score mate (-?\d+)/);
             if(m) {
                 let mate = parseInt(m[1]);
                 if(State.game.turn() === 'b') mate = -mate;
                 let evalPerc = mate > 0 ? 100 : 0;
                 $('#eval-fill').css('width', evalPerc + '%');
             }
        }
    },
    analyze: function() {
        State.engine.postMessage('stop');
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage('go depth 10');
    }
};

const Game = {
    checkStatus: function() {
        if(State.game.in_checkmate()) {
            let winner = State.game.turn() === 'w' ? 'Negras' : 'Blancas';
            UI.feedback("隆Jaque Mate!", "success");
            $('#coach-display').html(`<span class="tag end"> Ganan ${winner}</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        if(State.game.in_draw() || State.game.in_stalemate() || State.game.in_threefold_repetition()) {
            UI.feedback("隆Tablas!", "warn");
            $('#coach-display').html(`<span class="tag end">陆 - 陆 Tablas</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        return false;
    },
    onDragStart: function(s, p) {
        if(State.game.game_over()) return false;
        if(State.mode === 'opening') return false; 
        if(State.mode === 'play') {
            const myColor = $('#cfg-play-color').val();
            if((myColor==='w' && p.startsWith('b')) || (myColor==='b' && p.startsWith('w'))) return false;
        }
        if(State.mode === 'tactics') {
            if((State.game.turn()==='w' && p.startsWith('b')) || (State.game.turn()==='b' && p.startsWith('w'))) return false;
        }
        return true;
    },
    onDrop: function(s, t) {
        if(State.mode === 'tactics') {
            const temp = new Chess(State.game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'});
            if(m) {
                const correct = State.currentPuzzle.moves[State.currentPuzzle.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    State.game.move({from:s, to:t, promotion:'q'});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++; 
                    UI.feedback("隆Bien!", "success");
                    if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                        setTimeout(() => {
                            State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                            State.board.position(State.game.fen());
                            State.currentPuzzle.index++; 
                        }, 500);
                    } else {
                        UI.feedback("隆Resuelto!", "success");
                    }
                    return;
                }
            }
            UI.feedback("Incorrecto", "error");
            return 'snapback';
        }

        if(State.mode === 'play') {
            const m = State.game.move({from:s, to:t, promotion:'q'});
            if(!m) return 'snapback';
            State.board.position(State.game.fen());
            State.redoStack = [];
            if(Game.checkStatus()) return; 
            setTimeout(() => {
                const lvl = parseInt($('#cfg-play-level').val());
                let depth = 5; if(lvl > 5) depth = 10; if(lvl > 15) depth = 15;
                State.engine.postMessage(`setoption name Skill Level value ${lvl}`);
                Engine.go(depth);
            }, 250);
        }
    },
    undo: function() {
        if(State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) return; 
        if(State.mode === 'opening') {
            State.game.undo(); State.board.position(State.game.fen());
            if(State.currentLesson.index > 0) State.currentLesson.index--;
            Engine.analyze(); return;
        }
        let m = State.game.undo();
        if(m) {
            State.redoStack.push(m);
            if(State.mode === 'play') { let m2 = State.game.undo(); if(m2) State.redoStack.push(m2); }
            State.board.position(State.game.fen());
            Engine.analyze();
        }
    },
    redo: function() {
        if(State.mode === 'opening') {
            if(State.currentLesson.index < State.currentLesson.moves.length) {
                State.game.move(State.currentLesson.moves[State.currentLesson.index]);
                State.board.position(State.game.fen());
                State.currentLesson.index++;
                Engine.analyze();
            } return;
        }
        if(State.redoStack.length > 0) {
            let m = State.redoStack.pop();
            State.game.move(m);
            State.board.position(State.game.fen());
            if(State.mode === 'play' && State.redoStack.length > 0) {
                State.game.move(State.redoStack.pop());
                State.board.position(State.game.fen());
            }
            Engine.analyze();
        }
    },
    showSolution: function() {
        if(State.mode !== 'tactics') return;
        const move = State.currentPuzzle.moves[State.currentPuzzle.index];
        if(move) {
            State.game.move(move, {sloppy:true});
            State.board.position(State.game.fen());
            State.currentPuzzle.index++;
            if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                setTimeout(() => {
                    State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++;
                }, 500);
            }
        }
    }
};

const App = {
    init: function() {
        // Inicializamos con los datos BASE
        State.openings = JSON.parse(JSON.stringify(BaseOpenings));
        State.tactics = JSON.parse(JSON.stringify(BaseTactics));
        
        // Intentamos cargar de memoria (si el usuario ya carg贸 archivos antes)
        DB.loadFromMemory();
        
        State.board = Chessboard('board', { draggable: true, position: 'start', onDragStart: Game.onDragStart, onDrop: Game.onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        Engine.init();
        UI.refreshSelects();
    },
    goHome: function() { $('#view-board').removeClass('active'); $('#view-home').show(); State.mode = 'menu'; State.engine.postMessage('stop'); },
    enterBoard: function(mode) { State.mode = mode; $('#view-home').hide(); $('#view-board').addClass('active'); setTimeout(() => State.board.resize(), 100); $('#btn-solution').addClass('hidden'); $('#btn-next').addClass('hidden'); },
    next: function() {
        if(State.mode === 'tactics') this.startTactics();
        if(State.mode === 'opening') {
            let currentIdx = parseInt($('#cfg-opening-select').val()) || 0;
            let nextIdx = (currentIdx + 1) % State.openings.length;
            $('#cfg-opening-select').val(nextIdx);
            this.startOpening();
        }
    },
    startPlay: function() {
        this.enterBoard('play');
        State.game.reset(); State.board.start(); State.redoStack = [];
        const color = $('#cfg-play-color').val();
        State.board.orientation(color === 'w' ? 'white' : 'black');
        $('#gh-title').text("Partida vs Stockfish");
        $('#gh-subtitle').text("Nivel: " + $('#cfg-play-level option:selected').text());
        $('#coach-display').html('<span class="tag book">Nueva Partida</span>');
        if(color === 'b') setTimeout(() => Engine.go(5), 500); else Engine.analyze();
    },
    startOpening: function() {
        const idx = $('#cfg-opening-select').val();
        if(idx === "") return alert("Selecciona una apertura");
        const op = State.openings[idx];
        this.enterBoard('opening');
        State.game.reset(); State.board.start(); State.board.orientation('white');
        const clean = op.pgn.replace(/\d+\./g,'').replace(/\*/g,'').split(/\s+/).filter(x => x);
        State.currentLesson = { moves: clean, index: 0 };
        $('#gh-title').text(op.name);
        $('#gh-subtitle').text(`ECO: ${op.eco}`);
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Estudiando</span>`);
        Engine.analyze();
    },
    startTactics: function() {
        const elo = $('#cfg-tactics-elo').val();
        const puzzles = State.tactics[elo] || [];
        if(puzzles.length === 0) return alert("No hay puzzles de este nivel.");
        const p = puzzles[Math.floor(Math.random() * puzzles.length)];
        this.enterBoard('tactics');
        State.game.load(p.fen);
        
        if(p.moves && p.moves.length > 0) {
            State.game.move(p.moves[0], {sloppy:true});
        }
        
        State.board.position(State.game.fen());
        const userColor = State.game.turn() === 'w' ? 'white' : 'black';
        State.board.orientation(userColor);
        
        State.currentPuzzle = { moves: p.moves, index: 1 };
        
        $('#gh-title').text(`T谩ctica [${elo}]`);
        $('#gh-subtitle').text(p.theme ? `Tema: ${p.theme}` : `ID: ${p.id}`);
        $('#btn-solution').removeClass('hidden');
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Juegan ${userColor==='white'?'Blancas':'Negras'}</span>`);
    }
};

const UI = {
    refreshSelects: function() {
        const s = $('#cfg-opening-select').empty().append('<option value="">-- Selecciona --</option>');
        State.openings.forEach((o, i) => s.append(new Option(`[${o.eco}] ${o.name}`, i)));
        $('#lbl-opening-count').text(State.openings.length);
        let totalP = 0;
        Object.values(State.tactics).forEach(arr => totalP += arr.length);
        $('#lbl-tactics-count').text(totalP);
    },
    feedback: function(msg, type) {
        const el = $('#feedback');
        el.text(msg).removeClass('success error').addClass('show ' + type);
        setTimeout(() => el.removeClass('show'), 1000);
    },
    updateCoach: function(score) {
        let delta = score - State.lastScore;
        if(State.game.turn() === 'w') delta = -delta; 
        let tag = "";
        if(delta < -200) tag = "<span class='tag bad'>Error Grave</span>";
        else if(delta < -80) tag = "<span class='tag bad'>Error</span>";
        else if(delta < -30) tag = "<span class='tag warn'>Imprecisi贸n</span>";
        else if(delta > 30) tag = "<span class='tag good'>Buena</span>";
        else tag = "<span class='tag book'>Normal</span>";
        $('#coach-display').html(tag);
        State.lastScore = score;
    },
    updateEval: function(score) {
        let p = 100 / (1 + Math.exp(-0.003 * score));
        if(State.game.turn() === 'b') p = 100 - p;
        p = Math.max(2, Math.min(98, p));
        $('#eval-fill').css('width', p + '%');
    }
};

const DB = {
    loadOpenings: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); let c = 0;
            lines.forEach(l => {
                const p = l.split('\t');
                if(p.length >= 3) {
                    State.openings.push({eco:p[0], name:p[1], pgn:p[p.length-1].trim()});
                    c++;
                }
            });
            Storage.save(); UI.refreshSelects(); alert(`+${c} Aperturas`);
        };
        reader.readAsText(file);
    },
    loadTactics: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); 
            let c = 0; 
            const isComma = lines[0].includes(',');
            
            // --- DETECCIN DE MVIL Y LMITES ---
            // Puedes modificar estos n煤meros manualmente:
            const LIMITE_MOVIL = 2000;
            const LIMITE_PC = 20000;
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const MAX_PUZZLES = isMobile ? LIMITE_MOVIL : LIMITE_PC;
            // ------------------------------------

            for(let i=0; i < lines.length; i++) {
                if(c >= MAX_PUZZLES) {
                    if(isMobile) alert(` Modo M贸vil: L铆mite de ${MAX_PUZZLES} ejercicios alcanzado para proteger tu memoria.`);
                    else alert(` Modo PC: L铆mite de ${MAX_PUZZLES} ejercicios completado.`);
                    break;
                }
                
                if(!lines[i]) continue;
                const cols = lines[i].split(isComma ? ',' : '\t');
                if(cols.length > 3) {
                    const r = parseInt(cols[3]);
                    if(!isNaN(r)) {
                        let k = "800";
                        if(r >= 2500) k = "2500";
                        else if(r >= 2300) k = "2300";
                        else if(r >= 2000) k = "2000";
                        else if(r >= 1700) k = "1700";
                        else if(r >= 1400) k = "1400";
                        else if(r >= 1100) k = "1100";
                        
                        if(!State.tactics[k]) State.tactics[k] = [];
                        let th = cols[7] ? cols[7].trim() : "";
                        State.tactics[k].push({id:cols[0], fen:cols[1], moves:cols[2].split(' '), theme: th});
                        c++;
                    }
                }
            }
            Storage.save(); 
            UI.refreshSelects(); 
            if(c < MAX_PUZZLES) alert(`xito: +${c} Puzzles cargados.`);
        };
        reader.readAsText(file);
    },
    loadFromMemory: function() {
        // Solo sobrescribe la base lite si hay datos guardados
        const op = localStorage.getItem('ad_openings');
        const tac = localStorage.getItem('ad_tactics');
        
        if(op) {
            try {
                const parsed = JSON.parse(op);
                if(parsed && parsed.length > 0) State.openings = parsed;
            } catch(e) { console.log("Error cargando aperturas guardadas"); }
        }
        
        if(tac) {
            try {
                const parsed = JSON.parse(tac);
                // Verificamos que tenga contenido real
                let total = 0; Object.values(parsed).forEach(arr => total += arr.length);
                if(total > 0) State.tactics = parsed;
            } catch(e) { console.log("Error cargando t谩ctica guardada"); }
        }
    }
};

const Storage = {
    save: function() {
        try {
            localStorage.setItem('ad_openings', JSON.stringify(State.openings));
            localStorage.setItem('ad_tactics', JSON.stringify(State.tactics));
        } catch(e) { 
            if (e.name === 'QuotaExceededError') {
                alert("锔 Almacenamiento lleno. Los datos est谩n activos ahora, pero no se guardar谩n si cierras la app.");
            } else {
                console.error(e);
            }
        }
    },
    clear: function() { localStorage.clear(); location.reload(); }
};

$(document).ready(function() { 
    App.init();
    document.addEventListener('keydown', function(e) {
        if (e.key === "ArrowLeft") { Game.undo(); e.preventDefault(); }
        if (e.key === "ArrowRight") { Game.redo(); e.preventDefault(); }
    });
});
</script>
</body>
</html>
