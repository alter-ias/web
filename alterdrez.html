<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 7.0</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS "ZEN" (v5.8) --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME (MEN√ö) --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
            -webkit-overflow-scrolling: touch;
        }

        .home-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }

        /* DATOS Y VIDEO */
        .db-section {
            margin-top: 40px; padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        
        .video-box {
            width: 100%; margin-bottom: 20px; border: 1px solid #444; 
            border-radius: 8px; overflow: hidden; background: #000;
        }
        .video-box video { width: 100%; display: block; max-height: 400px; }

        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }

        /* --- VISTA: BOARD (JUEGO) --- */
        #view-board {
            flex: 1; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
            overflow: hidden;
        }
        #view-board.active { display: flex; }

        /* HEADER FLOTANTE JUEGO */
        .game-header {
            width: 100%; max-width: 600px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20,20,20,0.8); border-bottom: 1px solid #333;
            position: absolute; top: 0; z-index: 50; height: 50px;
        }
        .gh-info { display: flex; flex-direction: column; }
        .gh-title { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .gh-subtitle { font-size: 0.75rem; color: #888; }
        
        .btn-exit {
            background: transparent; border: 1px solid #444; color: #ccc;
            padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
        }

        /* Layout del Tablero */
        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 60px 10px 10px 10px; 
            justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #263238; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background-size: contain; 
        }

        /* Panel Info */
        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }
        .tag.end { background: #fff; color: #000; border: 2px solid var(--accent); }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:active { background: #444; color: #fff; }
        .ctrl-btn.sol { background: var(--warn); color: #000; border: none; }
        .ctrl-btn.next { background: var(--success); color: #000; border: none; }

        /* Feedback */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        /* Modal Tutorial */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1e1e1e; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; color: #eee; }
        .close-modal { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- VISTA: HOME -->
<div id="view-home">
    <div class="home-header">
        <h1>AlterDrez</h1>
        <p>Entrenamiento de Ajedrez Profesional v7.0</p>
    </div>

    <div class="cards-container">
        <!-- CARD JUGAR -->
        <div class="card play">
            <div class="card-title"><i class="bi bi-joystick"></i> Jugar</div>
            <div class="config-row">
                <select id="cfg-play-color">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
                <select id="cfg-play-level">
                    <option value="0">Novato (800)</option>
                    <option value="5">Club (1500)</option>
                    <option value="10">Maestro (2200)</option>
                    <option value="20">GM (3000+)</option>
                </select>
            </div>
            <button class="btn-action" onclick="App.startPlay()">Jugar vs IA</button>
        </div>

        <!-- CARD APERTURAS -->
        <div class="card learn">
            <div class="card-title"><i class="bi bi-book"></i> Aperturas</div>
            <select id="cfg-opening-select">
                <option value="">-- Selecciona Apertura --</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-opening-count" style="color:var(--success)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startOpening()">Estudiar</button>
        </div>

        <!-- CARD T√ÅCTICA -->
        <div class="card tactics">
            <div class="card-title"><i class="bi bi-lightning-fill"></i> T√°ctica</div>
            <select id="cfg-tactics-elo">
                <option value="800">Principiante (800)</option>
                <option value="1600">Intermedio (1600)</option>
                <option value="2400">Avanzado (2400)</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-tactics-count" style="color:var(--tactics)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startTactics()">Resolver</button>
        </div>
    </div>

    <div class="db-section">
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px;">Gesti√≥n de Datos & Tutorial</h3>
        
        <!-- VIDEO TUTORIAL -->
        <div class="video-box">
            <video controls playsinline preload="auto" muted>
                <source src="assets/alterdrez/tutorial.mp4" type="video/mp4">
                Tu navegador no soporta la reproducci√≥n de video.
            </video>
        </div>

        <button class="db-btn" onclick="document.getElementById('modal-help').classList.add('active')">
            <i class="bi bi-question-circle"></i> ¬øC√≥mo usar?
        </button>
        <button class="db-btn" onclick="document.getElementById('file-openings').click()">
            <i class="bi bi-upload"></i> Cargar Aperturas (.tsv)
        </button>
        <button class="db-btn" onclick="document.getElementById('file-tactics').click()">
            <i class="bi bi-upload"></i> Cargar T√°ctica (.csv)
        </button>
        <button class="db-btn" onclick="Storage.clear()" style="color:var(--error); border-color:var(--error);">
            <i class="bi bi-trash"></i> Borrar Datos Guardados
        </button>
        
        <input type="file" id="file-openings" accept=".tsv,.txt,.csv" style="display:none" onchange="DB.loadOpenings(this)">
        <input type="file" id="file-tactics" accept=".csv" style="display:none" onchange="DB.loadTactics(this)">
    </div>
</div>

<!-- VISTA: JUEGO -->
<div id="view-board">
    <!-- HEADER FLOTANTE -->
    <div class="game-header">
        <div class="gh-info">
            <div class="gh-title" id="gh-title">Modo Juego</div>
            <div class="gh-subtitle" id="gh-subtitle">VS Stockfish</div>
        </div>
        <button class="btn-exit" onclick="App.goHome()"><i class="bi bi-x-lg"></i> Salir</button>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

    <div class="game-layout">
        <!-- BARRA AN√ÅLISIS -->
        <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
        
        <div class="board-container">
            <div id="board"></div>
        </div>

        <div class="game-info">
            <div class="coach-tags" id="coach-display">
                <span class="tag book">Listo</span>
            </div>

            <div class="controls">
                <button class="ctrl-btn" onclick="Game.undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="ctrl-btn" onclick="Game.redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="ctrl-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
                
                <button class="ctrl-btn sol hidden" id="btn-solution" title="Ver Soluci√≥n" onclick="Game.showSolution()"><i class="bi bi-eye-fill"></i></button>
                <button class="ctrl-btn next hidden" id="btn-next" title="Siguiente" onclick="App.next()"><i class="bi bi-skip-forward-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TUTORIAL -->
<div id="modal-help" class="modal">
    <div class="modal-box">
        <h2>Gu√≠a R√°pida</h2>
        <p>1. Descarga el pack de bases de datos.</p>
        <p>2. Carga los archivos para habilitar miles de ejercicios.</p>
        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="color:var(--accent);">Ir a Google Drive</a>
        <button class="close-modal" onclick="document.getElementById('modal-help').classList.remove('active')">Entendido</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
// --- DATOS BASE ---
const BaseOpenings = [
    {eco:"C50", name:"Italiana", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4"},
    {eco:"B20", name:"Siciliana", pgn:"1. e4 c5"},
    {eco:"D00", name:"Pe√≥n Dama", pgn:"1. d4 d5"},
    {eco:"C60", name:"Ruy Lopez", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
    {eco:"C00", name:"Francesa", pgn:"1. e4 e6"}
];
const BaseTactics = {
    // Ajustados: FEN Inicial -> Move Rival -> Move Player
    "800": [{id:"1", fen:"6k1/5ppp/8/8/8/8/5PPP/3r2K1 w - - 0 1", moves:["Rxd1", "Rxd1#"], theme:"Mate Pasillo"}],
    "1600": [{id:"2", fen:"4k3/8/8/3N4/8/8/8/3rK3 w - - 0 1", moves:["Kxd1", "Nc7+"], theme:"Horquilla"}],
    "2400": [{id:"3", fen:"8/8/8/8/p7/P7/2k5/6K1 w - - 0 1", moves:["Kh1", "Kb3"], theme:"Zugzwang"}]
};

// --- GESTI√ìN DE ESTADO ---
let State = { mode: 'menu', openings: [], tactics: {}, game: new Chess(), board: null, engine: null, redoStack: [], currentLesson: { moves: [], index: 0 }, currentPuzzle: { moves: [], index: 0 }, lastScore: 0 };

// --- MOTOR ---
const Engine = {
    init: function() {
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');`], {type: 'application/javascript'});
        State.engine = new Worker(URL.createObjectURL(blob));
        State.engine.onmessage = this.onMessage;
        State.engine.postMessage('uci');
    },
    go: function(depth) {
        if(State.mode === 'tactics') return; 
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage(`go depth ${depth}`);
    },
    stop: function() { State.engine.postMessage('stop'); },
    onMessage: function(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) {
            State.game.move(msg.split(' ')[1], {sloppy:true});
            State.board.position(State.game.fen());
            Game.checkStatus(); // VERIFICAR MATE
            Engine.analyze();
        }
        if(msg.includes('score cp')) {
            const m = msg.match(/score cp (-?\d+)/);
            if(m) {
                let score = parseInt(m[1]);
                if(State.game.turn() === 'b') score = -score;
                
                // SIGMOIDE para barra de an√°lisis
                let evalPerc = 100 / (1 + Math.exp(-0.003 * score));
                evalPerc = Math.max(2, Math.min(98, evalPerc));
                $('#eval-fill').css('width', evalPerc + '%');
                
                if(State.mode !== 'tactics') UI.updateCoach(score);
            }
        }
        if(msg.includes('score mate')) {
             const m = msg.match(/score mate (-?\d+)/);
             if(m) {
                 let mate = parseInt(m[1]);
                 if(State.game.turn() === 'b') mate = -mate;
                 let evalPerc = mate > 0 ? 100 : 0;
                 $('#eval-fill').css('width', evalPerc + '%');
             }
        }
    },
    analyze: function() {
        State.engine.postMessage('stop');
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage('go depth 10');
    }
};

// --- L√ìGICA JUEGO ---
const Game = {
    checkStatus: function() {
        if(State.game.in_checkmate()) {
            let winner = State.game.turn() === 'w' ? 'Negras' : 'Blancas';
            UI.feedback("¬°Jaque Mate!", "success");
            $('#coach-display').html(`<span class="tag end">üèÜ Ganan ${winner}</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        if(State.game.in_draw() || State.game.in_stalemate() || State.game.in_threefold_repetition()) {
            UI.feedback("¬°Tablas!", "warn");
            $('#coach-display').html(`<span class="tag end">¬Ω - ¬Ω Tablas</span>`);
            State.engine.postMessage('stop');
            return true;
        }
        return false;
    },
    onDragStart: function(s, p) {
        if(State.game.game_over()) return false;
        if(State.mode === 'opening') return false; 
        if(State.mode === 'play') {
            const myColor = $('#cfg-play-color').val();
            if((myColor==='w' && p.startsWith('b')) || (myColor==='b' && p.startsWith('w'))) return false;
        }
        if(State.mode === 'tactics') {
            if((State.game.turn()==='w' && p.startsWith('b')) || (State.game.turn()==='b' && p.startsWith('w'))) return false;
        }
        return true;
    },
    onDrop: function(s, t) {
        // TACTICA (L√≥gica Corregida)
        if(State.mode === 'tactics') {
            const temp = new Chess(State.game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'});
            if(m) {
                // Comparar con index 1 (Respuesta del jugador)
                const correct = State.currentPuzzle.moves[State.currentPuzzle.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    State.game.move({from:s, to:t, promotion:'q'});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++; // Mover al siguiente (rival)
                    
                    UI.feedback("¬°Bien!", "success");
                    
                    // Respuesta Rival
                    if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                        setTimeout(() => {
                            State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                            State.board.position(State.game.fen());
                            State.currentPuzzle.index++; // Preparar siguiente
                        }, 500);
                    } else {
                        UI.feedback("¬°Resuelto!", "success");
                    }
                    return;
                }
            }
            UI.feedback("Incorrecto", "error");
            return 'snapback';
        }

        // JUEGO
        if(State.mode === 'play') {
            const m = State.game.move({from:s, to:t, promotion:'q'});
            if(!m) return 'snapback';
            State.board.position(State.game.fen());
            State.redoStack = [];
            
            if(Game.checkStatus()) return; // Check Mate

            // Turno IA
            setTimeout(() => {
                const lvl = parseInt($('#cfg-play-level').val());
                let depth = 5; 
                if(lvl > 5) depth = 10; if(lvl > 15) depth = 15;
                State.engine.postMessage(`setoption name Skill Level value ${lvl}`);
                Engine.go(depth);
            }, 250);
        }
    },
    undo: function() {
        if(State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) return; 
        if(State.mode === 'opening') {
            State.game.undo(); State.board.position(State.game.fen());
            if(State.currentLesson.index > 0) State.currentLesson.index--;
            Engine.analyze();
            return;
        }
        let m = State.game.undo();
        if(m) {
            State.redoStack.push(m);
            if(State.mode === 'play') { 
                let m2 = State.game.undo();
                if(m2) State.redoStack.push(m2);
            }
            State.board.position(State.game.fen());
            Engine.analyze();
        }
    },
    redo: function() {
        if(State.mode === 'opening') {
            if(State.currentLesson.index < State.currentLesson.moves.length) {
                State.game.move(State.currentLesson.moves[State.currentLesson.index]);
                State.board.position(State.game.fen());
                State.currentLesson.index++;
                Engine.analyze();
            }
            return;
        }
        if(State.redoStack.length > 0) {
            let m = State.redoStack.pop();
            State.game.move(m);
            State.board.position(State.game.fen());
            if(State.mode === 'play' && State.redoStack.length > 0) {
                State.game.move(State.redoStack.pop());
                State.board.position(State.game.fen());
            }
            Engine.analyze();
        }
    },
    showSolution: function() {
        if(State.mode !== 'tactics') return;
        const move = State.currentPuzzle.moves[State.currentPuzzle.index];
        if(move) {
            State.game.move(move, {sloppy:true});
            State.board.position(State.game.fen());
            State.currentPuzzle.index++;
            if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                setTimeout(() => {
                    State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++;
                }, 500);
            }
        }
    }
};

// --- APP CONTROLLER ---
const App = {
    init: function() {
        State.openings = JSON.parse(JSON.stringify(BaseOpenings));
        State.tactics = JSON.parse(JSON.stringify(BaseTactics));
        DB.loadFromMemory();
        
        State.board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: Game.onDragStart,
            onDrop: Game.onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        
        Engine.init();
        UI.refreshSelects();
    },
    goHome: function() {
        $('#view-board').removeClass('active');
        $('#view-home').show();
        State.mode = 'menu';
        State.engine.postMessage('stop');
    },
    enterBoard: function(mode) {
        State.mode = mode;
        $('#view-home').hide();
        $('#view-board').addClass('active');
        setTimeout(() => State.board.resize(), 100);
        $('#btn-solution').addClass('hidden');
        $('#btn-next').addClass('hidden');
    },
    next: function() {
        if(State.mode === 'tactics') this.startTactics();
        if(State.mode === 'opening') {
            let currentIdx = parseInt($('#cfg-opening-select').val()) || 0;
            let nextIdx = (currentIdx + 1) % State.openings.length;
            $('#cfg-opening-select').val(nextIdx);
            this.startOpening();
        }
    },
    startPlay: function() {
        this.enterBoard('play');
        State.game.reset(); State.board.start(); State.redoStack = [];
        const color = $('#cfg-play-color').val();
        State.board.orientation(color === 'w' ? 'white' : 'black');
        
        $('#gh-title').text("Partida vs Stockfish");
        $('#gh-subtitle').text("Nivel: " + $('#cfg-play-level option:selected').text());
        $('#coach-display').html('<span class="tag book">Nueva Partida</span>');
        
        if(color === 'b') setTimeout(() => Engine.go(5), 500);
        else Engine.analyze();
    },
    startOpening: function() {
        const idx = $('#cfg-opening-select').val();
        if(idx === "") return alert("Selecciona una apertura");
        
        const op = State.openings[idx];
        this.enterBoard('opening');
        State.game.reset(); State.board.start(); State.board.orientation('white');
        
        const clean = op.pgn.replace(/\d+\./g,'').replace(/\*/g,'').split(/\s+/).filter(x => x);
        State.currentLesson = { moves: clean, index: 0 };
        
        $('#gh-title').text(op.name);
        $('#gh-subtitle').text(`ECO: ${op.eco}`);
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Estudiando</span>`);
        Engine.analyze();
    },
    startTactics: function() {
        const elo = $('#cfg-tactics-elo').val();
        const puzzles = State.tactics[elo] || [];
        if(puzzles.length === 0) return alert("No hay puzzles de este nivel.");
        
        const p = puzzles[Math.floor(Math.random() * puzzles.length)];
        
        this.enterBoard('tactics');
        
        // 1. Cargar FEN
        State.game.load(p.fen);
        
        // 2. JUGAR MOVIMIENTO DEL RIVAL (Index 0)
        if(p.moves && p.moves.length > 0) {
            State.game.move(p.moves[0], {sloppy:true});
        }
        
        // 3. Orientar al jugador
        State.board.position(State.game.fen());
        const userColor = State.game.turn() === 'w' ? 'white' : 'black';
        State.board.orientation(userColor);
        
        // 4. Esperar respuesta (Index 1)
        State.currentPuzzle = { moves: p.moves, index: 1 };
        
        $('#gh-title').text(`T√°ctica [${elo}]`);
        $('#gh-subtitle').text(p.theme ? `Tema: ${p.theme}` : `ID: ${p.id}`);
        $('#btn-solution').removeClass('hidden');
        $('#btn-next').removeClass('hidden'); 
        $('#coach-display').html(`<span class="tag book">Juegan ${userColor==='white'?'Blancas':'Negras'}</span>`);
    }
};

const UI = {
    refreshSelects: function() {
        const s = $('#cfg-opening-select').empty().append('<option value="">-- Selecciona --</option>');
        State.openings.forEach((o, i) => s.append(new Option(`[${o.eco}] ${o.name}`, i)));
        $('#lbl-opening-count').text(State.openings.length);
        let totalP = 0;
        Object.values(State.tactics).forEach(arr => totalP += arr.length);
        $('#lbl-tactics-count').text(totalP);
    },
    feedback: function(msg, type) {
        const el = $('#feedback');
        el.text(msg).removeClass('success error').addClass('show ' + type);
        setTimeout(() => el.removeClass('show'), 1000);
    },
    updateCoach: function(score) {
        let delta = score - State.lastScore;
        if(State.game.turn() === 'w') delta = -delta; 
        let tag = "";
        if(delta < -200) tag = "<span class='tag bad'>Error Grave</span>";
        else if(delta < -80) tag = "<span class='tag bad'>Error</span>";
        else if(delta < -30) tag = "<span class='tag warn'>Imprecisi√≥n</span>";
        else if(delta > 30) tag = "<span class='tag good'>Buena</span>";
        else tag = "<span class='tag book'>Normal</span>";
        $('#coach-display').html(tag);
        State.lastScore = score;
    },
    updateEval: function(score) {
        let p = 100 / (1 + Math.exp(-0.003 * score)); // Sigmoide
        if(State.game.turn() === 'b') p = 100 - p;
        p = Math.max(5, Math.min(95, p));
        $('#eval-fill').css('width', p + '%');
    }
};

const DB = {
    loadOpenings: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); let c = 0;
            lines.forEach(l => {
                const p = l.split('\t');
                if(p.length >= 3 && p[p.length-1].length > 3) {
                    State.openings.push({eco:p[0], name:p[1], pgn:p[p.length-1].trim()});
                    c++;
                }
            });
            Storage.save(); UI.refreshSelects(); alert(`+${c} Aperturas`);
        };
        reader.readAsText(file);
    },
    loadTactics: function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n'); let c = 0; const isComma = lines[0].includes(',');
            
            const MAX_PUZZLES = 20000;
            let currentTotal = 0;
            Object.values(State.tactics).forEach(arr => currentTotal += arr.length);
            if(currentTotal >= MAX_PUZZLES) return alert("L√≠mite de 20,000 ejercicios alcanzado.");

            for(let i=0; i < lines.length; i++) {
                if(currentTotal >= MAX_PUZZLES) break;
                if(!lines[i]) continue;
                const cols = lines[i].split(isComma ? ',' : '\t');
                if(cols.length > 3) {
                    const r = parseInt(cols[3]);
                    if(!isNaN(r)) {
                        let k = "800";
                        if(r >= 2400) k = "2400"; else if(r >= 1600) k = "1600";
                        if(!State.tactics[k]) State.tactics[k] = [];
                        let th = cols[7] ? cols[7].trim() : "";
                        State.tactics[k].push({id:cols[0], fen:cols[1], moves:cols[2].split(' '), theme: th});
                        c++; currentTotal++;
                    }
                }
            }
            Storage.save(); UI.refreshSelects(); alert(`+${c} Puzzles`);
        };
        reader.readAsText(file);
    },
    loadFromMemory: function() {
        const op = localStorage.getItem('ad_openings');
        const tac = localStorage.getItem('ad_tactics');
        if(op) State.openings = JSON.parse(op);
        if(tac) State.tactics = JSON.parse(tac);
    }
};

const Storage = {
    save: function() {
        try {
            localStorage.setItem('ad_openings', JSON.stringify(State.openings));
            localStorage.setItem('ad_tactics', JSON.stringify(State.tactics));
        } catch(e) { alert("Memoria llena."); }
    },
    clear: function() { localStorage.clear(); location.reload(); }
};

$(document).ready(function() { App.init(); });
</script>
</body>
</html>
