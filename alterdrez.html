<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Suite Profesional</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS GENERALES Y MODERNIZACI√ìN --- */
        :root {
            --bg: #0b0e14;
            --panel: #151922;
            --accent: #00bcd4; /* Cyan m√°s moderno */
            --text: #eceff1;
            --text-muted: #90a4ae;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
            --glass: rgba(21, 25, 34, 0.85);
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            background-image: radial-gradient(circle at 50% 0%, #1a2733 0%, #0b0e14 70%);
        }

        /* SCROLLBAR PERSONALIZADO */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #37474f; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        header { 
            width: 100%; padding: 15px 30px; 
            background: rgba(11, 14, 20, 0.8); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: 800; color: var(--accent); text-shadow: 0 0 15px rgba(0, 188, 212, 0.4); }

        .btn-help {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            transition: all 0.3s; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .btn-help:hover { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }

        .main-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 25px;
            width: 100%; max-width: 1400px; padding: 30px 20px;
        }

        /* --- MODAL DE BIENVENIDA (NUEVO) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: 0.4s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: #1c212c; width: 90%; max-width: 900px; max-height: 90vh;
            border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow-y: auto; padding: 0; display: flex; flex-direction: column;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header {
            padding: 25px; background: linear-gradient(90deg, #151922 0%, #1c2331 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;
        }
        .modal-body { padding: 30px; color: #cfd8dc; line-height: 1.6; }
        
        .tutorial-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 768px) { .tutorial-grid { grid-template-columns: 1fr; } }

        .step-card {
            background: rgba(255,255,255,0.03); padding: 20px; border-radius: 10px;
            border-left: 4px solid #555; transition: transform 0.2s;
        }
        .step-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.05); }
        .step-card h4 { margin: 0 0 10px 0; color: #fff; font-size: 1.1rem; }
        .step-card p { font-size: 0.9rem; color: #b0bec5; margin: 0; }
        
        .download-btn {
            display: inline-block; background: linear-gradient(45deg, #00bcd4, #00e5ff); 
            color: #000; font-weight: bold; padding: 12px 25px; border-radius: 30px; 
            text-decoration: none; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,188,212,0.3);
            transition: 0.3s; text-align: center; width: 100%;
        }
        .download-btn:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,188,212,0.5); }

        .video-container {
            width: 100%; border-radius: 10px; overflow: hidden; margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #333;
        }
        video { width: 100%; display: block; }

        /* FUN FACTS */
        .fun-facts-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px;
        }
        .fact-box {
            padding: 15px; border-radius: 8px; color: #fff; position: relative; overflow: hidden;
        }
        .fact-box h5 { margin: 0 0 5px 0; font-size: 0.85rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .fact-box p { margin: 0; font-size: 0.8rem; font-weight: 300; }
        .fact-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .fact-2 { background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%); }
        .fact-3 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

        .btn-close-modal {
            background: #fff; color: #000; border: none; padding: 12px 30px; 
            font-weight: bold; font-size: 1rem; border-radius: 8px; cursor: pointer;
            margin-top: 20px; align-self: center; width: auto;
        }
        .btn-close-modal:hover { background: #eee; }

        /* --- FIN ESTILOS NUEVOS --- */

        /* ZONA TABLERO */
        .board-section { flex: 1; min-width: 300px; max-width: 650px; }
        .board-container {
            width: 100%; touch-action: none;
            border: 0 solid #222; border-radius: 6px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            position: relative; overflow: hidden;
        }

        .lesson-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 15px 25px; border-radius: 8px;
            text-align: center; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 10; border: 1px solid var(--accent); font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .lesson-feedback.show { opacity: 1; }
        .lesson-feedback.error { border-color: var(--error); color: var(--error); box-shadow: 0 0 15px rgba(255,23,68,0.3); }
        .lesson-feedback.success { border-color: var(--success); color: var(--success); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        .lesson-feedback.tactics { border-color: var(--tactics); color: var(--tactics); box-shadow: 0 0 15px rgba(213,0,249,0.3); }

        .eval-bar-wrapper { height: 6px; background: #263238; border-radius: 3px; overflow: hidden; display: flex; margin-bottom: 10px; }
        .eval-fill { height: 100%; width: 50%; background: #fff; transition: width 0.5s ease, background 0.3s; box-shadow: 0 0 10px #fff; }

        /* PANELES */
        .sidebar { flex: 1; min-width: 320px; max-width: 420px; display: flex; flex-direction: column; gap: 20px; }
        .panel { 
            background: var(--panel); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 12px; padding: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .panel:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .panel h3 { margin: 0 0 15px 0; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; letter-spacing: 1px; font-weight: 600;}

        /* UTILIDADES UI */
        label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
        select, button, input[type="text"] {
            width: 100%; padding: 12px; background: #1c212c; border: 1px solid #37474f; color: #eceff1;
            border-radius: 6px; font-family: inherit; margin-bottom: 12px; cursor: pointer; font-size: 0.9rem;
            transition: border 0.2s, background 0.2s; outline: none;
        }
        select:focus, input:focus { border-color: var(--accent); background: #232936; }
        input[type="text"] { cursor: text; }
        button { font-weight: 600; letter-spacing: 0.5px; }
        button:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .btn-row { display: flex; gap: 10px; }
        .hidden { display: none; }
        
        /* Botones espec√≠ficos de Carga */
        .btn-db-tactics { 
            background: rgba(213, 0, 249, 0.05); border: 1px dashed var(--tactics); 
            font-size: 0.8rem; margin-top:5px; color: var(--tactics); 
        }
        .btn-db-tactics:hover { background: var(--tactics); color: white; }
        
        .btn-db-opening { 
            background: rgba(0, 230, 118, 0.05); border: 1px dashed var(--success); 
            font-size: 0.8rem; margin-top:5px; color: var(--success);
        }
        .btn-db-opening:hover { background: var(--success); color: white; }

        .lesson-status { font-size: 1rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; border-left: 3px solid var(--accent); padding-left: 10px; }
        .tactics-info { font-size: 0.9rem; color: #b39ddb; margin-bottom: 8px; min-height: 20px;}
        .tactics-turn { font-weight: bold; color: var(--tactics); font-size: 1rem; }

        select { max-height: 200px; }
        
        /* ENTRENADOR */
        .coach-msg { font-size: 0.95rem; line-height: 1.5; color: #fff; margin-bottom: 15px; min-height: 45px; font-weight: 300; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; letter-spacing: 0.5px; }
        .tag.good { background: rgba(0,230,118,0.15); color: var(--success); border-color: rgba(0,230,118,0.3); }
        .tag.bad { background: rgba(255,23,68,0.15); color: var(--error); border-color: rgba(255,23,68,0.3); }
        .tag.warn { background: rgba(255,234,0,0.15); color: var(--warn); border-color: rgba(255,234,0,0.3); }
        .tag.info { background: rgba(77,184,255,0.15); color: var(--accent); border-color: rgba(77,184,255,0.3); }

        /* Thinking animation */
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        #thinkingIndicator { animation: pulse 1.5s infinite; font-weight: 600; letter-spacing: 1px; }

    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <h1 style="display:flex; align-items:center; gap:10px;">
            Alter.Drez <span style="font-size:0.8rem; background:var(--panel); padding:2px 8px; border-radius:4px; color:#aaa; font-weight:400; letter-spacing:0;">PRO v3.0</span>
        </h1>
    </div>
    <button class="btn-help" onclick="toggleModal()" title="Ver Tutorial y Descargas"><i class="bi bi-question-lg"></i></button>
</header>

<!-- MODAL DE BIENVENIDA -->
<div id="welcomeModal" class="modal-overlay active">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0; color:var(--accent);"><i class="bi bi-rocket-takeoff-fill"></i> Bienvenido a Alter.Drez</h2>
            <button onclick="toggleModal()" style="background:transparent; border:none; color:#fff; font-size:1.5rem; padding:0; width:auto; margin:0;"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="modal-body">
            <p style="font-size:1.1rem; color:#fff;">Has accedido a la plataforma de entrenamiento t√°ctico m√°s ligera y potente. Sigue estos pasos para desbloquear todo el potencial de la IA y las bases de datos masivas.</p>
            
            <div class="tutorial-grid">
                <!-- COLUMNA IZQUIERDA: DESCARGAS -->
                <div>
                    <div class="step-card" style="border-color: var(--accent);">
                        <h4><i class="bi bi-database-fill-down"></i> 1. Descarga los Archivos</h4>
                        <p>Para no saturar tu navegador, los millones de ejercicios se cargan bajo demanda. Descarga el paquete oficial desde nuestro Drive seguro.</p>
                        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" class="download-btn">
                            <i class="bi bi-google"></i> Ir a Google Drive
                        </a>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <div class="step-card" style="border-color: var(--success); margin-bottom:10px;">
                            <h4><i class="bi bi-filetype-tsv"></i> Archivos .TSV</h4>
                            <p>√ösalos en la secci√≥n <b>APERTURAS</b>. Contienen miles de l√≠neas te√≥ricas (ECO).</p>
                        </div>
                        <div class="step-card" style="border-color: var(--tactics);">
                            <h4><i class="bi bi-filetype-csv"></i> Archivos .CSV</h4>
                            <p>√ösalos en la secci√≥n <b>T√ÅCTICA</b>. Contienen millones de puzzles de Lichess.</p>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: VIDEO -->
                <div>
                    <h4 style="margin-top:0; color:#fff;"><i class="bi bi-play-circle"></i> Video Tutorial R√°pido</h4>
                    <p style="font-size:0.85rem;">Aprende a importar las bases de datos en 30 segundos.</p>
                    <div class="video-container">
                        <video controls>
                            <source src="tutorial.mp4" type="video/mp4">
                            Tu navegador no soporta video.
                        </video>
                    </div>
                </div>
            </div>

            <!-- SABIAS QUE -->
            <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-top:30px;">
                <i class="bi bi-lightbulb-fill" style="color:#ffea00;"></i> Curiosidades del Ajedrez
            </h3>
            <div class="fun-facts-container">
                <div class="fact-box fact-1">
                    <h5>Inmensidad</h5>
                    <p>Hay m√°s posiciones posibles en un juego de ajedrez (N√∫mero de Shannon) que √°tomos en el universo observable.</p>
                    <i class="bi bi-infinity" style="position:absolute; bottom:-10px; right:5px; font-size:4rem; opacity:0.2;"></i>
                </div>
                <div class="fact-box fact-2">
                    <h5>La m√°s larga</h5>
                    <p>La partida m√°s larga posible te√≥ricamente tendr√≠a 5,949 movimientos. La m√°s larga jugada dur√≥ 20 horas.</p>
                    <i class="bi bi-hourglass-split" style="position:absolute; bottom:-10px; right:5px; font-size:3rem; opacity:0.2;"></i>
                </div>
                <div class="fact-box fact-3">
                    <h5>Checkmate</h5>
                    <p>La palabra "Jaque Mate" proviene del persa "Shah Mat", que significa "El Rey est√° indefenso".</p>
                    <i class="bi bi-translate" style="position:absolute; bottom:-10px; right:5px; font-size:3rem; opacity:0.2;"></i>
                </div>
            </div>

            <div style="text-align:center;">
                <button class="btn-close-modal" onclick="toggleModal()">Entendido, ¬°A jugar!</button>
            </div>
        </div>
    </div>
</div>

<div class="main-container">
    
    <!-- IZQUIERDA: TABLERO -->
    <div class="board-section">
        <div class="eval-bar-wrapper">
            <div id="evalFill" class="eval-fill"></div>
        </div>
        
        <div class="board-container">
            <div id="board"></div>
            <div id="lessonFeedback" class="lesson-feedback"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.9rem; color:#90a4ae; font-weight:500;">
            <span id="statusText"><i class="bi bi-circle-fill" style="font-size:0.6rem; color:var(--success);"></i> Sistema Listo</span>
            <span id="thinkingIndicator" style="display:none; color:var(--accent);"><i class="bi bi-cpu"></i> IA Calculando...</span>
        </div>
    </div>

    <!-- DERECHA: CONTROLES -->
    <div class="sidebar">

        <!-- 1. ACADEMIA DE APERTURAS (RENOMBRADO) -->
        <div class="panel" style="border-left: 3px solid var(--success);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3><i class="bi bi-mortarboard-fill"></i> Aperturas</h3>
                <span id="openingCountBadge" style="font-size:0.65rem; background:#1c2331; color:var(--success); padding:3px 8px; border-radius:10px; border:1px solid var(--success);">Base Inicial</span>
            </div>
            
            <div id="lessonControls">
                <!-- Buscador de aperturas -->
                <input type="text" id="openingSearch" placeholder="üîç Buscar apertura (ej: Sicilian)...">
                
                <select id="openingSelect">
                    <option value="">-- Seleccionar Lecci√≥n --</option>
                </select>

                <!-- IMPORTAR DB APERTURAS -->
                <input type="file" id="openingDbInput" accept=".csv,.tsv,.txt" style="display:none">
                <button onclick="document.getElementById('openingDbInput').click()" class="btn-db-opening">
                    <i class="bi bi-upload"></i> Cargar DB Aperturas (.tsv)
                </button>
                
                <div id="lessonActiveUI" class="hidden" style="margin-top:15px; padding-top:10px; border-top:1px dashed #333;">
                    <div class="lesson-status" id="lessonInstruction">Tu turno...</div>
                    <div style="font-size: 0.85rem; color: #b0bec5; margin-bottom: 10px; font-style: italic;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="background: #263238; border-color: #37474f;">Salir de la Lecci√≥n</button>
                </div>
            </div>
        </div>

        <!-- 2. T√ÅCTICA -->
        <div class="panel" style="border-left: 3px solid var(--tactics);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3><i class="bi bi-lightning-charge-fill"></i> T√°ctica</h3>
                <span id="dbCountBadge" style="font-size:0.65rem; background:#1c2331; color:var(--tactics); padding:3px 8px; border-radius:10px; border:1px solid var(--tactics);">Base Inicial</span>
            </div>
            
            <div id="tacticsControls">
                <div class="btn-row">
                    <select id="tacticsEloSelect" style="margin-bottom:0;">
                        <option value="">-- Nivel (Elo) --</option>
                        <option value="800">800 (Principiante)</option>
                        <option value="1000">1000 (Aficionado)</option>
                        <option value="1300">1300 (Intermedio)</option>
                        <option value="1600">1600 (Club)</option>
                        <option value="2000">2000 (Experto)</option>
                        <option value="2400">2400 (Maestro)</option>
                        <option value="2800">2800 (GM)</option>
                    </select>
                </div>

                <select id="tacticsPuzzleSelect" disabled style="margin-top:10px;">
                    <option value="">-- Seleccionar --</option>
                </select>

                <input type="file" id="dbInput" accept=".csv" style="display:none">
                <button onclick="document.getElementById('dbInput').click()" class="btn-db-tactics">
                    <i class="bi bi-upload"></i> Cargar DB Puzzles (.csv)
                </button>

                <div id="tacticsActiveUI" class="hidden" style="margin-top:15px; padding-top:10px; border-top:1px dashed #333;">
                    <div class="tactics-info" id="tacticsDesc"></div>
                    <div class="tactics-turn" id="tacticsTurnIndicator"></div>
                    <button id="btnQuitTactics" style="background: #263238; border-color: #37474f; margin-top:5px;">Salir de T√°ctica</button>
                </div>
            </div>
        </div>

        <!-- 3. ENTRENADOR -->
        <div class="panel" id="coachPanel">
            <h3><i class="bi bi-robot"></i> Entrenador Virtual</h3>
            <div class="coach-msg" id="coachMsg">Esperando que inicies una partida para analizar...</div>
            <div class="coach-tags" id="coachTags"></div>
        </div>

        <!-- 4. JUGAR VS STOCKFISH -->
        <div class="panel">
            <h3><i class="bi bi-cpu-fill"></i> Jugar vs Stockfish</h3>
            
            <div class="btn-row">
                <div style="width: 50%;">
                    <label>Tu Color</label>
                    <select id="playerColor">
                        <option value="w">Blancas</option>
                        <option value="b">Negras</option>
                    </select>
                </div>
                <div style="width: 50%;">
                    <label>Nivel de Juego</label>
                    <select id="skillLevel">
                        <option value="0">Principiante (800)</option>
                        <option value="3">Aficionado (1000)</option>
                        <option value="6">Intermedio (1300)</option>
                        <option value="10" selected>Club (1600)</option>
                        <option value="14">Experto (2000)</option>
                        <option value="17">Maestro (2400)</option>
                        <option value="20">Grand Master (2800+)</option>
                    </select>
                </div>
            </div>

            <div class="btn-row">
                <select id="gameMode">
                    <option value="pvc">Modo Competitivo (IA Juega)</option>
                    <option value="analysis">Modo An√°lisis (T√∫ mueves ambos)</option>
                </select>
            </div>

            <div class="btn-row">
                <button id="btnNewGame"><i class="bi bi-arrow-clockwise"></i> Nueva Partida</button>
                <button id="btnFlip" style="width: 40%;"><i class="bi bi-arrow-down-up"></i></button>
            </div>
            
            <div class="btn-row" style="margin-top: 5px;">
                <button id="btnUndo"><i class="bi bi-arrow-left"></i></button>
                <button id="btnRedo"><i class="bi bi-arrow-right"></i></button>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- CONTROL DEL MODAL ---
    function toggleModal() {
        const m = document.getElementById('welcomeModal');
        if(m.classList.contains('active')) m.classList.remove('active');
        else m.classList.add('active');
    }

    // --- VARIABLES GLOBALES ---
    const game = new Chess();
    let board = null;
    let engine = null;
    let redoStack = [];
    
    // Estados
    let currentMode = 'pvc'; 
    let lessonState = { active: false, moves: [], index: 0, currentOpening: null };
    let tacticsState = { active: false, puzzle: null, index: 0 };
    let isEnginePlaying = false; 

    // --- BASE DE DATOS DE APERTURAS (INICIAL) ---
    let openingsList = [
        { eco: "C50", name: "Italian Game", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bc4" },
        { eco: "C60", name: "Ruy Lopez", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bb5" },
        { eco: "B20", name: "Sicilian Defense", pgn: "1. e4 c5" },
        { eco: "B01", name: "Scandinavian Defense", pgn: "1. e4 d5" },
        { eco: "A45", name: "Queen's Pawn Game", pgn: "1. d4 Nf6" },
        { eco: "D00", name: "Queen's Pawn Game: Chigorin", pgn: "1. d4 d5 2. Nc3" },
        { eco: "C00", name: "French Defense", pgn: "1. e4 e6" },
        { eco: "B10", name: "Caro-Kann Defense", pgn: "1. e4 c6" }
    ];

    // --- BASE DE DATOS T√ÅCTICA (INICIAL) ---
    let tacticsDB = {
        "800": [{ id: "1", name: "Mate Pasillo", fen: "6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves: ["Rd8#"], desc: "Mate en 1." }],
        "1000": [{ id: "2", name: "Mate Pastor", fen: "r1bqkb1r/pppp1ppp/2n5/4P3/2B1n3/5Q2/PPP2PPP/RNB1K1NR w KQkq - 0 6", moves: ["Qxf7#"], desc: "Ataca f7." }],
        "1300": [], "1600": [], "2000": [], "2400": [], "2800": []
    };

    // --- GESTOR DE APERTURAS ---
    const OpeningManager = {
        importFile: function(file) {
            const reader = new FileReader();
            reader.onload = function(e) { OpeningManager.parseECO(e.target.result); };
            reader.readAsText(file);
        },
        parseECO: function(text) {
            const lines = text.split('\n');
            let newOpenings = [];
            let count = 0;
            for(let line of lines) {
                if(!line || line.startsWith('#')) continue;
                let parts = line.split('\t');
                if(parts.length < 3) parts = line.split(','); 
                if(parts.length >= 3) {
                    let eco = parts[0].trim();
                    let name = parts[1].trim();
                    let pgn = parts[parts.length-1].trim();
                    if(pgn.length > 2) { newOpenings.push({ eco: eco, name: name, pgn: pgn }); count++; }
                }
            }
            if(count > 0) {
                openingsList = newOpenings;
                alert(`¬°√âxito! Cargadas ${count} aperturas.`);
                $('#openingCountBadge').text(`${count} Ops`);
                populateOpeningsGUI('');
            } else alert("No se detect√≥ formato v√°lido.");
        },
        pgnToArray: function(pgnString) {
            const tempGame = new Chess();
            const cleanPgn = pgnString.replace(/\*/g, '').replace(/1-0/g,'').replace(/0-1/g,'').replace(/1\/2-1\/2/g,'');
            if(!tempGame.load_pgn(cleanPgn)) {
                tempGame.reset();
                const tokens = cleanPgn.replace(/\d+\./g, '').split(/\s+/);
                for(let t of tokens) { if(t) tempGame.move(t, {sloppy:true}); }
            }
            return tempGame.history();
        }
    };

    // --- GESTOR DE T√ÅCTICA ---
    const TacticsManager = {
        importCSV: function(file) {
            const reader = new FileReader();
            reader.onload = function(e) { TacticsManager.parse(e.target.result); };
            reader.readAsText(file);
        },
        parse: function(csvText) {
            const lines = csvText.split('\n');
            let count = 0;
            tacticsDB = { "800":[], "1000":[], "1300":[], "1600":[], "2000":[], "2400":[], "2800":[] };
            for(let i=1; i < lines.length && count < 10000; i++) {
                const cols = lines[i].split(',');
                if(cols.length < 4) continue;
                const fen = cols[1];
                const moves = cols[2].split(' ');
                const rating = parseInt(cols[3]);
                let b = "800";
                if(rating>=2800) b="2800"; else if(rating>=2400) b="2400"; else if(rating>=2000) b="2000";
                else if(rating>=1600) b="1600"; else if(rating>=1300) b="1300"; else if(rating>=1000) b="1000";
                tacticsDB[b].push({ id: cols[0], name: `Puzzle ${rating}`, fen: fen, moves: moves, desc: "Encuentra la mejor l√≠nea" });
                count++;
            }
            $('#dbCountBadge').text(`${count} Puzzles`);
            alert(`Cargados ${count} ejercicios.`);
        }
    };

    // --- LECCIONES ---
    const LessonSystem = {
        start: function(index) {
            const op = openingsList[index];
            if (!op) return;
            this.stopOtherModes();
            const movesArray = OpeningManager.pgnToArray(op.pgn);
            lessonState = { active: true, moves: movesArray, index: 0, currentOpening: op };
            currentMode = 'lesson';
            $('#lessonActiveUI').removeClass('hidden');
            $('#lessonDescription').text(`${op.eco} - ${op.name}`);
            game.reset(); board.position('start'); board.orientation('white');
            this.updatePrompt();
        },
        updatePrompt: function() {
            if(lessonState.index >= lessonState.moves.length) { this.finish(); return; }
            const move = lessonState.moves[lessonState.index];
            const turn = game.turn() === 'w' ? 'Blancas' : 'Negras';
            $('#lessonInstruction').html(`<span style="color:var(--accent)">${turn}:</span> Juega <b>${move}</b>`);
            $('#statusText').html(`<i class="bi bi-mortarboard-fill"></i> Academia: ${lessonState.currentOpening.name}`);
        },
        checkMove: function(moveObj) {
            const expected = lessonState.moves[lessonState.index];
            if (moveObj.san === expected) {
                this.feedback("¬°Correcto!", "success");
                lessonState.index++;
                if(lessonState.index < lessonState.moves.length) setTimeout(() => this.playAuto(), 500);
                else this.finish();
                return true;
            }
            this.feedback(`Error. La l√≠nea es ${expected}`, "error");
            return false;
        },
        playAuto: function() {
            if(!lessonState.active) return;
            game.move(lessonState.moves[lessonState.index]);
            board.position(game.fen());
            lessonState.index++;
            this.updatePrompt();
        },
        feedback: function(msg, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(msg).removeClass('success error tactics').addClass('show '+type);
            setTimeout(() => $fb.removeClass('show'), 1500);
        },
        finish: function() { $('#lessonInstruction').html(`<span style="color:var(--success)">¬°Completado!</span>`); currentMode = 'analysis'; },
        stop: function() { lessonState.active = false; $('#lessonActiveUI').addClass('hidden'); currentMode = 'analysis'; },
        stopOtherModes: function() { TacticsSystem.stop(); }
    };

    // --- T√ÅCTICA ---
    const TacticsSystem = {
        start: function(elo, idx) {
            const puzzle = tacticsDB[elo][idx];
            if (!puzzle) return;
            this.stopOtherModes();
            tacticsState = { active: true, puzzle: puzzle, index: 0 };
            currentMode = 'tactics';
            $('#tacticsActiveUI').removeClass('hidden');
            $('#tacticsDesc').text(puzzle.desc);
            game.load(puzzle.fen);
            board.position(puzzle.fen);
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            this.updatePrompt();
        },
        updatePrompt: function() { $('#tacticsTurnIndicator').text(`Juegan ${game.turn()==='w'?'Blancas':'Negras'}`); },
        checkMove: function(moveObj) {
            const expected = tacticsState.puzzle.moves[tacticsState.index];
            let ok = (moveObj.san === expected) || (moveObj.from+moveObj.to+(moveObj.promotion||'') === expected);
            if (ok) {
                this.feedback("¬°Bien!", "tactics");
                tacticsState.index++;
                if (tacticsState.index < tacticsState.puzzle.moves.length) setTimeout(() => this.playResponse(), 600);
                else this.finish();
                return true;
            }
            this.feedback("Mal", "error");
            return false;
        },
        playResponse: function() {
            if(!tacticsState.active) return;
            const m = tacticsState.puzzle.moves[tacticsState.index];
            if(m) { game.move(m, {sloppy:true}); board.position(game.fen()); tacticsState.index++; }
            if(tacticsState.index >= tacticsState.puzzle.moves.length) this.finish();
        },
        feedback: function(msg, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(msg).removeClass('success error tactics').addClass('show '+type);
            setTimeout(() => $fb.removeClass('show'), 1000);
        },
        finish: function() { $('#tacticsTurnIndicator').html("<span style='color:lime'>¬°Resuelto!</span>"); },
        stop: function() { tacticsState.active = false; $('#tacticsActiveUI').addClass('hidden'); currentMode = 'analysis'; },
        stopOtherModes: function() { LessonSystem.stop(); }
    };

    // --- ENTRENADOR (OBSERVER) ---
    const Observer = {
        lastScore: 0,
        evaluate: function(game, score, pColor) {
            if(currentMode === 'lesson' || currentMode === 'tactics') return;
            
            let delta = score - this.lastScore;
            let msgs = [], tags = [];
            
            if (Math.abs(score) < 50) tags.push({text:"Igualdad", type:"info"});
            else if ((pColor==='w' && score>100) || (pColor==='b' && score<-100)) tags.push({text:"Vas Ganando", type:"good"});
            else if ((pColor==='w' && score<-100) || (pColor==='b' && score>100)) tags.push({text:"Vas Perdiendo", type:"bad"});

            const fen = game.fen();
            const moves = parseInt(fen.split(' ')[5]);

            if(moves < 8 && Math.abs(score) < 80) msgs.push("Apertura: Desarrolla piezas y controla el centro.");
            else if (Math.abs(delta) > 200) {
                msgs.push("¬°Cambio dr√°stico! Revisa el √∫ltimo movimiento.");
                tags.push({text:"Ojo T√°ctico", type:"warn"});
            } else {
                msgs.push("Busca mejorar tu posici√≥n poco a poco.");
            }

            $('#coachMsg').text(msgs[0]);
            $('#coachTags').empty();
            tags.forEach(t => $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`));
            this.lastScore = score;
        }
    };

    // --- INIT & UTILS ---
    function init() {
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
            .then(r=>r.blob()).then(blob=>{
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('uci');
                engine.onmessage = handleEngine;
                $('#statusText').html('<i class="bi bi-check-circle-fill" style="color:var(--success)"></i> Motor Listo');
            });

        // UI Events
        $('#openingDbInput').change(function() { if(this.files.length) OpeningManager.importFile(this.files[0]); });
        $('#openingSearch').on('input', function() { populateOpeningsGUI($(this).val()); });
        $('#openingSelect').change(function() { if($(this).val()!=='') LessonSystem.start($(this).val()); });
        $('#btnQuitLesson').click(() => LessonSystem.stop());
        
        $('#dbInput').change(function() { if(this.files.length) TacticsManager.importCSV(this.files[0]); });
        $('#tacticsEloSelect').change(updateTacticsList);
        $('#tacticsPuzzleSelect').change(function() { if($(this).val()) TacticsSystem.start($('#tacticsEloSelect').val(), $(this).val()); });
        $('#btnQuitTactics').click(() => TacticsSystem.stop());

        $('#btnNewGame').click(newGame);
        $('#btnUndo').click(undo); $('#btnRedo').click(redo); $('#btnFlip').click(()=>board.flip());

        populateOpeningsGUI('');
    }

    function populateOpeningsGUI(filter) {
        const $sel = $('#openingSelect').empty().append('<option value="">-- Seleccionar --</option>');
        const term = filter.toLowerCase();
        openingsList.forEach((op, idx) => {
            if(op.name.toLowerCase().includes(term) || op.eco.toLowerCase().includes(term)) {
                $sel.append(`<option value="${idx}">[${op.eco}] ${op.name}</option>`);
            }
        });
    }

    function updateTacticsList() {
        const elo = $('#tacticsEloSelect').val();
        const $sel = $('#tacticsPuzzleSelect').empty().append('<option value="">-- Seleccionar --</option>');
        if(elo && tacticsDB[elo]) {
            tacticsDB[elo].slice(0, 100).forEach((p, i) => $sel.append(`<option value="${i}">${p.name}</option>`));
            $sel.prop('disabled', false);
        } else $sel.prop('disabled', true);
    }

    // --- L√ìGICA DE JUEGO & ENGINE ---
    function handleEngine(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && isEnginePlaying) {
            const move = msg.split(' ')[1];
            game.move(move, {sloppy:true});
            board.position(game.fen());
            isEnginePlaying = false;
            $('#thinkingIndicator').hide();
            triggerAnalysis(); 
        }
        if(msg.startsWith('info') && msg.includes('score') && !msg.includes('lowerbound') && !msg.includes('upperbound')) {
            const match = msg.match(/score (cp|mate) (-?\d+)/);
            if(match) {
                let score = parseInt(match[2]);
                if(game.turn() === 'b') score = -score; 
                updateEvalBar(score, match[1]);
                Observer.evaluate(game, score, $('#playerColor').val());
            }
        }
    }

    function triggerAI() {
        if(currentMode !== 'pvc' || game.game_over()) return;
        isEnginePlaying = true;
        $('#thinkingIndicator').show();
        const level = parseInt($('#skillLevel').val());
        let depth = level < 5 ? 1 : (level < 10 ? 5 : (level < 15 ? 10 : 18));
        engine.postMessage(`setoption name Skill Level value ${level}`);
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage(`go depth ${depth}`);
    }

    function triggerAnalysis() {
        if(currentMode==='lesson'||currentMode==='tactics') return;
        engine.postMessage('stop');
        engine.postMessage(`setoption name Skill Level value 20`);
        engine.postMessage('position fen '+game.fen());
        engine.postMessage('go depth 10');
    }

    function updateEvalBar(score, type) {
        let per = 50;
        if(type==='mate') per = score > 0 ? 100 : 0;
        else {
            let sc = Math.max(-500, Math.min(500, score));
            per = 50 + (sc / 10);
        }
        $('#evalFill').css('width', per + '%');
    }
    
    // TABLERO
    function onDrop(src, tgt) {
        if(currentMode === 'lesson') {
            const t = new Chess(game.fen()); 
            if(t.move({from:src, to:tgt, promotion:'q'})) {
               if(LessonSystem.checkMove({san: t.history().pop()})) {
                   game.move({from:src, to:tgt, promotion:'q'}); board.position(game.fen());
               } 
            }
            return 'snapback';
        }
        if(currentMode === 'tactics') {
            const t = new Chess(game.fen()); const m = t.move({from:src, to:tgt, promotion:'q'});
            if(m && TacticsSystem.checkMove(m)) {
                game.move({from:src, to:tgt, promotion:'q'}); board.position(game.fen());
                return;
            }
            return 'snapback';
        }
        const move = game.move({from:src, to:tgt, promotion:'q'});
        if(!move) return 'snapback';
        board.position(game.fen()); redoStack = [];
        if(currentMode === 'pvc' && game.turn() !== $('#playerColor').val()) {
            setTimeout(triggerAI, 250);
        } else {
            triggerAnalysis();
        }
    }

    function onDragStart(s,p) {
        if(game.game_over() || isEnginePlaying) return false;
        if(currentMode==='pvc' && (($('#playerColor').val()==='w' && p.startsWith('b')) || ($('#playerColor').val()==='b' && p.startsWith('w')))) return false;
        if(currentMode==='lesson' && !lessonState.active) return false;
    }

    function newGame() {
        LessonSystem.stop(); TacticsSystem.stop(); game.reset(); board.start(); redoStack=[];
        currentMode = $('#gameMode').val();
        $('#statusText').text("Nueva Partida");
        if(currentMode === 'pvc' && $('#playerColor').val() === 'b') triggerAI();
        else triggerAnalysis();
    }
    
    function undo(){ if(!isEnginePlaying && currentMode!=='lesson' && currentMode!=='tactics') { game.undo(); if(currentMode==='pvc') game.undo(); board.position(game.fen()); triggerAnalysis(); }}
    function redo(){ if(!isEnginePlaying && redoStack.length && currentMode!=='lesson') { game.move(redoStack.pop()); if(currentMode==='pvc' && redoStack.length) game.move(redoStack.pop()); board.position(game.fen()); triggerAnalysis(); }}

    $(document).ready(() => {
        board = Chessboard('board', { draggable:true, position:'start', onDragStart:onDragStart, onDrop:onDrop, pieceTheme:'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        $(window).resize(board.resize);
        init();
    });
</script>
</body>
</html>
