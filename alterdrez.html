<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Jugable</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        :root {
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --accent: #4dabf7;
            --text: #e9ecef;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; 
        }

        h1 { margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }

        /* --- CONTENEDOR CENTRAL --- */
        .game-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
            padding: 10px;
        }

        /* --- TABLERO --- */
        .board-wrapper {
            width: 100%;
            max-width: 500px;
            /* CRÍTICO PARA MÓVIL: Evita el scroll al tocar el tablero */
            touch-action: none; 
        }
        
        #board {
            width: 100%;
        }

        /* --- PANELES --- */
        .sidebar {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .status-box { font-weight: bold; margin-bottom: 5px; }
        .thinking-text { color: var(--accent); font-style: italic; font-size: 0.9em; min-height: 1.2em; }

        /* Barra de Evaluación */
        .eval-wrapper {
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
            display: flex;
        }
        .eval-bar {
            height: 100%;
            width: 50%;
            background: #aaa;
            transition: width 0.5s ease, background 0.3s;
        }

        /* Botones */
        button {
            background: #333; border: 1px solid var(--accent); color: white;
            padding: 12px; width: 100%; border-radius: 5px; font-weight: bold;
            cursor: pointer; margin-top: 5px; transition: 0.2s;
        }
        button:active { transform: scale(0.98); }
        select {
            width: 100%; padding: 10px; background: #222; color: white; 
            border: 1px solid #444; border-radius: 5px; margin-bottom: 10px;
        }

        /* Resaltado de casillas */
        .highlight-current { box-shadow: inset 0 0 3px 3px yellow; }
        .highlight-move { box-shadow: inset 0 0 3px 3px #4dabf7; }

    </style>
</head>
<body>

    <h1>Alter.Drez</h1>

    <div class="game-area">
        <!-- Tablero -->
        <div class="board-wrapper">
            <div id="board"></div>
        </div>

        <!-- Controles -->
        <div class="sidebar">
            <div class="panel">
                <div class="status-box" id="status">Cargando...</div>
                <div class="thinking-text" id="thinking"></div>
                
                <div class="eval-wrapper">
                    <div id="evalBar" class="eval-bar"></div>
                </div>
                <div id="evalText" style="font-size: 0.8em; text-align: center; color: #888;">Evaluación</div>
            </div>

            <div class="panel">
                <label>Nivel de IA</label>
                <select id="skillLevel">
                    <option value="1">Nivel 1 (Muy Fácil)</option>
                    <option value="5">Nivel 5 (Fácil)</option>
                    <option value="10" selected>Nivel 10 (Normal)</option>
                    <option value="15">Nivel 15 (Difícil)</option>
                    <option value="20">Nivel 20 (Experto)</option>
                </select>
                <button id="resetBtn">Nueva Partida</button>
                <button id="undoBtn">Deshacer</button>
            </div>
            
            <div class="panel">
                <div id="pgn" style="font-family: monospace; font-size: 0.8em; color: #aaa; max-height: 100px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script>
        // --- CONFIGURACIÓN ---
        const game = new Chess();
        let board = null;
        let engine = null;
        
        // ESTADOS DEL MOTOR: 'IDLE' (Inactivo), 'PLAYING' (Calculando jugada), 'ANALYZING' (Calculando barra)
        let engineStatus = 'IDLE'; 
        
        let selectedSquare = null; // Para clic en móviles

        // --- INICIALIZACIÓN ---
        $(document).ready(function() {
            initStockfish();
            
            // Config del tablero
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('board', config);
            $(window).resize(board.resize);

            // Click Handlers para móviles (Tap to move)
            $('#board').on('click', '.square-55d63', handleSquareClick);
        });

        // --- LÓGICA STOCKFISH ---
        function initStockfish() {
            // Cargar Stockfish vía Blob para evitar errores de archivo local
            fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
                .then(r => r.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    engine = new Worker(url);
                    
                    engine.onmessage = (e) => {
                        const msg = e.data;
                        
                        // 1. SI LA IA DECIDE MOVER
                        if (msg.startsWith('bestmove')) {
                            // SOLO movemos si el estado es PLAYING
                            if (engineStatus === 'PLAYING') {
                                const move = msg.split(' ')[1];
                                game.move(move, { sloppy: true });
                                board.position(game.fen());
                                updateStatus();
                                
                                engineStatus = 'IDLE';
                                $('#thinking').text('');
                                
                                // Después de mover, analizamos la posición final (sin jugar)
                                startAnalysis();
                            }
                            // Si el estado era ANALYZING, ignoramos el 'bestmove' (no lo jugamos)
                        }
                        
                        // 2. LECTURA DE EVALUACIÓN (SCORE)
                        if (msg.startsWith('info') && msg.includes('score')) {
                            const scoreMatch = msg.match(/score (cp|mate) (-?\d+)/);
                            if(scoreMatch) {
                                let score = parseInt(scoreMatch[2]);
                                const type = scoreMatch[1];
                                
                                // Ajustar perspectiva (Stockfish da score para quien mueve)
                                if (game.turn() === 'b') score = -score;
                                
                                updateEvalBar(type, score);
                            }
                        }
                    };

                    engine.postMessage('uci');
                    updateStatus();
                });
        }

        // --- CONTROL DEL JUEGO ---

        function makeEngineMove() {
            if(game.game_over()) return;

            engineStatus = 'PLAYING'; // <--- IMPORTANTE: Marcamos que va a jugar
            $('#thinking').text('La IA está pensando...');
            
            const skill = $('#skillLevel').val();
            // Profundidad según nivel
            let depth = 10;
            if(skill < 5) depth = 5;
            else if(skill > 15) depth = 16;

            engine.postMessage(`setoption name Skill Level value ${skill}`);
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage(`go depth ${depth}`);
        }

        function startAnalysis() {
            // Pedimos análisis, pero marcamos estado ANALYZING para no mover piezas
            engineStatus = 'ANALYZING'; 
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage('go depth 10'); 
        }

        // --- ARRASTRAR Y SOLTAR (PC) ---
        function onDragStart(source, piece) {
            if (game.game_over() || engineStatus === 'PLAYING') return false;
            if (piece.search(/^b/) !== -1) return false; // Solo blancas
            
            removeHighlights();
            selectedSquare = source;
            highlightSquare(source, 'highlight-current');
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            removeHighlights();
            selectedSquare = null;

            if (move === null) return 'snapback';

            updateStatus();
            // Turno IA
            makeEngineMove();
        }

        // --- CLIC EN MÓVILES (TAP TO MOVE) ---
        function handleSquareClick() {
            if (game.game_over() || engineStatus === 'PLAYING') return;

            const square = $(this).attr('data-square');
            const piece = game.get(square);

            // 1. Si ya seleccioné origen, intento mover destino
            if (selectedSquare) {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });

                if (move !== null) {
                    // Movimiento válido
                    board.position(game.fen());
                    removeHighlights();
                    selectedSquare = null;
                    updateStatus();
                    makeEngineMove();
                } else {
                    // Movimiento inválido
                    removeHighlights();
                    // Si toqué otra pieza mía, cambio selección
                    if (piece && piece.color === 'w') {
                        selectedSquare = square;
                        highlightSquare(square, 'highlight-current');
                    } else {
                        selectedSquare = null;
                    }
                }
            } 
            // 2. Primera selección
            else {
                if (piece && piece.color === 'w') {
                    selectedSquare = square;
                    highlightSquare(square, 'highlight-current');
                }
            }
        }

        // --- UI UTILS ---
        function updateStatus() {
            let status = '';
            if (game.in_checkmate()) status = 'Jaque Mate. Fin.';
            else if (game.in_draw()) status = 'Tablas.';
            else {
                status = (game.turn() === 'w') ? 'Tu turno' : 'Turno IA';
                if (game.in_check()) status += ' (JAQUE)';
            }
            $('#status').text(status);
            $('#pgn').text(game.pgn());
        }

        function updateEvalBar(type, score) {
            let percent = 50;
            let text = "Igualdad";
            
            if (type === 'mate') {
                percent = score > 0 ? 100 : 0;
                text = `Mate en ${Math.abs(score)}`;
            } else {
                // Limitamos visualmente entre -500 y 500
                const val = Math.max(-500, Math.min(500, score));
                percent = 50 + (val / 10);
                
                const p = (score/100).toFixed(2);
                text = (score > 0 ? "+" : "") + p;
            }

            $('#evalBar').css('width', percent + '%');
            // Color de barra: Blanco si gana blanco, oscuro si gana negro
            $('#evalBar').css('background', percent > 50 ? '#fff' : '#444');
            $('#evalText').text(text);
        }

        function highlightSquare(sq, cls) {
            $('#board .square-' + sq).addClass(cls);
        }
        function removeHighlights() {
            $('#board .square-55d63').removeClass('highlight-current');
        }

        // Botones
        $('#resetBtn').on('click', function() {
            game.reset();
            board.start();
            engineStatus = 'IDLE';
            updateStatus();
            $('#thinking').text('');
            $('#evalBar').css('width', '50%');
        });

        $('#undoBtn').on('click', function() {
            if(engineStatus === 'PLAYING') return;
            game.undo(); game.undo();
            board.position(game.fen());
            updateStatus();
            startAnalysis();
        });

    </script>
</body>
</html>
