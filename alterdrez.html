<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 5.0</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME (MENÚ) --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
        }

        .home-header { text-align: center; margin-bottom: 30px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: #444; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.play .btn-action:hover { background: #00c853; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.learn .btn-action:hover { background: #ff9800; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }
        .card.tactics .btn-action:hover { background: #aa00ff; }

        .db-section {
            margin-top: 40px; padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }

        /* --- VISTA: BOARD (JUEGO) --- */
        #view-board {
            flex: 1; display: none; /* Oculto por defecto */
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
        }
        #view-board.active { display: flex; }

        /* Botón Salir Flotante */
        .btn-exit {
            position: absolute; top: 15px; left: 15px; z-index: 100;
            background: rgba(0,0,0,0.6); border: 1px solid #444; color: #ccc;
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
        }
        .btn-exit:hover { background: var(--error); color: #fff; border-color: var(--error); }

        /* Layout del Tablero */
        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 10px; justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #333; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 0.5s ease; }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Panel de Información debajo del tablero */
        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:hover { background: #333; color: #fff; }
        .ctrl-btn.sol { background: var(--tactics); color: #fff; border: none; }

        /* Feedback Flotante */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        /* Modal Tutorial */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1e1e1e; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; color: #eee; }
        .close-modal { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- VISTA: HOME (MENÚ) -->
<div id="view-home">
    <div class="home-header">
        <h1>AlterDrez</h1>
        <p>Entrenamiento de Ajedrez Profesional</p>
    </div>

    <div class="cards-container">
        <!-- TARJETA JUGAR -->
        <div class="card play">
            <div class="card-title"><i class="bi bi-joystick"></i> Jugar</div>
            <div class="config-row">
                <select id="cfg-play-color">
                    <option value="w">Blancas</option>
                    <option value="b">Negras</option>
                </select>
                <select id="cfg-play-level">
                    <option value="0">Principiante (800)</option>
                    <option value="5">Club (1500)</option>
                    <option value="10">Maestro (2200)</option>
                    <option value="20">Grandmaster</option>
                </select>
            </div>
            <button class="btn-action" onclick="App.startPlay()">Jugar vs IA</button>
        </div>

        <!-- TARJETA APERTURAS -->
        <div class="card learn">
            <div class="card-title"><i class="bi bi-book"></i> Aperturas</div>
            <select id="cfg-opening-select">
                <option value="">-- Selecciona Apertura --</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-opening-count" style="color:var(--success)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startOpening()">Estudiar</button>
        </div>

        <!-- TARJETA TÁCTICA -->
        <div class="card tactics">
            <div class="card-title"><i class="bi bi-lightning-fill"></i> Táctica</div>
            <select id="cfg-tactics-elo">
                <option value="800">Principiante (800)</option>
                <option value="1600">Intermedio (1600)</option>
                <option value="2400">Avanzado (2400)</option>
            </select>
            <div style="font-size:0.8rem; color:#888;">
                Base: <span id="lbl-tactics-count" style="color:var(--tactics)">Cargando...</span>
            </div>
            <button class="btn-action" onclick="App.startTactics()">Resolver</button>
        </div>
    </div>

    <!-- SECCIÓN DATOS Y TUTORIAL -->
    <div class="db-section">
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px;">Configuración y Datos</h3>
        <button class="db-btn" onclick="document.getElementById('modal-help').classList.add('active')">
            <i class="bi bi-question-circle"></i> ¿Cómo usar esta plataforma?
        </button>
        <button class="db-btn" onclick="document.getElementById('file-openings').click()">
            <i class="bi bi-upload"></i> Cargar Base Aperturas (.tsv)
        </button>
        <button class="db-btn" onclick="document.getElementById('file-tactics').click()">
            <i class="bi bi-upload"></i> Cargar Base Táctica (.csv)
        </button>
        <button class="db-btn" onclick="Storage.clear()" style="color:var(--error); border-color:var(--error);">
            <i class="bi bi-trash"></i> Borrar Datos Guardados
        </button>
        
        <!-- Inputs ocultos -->
        <input type="file" id="file-openings" accept=".tsv,.txt,.csv" style="display:none" onchange="DB.loadOpenings(this)">
        <input type="file" id="file-tactics" accept=".csv" style="display:none" onchange="DB.loadTactics(this)">
    </div>
</div>

<!-- VISTA: TABLERO (JUEGO) -->
<div id="view-board">
    <button class="btn-exit" onclick="App.goHome()"><i class="bi bi-arrow-left"></i> Menú</button>
    <div id="feedback" class="feedback-overlay"></div>

    <div class="game-layout">
        <!-- Barra Eval -->
        <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
        
        <!-- Tablero -->
        <div class="board-container">
            <div id="board"></div>
        </div>

        <!-- Info y Controles -->
        <div class="game-info">
            <!-- Entrenador / Status -->
            <div class="coach-tags" id="coach-display">
                <span class="tag book">Listo para jugar</span>
            </div>

            <!-- Controles -->
            <div class="controls">
                <button class="ctrl-btn" onclick="Game.undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="ctrl-btn" onclick="Game.redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="ctrl-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
                <!-- Botón especial Táctica -->
                <button class="ctrl-btn sol hidden" id="btn-solution" onclick="Game.showSolution()"><i class="bi bi-eye-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TUTORIAL -->
<div id="modal-help" class="modal">
    <div class="modal-box">
        <h2>Guía Rápida</h2>
        <p>1. Descarga las bases de datos (pack) desde el enlace de Drive.</p>
        <p>2. Sube el archivo <b>.tsv</b> en "Cargar Aperturas" y el <b>.csv</b> en "Cargar Táctica".</p>
        <p>3. Los datos se guardan en tu navegador automáticamente.</p>
        <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="color:var(--accent);">Ir a Google Drive</a>
        <button class="close-modal" onclick="document.getElementById('modal-help').classList.remove('active')">Entendido</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
// --- DATOS BASE ---
const BaseOpenings = [
    {eco:"C50", name:"Italiana", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4"},
    {eco:"B20", name:"Siciliana", pgn:"1. e4 c5"},
    {eco:"D00", name:"Peón Dama", pgn:"1. d4 d5"},
    {eco:"C60", name:"Ruy Lopez", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
    {eco:"C00", name:"Francesa", pgn:"1. e4 e6"}
];
const BaseTactics = {
    "800": [{id:"1", fen:"6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves:["Rd8#"]}],
    "1600": [{id:"2", fen:"4k3/8/8/3N4/8/8/8/4K3 w - - 0 1", moves:["Nc7+","Kd8","Nxa8"]}],
    "2400": [{id:"3", fen:"8/8/8/8/p7/P7/2k5/7K w - - 0 1", moves:["Kg1"]}]
};

// --- GESTIÓN DE ESTADO ---
let State = {
    mode: 'menu', // menu, play, opening, tactics
    openings: [],
    tactics: {},
    game: new Chess(),
    board: null,
    engine: null,
    redoStack: [],
    currentLesson: { moves: [], index: 0 },
    currentPuzzle: { moves: [], index: 0 },
    lastScore: 0
};

// --- MOTOR ---
const Engine = {
    init: function() {
        const blob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');`], {type: 'application/javascript'});
        const url = URL.createObjectURL(blob);
        State.engine = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js'); // Direct link for stability
        State.engine.onmessage = this.onMessage;
        State.engine.postMessage('uci');
    },
    go: function(depth) {
        if(State.mode === 'tactics') return; // No engine in tactics thinking
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage(`go depth ${depth}`);
    },
    stop: function() { State.engine.postMessage('stop'); },
    onMessage: function(e) {
        const msg = e.data;
        if(msg.startsWith('bestmove') && State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) {
            State.game.move(msg.split(' ')[1], {sloppy:true});
            State.board.position(State.game.fen());
            Engine.analyze();
        }
        if(msg.includes('score cp')) {
            const m = msg.match(/score cp (-?\d+)/);
            if(m) {
                let score = parseInt(m[1]);
                if(State.game.turn() === 'b') score = -score; // Normalize to White
                UI.updateEval(score);
                if(State.mode !== 'tactics') UI.updateCoach(score);
            }
        }
    },
    analyze: function() {
        State.engine.postMessage('stop');
        State.engine.postMessage('position fen ' + State.game.fen());
        State.engine.postMessage('go depth 10');
    }
};

// --- LÓGICA JUEGO ---
const Game = {
    onDragStart: function(s, p) {
        if(State.game.game_over()) return false;
        if(State.mode === 'opening') return false; // Solo visual
        if(State.mode === 'play') {
            const myColor = $('#cfg-play-color').val();
            if((myColor==='w' && p.startsWith('b')) || (myColor==='b' && p.startsWith('w'))) return false;
        }
        if(State.mode === 'tactics') {
            // Solo permitir mover al bando que le toca
            if((State.game.turn()==='w' && p.startsWith('b')) || (State.game.turn()==='b' && p.startsWith('w'))) return false;
        }
        return true;
    },
    onDrop: function(s, t) {
        // TACTICA
        if(State.mode === 'tactics') {
            const temp = new Chess(State.game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'});
            if(m) {
                const correct = State.currentPuzzle.moves[State.currentPuzzle.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    State.game.move({from:s, to:t, promotion:'q'});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++;
                    UI.feedback("¡Bien!", "success");
                    // Respuesta rival
                    if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                        setTimeout(() => {
                            State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                            State.board.position(State.game.fen());
                            State.currentPuzzle.index++;
                        }, 500);
                    } else {
                        UI.feedback("¡Resuelto!", "success");
                    }
                    return;
                }
            }
            UI.feedback("Error", "error");
            return 'snapback';
        }

        // JUEGO
        if(State.mode === 'play') {
            const m = State.game.move({from:s, to:t, promotion:'q'});
            if(!m) return 'snapback';
            State.board.position(State.game.fen());
            State.redoStack = [];
            
            // Turno IA
            setTimeout(() => {
                const lvl = parseInt($('#cfg-play-level').val());
                let depth = 5; 
                if(lvl > 5) depth = 10; if(lvl > 15) depth = 15;
                State.engine.postMessage(`setoption name Skill Level value ${lvl}`);
                Engine.go(depth);
            }, 250);
        }
    },
    undo: function() {
        if(State.mode === 'play' && State.game.turn() !== $('#cfg-play-color').val()) return; // Esperar a IA
        
        if(State.mode === 'opening') {
            State.game.undo(); State.board.position(State.game.fen());
            if(State.currentLesson.index > 0) State.currentLesson.index--;
            Engine.analyze();
            return;
        }

        let m = State.game.undo();
        if(m) {
            State.redoStack.push(m);
            if(State.mode === 'play') { // Deshacer la de la IA también
                let m2 = State.game.undo();
                if(m2) State.redoStack.push(m2);
            }
            State.board.position(State.game.fen());
            Engine.analyze();
        }
    },
    redo: function() {
        if(State.mode === 'opening') {
            if(State.currentLesson.index < State.currentLesson.moves.length) {
                State.game.move(State.currentLesson.moves[State.currentLesson.index]);
                State.board.position(State.game.fen());
                State.currentLesson.index++;
                Engine.analyze();
            }
            return;
        }
        if(State.redoStack.length > 0) {
            let m = State.redoStack.pop();
            State.game.move(m);
            State.board.position(State.game.fen());
            if(State.mode === 'play' && State.redoStack.length > 0) {
                State.game.move(State.redoStack.pop());
                State.board.position(State.game.fen());
            }
            Engine.analyze();
        }
    },
    showSolution: function() {
        if(State.mode !== 'tactics') return;
        const move = State.currentPuzzle.moves[State.currentPuzzle.index];
        if(move) {
            State.game.move(move, {sloppy:true});
            State.board.position(State.game.fen());
            State.currentPuzzle.index++;
            if(State.currentPuzzle.index < State.currentPuzzle.moves.length) {
                setTimeout(() => {
                    State.game.move(State.currentPuzzle.moves[State.currentPuzzle.index], {sloppy:true});
                    State.board.position(State.game.fen());
                    State.currentPuzzle.index++;
                }, 500);
            }
        }
    }
};

// --- APP CONTROLLER ---
const App = {
    init: function() {
        State.openings = JSON.parse(JSON.stringify(BaseOpenings));
        State.tactics = JSON.parse(JSON.stringify(BaseTactics));
        DB.loadFromMemory();
        
        State.board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: Game.onDragStart,
            onDrop: Game.onDrop
        });
        
        Engine.init();
        UI.refreshSelects();
    },
    goHome: function() {
        $('#view-board').removeClass('active');
        $('#view-home').show();
        State.mode = 'menu';
    },
    startPlay: function() {
        this.enterBoard('play');
        State.game.reset(); State.board.start(); State.redoStack = [];
        const color = $('#cfg-play-color').val();
        State.board.orientation(color === 'w' ? 'white' : 'black');
        $('#btn-solution').addClass('hidden');
        $('#coach-display').html('<span class="tag book">Nueva Partida</span>');
        
        if(color === 'b') { // IA mueve primero
            setTimeout(() => Engine.go(5), 500);
        } else {
            Engine.analyze();
        }
    },
    startOpening: function() {
        const idx = $('#cfg-opening-select').val();
        if(idx === "") return alert("Selecciona una apertura");
        
        const op = State.openings[idx];
        this.enterBoard('opening');
        State.game.reset(); State.board.start(); State.board.orientation('white');
        
        // Parse moves
        const temp = new Chess();
        const clean = op.pgn.replace(/\d+\./g,'').replace(/\*/g,'').split(/\s+/).filter(x => x);
        State.currentLesson = { moves: clean, index: 0 };
        
        $('#btn-solution').addClass('hidden');
        $('#coach-display').html(`<span class="tag book">${op.name}</span>`);
        Engine.analyze();
    },
    startTactics: function() {
        const elo = $('#cfg-tactics-elo').val();
        const puzzles = State.tactics[elo] || [];
        if(puzzles.length === 0) return alert("No hay puzzles de este nivel.");
        
        const p = puzzles[Math.floor(Math.random() * puzzles.length)];
        
        this.enterBoard('tactics');
        State.game.load(p.fen);
        State.board.position(p.fen);
        State.board.orientation(State.game.turn() === 'w' ? 'white' : 'black');
        
        State.currentPuzzle = { moves: p.moves, index: 0 };
        $('#btn-solution').removeClass('hidden');
        $('#coach-display').html(`<span class="tag book">Encuentra la mejor jugada</span>`);
    },
    enterBoard: function(mode) {
        State.mode = mode;
        $('#view-home').hide();
        $('#view-board').addClass('active');
        setTimeout(() => State.board.resize(), 100); // Hack para que resize bien
    }
};

// --- BASE DE DATOS Y STORAGE ---
const DB = {
    loadOpenings: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n');
            let c = 0;
            lines.forEach(l => {
                const p = l.split('\t'); // TSV usually
                if(p.length >= 3 && p[p.length-1].length > 3) {
                    State.openings.push({eco:p[0], name:p[1], pgn:p[p.length-1].trim()});
                    c++;
                }
            });
            Storage.save();
            UI.refreshSelects();
            alert(`Cargadas ${c} aperturas.`);
        };
        reader.readAsText(file);
    },
    loadTactics: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const lines = e.target.result.split('\n');
            let c = 0;
            const isComma = lines[0].includes(',');
            lines.forEach(l => {
                const cols = l.split(isComma ? ',' : '\t');
                if(cols.length > 3) {
                    const r = parseInt(cols[3]);
                    if(!isNaN(r)) {
                        let k = "800";
                        if(r >= 2400) k = "2400"; else if(r >= 1600) k = "1600";
                        if(!State.tactics[k]) State.tactics[k] = [];
                        State.tactics[k].push({id:cols[0], fen:cols[1], moves:cols[2].split(' ')});
                        c++;
                    }
                }
            });
            Storage.save();
            UI.refreshSelects();
            alert(`Cargados ${c} puzzles.`);
        };
        reader.readAsText(file);
    },
    loadFromMemory: function() {
        const op = localStorage.getItem('ad_openings');
        const tac = localStorage.getItem('ad_tactics');
        if(op) State.openings = JSON.parse(op);
        if(tac) State.tactics = JSON.parse(tac);
    }
};

const Storage = {
    save: function() {
        try {
            localStorage.setItem('ad_openings', JSON.stringify(State.openings));
            localStorage.setItem('ad_tactics', JSON.stringify(State.tactics));
        } catch(e) { alert("Memoria llena. No se guardarán los cambios."); }
    },
    clear: function() {
        localStorage.clear();
        location.reload();
    }
};

// --- INTERFAZ AUXILIAR ---
const UI = {
    refreshSelects: function() {
        const s = $('#cfg-opening-select').empty().append('<option value="">-- Selecciona --</option>');
        State.openings.forEach((o, i) => s.append(new Option(`[${o.eco}] ${o.name}`, i)));
        $('#lbl-opening-count').text(State.openings.length);
        
        let totalP = 0;
        Object.values(State.tactics).forEach(arr => totalP += arr.length);
        $('#lbl-tactics-count').text(totalP);
    },
    feedback: function(msg, type) {
        const el = $('#feedback');
        el.text(msg).removeClass('success error').addClass('show ' + type);
        setTimeout(() => el.removeClass('show'), 1000);
    },
    updateEval: function(score) {
        // Sigmoide visual
        let p = 50 + (score / 4); // Simple linear clamp for performance or sigmoid
        p = Math.max(5, Math.min(95, p)); // Clamp visual
        $('#eval-fill').css('width', p + '%');
    },
    updateCoach: function(score) {
        let delta = score - State.lastScore;
        // Invertir delta si mueven negras para que positivo siempre sea "bueno para el que movió"
        if(State.game.turn() === 'w') delta = -delta; 

        let tag = "";
        if(delta < -200) tag = "<span class='tag blunder'>Error Grave</span>";
        else if(delta < -80) tag = "<span class='tag bad'>Error</span>";
        else if(delta < -30) tag = "<span class='tag warn'>Imprecisión</span>";
        else if(delta > 30) tag = "<span class='tag good'>Buena</span>";
        else tag = "<span class='tag book'>Normal</span>";
        
        $('#coach-display').html(tag);
        State.lastScore = score;
    }
};

$(document).ready(function() {
    App.init();
});
</script>
</body>
</html>
