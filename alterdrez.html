<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Análisis Profundo</title>

    <!-- ESTILOS Y FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        :root {
            --bg: #0F121B;
            --panel: #1a1d29;
            --accent: #4db8ff;
            --text: #e0e0e0;
            --good: #00e676; /* Verde */
            --bad: #ff1744;  /* Rojo */
            --warn: #ffea00; /* Amarillo */
        }

        body {
            background: radial-gradient(circle at top, #1F2533, #000);
            color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container { max-width: 1300px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; }

        /* HEADER */
        header { width: 100%; text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; font-weight: 800; letter-spacing: 2px; color: var(--accent); font-size: 2rem; }

        /* TABLERO */
        .board-area { flex: 1; min-width: 320px; max-width: 600px; }
        .board-wrapper {
            border: 5px solid #333; border-radius: 4px;
            touch-action: none; /* Bloquea scroll en móvil */
        }

        /* BARRA DE EVALUACIÓN */
        .eval-bar-container {
            height: 15px; background: #333; margin-bottom: 10px; border-radius: 3px; overflow: hidden; position: relative;
            display: flex;
        }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 0.6s ease, background 0.3s; }
        .eval-score { 
            position: absolute; width: 100%; text-align: center; font-size: 0.7rem; line-height: 15px; 
            color: #000; font-weight: bold; mix-blend-mode: difference; 
        }

        /* PANEL LATERAL */
        .sidebar { flex: 1; min-width: 300px; max-width: 450px; display: flex; flex-direction: column; gap: 15px; }
        
        .panel {
            background: var(--panel); border: 1px solid #333; border-radius: 8px; padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .panel h3 { margin: 0 0 10px 0; font-size: 0.9rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* COACH / ANALISTA */
        .coach-feedback { font-size: 0.95rem; line-height: 1.5; min-height: 60px; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag.good { background: rgba(0, 230, 118, 0.15); color: var(--good); border: 1px solid var(--good); }
        .tag.bad { background: rgba(255, 23, 68, 0.15); color: var(--bad); border: 1px solid var(--bad); }
        .tag.warn { background: rgba(255, 234, 0, 0.15); color: var(--warn); border: 1px solid var(--warn); }
        .tag.info { background: rgba(77, 184, 255, 0.15); color: var(--accent); border: 1px solid var(--accent); }

        /* CONTROLES */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button {
            flex: 1; padding: 12px; border: 1px solid #555; background: #222; color: #fff; border-radius: 5px;
            cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.2s;
        }
        button:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        button:active { transform: scale(0.98); }
        
        select { width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #555; border-radius: 5px; margin-bottom: 10px; }

        /* PGN */
        #pgn { font-family: monospace; color: #888; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; max-height: 80px; overflow-y: auto; font-size: 0.8rem; }

        /* UI INDICATORS */
        .highlight-move { box-shadow: inset 0 0 3px 3px rgba(77, 184, 255, 0.6); }
        .highlight-check { box-shadow: inset 0 0 10px 5px rgba(255, 23, 68, 0.6) !important; }
        
        #thinking { color: var(--accent); font-style: italic; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ALTER.DREZ</h1>
    </header>

    <!-- ZONA TABLERO -->
    <div class="board-area">
        <div class="eval-bar-container">
            <div id="evalFill" class="eval-fill"></div>
            <div id="evalScore" class="eval-score">0.0</div>
        </div>
        
        <div class="board-wrapper">
            <div id="board"></div>
        </div>

        <div style="margin-top: 10px; text-align: center; color: #888; font-size: 0.9rem;">
            <span id="status">Bienvenido</span>
            <div id="thinking">Stockfish está pensando...</div>
        </div>
    </div>

    <!-- ZONA PANELES -->
    <div class="sidebar">
        
        <!-- PANEL 1: ENTRENADOR (ANÁLISIS REAL) -->
        <div class="panel" style="border-color: var(--accent);">
            <h3 style="color: var(--accent);">Entrenador Virtual <i class="bi bi-robot"></i></h3>
            <div id="coachFeedback" class="coach-feedback">
                Haz tu primer movimiento para comenzar el análisis estructural y táctico.
            </div>
            <div id="coachTags" class="coach-tags"></div>
        </div>

        <!-- PANEL 2: CONTROLES -->
        <div class="panel">
            <h3>Controles</h3>
            
            <label style="font-size:0.8rem; color:#aaa;">Navegación (Usa flechas ← →)</label>
            <div class="btn-group">
                <button id="btnBack"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button id="btnForward">Adelante <i class="bi bi-arrow-right"></i></button>
            </div>
            
            <div style="margin-top: 15px;"></div>
            
            <select id="gameMode">
                <option value="analysis">Modo Análisis (Libre)</option>
                <option value="pvc">Jugar vs Stockfish</option>
            </select>
            
            <div class="btn-group">
                <select id="skillLevel" style="margin-bottom:0;">
                    <option value="1">Nivel 1 (Novato)</option>
                    <option value="10" selected>Nivel 10 (Club)</option>
                    <option value="20">Nivel 20 (Maestro)</option>
                </select>
                <button id="btnNewGame" style="background: var(--accent); color: #000;">Reiniciar</button>
            </div>
        </div>

        <!-- PANEL 3: APERTURAS -->
        <div class="panel">
            <h3>Lecciones / Aperturas</h3>
            <select id="openingSelect">
                <option value="">-- Cargar Lección --</option>
            </select>
            <div id="pgn"></div>
        </div>

    </div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- MÓDULO DE ANÁLISIS ESTRUCTURAL (COACH) ---
    const Coach = {
        lastScore: 0, // Para comparar si mejoraste o empeoraste
        
        analyze: function(game, currentScore, moveColor) {
            let comments = [];
            let tags = [];
            
            // 1. DETECCIÓN DE ERRORES (BLUNDER CHECK)
            // Si el score cambió mucho en mi contra tras mi movimiento
            // Nota: currentScore es relativo a blancas. 
            // Si jugaron Blancas, queremos ver si el score bajó.
            // Si jugaron Negras, queremos ver si el score subió.
            
            let delta = 0;
            if (moveColor === 'w') delta = currentScore - this.lastScore; 
            else delta = this.lastScore - currentScore; // Invertido para negras (score más bajo es mejor para ellas)

            // Guardamos score para el siguiente turno
            this.lastScore = currentScore;

            if (delta < -200) {
                tags.push({ text: "Error Grave", type: "bad" });
                comments.push("¡Cuidado! Ese movimiento ha regalado una ventaja significativa.");
            } else if (delta < -80) {
                tags.push({ text: "Imprecisión", type: "warn" });
                comments.push("Había mejores opciones. Has perdido algo de iniciativa.");
            } else if (delta > 100) {
                tags.push({ text: "¡Gran Jugada!", type: "good" });
                comments.push("Has encontrado un movimiento fuerte que mejora tu posición.");
            }

            // 2. ANÁLISIS DE ESTRUCTURA DE PEONES
            const structure = this.analyzePawnStructure(game);
            if (structure.isolated > 0) {
                tags.push({ text: "Peón Aislado", type: "warn" });
                comments.push("Tienes peones aislados (sin compañeros a los lados). Son débiles en finales.");
            }
            if (structure.doubled > 0) {
                tags.push({ text: "Peones Doblados", type: "warn" });
                comments.push("Tienes peones doblados en la misma columna. Esto dificulta su avance.");
            }

            // 3. MATERIAL
            const material = this.getMaterial(game);
            if (Math.abs(material) > 2) {
                const leader = material > 0 ? "Blancas" : "Negras";
                comments.push(`Las ${leader} tienen ventaja material.`);
            }

            // 4. ESTADO GENERAL
            if (Math.abs(currentScore) < 40) {
                tags.push({ text: "Igualdad", type: "info" });
            } else if (Math.abs(currentScore) > 300) {
                tags.push({ text: "Decisivo", type: "bad" }); // O good, depende perspectiva
            }

            if(comments.length === 0) comments.push("Posición sólida. Continúa desarrollando el plan.");

            this.render(comments, tags);
        },

        // Busca peones aislados y doblados
        analyzePawnStructure: function(game) {
            const board = game.board();
            const turn = game.turn(); // Quien acaba de mover (el turno ya cambió, así que miramos el color opuesto)
            const color = turn === 'w' ? 'b' : 'w'; 
            
            let pawnsPerFile = [0,0,0,0,0,0,0,0]; // Columna A-H
            
            // Contar peones
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const p = board[r][c];
                    if(p && p.type === 'p' && p.color === color) {
                        pawnsPerFile[c]++;
                    }
                }
            }

            let isolated = 0;
            let doubled = 0;

            for(let i=0; i<8; i++) {
                if (pawnsPerFile[i] > 1) doubled++;
                if (pawnsPerFile[i] > 0) {
                    // Ver si tiene vecinos
                    let hasLeft = (i > 0) && pawnsPerFile[i-1] > 0;
                    let hasRight = (i < 7) && pawnsPerFile[i+1] > 0;
                    if (!hasLeft && !hasRight) isolated++;
                }
            }
            return { isolated, doubled };
        },

        getMaterial: function(game) {
            const b = game.board();
            let score = 0;
            const vals = {p:1, n:3, b:3, r:5, q:9, k:0};
            b.forEach(row => row.forEach(p => {
                if(p) score += (p.color==='w' ? vals[p.type] : -vals[p.type]);
            }));
            return score;
        },

        render: function(comments, tags) {
            $('#coachFeedback').html(comments.join("<br>"));
            $('#coachTags').empty();
            tags.forEach(t => {
                $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`);
            });
        }
    };

    // --- MAIN GAME LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        const game = new Chess();
        let board = null;
        let engine = null;
        
        // HISTORIAL DE MOVIMIENTOS (REDO STACK)
        let redoStack = []; 
        let isAnalyzing = false; // Flag para no disparar análisis en undo/redo rápido

        // Inicializar Stockfish
        const workerBlob = new Blob([`
            importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');
        `], {type: 'application/javascript'});
        engine = new Worker(URL.createObjectURL(workerBlob));
        
        engine.onmessage = function(e) {
            const msg = e.data;
            
            // 1. Movimiento de la IA
            if (msg.startsWith('bestmove')) {
                const move = msg.split(' ')[1];
                if($('#gameMode').val() === 'pvc' && !game.game_over()) {
                     makeMove(move);
                }
                $('#thinking').hide();
            }

            // 2. Información de análisis
            if (msg.startsWith('info') && msg.includes('score')) {
                const scoreMatch = msg.match(/score (cp|mate) (-?\d+)/);
                if (scoreMatch) {
                    let score = parseInt(scoreMatch[2]);
                    // Stockfish score es relativo. Lo hacemos absoluto (Positivo = Bueno para Blanco)
                    if (game.turn() === 'b') score = -score;
                    
                    updateEvalUI(scoreMatch[1], score);
                    
                    // Solo activar el Coach si no estamos spameando el botón
                    if(isAnalyzing) {
                         // Color del último movimiento
                        const history = game.history({verbose:true});
                        const lastMove = history[history.length-1];
                        const movedColor = lastMove ? lastMove.color : 'w';
                        
                        Coach.analyze(game, score, movedColor);
                        isAnalyzing = false;
                    }
                }
            }
        };
        engine.postMessage('uci');

        // --- FUNCIONES DEL JUEGO ---

        function makeMove(moveObjOrString) {
            const result = game.move(moveObjOrString, { sloppy: true });
            if (!result) return false;
            
            // Al hacer un movimiento nuevo, borramos el futuro (redoStack)
            redoStack = []; 
            
            updateBoardState();
            
            // Si es PVC y moví yo, pedir respuesta
            const mode = $('#gameMode').val();
            if (mode === 'pvc' && !game.game_over() && game.turn() !== $('#playerColor').val()) {
                requestEngineMove();
            } else {
                requestAnalysis();
            }
            return true;
        }

        function requestEngineMove() {
            $('#thinking').show();
            const level = $('#skillLevel').val();
            const depth = level < 5 ? 5 : (level < 15 ? 10 : 15);
            engine.postMessage(`setoption name Skill Level value ${level}`);
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage(`go depth ${depth}`);
        }

        function requestAnalysis() {
            isAnalyzing = true; // Activar el coach para esta respuesta
            engine.postMessage(`position fen ${game.fen()}`);
            engine.postMessage('go depth 12'); 
        }

        function updateBoardState() {
            board.position(game.fen());
            updateStatus();
            removeHighlights();
            
            // Resaltar último movimiento
            const hist = game.history({verbose: true});
            if(hist.length > 0) {
                const last = hist[hist.length-1];
                highlightSquare(last.from);
                highlightSquare(last.to);
                if(game.in_check()) {
                    // Buscar rey atacado (lógica visual simplificada)
                }
            }
        }

        // --- NAVEGACIÓN (ATRÁS / ADELANTE) ---

        function goBack() {
            const move = game.undo();
            if (move) {
                redoStack.push(move); // Guardamos para rehacer
                board.position(game.fen());
                updateStatus();
                removeHighlights();
                // Analizar la posición anterior
                requestAnalysis();
                
                // Si estamos en PVC, deshacemos 2 veces (humano e IA)
                // A menos que solo quieras ver qué pasó. 
                // Para análisis puro dejamos deshacer de a 1.
                if ($('#gameMode').val() === 'pvc' && game.turn() !== $('#playerColor').val()) {
                     // Si es turno de IA tras deshacer, deshacemos uno más para que sea mi turno
                     const move2 = game.undo();
                     if(move2) redoStack.push(move2);
                     board.position(game.fen());
                }
            }
        }

        function goForward() {
            const move = redoStack.pop();
            if (move) {
                game.move(move);
                board.position(game.fen());
                updateStatus();
                requestAnalysis();
            }
        }

        // --- EVENTOS DE TECLADO Y BOTONES ---

        document.addEventListener('keydown', (e) => {
            if (e.key === "ArrowLeft") goBack();
            if (e.key === "ArrowRight") goForward();
        });

        $('#btnBack').click(goBack);
        $('#btnForward').click(goForward);
        
        $('#btnNewGame').click(() => {
            game.reset();
            redoStack = [];
            board.start();
            Coach.lastScore = 0;
            updateStatus();
            requestAnalysis();
        });

        // --- CONFIGURACIÓN TABLERO ---

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            // En PVC solo mueves tu color
            if ($('#gameMode').val() === 'pvc') {
                // Suponiendo que juegas Blancas por defecto o selector (no implementado selector en este snippet corto, asumo blancas vs IA)
                // Si quieres selector de color, agregalo y valida aqui.
            }
        }

        function onDrop(source, target) {
            const move = { from: source, to: target, promotion: 'q' };
            // Usamos makeMove para centralizar lógica
            if (!makeMove(move)) return 'snapback';
        }

        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);
        $(window).resize(board.resize);

        // --- UTILS UI ---

        function updateEvalUI(type, score) {
            let percent = 50;
            let text = "0.0";

            if (type === 'mate') {
                percent = score > 0 ? 100 : 0;
                text = "M" + Math.abs(score);
            } else {
                // Clamp -500 a 500
                let val = Math.max(-500, Math.min(500, score));
                percent = 50 + (val / 10);
                text = (score / 100).toFixed(1);
                if (score > 0) text = "+" + text;
            }
            
            $('#evalFill').css('width', percent + '%');
            $('#evalScore').text(text);
            
            // Color barra según ventaja
            if (percent > 55) $('#evalFill').css('background', '#fff'); // Blanco
            else if (percent < 45) $('#evalFill').css('background', '#444'); // Negro
            else $('#evalFill').css('background', '#888');
        }

        function updateStatus() {
            let status = '';
            if (game.in_checkmate()) status = "Jaque Mate";
            else if (game.in_draw()) status = "Tablas";
            else {
                status = game.turn() === 'w' ? "Turno Blancas" : "Turno Negras";
                if (game.in_check()) status += " (JAQUE)";
            }
            $('#status').text(status);
            $('#pgn').text(game.pgn());
        }

        function highlightSquare(sq) {
            $('#board .square-' + sq).addClass('highlight-move');
        }
        function removeHighlights() {
            $('#board .square-55d63').removeClass('highlight-move');
        }

        // --- DATA DE LECCIONES (Ejemplo) ---
        const lessons = [
            {name: "Apertura Italiana", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bc4"},
            {name: "Defensa Siciliana", pgn: "1. e4 c5 2. Nf3 d6 3. d4 cxd4"},
            {name: "Gambito de Rey", pgn: "1. e4 e5 2. f4"}
        ];
        lessons.forEach((l,i) => $('#openingSelect').append(new Option(l.name, i)));
        
        $('#openingSelect').change(function() {
            const idx = $(this).val();
            if(idx !== "") {
                game.load_pgn(lessons[idx].pgn);
                board.position(game.fen());
                redoStack = [];
                requestAnalysis(); // Analizar la apertura cargada
            }
        });
        
        // Carga inicial
        setTimeout(requestAnalysis, 1000);
    });
</script>

</body>
</html>
