<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Plataforma Profesional</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --bg: #0F121B;
            --panel: #1A1E29;
            --accent: #4db8ff;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        header { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); text-align: center; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 1.6rem; letter-spacing: 2px; font-weight: 800; color: var(--accent); }

        .main-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
            width: 100%; max-width: 1300px; padding: 20px;
        }

        /* ZONA TABLERO */
        .board-section { flex: 1; min-width: 300px; max-width: 600px; }
        .board-container {
            width: 100%; touch-action: none;
            border: 5px solid #222; border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Feedback Lecciones */
        .lesson-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 15px 25px; border-radius: 8px;
            text-align: center; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 10; border: 1px solid var(--accent); font-size: 1.2rem;
        }
        .lesson-feedback.show { opacity: 1; }
        .lesson-feedback.error { border-color: var(--error); color: var(--error); }
        .lesson-feedback.success { border-color: var(--success); color: var(--success); }

        .eval-bar-wrapper { height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 5px; }
        .eval-fill { height: 100%; width: 50%; background: #fff; transition: width 0.5s ease, background 0.3s; }

        /* PANELES */
        .sidebar { flex: 1; min-width: 300px; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 10px; padding: 15px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 0.8rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* ENTRENADOR */
        .coach-msg { font-size: 0.9rem; line-height: 1.4; color: #fff; margin-bottom: 10px; min-height: 40px; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; }
        .tag.good { background: rgba(0,230,118,0.1); color: var(--success); border-color: var(--success); }
        .tag.bad { background: rgba(255,23,68,0.1); color: var(--error); border-color: var(--error); }
        .tag.warn { background: rgba(255,234,0,0.1); color: var(--warn); border-color: var(--warn); }
        .tag.info { background: rgba(77,184,255,0.1); color: var(--accent); border-color: var(--accent); }

        /* FORMULARIOS */
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
        select, button {
            width: 100%; padding: 10px; background: #252a36; border: 1px solid #444; color: #fff;
            border-radius: 5px; font-family: inherit; margin-bottom: 10px; cursor: pointer;
        }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }
        
        .btn-row { display: flex; gap: 10px; }
        .hidden { display: none; }

        /* Indicador de turno en lección */
        .lesson-status { font-size: 0.9rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Alter.Drez <i class="bi bi-trophy-fill"></i></h1>
</header>

<div class="main-container">
    
    <!-- IZQUIERDA: TABLERO -->
    <div class="board-section">
        <div class="eval-bar-wrapper">
            <div id="evalFill" class="eval-fill"></div>
        </div>
        
        <div class="board-container">
            <div id="board"></div>
            <!-- Feedback flotante -->
            <div id="lessonFeedback" class="lesson-feedback"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.85rem; color:#aaa;">
            <span id="statusText">Esperando...</span>
            <span id="thinkingIndicator" style="display:none; color:var(--accent);">IA Pensando...</span>
        </div>
    </div>

    <!-- DERECHA: CONTROLES -->
    <div class="sidebar">

        <!-- 1. MÓDULO DE LECCIONES -->
        <div class="panel" style="border-left: 3px solid var(--success);">
            <h3><i class="bi bi-mortarboard"></i> Academia de Aperturas</h3>
            
            <div id="lessonControls">
                <select id="openingCategory">
                    <option value="all">Todas las Categorías</option>
                    <option value="open">Juegos Abiertos (1. e4 e5)</option>
                    <option value="semi">Semi-Abiertos (1. e4 ...)</option>
                    <option value="closed">Juegos Cerrados (1. d4 ...)</option>
                </select>
                
                <select id="openingSelect">
                    <option value="">-- Seleccionar Lección --</option>
                </select>
                
                <div id="lessonActiveUI" class="hidden">
                    <div class="lesson-status" id="lessonInstruction">Tu turno...</div>
                    <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="background: #333; border-color: #555;">Salir de la Lección</button>
                </div>
            </div>
        </div>

        <!-- 2. ENTRENADOR VIRTUAL -->
        <div class="panel" id="coachPanel">
            <h3><i class="bi bi-robot"></i> Entrenador Virtual</h3>
            <div class="coach-msg" id="coachMsg">Selecciona un modo para comenzar.</div>
            <div class="coach-tags" id="coachTags"></div>
        </div>

        <!-- 3. CONFIGURACIÓN PARTIDA -->
        <div class="panel">
            <h3>Jugar vs Stockfish</h3>
            
            <div class="btn-row">
                <div style="width: 50%;">
                    <label>Tu Color</label>
                    <select id="playerColor">
                        <option value="w">Blancas</option>
                        <option value="b">Negras</option>
                    </select>
                </div>
                <div style="width: 50%;">
                    <label>Nivel (ELO Aprox)</label>
                    <select id="skillLevel">
                        <option value="0">Principiante (800)</option>
                        <option value="3">Aficionado (1000)</option>
                        <option value="6">Intermedio (1300)</option>
                        <option value="10" selected>Club (1600)</option>
                        <option value="14">Experto (2000)</option>
                        <option value="17">Maestro (2400)</option>
                        <option value="20">Grand Master (2800+)</option>
                    </select>
                </div>
            </div>

            <div class="btn-row">
                <select id="gameMode">
                    <option value="pvc">Modo Competitivo</option>
                    <option value="analysis">Modo Análisis Libre</option>
                </select>
            </div>

            <div class="btn-row">
                <button id="btnNewGame">Nueva Partida</button>
                <button id="btnFlip" style="width: 40%;"><i class="bi bi-arrow-down-up"></i></button>
            </div>
            
            <div class="btn-row" style="margin-top: 5px;">
                <button id="btnUndo"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button id="btnRedo">Adelante <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- DATOS DE APERTURAS (ACADEMIA) ---
    const openingsDB = [
        { id: "ruy_lopez", name: "Ruy López (Española)", cat: "open", moves: ["e4", "e5", "Nf3", "Nc6", "Bb5"], desc: "Controla el centro y presiona al defensor del peón e5." },
        { id: "italian", name: "Apertura Italiana", cat: "open", moves: ["e4", "e5", "Nf3", "Nc6", "Bc4"], desc: "Desarrollo lógico apuntando al punto débil f7." },
        { id: "sicilian", name: "Defensa Siciliana", cat: "semi", moves: ["e4", "c5", "Nf3", "d6", "d4", "cxd4", "Nxd4", "Nf6", "Nc3"], desc: "Contraataque agresivo por el flanco de dama." },
        { id: "caro_kann", name: "Defensa Caro-Kann", cat: "semi", moves: ["e4", "c6", "d4", "d5"], desc: "Estructura sólida de peones, muy difícil de romper." },
        { id: "queens_gambit", name: "Gambito de Dama", cat: "closed", moves: ["d4", "d5", "c4"], desc: "Ofrece un peón lateral para ganar control central total." },
        { id: "kings_indian", name: "India de Rey", cat: "closed", moves: ["d4", "Nf6", "c4", "g6", "Nc3", "Bg7", "e4", "d6"], desc: "Cede el centro para contraatacar después." }
    ];

    // --- VARIABLES GLOBALES ---
    const game = new Chess();
    let board = null;
    let engine = null;
    let redoStack = [];
    
    // Estados
    let currentMode = 'pvc'; // 'pvc', 'analysis', 'lesson'
    let lessonState = { active: false, moves: [], index: 0 };
    let isEnginePlaying = false; 

    // --- MÓDULO LECCIONES ---
    const LessonSystem = {
        start: function(id) {
            const op = openingsDB.find(o => o.id === id);
            if (!op) return;
            
            lessonState = { active: true, moves: op.moves, index: 0 };
            currentMode = 'lesson';
            
            $('#lessonActiveUI').removeClass('hidden');
            $('#openingSelect').val('');
            $('#lessonDescription').text(op.desc);
            
            game.reset();
            board.position('start');
            board.orientation('white');
            this.updatePrompt();
        },
        updatePrompt: function() {
            if(lessonState.index >= lessonState.moves.length) {
                this.finish(); return;
            }
            const move = lessonState.moves[lessonState.index];
            const turn = game.turn() === 'w' ? 'Blancas' : 'Negras';
            $('#lessonInstruction').html(`<span style="color:var(--accent)">${turn}:</span> Juega <b>${move}</b>`);
            $('#statusText').text("Modo Lección");
        },
        checkMove: function(moveObj) {
            const expected = lessonState.moves[lessonState.index];
            if (moveObj.san === expected) {
                this.feedback("¡Correcto!", "success");
                lessonState.index++;
                if(lessonState.index < lessonState.moves.length) setTimeout(() => this.playAuto(), 500);
                else this.finish();
                return true;
            }
            this.feedback(`Error. Juega ${expected}`, "error");
            return false;
        },
        playAuto: function() {
            if(!lessonState.active) return;
            const m = lessonState.moves[lessonState.index];
            game.move(m);
            board.position(game.fen());
            lessonState.index++;
            this.updatePrompt();
        },
        feedback: function(msg, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(msg).removeClass('success error').addClass('show '+type);
            setTimeout(() => $fb.removeClass('show'), 1500);
        },
        finish: function() {
            $('#lessonInstruction').html(`<span style="color:var(--success)">¡Completado!</span>`);
            currentMode = 'analysis';
            $('#statusText').text("Lección terminada. Análisis libre.");
        },
        stop: function() {
            lessonState.active = false;
            $('#lessonActiveUI').addClass('hidden');
            currentMode = 'analysis';
            $('#statusText').text("Lección cancelada.");
        }
    };

    // --- ENTRENADOR (OBSERVER) ---
    const Observer = {
        lastScore: 0,
        evaluate: function(game, score, pColor) {
            if(currentMode === 'lesson') return;
            
            // Delta desde perspectiva del que movió
            let delta = score - this.lastScore;
            if (game.turn() === 'b') delta = -delta; 

            let msgs = [], tags = [];
            
            // Heurísticas básicas
            if (Math.abs(score) < 50) tags.push({text:"Igualdad", type:"info"});
            else if ((pColor==='w' && score>100) || (pColor==='b' && score<-100)) tags.push({text:"Vas Ganando", type:"good"});
            else if ((pColor==='w' && score<-100) || (pColor==='b' && score>100)) tags.push({text:"Vas Perdiendo", type:"bad"});

            const fen = game.fen();
            const moves = parseInt(fen.split(' ')[5]);

            if(moves < 8 && Math.abs(score) < 80) msgs.push("Fase de Apertura: Controla el centro y desarrolla piezas.");
            else if (Math.abs(delta) > 200) {
                msgs.push("¡Cambio brusco en la partida! Revisa el último movimiento.");
                tags.push({text:"Error Táctico", type:"warn"});
            } else {
                msgs.push("Mantén la estructura y busca debilidades en el rival.");
            }

            $('#coachMsg').text(msgs[0]);
            $('#coachTags').empty();
            tags.forEach(t => $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`));
            this.lastScore = score;
        }
    };

    // --- SETUP PRINCIPAL ---
    function init() {
        // Carga de Stockfish
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
            .then(r=>r.blob()).then(blob=>{
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('uci');
                engine.onmessage = handleEngine;
                $('#statusText').text("Motor Listo.");
            });

        // UI
        populateOpenings('all');
        $('#openingCategory').change(function() { populateOpenings($(this).val()); });
        $('#openingSelect').change(function() { if($(this).val()) LessonSystem.start($(this).val()); });
        $('#btnQuitLesson').click(() => LessonSystem.stop());
        
        $('#btnNewGame').click(newGame);
        $('#btnUndo').click(undo);
        $('#btnRedo').click(redo);
        $('#btnFlip').click(() => board.flip());
    }

    function populateOpenings(cat) {
        const $s = $('#openingSelect').empty().append('<option value="">-- Seleccionar Lección --</option>');
        openingsDB.forEach(o => { if(cat==='all' || o.cat===cat) $s.append(new Option(o.name, o.id)); });
    }

    // --- LÓGICA DEL MOTOR (IA) ---
    function handleEngine(e) {
        const msg = e.data;
        
        // IA Mueve
        if (msg.startsWith('bestmove') && isEnginePlaying) {
            const move = msg.split(' ')[1];
            game.move(move, {sloppy:true});
            board.position(game.fen());
            isEnginePlaying = false;
            $('#thinkingIndicator').hide();
            triggerAnalysis(); // Analizar tras mover
        }
        
        // IA Analiza
        if (msg.startsWith('info') && msg.includes('score') && !msg.includes('lowerbound')) {
            const match = msg.match(/score (cp|mate) (-?\d+)/);
            if(match) {
                let score = parseInt(match[2]);
                if(game.turn() === 'b') score = -score; // Score Absoluto
                updateEval(score, match[1]);
                Observer.evaluate(game, score, $('#playerColor').val());
            }
        }
    }

    function triggerAI() {
        if(currentMode !== 'pvc' || game.game_over()) return;
        isEnginePlaying = true;
        $('#thinkingIndicator').show();
        
        // Mapeo de Nivel ELO -> Parámetros Stockfish
        const level = parseInt($('#skillLevel').val());
        let depth = 1;
        
        // Lógica de dificultad variable
        if (level === 0) depth = 1;      // 800 ELO (Muy torpe)
        else if (level <= 5) depth = 5;  // 1200 ELO
        else if (level <= 10) depth = 10; // 1600 ELO
        else if (level <= 15) depth = 15; // 2000 ELO
        else depth = 20;                 // 2800 ELO
        
        // Configurar motor para jugar a ESE nivel
        engine.postMessage(`setoption name Skill Level value ${level}`);
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage(`go depth ${depth}`);
    }

    function triggerAnalysis() {
        if(currentMode === 'lesson') return;
        // Para analizar, SIEMPRE usar nivel máximo para dar buenos consejos
        engine.postMessage(`setoption name Skill Level value 20`); 
        engine.postMessage('stop');
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage('go depth 10');
    }

    function updateEval(score, type) {
        let per = 50;
        if(type==='mate') per = score>0 ? 100 : 0;
        else per = 50 + (Math.max(-500, Math.min(500, score)) / 10);
        $('#evalFill').css('width', per + '%');
    }

    // --- TABLERO ---
    function onDragStart(src, piece) {
        if(game.game_over() || isEnginePlaying) return false;
        if(currentMode === 'pvc') {
            const pc = $('#playerColor').val();
            if((pc==='w' && piece.search(/^b/)!==-1) || (pc==='b' && piece.search(/^w/)!==-1)) return false;
        }
        if(currentMode === 'lesson' && !lessonState.active) return false;
    }

    function onDrop(src, tgt) {
        // Modo Lección
        if(currentMode === 'lesson') {
            const tmp = new Chess(game.fen());
            const m = tmp.move({from:src, to:tgt, promotion:'q'});
            if(!m) return 'snapback';
            
            if(LessonSystem.checkMove(m)) {
                game.move({from:src, to:tgt, promotion:'q'});
                board.position(game.fen());
                return;
            } else {
                return 'snapback';
            }
        }

        // Modo Normal
        const move = game.move({from:src, to:tgt, promotion:'q'});
        if(!move) return 'snapback';

        board.position(game.fen());
        redoStack = [];
        
        if(currentMode === 'pvc' && game.turn() !== $('#playerColor').val()) {
            setTimeout(triggerAI, 500);
        } else {
            triggerAnalysis();
        }
    }

    // --- CONTROLES ---
    function newGame() {
        LessonSystem.stop();
        game.reset(); redoStack=[];
        const pc = $('#playerColor').val();
        board.orientation(pc==='w'?'white':'black');
        board.start();
        currentMode = $('#gameMode').val();
        if(currentMode==='pvc' && pc==='b') triggerAI();
        else triggerAnalysis();
        $('#statusText').text("Nueva Partida");
    }

    function undo() {
        if(isEnginePlaying || currentMode === 'lesson') return;
        let m = game.undo();
        if(m) {
            redoStack.push(m);
            if(currentMode==='pvc') { let m2=game.undo(); if(m2) redoStack.push(m2); }
            board.position(game.fen());
            triggerAnalysis();
        }
    }

    function redo() {
        if(isEnginePlaying || redoStack.length===0 || currentMode === 'lesson') return;
        let m = redoStack.pop(); game.move(m);
        if(currentMode==='pvc' && redoStack.length>0) game.move(redoStack.pop());
        board.position(game.fen());
        triggerAnalysis();
    }

    // ARRANQUE
    $(document).ready(function() {
        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        $(window).resize(board.resize);
        init();
    });
</script>
</body>
</html>
