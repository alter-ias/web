<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AlterDrez 5.9</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- CORE STYLES (INTACTOS v5.8) --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --accent: #00bcd4;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VISTA: HOME --- */
        #view-home {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding: 20px;
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #121212 60%);
            -webkit-overflow-scrolling: touch;
        }

        .home-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .home-header h1 { font-size: 2.5rem; margin: 0; letter-spacing: 2px; color: var(--accent); }
        .home-header p { color: #888; margin-top: 5px; font-size: 0.9rem; }

        .cards-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 20px;
            border: 1px solid #333; transition: transform 0.2s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card.play .card-title { color: var(--success); }
        .card.learn .card-title { color: #ffa726; }
        .card.tactics .card-title { color: var(--tactics); }

        .config-row { display: flex; gap: 10px; }
        
        select, .btn-action {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: #252525; color: #fff; font-family: inherit; outline: none; cursor: pointer;
        }
        .btn-action { font-weight: 800; text-transform: uppercase; border: none; transition: 0.2s; margin-top: auto; }
        .card.play .btn-action { background: var(--success); color: #000; }
        .card.learn .btn-action { background: #ffa726; color: #000; }
        .card.tactics .btn-action { background: var(--tactics); color: #fff; }

        /* SECCI√ìN VIDEO Y DATOS */
        .tutorial-video-container {
            max-width: 800px; margin: 40px auto 20px auto; width: 100%;
            border-radius: 8px; overflow: hidden; border: 1px solid #444; background: #000;
        }
        .tutorial-video-container video { width: 100%; display: block; }

        .db-section {
            padding: 20px; border-top: 1px solid #333;
            max-width: 800px; margin-left: auto; margin-right: auto; width: 100%;
        }
        .db-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .db-btn:hover { background: #444; color: #fff; border-color: #777; }

        /* FOOTER ALTERLAB */
        .alterlab-footer {
            margin-top: 30px; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 12px;
            max-width: 900px; margin-left: auto; margin-right: auto; text-align: center; border: 1px solid #333;
        }
        .alterlab-footer h3 { color: #fff; margin-bottom: 15px; font-size: 1.5rem; }
        .alterlab-footer p { color: #aaa; font-size: 0.9rem; line-height: 1.6; margin-bottom: 20px; text-align: justify; }
        .footer-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-lab { padding: 10px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.9rem; border: 2px solid transparent; transition: 0.3s; cursor: pointer; }
        .btn-donate { background: transparent; border-color: var(--accent); color: var(--accent); }
        .btn-project { background: #fff; color: #000; }

        /* --- VISTA: BOARD --- */
        #view-board {
            flex: 1; display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: #000;
            overflow: hidden;
        }
        #view-board.active { display: flex; }

        /* HEADER JUEGO */
        .game-header {
            width: 100%; max-width: 600px; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20,20,20,0.9); border-bottom: 1px solid #333;
            position: absolute; top: 0; z-index: 50; height: 50px;
        }
        .gh-info { display: flex; flex-direction: column; }
        .gh-title { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .gh-subtitle { font-size: 0.75rem; color: #888; }
        .btn-exit { background: transparent; border: 1px solid #444; color: #ccc; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }

        /* Layout Tablero */
        .game-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 600px; height: 100%;
            padding: 60px 10px 10px 10px; 
            justify-content: center;
        }

        .eval-bar-wrapper { width: 100%; height: 12px; background: #263238; border-radius: 6px 6px 0 0; overflow: hidden; display: flex; }
        .eval-fill { height: 100%; background: #fff; width: 50%; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); }

        .board-container {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background-size: contain; 
        }

        .game-info {
            width: 100%; background: #1a1a1a; padding: 10px;
            border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none;
        }

        .coach-tags { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; min-height: 25px; }
        .tag { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tag.book { background: #448aff; color: white; }
        .tag.good { background: var(--success); color: black; }
        .tag.bad { background: var(--error); color: white; }
        .tag.warn { background: var(--warn); color: black; }
        .tag.end { background: #fff; color: #000; border: 2px solid var(--accent); }

        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .ctrl-btn { flex: 1; background: #252525; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .ctrl-btn:active { background: #444; color: #fff; }
        .ctrl-btn.sol { background: var(--warn); color: #000; border: none; }
        .ctrl-btn.next { background: var(--success); color: #000; border: none; }

        /* Feedback */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 20px 40px; border-radius: 12px;
            color: #fff; font-size: 1.5rem; font-weight: 800; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; border: 2px solid var(--accent); z-index: 50; text-align: center;
        }
        .feedback-overlay.show { opacity: 1; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo-link">
        <h1>AlterDrez</h1> <span style="font-size:0.7rem; color:#888;">PRO v5.9</span>
    </a>
    <div class="nav-menu">
        <button class="nav-btn" onclick="openModal('facts')">Secretos</button>
        <button class="nav-btn" onclick="openModal('benefits')">Neuro-Estrategia</button>
        <button class="nav-btn" onclick="openModal('news')">Noticias</button>
    </div>
    <button class="btn-help" onclick="openModal('welcome')"><i class="bi bi-gear-fill"></i></button>
</header>

<div id="toast" style="visibility:hidden; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:4px; z-index:3000;">Notificaci√≥n</div>

<div id="modal-welcome" class="modal-overlay active">
    <div class="modal-content">
        <div class="modal-header"><h2>Configuraci√≥n</h2><button onclick="document.getElementById('modal-welcome').classList.remove('active')" style="background:none;border:none;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <h4>1. Bases de Datos</h4>
                    <p style="font-size:0.85rem;">Si subes archivos, se sumar√°n.</p>
                    <a href="https://drive.google.com/file/d/1p1_YbMN57ET5-YMbJhHuzpltCXHgN3Gq/view?usp=sharing" target="_blank" style="display:block; text-align:center; background:var(--accent); color:#000; padding:10px; text-decoration:none; border-radius:4px; font-weight:bold;">Descargar Pack</a>
                    <button onclick="StorageManager.clearDB()" style="margin-top:10px; background:#333; border:1px solid #555; color:#aaa;">Resetear</button>
                </div>
                <div>
                    <h4>2. Tutorial</h4>
                    <video controls style="width:100%; border-radius:4px;"><source src="assets/alterdrez/tutorial.mp4" type="video/mp4"></video>
                </div>
            </div>
            <button onclick="document.getElementById('modal-welcome').classList.remove('active')" style="width:100%; margin-top:20px; background:var(--success); color:#fff; font-size:1.1rem; padding:15px; border:none; border-radius:6px; cursor:pointer;">¬°A JUGAR!</button>
        </div>
    </div>
</div>

<div id="modal-facts" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Secretos</h2><button onclick="closeAllModals()" style="background:none;border:none;width:auto;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><div class="fact-box fact-1"><h4>Shannon</h4><p>10^120 partidas posibles.</p></div><div class="fact-box fact-2"><h4>Larga</h4><p>269 movimientos.</p></div></div></div></div>
<div id="modal-benefits" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Beneficios</h2><button onclick="closeAllModals()" style="background:none;border:none;width:auto;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><div class="benefit-item"><h4>Plasticidad</h4><p>Mejora neuronal.</p></div></div></div></div>
<div id="modal-news" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Noticias</h2><button onclick="closeAllModals()" style="background:none;border:none;width:auto;color:#fff;font-size:1.5rem;"><i class="bi bi-x-lg"></i></button></div><div class="modal-body"><div class="news-grid"><a href="https://chess.com" target="_blank" class="news-card">Chess.com</a><a href="https://lichess.org" target="_blank" class="news-card">Lichess</a></div></div></div></div>

<div class="main-container">
    <div class="board-section">
        <div class="board-wrapper">
            <div class="eval-bar-wrapper"><div id="eval-fill" class="eval-fill"></div></div>
            <div class="board-container">
                <div id="board"></div>
                <div id="lessonFeedback" class="lesson-feedback"></div>
            </div>
            <div class="game-controls">
                <button class="control-btn" onclick="goToStart()"><i class="bi bi-skip-start-fill"></i></button>
                <button class="control-btn" onclick="undo()"><i class="bi bi-caret-left-fill"></i></button>
                <button class="control-btn" onclick="redo()"><i class="bi bi-caret-right-fill"></i></button>
                <button class="control-btn" onclick="goToEnd()"><i class="bi bi-skip-end-fill"></i></button>
                <button class="control-btn" onclick="board.flip()"><i class="bi bi-arrow-repeat"></i></button>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:5px; width:100%; font-size:0.8rem; color:#777;">
                <span id="statusText">Listo</span>
                <span id="thinkingIndicator" style="display:none; color:var(--accent);">Pensando...</span>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <!-- 1. JUGAR -->
        <div class="accordion-item active" id="panel-play">
            <div class="accordion-header" onclick="toggleAccordion('panel-play')">
                <span><i class="bi bi-joystick"></i> Jugar vs Stockfish</span> <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div style="display:flex; gap:10px;">
                    <select id="playerColor" style="flex:1;"><option value="w">Blancas</option><option value="b">Negras</option></select>
                    <select id="skillLevel" style="flex:1;">
                        <option value="0">Novato (800)</option>
                        <option value="3">Aficionado (1100)</option>
                        <option value="6">Intermedio (1400)</option>
                        <option value="9">Club (1700)</option>
                        <option value="12">Fuerte (2000)</option>
                        <option value="15">Maestro (2300)</option>
                        <option value="20">GM (3000+)</option>
                    </select>
                </div>
                <select id="gameMode">
                    <option value="pvc">Modo Competitivo</option>
                    <option value="analysis">Modo An√°lisis</option>
                </select>
                <button id="btnNewGame" style="background:var(--success); color:#fff; border:none;">Nueva Partida</button>
            </div>
        </div>

        <!-- 2. ENTRENADOR SIMPLIFICADO -->
        <div class="accordion-item active" id="panel-coach">
            <div class="accordion-header" onclick="toggleAccordion('panel-coach')">
                <span><i class="bi bi-activity"></i> An√°lisis</span> <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content" style="padding:10px;">
                <div class="coach-tags" id="coachTags">
                    <span class="tag book">Libro / Inicio</span>
                </div>
            </div>
        </div>

        <!-- 3. APERTURAS -->
        <div class="accordion-item acc-opening" id="panel-opening">
            <div class="accordion-header" onclick="toggleAccordion('panel-opening')">
                <span><i class="bi bi-book-half"></i> Aperturas</span> <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:0.7rem; color:var(--success);">Total: <span id="openingsTotal"></span></span>
                    <span style="font-size:0.7rem; color:#aaa;" id="openingDbBadge">Base</span>
                </div>
                <input type="text" id="openingSearch" placeholder="üîç Buscar...">
                <select id="openingSelect"><option value="">-- Seleccionar --</option></select>
                <input type="file" id="openingDbInput" accept=".csv,.tsv,.txt" style="display:none">
                <button onclick="document.getElementById('openingDbInput').click()" style="background:#222; border:1px dashed #555; color:#999;">Cargar DB (.tsv)</button>
                <div id="lessonActiveUI" class="hidden" style="margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                    <div style="color:var(--success); font-weight:bold;" id="lessonInstruction"></div>
                    <div style="font-size:0.8rem; color:#aaa;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="margin-top:5px; background:#333;">Salir</button>
                </div>
            </div>
        </div>

        <!-- 4. T√ÅCTICA -->
        <div class="accordion-item acc-tactics" id="panel-tactics">
            <div class="accordion-header" onclick="toggleAccordion('panel-tactics')">
                <span><i class="bi bi-lightning-fill"></i> T√°ctica</span> <i class="bi bi-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                     <label>Nivel</label> <span id="dbCountBadge" style="font-size:0.6rem; color:var(--tactics);"></span>
                </div>
                <select id="tacticsEloSelect">
                    <option value="800">Principiante (800)</option>
                    <option value="1100">Aficionado (1100)</option>
                    <option value="1400">Intermedio (1400)</option>
                    <option value="1700">Club (1700)</option>
                    <option value="2000">Avanzado (2000)</option>
                    <option value="2300">Maestro (2300)</option>
                    <option value="2500">Elite (2500+)</option>
                </select>
                <select id="tacticsPuzzleSelect" disabled><option value="">-- Puzzle --</option></select>
                <input type="file" id="dbInput" accept=".csv" style="display:none">
                <button onclick="document.getElementById('dbInput').click()" style="background:#222; border:1px dashed #555; color:#999;">Cargar DB (.csv)</button>
                <div id="tacticsActiveUI" class="hidden" style="margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                    <div style="color:var(--tactics); font-weight:bold;" id="tacticsTurnIndicator"></div>
                    <div style="font-size:0.8rem; color:#aaa;" id="tacticsDesc"></div>
                    <button id="btnQuitTactics" style="margin-top:5px; background:#333;">Salir</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
    function openModal(id) { closeAllModals(); document.getElementById('modal-' + id).classList.add('active'); }
    function toggleAccordion(id) { document.getElementById(id).classList.toggle('active'); }
    function showToast(msg) { const x = document.getElementById("toast"); x.style.visibility="visible"; x.innerText = msg; setTimeout(()=>x.style.visibility="hidden", 3000); }

    const game = new Chess();
    let board = null, engine = null, redoStack = [], currentMode = 'pvc', isEnginePlaying = false, lastEval = 0;
    let lessonState = { active: false, moves: [], index: 0, currentOpening: null };
    let tacticsState = { active: false, puzzle: null, index: 0 };

    // --- DATOS DUROS EXTENDIDOS (RESTAURADOS) ---
    let defaultOpenings = [
        {eco:"C50", name:"Italiana", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4"},
        {eco:"C60", name:"Ruy Lopez", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bb5"},
        {eco:"B20", name:"Siciliana", pgn:"1. e4 c5"},
        {eco:"B01", name:"Escandinava", pgn:"1. e4 d5"},
        {eco:"C00", name:"Francesa", pgn:"1. e4 e6"},
        {eco:"B10", name:"Caro-Kann", pgn:"1. e4 c6"},
        {eco:"D00", name:"Pe√≥n Dama", pgn:"1. d4 d5"},
        {eco:"D06", name:"Gambito Dama", pgn:"1. d4 d5 2. c4"},
        {eco:"A45", name:"Trompowsky", pgn:"1. d4 Nf6 2. Bg5"},
        {eco:"E60", name:"India de Rey", pgn:"1. d4 Nf6 2. c4 g6"},
        {eco:"A02", name:"Bird", pgn:"1. f4"},
        {eco:"A00", name:"Orangut√°n", pgn:"1. b4"},
        {eco:"C42", name:"Petrov", pgn:"1. e4 e5 2. Nf3 Nf6"},
        {eco:"C41", name:"Philidor", pgn:"1. e4 e5 2. Nf3 d6"},
        {eco:"C20", name:"Apertura de Rey", pgn:"1. e4 e5"},
        {eco:"B00", name:"Nimzowitsch", pgn:"1. e4 Nc6"},
        {eco:"A04", name:"Reti", pgn:"1. Nf3"},
        {eco:"A10", name:"Inglesa", pgn:"1. c4"},
        {eco:"C45", name:"Escocesa", pgn:"1. e4 e5 2. Nf3 Nc6 3. d4"},
        {eco:"C55", name:"Dos Caballos", pgn:"1. e4 e5 2. Nf3 Nc6 3. Bc4 Nf6"}
    ];
    let openingsList = JSON.parse(JSON.stringify(defaultOpenings));

    let defaultTactics = {
        "800": [{id:"1", fen:"6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves:["Rd8#"], theme:"Mate Pasillo"}, {id:"2", fen:"r1bqkb1r/pppp1ppp/2n5/4P3/2B1n3/5Q2/PPP2PPP/RNB1K1NR w KQkq - 0 6", moves:["Qxf7#"], theme:"Pastor"}, {id:"3", fen:"8/8/8/8/8/5k2/8/6QK w - - 0 1", moves:["Qg2#"], theme:"Mate Dama"}, {id:"4", fen:"4k3/8/8/8/8/8/4N3/2K3r1 w - - 0 1", moves:["Nxg1"], theme:"Come Torre"}, {id:"5", fen:"rnbqkbnr/pppp1ppp/8/4p3/6P4/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 2", moves:["Qh4#"], theme:"Mate Loco"}],
        "1600": [{id:"11", fen:"4k3/8/8/3N4/8/8/8/4K3 w - - 0 1", moves:["Nc7+","Kd8","Nxa8"], theme:"Horquilla"}, {id:"12", fen:"rnbqkb1r/pppppppp/5n2/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 1 2", moves:["e5"], theme:"Ataque"}, {id:"13", fen:"3r4/8/8/3R4/3K4/8/8/8 w - - 0 1", moves:["Rxd8"], theme:"Rayos X"}, {id:"14", fen:"r1b1k1nr/ppppqppp/2n5/2b5/2B1P3/2N2N2/PPPP1PPP/R1BQK2R w KQkq - 4 5", moves:["O-O"], theme:"Clavada"}, {id:"15", fen:"rnbqkbnr/pppp1ppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq - 0 1", moves:["e5"], theme:"Control"}],
        "2400": [{id:"21", fen:"8/8/8/8/p7/P7/2k5/7K w - - 0 1", moves:["Kg1"], theme:"Zugzwang"}, {id:"22", fen:"8/8/8/8/8/8/4K3/4k3 w - - 0 1", moves:["Ke3"], theme:"Oposici√≥n"}, {id:"23", fen:"7k/8/7K/8/8/8/8/Q7 w - - 0 1", moves:["Qa8#"], theme:"Mate Dama"}, {id:"24", fen:"8/8/8/5Q2/8/8/5K2/6qk w - - 0 1", moves:["Qh3+"], theme:"Tablas"}, {id:"25", fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", moves:["e4"], theme:"Best Move"}]
    };
    let tacticsDB = JSON.parse(JSON.stringify(defaultTactics));

    const StorageManager = {
        dbName: "AlterDrezDB", dbVersion: 1,
        init: function() {
            return new Promise((resolve) => {
                const req = indexedDB.open(this.dbName, this.dbVersion);
                req.onupgradeneeded = (e) => { const db=e.target.result; if(!db.objectStoreNames.contains("openings")) db.createObjectStore("openings"); if(!db.objectStoreNames.contains("tactics")) db.createObjectStore("tactics"); };
                req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                req.onerror = () => resolve(); 
            });
        },
        saveData: function(store, key, data) { const tx=this.db.transaction(store,"readwrite"); tx.objectStore(store).put(data,key); },
        loadData: function() {
            const txOp=this.db.transaction("openings","readonly"); 
            txOp.objectStore("openings").get("main").onsuccess=(e)=>{ 
                if(e.target.result && e.target.result.length > 0) { 
                    openingsList=e.target.result; 
                    $('#openingDbBadge').text("Memoria Local").css('color','lime');
                }
                populateOpeningsGUI(''); 
            };
            const txTac=this.db.transaction("tactics","readonly"); 
            txTac.objectStore("tactics").get("main").onsuccess=(e)=>{ 
                if(e.target.result && Object.keys(e.target.result).length > 0) { 
                    tacticsDB=e.target.result; 
                    $('#dbCountBadge').text(`Total: ${countTactics()}`).css('color','lime');
                }
            };
        },
        clearDB: function() { indexedDB.deleteDatabase(this.dbName).onsuccess=()=>{ location.reload(); }; }
    };

    function countTactics() { let c=0; Object.keys(tacticsDB).forEach(k=>c+=tacticsDB[k].length); return c; }

    const Observer = {
        eval: function(g, score, playerColor) {
            let delta = score - lastEval;
            let turn = g.turn(); 
            let mover = turn === 'w' ? 'Negras' : 'Blancas'; 
            let relDelta = (mover === 'Blancas') ? delta : -delta;

            let tagHtml = "";
            if(relDelta < -200) tagHtml = "<span class='tag blunder'>Error Grave</span>";
            else if(relDelta < -80) tagHtml = "<span class='tag mistake'>Error</span>";
            else if(relDelta < -30) tagHtml = "<span class='tag inaccuracy'>Imprecisi√≥n</span>";
            else if(relDelta > 20) tagHtml = "<span class='tag best'>Buena</span>";
            else tagHtml = "<span class='tag book'>Normal</span>";

            $('#coachTags').html(tagHtml);
            lastEval = score;
        }
    };

    function initEngine() {
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r=>r.blob()).then(blob=>{
            engine = new Worker(URL.createObjectURL(blob));
            engine.postMessage('uci');
            engine.onmessage = function(e) {
                const msg = e.data;
                if(msg.startsWith('bestmove') && isEnginePlaying) {
                    game.move(msg.split(' ')[1], {sloppy:true});
                    board.position(game.fen());
                    isEnginePlaying = false; $('#thinkingIndicator').hide();
                    analyze();
                }
                if(msg.includes('score cp')) {
                    const m = msg.match(/score cp (-?\d+)/);
                    if(m) {
                        let score = parseInt(m[1]);
                        if(game.turn() === 'b') score = -score;
                        let evalPerc = 100 / (1 + Math.exp(-0.004 * score));
                        evalPerc = Math.max(5, Math.min(95, evalPerc));
                        $('#evalFill').css('width', evalPerc + '%');
                        Observer.eval(game, score, $('#playerColor').val());
                    }
                }
                if(msg.includes('score mate')) {
                    const m = msg.match(/score mate (-?\d+)/);
                    if(m) {
                        let mate = parseInt(m[1]);
                        if(game.turn() === 'b') mate = -mate;
                        let evalPerc = mate > 0 ? 100 : 0;
                        $('#evalFill').css('width', evalPerc + '%');
                    }
                }
            };
        });
    }

    function moveAI() {
        if(currentMode!=='pvc' || game.game_over()) return;
        isEnginePlaying = true; $('#thinkingIndicator').show();
        let lvl = parseInt($('#skillLevel').val());
        let depth = 10; if(lvl < 5) depth = 2; else if(lvl < 10) depth = 6; else if(lvl < 15) depth = 10; else depth = 14;
        engine.postMessage(`setoption name Skill Level value ${lvl}`); engine.postMessage('position fen '+game.fen()); engine.postMessage(`go depth ${depth}`);
    }

    function analyze() {
        if(currentMode==='tactics') return; 
        engine.postMessage('stop'); engine.postMessage('setoption name Skill Level value 20'); engine.postMessage('position fen '+game.fen()); engine.postMessage('go depth 10');
    }

    // --- GAME LOGIC ---
    function checkStatus() {
        if(game.in_checkmate()) {
            UI.feedback("¬°Jaque Mate!", "success");
            $('#coach-display').html(`<span class="tag end">üèÜ Jaque Mate</span>`);
            engine.postMessage('stop');
            return true;
        }
        if(game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
            UI.feedback("¬°Tablas!", "warn");
            $('#coach-display').html(`<span class="tag end">¬Ω Tablas</span>`);
            engine.postMessage('stop');
            return true;
        }
        return false;
    }

    function onDrop(s, t) {
        if(currentMode === 'lesson') return 'snapback';
        
        if(currentMode === 'tactics') {
            const temp = new Chess(game.fen());
            const m = temp.move({from:s, to:t, promotion:'q'}); 
            if(m) {
                // FIXED TACTICS LOGIC: We are at index 1 (our turn)
                const correct = tacticsState.puzzle.moves[tacticsState.index];
                if(m.san === correct || (m.from+m.to+(m.promotion||'')) === correct) {
                    game.move({from:s, to:t, promotion:'q'}); 
                    board.position(game.fen()); 
                    tacticsState.index++;
                    UI.feedback("¬°Bien!", "success");
                    
                    // Opponent move
                    if(tacticsState.index < tacticsState.puzzle.moves.length) {
                        setTimeout(() => {
                            game.move(tacticsState.puzzle.moves[tacticsState.index], {sloppy:true});
                            board.position(game.fen());
                            tacticsState.index++;
                        }, 500);
                    } else UI.feedback("¬°Resuelto!", "success");
                    return;
                }
            } 
            UI.feedback("Incorrecto", "error");
            return 'snapback';
        }
        
        if(redoStack.length > 0) redoStack = [];
        const m = game.move({from:s, to:t, promotion:'q'}); 
        if(!m) return 'snapback';
        
        board.position(game.fen());
        
        if(checkStatus()) return;

        if(currentMode==='pvc' && game.turn()!==$('#playerColor').val()) setTimeout(moveAI, 100); else analyze();
    }

    function onDragStart(s, p) {
        if(game.game_over()) return false;
        if(currentMode === 'tactics') {
            if((game.turn() === 'w' && p.search(/^b/) !== -1) || (game.turn() === 'b' && p.search(/^w/) !== -1)) return false;
            return true;
        }
        if(currentMode==='pvc' && isEnginePlaying) return false;
        if(currentMode==='pvc' && (($('#playerColor').val()==='w' && p.startsWith('b')) || ($('#playerColor').val()==='b' && p.startsWith('w')))) return false;
        if(currentMode==='lesson') return false; 
        return true;
    }

    function undo() { 
        if(isEnginePlaying) return; 
        if(currentMode === 'lesson') { LessonSystem.prev(); return; } 
        let m = game.undo(); 
        if(m) { redoStack.push(m); board.position(game.fen()); analyze(); } 
    }
    function redo() { 
        if(isEnginePlaying) return; 
        if(currentMode === 'lesson') { LessonSystem.next(); return; } 
        if(redoStack.length > 0) { let m = redoStack.pop(); game.move(m); board.position(game.fen()); analyze(); } 
    }
    function goToStart() { if(currentMode==='lesson') return; while(game.undo()) { redoStack.push(game.undo()); } game.reset(); board.position('start'); redoStack = []; }
    function goToEnd() { while(redoStack.length > 0) redo(); }

    const OpeningManager = {
        importFile: function(f) { const r=new FileReader(); r.onload=e=>this.parse(e.target.result); r.readAsText(f); },
        parse: function(t) {
            const l=t.split('\n'); let added=0;
            for(let x of l) { 
                let p=x.split(x.includes('\t')?'\t':','); 
                if(p.length>=3 && p[p.length-1].length>2) {
                    openingsList.push({eco:p[0],name:p[1],pgn:p[p.length-1].trim()}); added++;
                }
            }
            if(added>0){ 
                StorageManager.saveData("openings","main",openingsList); populateOpeningsGUI(''); 
                showToast(`+${added} aperturas`);
            } else alert("Error archivo");
        },
        pgnToArray: function(p) {
            const t=new Chess(); const c=p.replace(/\*/g,'').replace(/1-0|0-1|1\/2-1\/2/g,'');
            const tk=c.replace(/\d+\./g,'').split(/\s+/);
            for(let k of tk) if(k) t.move(k,{sloppy:true});
            return t.history();
        }
    };
    
    const TacticsManager = {
        importCSV: function(f) { const r=new FileReader(); r.onload=e=>this.parse(e.target.result); r.readAsText(f); },
        parse: function(t) {
            const l=t.split('\n'); let added=0; const isComma = t.indexOf(',') > -1;
            const MAX = 20000;
            if(countTactics() >= MAX) return alert("L√≠mite de memoria alcanzado.");

            for(let i=0; i<l.length; i++){
                if(countTactics() >= MAX) break;
                if(!l[i]) continue; const c = l[i].split(isComma ? ',' : '\t'); 
                if(c.length<4) continue; const r=parseInt(c[3]); if(isNaN(r)) continue;
                
                let k="800"; 
                if(r>=2500) k="2500"; else if(r>=2300) k="2300"; else if(r>=2000) k="2000"; 
                else if(r>=1700) k="1700"; else if(r>=1400) k="1400"; else if(r>=1100) k="1100";
                
                if(!tacticsDB[k]) tacticsDB[k] = [];
                tacticsDB[k].push({id:c[0], fen:c[1], moves:c[2].split(' '), desc:"Encuentra la mejor l√≠nea"}); added++;
            }
            if(added>0) {
                StorageManager.saveData("tactics","main",tacticsDB); showToast(`+${added} puzzles`); updateTacticsList();
                $('#dbCountBadge').text(`Total: ${countTactics()}`).css('color','cyan');
            } else alert("Error archivo");
        }
    };

    function populateOpeningsGUI(f) { 
        const s=$('#openingSelect').empty().append('<option>--</option>'); const t=f.toLowerCase(); 
        $('#openingsTotal').text(openingsList.length);
        openingsList.forEach((o,i)=>{ if(o.name.toLowerCase().includes(t)) s.append(new Option(o.name,i)); }); 
    }
    function updateTacticsList() { 
        const e=$('#tacticsEloSelect').val(); const s=$('#tacticsPuzzleSelect').empty(); 
        if(e&&tacticsDB[e]) tacticsDB[e].slice(0,100).forEach((p,i)=>s.append(new Option(`Puzzle ${i+1}`,i))); s.prop('disabled',!e); 
    }

    const LessonSystem = {
        start: function(idx) {
            const op = openingsList[idx]; if(!op) return;
            lessonState = { active: true, moves: OpeningManager.pgnToArray(op.pgn), index: 0, currentOpening: op };
            currentMode = 'lesson'; $('#lessonActiveUI').removeClass('hidden'); $('#lessonDescription').text(op.name);
            game.reset(); board.position('start'); board.orientation('white'); this.prompt(); analyze();
        },
        prompt: function() {
            if(lessonState.index >= lessonState.moves.length) { $('#lessonInstruction').text("¬°Completado!"); return; }
            $('#lessonInstruction').html(`Juega <b>${lessonState.moves[lessonState.index]}</b>`);
        },
        next: function() { 
            if(lessonState.index < lessonState.moves.length) { 
                game.move(lessonState.moves[lessonState.index]); board.position(game.fen()); 
                lessonState.index++; this.prompt(); analyze(); 
            } 
        },
        prev: function() { 
            game.undo(); board.position(game.fen()); 
            if(lessonState.index > 0) lessonState.index--; 
            this.prompt(); analyze();
        },
        stop: function() { lessonState.active=false; $('#lessonActiveUI').addClass('hidden'); currentMode='analysis'; }
    };

    const TacticsSystem = {
        start: function(elo, idx) {
            const p = tacticsDB[elo][idx]; if(!p) return;
            tacticsState = { active:true, puzzle:p, index:0 }; currentMode = 'tactics';
            $('#tacticsActiveUI').removeClass('hidden'); $('#tacticsDesc').text(p.desc);
            
            // FIX: Cargar FEN
            game.load(p.fen);
            
            // FIX: Jugar el primer movimiento (del rival) autom√°ticamente
            const opponentMove = p.moves[0];
            if(opponentMove) {
                game.move(opponentMove, {sloppy:true});
            }
            
            // Actualizar tablero y orientar al JUGADOR
            board.position(game.fen());
            const userColor = game.turn() === 'w' ? 'white' : 'black';
            board.orientation(userColor);
            
            // Empezamos buscando el √≠ndice 1 (respuesta del usuario)
            tacticsState.index = 1;
            
            $('#tacticsTurnIndicator').text(`Juegan ${userColor}`);
        },
        check: function(m) { return true; }, // Logic moved to onDrop for simplicity
        showSolution: function() {
            if(currentMode !== 'tactics') return;
            const move = tacticsState.puzzle.moves[tacticsState.index];
            if(move) {
                game.move(move, {sloppy:true});
                board.position(game.fen());
                tacticsState.index++;
                if(tacticsState.index < tacticsState.puzzle.moves.length) {
                    setTimeout(() => {
                        game.move(tacticsState.puzzle.moves[tacticsState.index], {sloppy:true});
                        board.position(game.fen());
                        tacticsState.index++;
                    }, 500);
                }
            }
        },
        stop: function() { tacticsState.active=false; $('#tacticsActiveUI').addClass('hidden'); currentMode='analysis'; }
    };

    $(document).ready(async () => {
        board = Chessboard('board', { draggable:true, position:'start', onDragStart:onDragStart, onDrop:onDrop, pieceTheme:'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        $(window).resize(board.resize);
        initEngine();
        await StorageManager.init(); StorageManager.loadData();
        populateOpeningsGUI(''); updateTacticsList();
        $('#dbCountBadge').text(`Total: ${countTactics()}`);

        $('#openingDbInput').change(function(){if(this.files.length)OpeningManager.importFile(this.files[0])});
        $('#dbInput').change(function(){if(this.files.length)TacticsManager.importCSV(this.files[0])});
        $('#openingSearch').on('input', function(){populateOpeningsGUI($(this).val())});
        $('#openingSelect').change(function(){if($(this).val())LessonSystem.start($(this).val())});
        $('#tacticsEloSelect').change(updateTacticsList);
        $('#tacticsPuzzleSelect').change(function(){if($(this).val())TacticsSystem.start($('#tacticsEloSelect').val(), $(this).val())});
        
        $('#btnQuitLesson').click(()=>LessonSystem.stop());
        $('#btnQuitTactics').click(()=>TacticsSystem.stop());
        $('#btnNewGame').click(()=>{ 
            game.reset(); board.start(); $('#statusText').text("Nueva Partida"); 
            currentMode = $('#gameMode').val();
            if(currentMode === 'pvc' && $('#playerColor').val()==='b') moveAI(); 
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === "ArrowLeft") { undo(); e.preventDefault(); }
            if (e.key === "ArrowRight") { redo(); e.preventDefault(); }
        });
    });
</script>
</body>
</html>
