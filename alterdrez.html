<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alter.Drez - Plataforma Profesional</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --bg: #0F121B;
            --panel: #1A1E29;
            --accent: #4db8ff;
            --text: #e0e0e0;
            --success: #00e676;
            --error: #ff1744;
            --warn: #ffea00;
            --tactics: #d500f9;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        header { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); text-align: center; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 1.6rem; letter-spacing: 2px; font-weight: 800; color: var(--accent); }

        .main-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
            width: 100%; max-width: 1300px; padding: 20px;
        }

        /* ZONA TABLERO */
        .board-section { flex: 1; min-width: 300px; max-width: 600px; }
        .board-container {
            width: 100%; touch-action: none;
            border: 5px solid #222; border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .lesson-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 15px 25px; border-radius: 8px;
            text-align: center; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 10; border: 1px solid var(--accent); font-size: 1.2rem;
        }
        .lesson-feedback.show { opacity: 1; }
        .lesson-feedback.error { border-color: var(--error); color: var(--error); }
        .lesson-feedback.success { border-color: var(--success); color: var(--success); }
        .lesson-feedback.tactics { border-color: var(--tactics); color: var(--tactics); }

        .eval-bar-wrapper { height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; margin-bottom: 5px; }
        .eval-fill { height: 100%; width: 50%; background: #fff; transition: width 0.5s ease, background 0.3s; }

        /* PANELES */
        .sidebar { flex: 1; min-width: 300px; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 10px; padding: 15px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 0.8rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* UTILIDADES UI */
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
        select, button, input[type="text"] {
            width: 100%; padding: 10px; background: #252a36; border: 1px solid #444; color: #fff;
            border-radius: 5px; font-family: inherit; margin-bottom: 10px; cursor: pointer;
        }
        input[type="text"] { cursor: text; }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }
        
        .btn-row { display: flex; gap: 10px; }
        .hidden { display: none; }
        
        .btn-db-tactics { background: #331a38; border: 1px dashed var(--tactics); font-size: 0.75rem; margin-top:5px; }
        .btn-db-tactics:hover { background: var(--tactics); color: white; }
        
        .btn-db-opening { background: #1a3824; border: 1px dashed var(--success); font-size: 0.75rem; margin-top:5px; }
        .btn-db-opening:hover { background: var(--success); color: white; }

        .lesson-status { font-size: 0.9rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
        .tactics-info { font-size: 0.85rem; color: #d1c4e9; margin-bottom: 8px; min-height: 35px;}
        .tactics-turn { font-weight: bold; color: var(--tactics); }

        /* Scrollbar para selects largos */
        select { max-height: 200px; }
        
        /* ENTRENADOR */
        .coach-msg { font-size: 0.9rem; line-height: 1.4; color: #fff; margin-bottom: 10px; min-height: 40px; }
        .coach-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; }
        .tag.good { background: rgba(0,230,118,0.1); color: var(--success); border-color: var(--success); }
        .tag.bad { background: rgba(255,23,68,0.1); color: var(--error); border-color: var(--error); }
        .tag.warn { background: rgba(255,234,0,0.1); color: var(--warn); border-color: var(--warn); }
        .tag.info { background: rgba(77,184,255,0.1); color: var(--accent); border-color: var(--accent); }

    </style>
</head>
<body>

<header>
    <h1>Alter.Drez <i class="bi bi-trophy-fill"></i></h1>
</header>

<div class="main-container">
    
    <!-- IZQUIERDA: TABLERO -->
    <div class="board-section">
        <div class="eval-bar-wrapper">
            <div id="evalFill" class="eval-fill"></div>
        </div>
        
        <div class="board-container">
            <div id="board"></div>
            <div id="lessonFeedback" class="lesson-feedback"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.85rem; color:#aaa;">
            <span id="statusText">Esperando...</span>
            <span id="thinkingIndicator" style="display:none; color:var(--accent);">IA Pensando...</span>
        </div>
    </div>

    <!-- DERECHA: CONTROLES -->
    <div class="sidebar">

        <!-- 1. ACADEMIA DE APERTURAS -->
        <div class="panel" style="border-left: 3px solid var(--success);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="bi bi-mortarboard"></i> Academia</h3>
                <span id="openingCountBadge" style="font-size:0.7rem; background:#333; padding:2px 6px; border-radius:4px;">B√°sica</span>
            </div>
            
            <div id="lessonControls">
                <!-- Buscador de aperturas -->
                <input type="text" id="openingSearch" placeholder="üîç Buscar apertura (ej: Sicilian)...">
                
                <select id="openingSelect">
                    <option value="">-- Seleccionar Lecci√≥n --</option>
                </select>

                <!-- IMPORTAR DB APERTURAS -->
                <input type="file" id="openingDbInput" accept=".csv,.tsv,.txt" style="display:none">
                <button onclick="document.getElementById('openingDbInput').click()" class="btn-db-opening">
                    <i class="bi bi-book"></i> Cargar ECO/PGN (.tsv/.csv)
                </button>
                
                <div id="lessonActiveUI" class="hidden">
                    <div class="lesson-status" id="lessonInstruction">Tu turno...</div>
                    <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;" id="lessonDescription"></div>
                    <button id="btnQuitLesson" style="background: #333; border-color: #555;">Salir de la Lecci√≥n</button>
                </div>
            </div>
        </div>

        <!-- 2. T√ÅCTICA -->
        <div class="panel" style="border-left: 3px solid var(--tactics);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="bi bi-lightning-fill"></i> T√°ctica</h3>
                <span id="dbCountBadge" style="font-size:0.7rem; background:#333; padding:2px 6px; border-radius:4px;">B√°sica</span>
            </div>
            
            <div id="tacticsControls">
                <select id="tacticsEloSelect">
                    <option value="">-- Nivel (Elo) --</option>
                    <option value="800">800 (Principiante)</option>
                    <option value="1000">1000 (Aficionado)</option>
                    <option value="1300">1300 (Intermedio)</option>
                    <option value="1600">1600 (Club)</option>
                    <option value="2000">2000 (Experto)</option>
                    <option value="2400">2400 (Maestro)</option>
                    <option value="2800">2800 (GM)</option>
                </select>

                <select id="tacticsPuzzleSelect" disabled>
                    <option value="">-- Seleccionar --</option>
                </select>

                <input type="file" id="dbInput" accept=".csv" style="display:none">
                <button onclick="document.getElementById('dbInput').click()" class="btn-db-tactics">
                    <i class="bi bi-folder-plus"></i> Cargar Puzzles Lichess
                </button>

                <div id="tacticsActiveUI" class="hidden">
                    <div class="tactics-info" id="tacticsDesc"></div>
                    <div class="tactics-turn" id="tacticsTurnIndicator"></div>
                    <button id="btnQuitTactics" style="background: #333; border-color: #555; margin-top:5px;">Salir</button>
                </div>
            </div>
        </div>

        <!-- 3. ENTRENADOR -->
        <div class="panel" id="coachPanel">
            <h3><i class="bi bi-robot"></i> Entrenador Virtual</h3>
            <div class="coach-msg" id="coachMsg">Selecciona un modo para comenzar.</div>
            <div class="coach-tags" id="coachTags"></div>
        </div>

        <!-- 4. JUGAR VS STOCKFISH -->
        <div class="panel">
            <h3>Jugar vs Stockfish</h3>
            
            <div class="btn-row">
                <div style="width: 50%;">
                    <label>Tu Color</label>
                    <select id="playerColor">
                        <option value="w">Blancas</option>
                        <option value="b">Negras</option>
                    </select>
                </div>
                <div style="width: 50%;">
                    <label>Nivel de Juego</label>
                    <select id="skillLevel">
                        <option value="0">Principiante (800)</option>
                        <option value="3">Aficionado (1000)</option>
                        <option value="6">Intermedio (1300)</option>
                        <option value="10" selected>Club (1600)</option>
                        <option value="14">Experto (2000)</option>
                        <option value="17">Maestro (2400)</option>
                        <option value="20">Grand Master (2800+)</option>
                    </select>
                </div>
            </div>

            <div class="btn-row">
                <select id="gameMode">
                    <option value="pvc">Modo Competitivo</option>
                    <option value="analysis">Modo An√°lisis Libre</option>
                </select>
            </div>

            <div class="btn-row">
                <button id="btnNewGame">Nueva Partida</button>
                <button id="btnFlip" style="width: 40%;"><i class="bi bi-arrow-down-up"></i></button>
            </div>
            
            <div class="btn-row" style="margin-top: 5px;">
                <button id="btnUndo"><i class="bi bi-arrow-left"></i></button>
                <button id="btnRedo"><i class="bi bi-arrow-right"></i></button>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
    // --- VARIABLES GLOBALES ---
    const game = new Chess();
    let board = null;
    let engine = null;
    let redoStack = [];
    
    // Estados
    let currentMode = 'pvc'; 
    let lessonState = { active: false, moves: [], index: 0, currentOpening: null };
    let tacticsState = { active: false, puzzle: null, index: 0 };
    let isEnginePlaying = false; 

    // --- BASE DE DATOS DE APERTURAS (INICIAL) ---
    let openingsList = [
        { eco: "C50", name: "Italian Game", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bc4" },
        { eco: "C60", name: "Ruy Lopez", pgn: "1. e4 e5 2. Nf3 Nc6 3. Bb5" },
        { eco: "B20", name: "Sicilian Defense", pgn: "1. e4 c5" },
        { eco: "B01", name: "Scandinavian Defense", pgn: "1. e4 d5" },
        { eco: "A45", name: "Queen's Pawn Game", pgn: "1. d4 Nf6" },
        { eco: "D00", name: "Queen's Pawn Game: Chigorin", pgn: "1. d4 d5 2. Nc3" },
        { eco: "C00", name: "French Defense", pgn: "1. e4 e6" },
        { eco: "B10", name: "Caro-Kann Defense", pgn: "1. e4 c6" }
    ];

    // --- BASE DE DATOS T√ÅCTICA (INICIAL) ---
    let tacticsDB = {
        "800": [{ id: "1", name: "Mate Pasillo", fen: "6k1/5ppp/8/8/8/8/5PPP/3R2K1 w - - 0 1", moves: ["Rd8#"], desc: "Mate en 1." }],
        "1000": [{ id: "2", name: "Mate Pastor", fen: "r1bqkb1r/pppp1ppp/2n5/4P3/2B1n3/5Q2/PPP2PPP/RNB1K1NR w KQkq - 0 6", moves: ["Qxf7#"], desc: "Ataca f7." }],
        "1300": [], "1600": [], "2000": [], "2400": [], "2800": []
    };

    // --- GESTOR DE APERTURAS ---
    const OpeningManager = {
        importFile: function(file) {
            const reader = new FileReader();
            reader.onload = function(e) { OpeningManager.parseECO(e.target.result); };
            reader.readAsText(file);
        },
        parseECO: function(text) {
            const lines = text.split('\n');
            let newOpenings = [];
            let count = 0;
            for(let line of lines) {
                if(!line || line.startsWith('#')) continue;
                let parts = line.split('\t');
                if(parts.length < 3) parts = line.split(','); 
                if(parts.length >= 3) {
                    let eco = parts[0].trim();
                    let name = parts[1].trim();
                    let pgn = parts[parts.length-1].trim();
                    if(pgn.length > 2) { newOpenings.push({ eco: eco, name: name, pgn: pgn }); count++; }
                }
            }
            if(count > 0) {
                openingsList = newOpenings;
                alert(`¬°√âxito! Cargadas ${count} aperturas.`);
                $('#openingCountBadge').text(`${count} Ops`);
                populateOpeningsGUI('');
            } else alert("No se detect√≥ formato v√°lido.");
        },
        pgnToArray: function(pgnString) {
            const tempGame = new Chess();
            const cleanPgn = pgnString.replace(/\*/g, '').replace(/1-0/g,'').replace(/0-1/g,'').replace(/1\/2-1\/2/g,'');
            if(!tempGame.load_pgn(cleanPgn)) {
                tempGame.reset();
                const tokens = cleanPgn.replace(/\d+\./g, '').split(/\s+/);
                for(let t of tokens) { if(t) tempGame.move(t, {sloppy:true}); }
            }
            return tempGame.history();
        }
    };

    // --- GESTOR DE T√ÅCTICA ---
    const TacticsManager = {
        importCSV: function(file) {
            const reader = new FileReader();
            reader.onload = function(e) { TacticsManager.parse(e.target.result); };
            reader.readAsText(file);
        },
        parse: function(csvText) {
            const lines = csvText.split('\n');
            let count = 0;
            tacticsDB = { "800":[], "1000":[], "1300":[], "1600":[], "2000":[], "2400":[], "2800":[] };
            for(let i=1; i < lines.length && count < 10000; i++) {
                const cols = lines[i].split(',');
                if(cols.length < 4) continue;
                const fen = cols[1];
                const moves = cols[2].split(' ');
                const rating = parseInt(cols[3]);
                let b = "800";
                if(rating>=2800) b="2800"; else if(rating>=2400) b="2400"; else if(rating>=2000) b="2000";
                else if(rating>=1600) b="1600"; else if(rating>=1300) b="1300"; else if(rating>=1000) b="1000";
                tacticsDB[b].push({ id: cols[0], name: `Puzzle ${rating}`, fen: fen, moves: moves, desc: "Encuentra la mejor l√≠nea" });
                count++;
            }
            $('#dbCountBadge').text(`${count} Puzzles`);
            alert(`Cargados ${count} ejercicios.`);
        }
    };

    // --- LECCIONES ---
    const LessonSystem = {
        start: function(index) {
            const op = openingsList[index];
            if (!op) return;
            this.stopOtherModes();
            const movesArray = OpeningManager.pgnToArray(op.pgn);
            lessonState = { active: true, moves: movesArray, index: 0, currentOpening: op };
            currentMode = 'lesson';
            $('#lessonActiveUI').removeClass('hidden');
            $('#lessonDescription').text(`${op.eco} - ${op.name}`);
            game.reset(); board.position('start'); board.orientation('white');
            this.updatePrompt();
        },
        updatePrompt: function() {
            if(lessonState.index >= lessonState.moves.length) { this.finish(); return; }
            const move = lessonState.moves[lessonState.index];
            const turn = game.turn() === 'w' ? 'Blancas' : 'Negras';
            $('#lessonInstruction').html(`<span style="color:var(--accent)">${turn}:</span> Juega <b>${move}</b>`);
            $('#statusText').text("Academia: " + lessonState.currentOpening.name);
        },
        checkMove: function(moveObj) {
            const expected = lessonState.moves[lessonState.index];
            if (moveObj.san === expected) {
                this.feedback("¬°Correcto!", "success");
                lessonState.index++;
                if(lessonState.index < lessonState.moves.length) setTimeout(() => this.playAuto(), 500);
                else this.finish();
                return true;
            }
            this.feedback(`Error. La l√≠nea es ${expected}`, "error");
            return false;
        },
        playAuto: function() {
            if(!lessonState.active) return;
            game.move(lessonState.moves[lessonState.index]);
            board.position(game.fen());
            lessonState.index++;
            this.updatePrompt();
        },
        feedback: function(msg, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(msg).removeClass('success error tactics').addClass('show '+type);
            setTimeout(() => $fb.removeClass('show'), 1500);
        },
        finish: function() { $('#lessonInstruction').html(`<span style="color:var(--success)">¬°Completado!</span>`); currentMode = 'analysis'; },
        stop: function() { lessonState.active = false; $('#lessonActiveUI').addClass('hidden'); currentMode = 'analysis'; },
        stopOtherModes: function() { TacticsSystem.stop(); }
    };

    // --- T√ÅCTICA ---
    const TacticsSystem = {
        start: function(elo, idx) {
            const puzzle = tacticsDB[elo][idx];
            if (!puzzle) return;
            this.stopOtherModes();
            tacticsState = { active: true, puzzle: puzzle, index: 0 };
            currentMode = 'tactics';
            $('#tacticsActiveUI').removeClass('hidden');
            $('#tacticsDesc').text(puzzle.desc);
            game.load(puzzle.fen);
            board.position(puzzle.fen);
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            this.updatePrompt();
        },
        updatePrompt: function() { $('#tacticsTurnIndicator').text(`Juegan ${game.turn()==='w'?'Blancas':'Negras'}`); },
        checkMove: function(moveObj) {
            const expected = tacticsState.puzzle.moves[tacticsState.index];
            let ok = (moveObj.san === expected) || (moveObj.from+moveObj.to+(moveObj.promotion||'') === expected);
            if (ok) {
                this.feedback("¬°Bien!", "tactics");
                tacticsState.index++;
                if (tacticsState.index < tacticsState.puzzle.moves.length) setTimeout(() => this.playResponse(), 600);
                else this.finish();
                return true;
            }
            this.feedback("Mal", "error");
            return false;
        },
        playResponse: function() {
            if(!tacticsState.active) return;
            const m = tacticsState.puzzle.moves[tacticsState.index];
            if(m) { game.move(m, {sloppy:true}); board.position(game.fen()); tacticsState.index++; }
            if(tacticsState.index >= tacticsState.puzzle.moves.length) this.finish();
        },
        feedback: function(msg, type) {
            const $fb = $('#lessonFeedback');
            $fb.text(msg).removeClass('success error tactics').addClass('show '+type);
            setTimeout(() => $fb.removeClass('show'), 1000);
        },
        finish: function() { $('#tacticsTurnIndicator').html("<span style='color:lime'>¬°Resuelto!</span>"); },
        stop: function() { tacticsState.active = false; $('#tacticsActiveUI').addClass('hidden'); currentMode = 'analysis'; },
        stopOtherModes: function() { LessonSystem.stop(); }
    };

    // --- ENTRENADOR (OBSERVER) - RESTAURADO ---
    const Observer = {
        lastScore: 0,
        evaluate: function(game, score, pColor) {
            if(currentMode === 'lesson' || currentMode === 'tactics') return;
            
            let delta = score - this.lastScore;
            // Si juegan negras, el score negativo es bueno para ellas, invertimos para l√≥gica humana
            // Pero Stockfish cp score suele ser relativo al que mueve. 
            // Simplificamos: Asumimos score centipawns absoluto (Positivo=Blancas mejor)
            
            let msgs = [], tags = [];
            
            if (Math.abs(score) < 50) tags.push({text:"Igualdad", type:"info"});
            else if ((pColor==='w' && score>100) || (pColor==='b' && score<-100)) tags.push({text:"Vas Ganando", type:"good"});
            else if ((pColor==='w' && score<-100) || (pColor==='b' && score>100)) tags.push({text:"Vas Perdiendo", type:"bad"});

            const fen = game.fen();
            const moves = parseInt(fen.split(' ')[5]);

            if(moves < 8 && Math.abs(score) < 80) msgs.push("Apertura: Desarrolla piezas y controla el centro.");
            else if (Math.abs(delta) > 200) {
                msgs.push("¬°Cambio dr√°stico! Revisa el √∫ltimo movimiento.");
                tags.push({text:"Ojo T√°ctico", type:"warn"});
            } else {
                msgs.push("Busca mejorar tu posici√≥n poco a poco.");
            }

            $('#coachMsg').text(msgs[0]);
            $('#coachTags').empty();
            tags.forEach(t => $('#coachTags').append(`<span class="tag ${t.type}">${t.text}</span>`));
            this.lastScore = score;
        }
    };

    // --- INIT & UTILS ---
    function init() {
        fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')
            .then(r=>r.blob()).then(blob=>{
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('uci');
                engine.onmessage = handleEngine;
                $('#statusText').text("Motor Listo");
            });

        // UI Events
        $('#openingDbInput').change(function() { if(this.files.length) OpeningManager.importFile(this.files[0]); });
        $('#openingSearch').on('input', function() { populateOpeningsGUI($(this).val()); });
        $('#openingSelect').change(function() { if($(this).val()!=='') LessonSystem.start($(this).val()); });
        $('#btnQuitLesson').click(() => LessonSystem.stop());
        
        $('#dbInput').change(function() { if(this.files.length) TacticsManager.importCSV(this.files[0]); });
        $('#tacticsEloSelect').change(updateTacticsList);
        $('#tacticsPuzzleSelect').change(function() { if($(this).val()) TacticsSystem.start($('#tacticsEloSelect').val(), $(this).val()); });
        $('#btnQuitTactics').click(() => TacticsSystem.stop());

        $('#btnNewGame').click(newGame);
        $('#btnUndo').click(undo); $('#btnRedo').click(redo); $('#btnFlip').click(()=>board.flip());

        populateOpeningsGUI('');
    }

    function populateOpeningsGUI(filter) {
        const $sel = $('#openingSelect').empty().append('<option value="">-- Seleccionar --</option>');
        const term = filter.toLowerCase();
        openingsList.forEach((op, idx) => {
            if(op.name.toLowerCase().includes(term) || op.eco.toLowerCase().includes(term)) {
                $sel.append(`<option value="${idx}">[${op.eco}] ${op.name}</option>`);
            }
        });
    }

    function updateTacticsList() {
        const elo = $('#tacticsEloSelect').val();
        const $sel = $('#tacticsPuzzleSelect').empty().append('<option value="">-- Seleccionar --</option>');
        if(elo && tacticsDB[elo]) {
            tacticsDB[elo].slice(0, 100).forEach((p, i) => $sel.append(`<option value="${i}">${p.name}</option>`));
            $sel.prop('disabled', false);
        } else $sel.prop('disabled', true);
    }

    // --- L√ìGICA DE JUEGO & ENGINE (ARREGLADA) ---
    function handleEngine(e) {
        const msg = e.data;
        
        // 1. Si la IA debe mover
        if(msg.startsWith('bestmove') && isEnginePlaying) {
            const move = msg.split(' ')[1];
            game.move(move, {sloppy:true});
            board.position(game.fen());
            isEnginePlaying = false;
            $('#thinkingIndicator').hide();
            triggerAnalysis(); // Analizar despu√©s del movimiento de la IA
        }
        
        // 2. An√°lisis (Evaluaci√≥n y Coach)
        if(msg.startsWith('info') && msg.includes('score') && !msg.includes('lowerbound') && !msg.includes('upperbound')) {
            const match = msg.match(/score (cp|mate) (-?\d+)/);
            if(match) {
                let score = parseInt(match[2]);
                // Ajuste de perspectiva: Stockfish da score relativo, queremos absoluto a veces
                // Para simplificar, pasamos el score tal cual al Observer y √©l decide
                if(game.turn() === 'b') score = -score; // Invertir si es turno de negras para normalizar a White perspective
                
                updateEvalBar(score, match[1]);
                Observer.evaluate(game, score, $('#playerColor').val());
            }
        }
    }

    function triggerAI() {
        if(currentMode !== 'pvc' || game.game_over()) return;
        isEnginePlaying = true;
        $('#thinkingIndicator').show();
        
        const level = parseInt($('#skillLevel').val());
        // Mapeo de dificultad
        let depth = 1;
        if (level < 5) depth = 1;
        else if (level < 10) depth = 5;
        else if (level < 15) depth = 10;
        else depth = 18;

        engine.postMessage(`setoption name Skill Level value ${level}`);
        engine.postMessage('position fen ' + game.fen());
        engine.postMessage(`go depth ${depth}`);
    }

    function triggerAnalysis() {
        if(currentMode==='lesson'||currentMode==='tactics') return;
        // An√°lisis siempre a m√°xima potencia
        engine.postMessage('stop');
        engine.postMessage(`setoption name Skill Level value 20`);
        engine.postMessage('position fen '+game.fen());
        engine.postMessage('go depth 10');
    }

    function updateEvalBar(score, type) {
        let per = 50;
        if(type==='mate') per = score > 0 ? 100 : 0;
        else {
            // Clampear entre -500 y 500 cp para la barra
            let sc = Math.max(-500, Math.min(500, score));
            per = 50 + (sc / 10);
        }
        $('#evalFill').css('width', per + '%');
    }
    
    // TABLERO
    function onDrop(src, tgt) {
        // LECCI√ìN
        if(currentMode === 'lesson') {
            const t = new Chess(game.fen()); 
            if(t.move({from:src, to:tgt, promotion:'q'})) {
               if(LessonSystem.checkMove({san: t.history().pop()})) {
                   game.move({from:src, to:tgt, promotion:'q'}); board.position(game.fen());
               } 
            }
            return 'snapback';
        }
        // T√ÅCTICA
        if(currentMode === 'tactics') {
            const t = new Chess(game.fen()); const m = t.move({from:src, to:tgt, promotion:'q'});
            if(m && TacticsSystem.checkMove(m)) {
                game.move({from:src, to:tgt, promotion:'q'}); board.position(game.fen());
                return;
            }
            return 'snapback';
        }
        
        // MODO JUEGO / AN√ÅLISIS
        const move = game.move({from:src, to:tgt, promotion:'q'});
        if(!move) return 'snapback';
        
        board.position(game.fen());
        redoStack = [];

        // Si es PVC y toca a la IA
        if(currentMode === 'pvc' && game.turn() !== $('#playerColor').val()) {
            setTimeout(triggerAI, 250); // Peque√±a pausa para que se vea el movimiento humano antes
        } else {
            triggerAnalysis();
        }
    }

    function onDragStart(s,p) {
        if(game.game_over() || isEnginePlaying) return false;
        if(currentMode==='pvc' && (($('#playerColor').val()==='w' && p.startsWith('b')) || ($('#playerColor').val()==='b' && p.startsWith('w')))) return false;
        if(currentMode==='lesson' && !lessonState.active) return false;
    }

    function newGame() {
        LessonSystem.stop(); TacticsSystem.stop(); game.reset(); board.start(); redoStack=[];
        currentMode = $('#gameMode').val();
        $('#statusText').text("Nueva Partida");
        
        // Si juega la IA primero (ej: Jugador elige negras)
        if(currentMode === 'pvc' && $('#playerColor').val() === 'b') {
            triggerAI();
        } else {
            triggerAnalysis();
        }
    }
    
    function undo(){ if(!isEnginePlaying && currentMode!=='lesson' && currentMode!=='tactics') { game.undo(); if(currentMode==='pvc') game.undo(); board.position(game.fen()); triggerAnalysis(); }}
    function redo(){ if(!isEnginePlaying && redoStack.length && currentMode!=='lesson') { game.move(redoStack.pop()); if(currentMode==='pvc' && redoStack.length) game.move(redoStack.pop()); board.position(game.fen()); triggerAnalysis(); }}

    $(document).ready(() => {
        board = Chessboard('board', { draggable:true, position:'start', onDragStart:onDragStart, onDrop:onDrop, pieceTheme:'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        $(window).resize(board.resize);
        init();
    });
</script>
</body>
</html>
