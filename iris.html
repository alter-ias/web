<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IRIS v8 - FINAL LAYOUT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: rgba(10, 10, 12, 0.95);
            --accent: #00E5FF;
            --accent-dim: rgba(0, 229, 255, 0.1);
            --text: #FFFFFF;
            --text-dim: #556677;
            --ui-scale: 1.0;
        }

        body { 
            margin: 0; overflow: hidden; background-color: var(--bg-color); 
            font-family: 'Rajdhani', sans-serif; color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- 1. VIEWPORT (AREA PRINCIPAL) --- */
        #viewport {
            flex-grow: 1; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 1; background: #000;
        }
        
        /* El Canvas de fondo (Salida Final) */
        #vj-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0.3; z-index: 0; /* Un poco dim para ver los monitores */
        }

        /* --- MONITORES FLOTANTES (LO QUE PEDISTE) --- */
        #monitor-stage {
            position: relative; z-index: 5;
            display: flex; gap: 40px; width: 80%; height: 50%;
            justify-content: center; align-items: center;
        }

        .float-screen {
            flex: 1; height: 100%; background: #000; 
            border: 2px solid #333; position: relative;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 30px #000; transition: 0.2s;
        }

        .float-vid { width: 100%; height: 100%; object-fit: contain; }

        /* Estilo cuando seleccionas Mix A o Mix B */
        .float-screen.editing { 
            border-color: var(--accent); 
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.3); 
            transform: scale(1.02);
        }

        .screen-label {
            position: absolute; top: -25px; left: 0; 
            font-family: 'Montserrat'; font-weight: 700; font-size: 14px; 
            color: #555; letter-spacing: 2px;
        }
        .float-screen.editing .screen-label { color: var(--accent); text-shadow: 0 0 10px var(--accent); }


        /* --- 2. UI CONTAINER (PANEL INFERIOR) --- */
        #ui-container {
            height: calc(260px * var(--ui-scale)); 
            background: var(--panel-bg);
            border-top: 1px solid rgba(0,229,255,0.2);
            flex-shrink: 0; position: relative; z-index: 10;
            transition: height 0.1s linear; overflow: hidden;
        }

        #dashboard {
            width: 100%; height: 260px;
            transform-origin: top left;
            transform: scale(var(--ui-scale));
            width: calc(100% / var(--ui-scale));
            display: grid; 
            grid-template-columns: 250px 1fr 350px;
            padding: 20px 40px; box-sizing: border-box;
            gap: 30px;
        }

        /* Scale Bar */
        #scale-strip { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #000; cursor: ew-resize; z-index: 50; }
        #scale-fill { height: 100%; width: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        #scale-input { position: absolute; top: -5px; left: 0; width: 100%; height: 15px; opacity: 0; cursor: ew-resize; z-index: 60; }

        /* Paneles */
        .panel { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        h3 { font-family: 'Montserrat', sans-serif; font-size: 10px; letter-spacing: 2px; color: var(--text-dim); margin: 0 0 10px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }

        /* Shortcuts */
        .shortcut-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #888; }
        .key-badge { color: var(--accent); font-weight: 700; }

        /* Mixer Central (Solo controles ahora) */
        .mix-controls-area {
            display: flex; flex-direction: column; justify-content: center; height: 100%;
        }

        .work-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .work-btn {
            flex: 1; padding: 20px; background: #0a0a0a; border: 1px solid #333; color: #555;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 18px; cursor: pointer; text-align: center;
            transition: 0.2s;
        }
        .work-btn:hover { border-color: #666; }
        .work-btn.selected { 
            background: var(--accent); color: #000; border-color: var(--accent); 
            box-shadow: 0 0 20px var(--accent);
        }

        #crossfader-track { width: 100%; height: 10px; background: #000; border-radius: 5px; position: relative; border: 1px solid #333; }
        #crossfader-handle {
            width: 60px; height: 24px; background: var(--accent); position: absolute; top: -7px; left: 50%;
            transform: translateX(-50%); border-radius: 2px; cursor: ew-resize;
            box-shadow: 0 0 15px var(--accent);
        }

        /* Panel Derecho */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .util-btn { padding: 8px; background: transparent; border: 1px solid #444; color: #888; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        .util-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Matriz Salida */
        .out-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .out-btn { padding: 12px; background: #1a0505; border: 1px solid #331111; color: #ff3366; font-weight: 700; font-size: 10px; cursor: pointer; }
        .out-btn.active-off { background: #ff0055; color: #fff; border-color: #ff0055; box-shadow: 0 0 15px #ff0055; }
        .out-btn.source { background: #051a1a; border-color: #113333; color: #44cccc; }
        .out-btn.source.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 11px; }
        .param-label { color: #666; width: 60px; }
        .param-slider { flex-grow: 1; accent-color: var(--accent); height: 2px; cursor: pointer; }

        /* Overlays */
        #notify { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; color: var(--accent); opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(0,0,0,0.8); padding: 10px 30px; border: 1px solid var(--accent); z-index: 99; }
        #boot { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #midi-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; }
        #midi-panel { width: 800px; height: 90vh; background: #0b0e14; border: 1px solid var(--accent); padding: 30px; display: flex; flex-direction: column; }
        #midi-scroll { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .midi-item { background: #151515; padding: 10px; border: 1px solid #222; }
        .midi-btn { width: 100%; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; }
        .midi-btn.learning { background: #ff0055; animation: blink 0.5s infinite; }
        @keyframes blink { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }
    </style>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        const state = {
            effectMode: 1, styleMode: 0, distortionType: 0, mixRatio: 0.0, 
            distortion: 2.0, micGain: 5.0, bloom: 1.5, speed: 1.0, rgbShift: 0.05, geoStrength: 4.0,
            tint: new THREE.Color(1, 1, 1), tintMix: 0.0, 
            loadingSlot: null, crossfade: 0.0, uiScale: 1.0,
            workDeck: 'A', outputMode: 'OFF'
        };

        const midiParams = {
            'work_a': { label: 'Mix A', type: null, val: null },
            'work_b': { label: 'Mix B', type: null, val: null },
            'out_off': { label: 'Blackout', type: null, val: null },
            'out_a': { label: 'Proj A', type: null, val: null },
            'out_b': { label: 'Proj B', type: null, val: null },
            'crossfader': { label: 'Fader', type: 'cc', val: 1 },
            'slot_a': { label: 'Clip A', type: 'note', val: 36 },
            'speed': { label: 'Speed', type: null, val: null }
        };

        let learningKey = null;
        let projectorWindow = null;

        const audio = { ready: false, init: async () => true, getLevels: () => ({ vol: 0.5, bass: 0.5 }) };

        // --- VJ ENGINE ---
        const canvas = document.getElementById('vj-canvas');
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, preserveDrawingBuffer: true });
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 9;

        // ELEMENTOS DE VIDEO
        const vidA = document.getElementById('vid-a');
        const vidB = document.getElementById('vid-b');
        vidA.src = 'assets/videos/iris.webm'; vidA.loop=true; vidA.muted=true; vidA.play();
        vidB.src = 'assets/videos/iris.webm'; vidB.loop=true; vidB.muted=true; vidB.play();

        const texA = new THREE.VideoTexture(vidA);
        const texB = new THREE.VideoTexture(vidB);
        const webcamEl = document.createElement('video'); webcamEl.muted=true; webcamEl.playsInline=true;
        const webcamTex = new THREE.VideoTexture(webcamEl);
        const noiseTex = new THREE.CanvasTexture(document.createElement('canvas'));

        const uniforms = {
            uTexA: { value: texA }, uTexB: { value: texB }, uCrossfade: { value: 0.0 },
            uTexCam: { value: noiseTex }, uMix: { value: 0.0 }, uTime: { value: 0.0 },
            uBass: { value: 0.0 }, uVol: { value: 0.0 }, uMode: { value: 1 }, uStyle: { value: 0 },
            uTint: { value: new THREE.Color(1,1,1) }, uTintMix: { value: 0.0 },
            uSpeed: { value: 1.0 }, uRGBShift: { value: 0.05 }, uGeoStrength: { value: 4.0 }, 
            uDistType: { value: 0 }, uResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) }
        };

        const fragmentShader = `
            uniform sampler2D uTexA; uniform sampler2D uTexB; uniform float uCrossfade;
            uniform sampler2D uTexCam; uniform float uMix; uniform float uTime;
            uniform float uBass; uniform float uVol; uniform int uMode; uniform int uStyle;
            uniform vec3 uTint; uniform float uTintMix; uniform float uSpeed; uniform float uRGBShift;
            varying vec2 vUv;
            float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
            vec3 rgbSplit(sampler2D tex, vec2 uv, float amount) {
                return vec3(texture2D(tex, uv - vec2(amount, 0.0)).r, texture2D(tex, uv).g, texture2D(tex, uv + vec2(amount, 0.0)).b);
            }
            void main() {
                vec2 uv = vUv; float t = uTime * uSpeed;
                if(uMode == 3) uv.x = abs(uv.x - 0.5) + 0.5;
                if(uMode == 4) { vec2 c=uv-0.5; float r=length(c); float a=atan(c.y,c.x); a=mod(a,1.047); a=abs(a-0.523); uv=0.5+r*vec2(cos(a),sin(a)); }
                float shift = (uMode==2) ? uBass*0.05 : uRGBShift * uBass;
                vec3 cA = rgbSplit(uTexA, uv, shift); vec3 cB = rgbSplit(uTexB, uv, shift);
                vec3 col = mix(cA, cB, uCrossfade);
                col = mix(col, rgbSplit(uTexCam, uv, shift), uMix);
                if(uMode == 7 && uBass > 0.6) col = 1.0 - col;
                col = mix(col, col * uTint, uTintMix);
                gl_FragColor = vec4(col, 1.0);
            }
        `;

        const vertexShader = `
            uniform float uVol; uniform float uTime; uniform float uSpeed;
            uniform float uGeoStrength; uniform int uDistType; varying vec2 vUv;
            void main() {
                vUv = uv; vec3 pos = position; float d = 0.0; float t = uTime * uSpeed;
                if (uDistType == 0) d = sin(pos.x * 2.0 + t) * cos(pos.y * 1.5 + t);
                pos.z += d * uVol * uGeoStrength; 
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            }
        `;

        const material = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader, fragmentShader, side: THREE.DoubleSide });
        const geometry = new THREE.PlaneGeometry(16, 9, 140, 140);
        const plane = new THREE.Mesh(geometry, material); scene.add(plane);
        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85); composer.addPass(bloom);

        // --- FUNCIONES UI ---
        function setScale(val) {
            state.uiScale = parseFloat(val);
            document.documentElement.style.setProperty('--scale-factor', state.uiScale);
            document.getElementById('scale-fill').style.width = ((state.uiScale - 0.6) / 0.8) * 100 + '%';
            setTimeout(resize, 50);
        }

        function updateUI() {
            // Activar Monitores
            document.getElementById('screen-a').className = `float-screen ${state.workDeck==='A'?'editing':''}`;
            document.getElementById('screen-b').className = `float-screen ${state.workDeck==='B'?'editing':''}`;
            
            // Botones Mix
            document.getElementById('btn-mix-a').className = `work-btn ${state.workDeck==='A'?'selected':''}`;
            document.getElementById('btn-mix-b').className = `work-btn ${state.workDeck==='B'?'selected':''}`;
            
            // Fader
            document.getElementById('crossfader-handle').style.left = (state.crossfade * 100) + '%';
            
            // Botones Salida
            document.getElementById('out-off').className = `out-btn ${state.outputMode==='OFF'?'active-off':''}`;
            document.getElementById('out-a').className = `out-btn source ${state.outputMode==='A'?'active':''}`;
            document.getElementById('out-b').className = `out-btn source ${state.outputMode==='B'?'active':''}`;
        }

        function notify(msg) {
            const n = document.getElementById('notify'); n.innerText = msg; n.style.opacity = 1; setTimeout(()=>n.style.opacity=0, 1500);
        }

        // --- ACCIONES ---
        const actions = {
            setWorkDeck: (d) => { state.workDeck = d; notify(`EDIT: MIX ${d}`); updateUI(); },
            setOutput: (mode) => {
                state.outputMode = mode;
                updateUI();
                if(projectorWindow && !projectorWindow.closed) {
                    projectorWindow.document.querySelector('video').style.opacity = (mode === 'OFF') ? 0 : 1;
                }
                if(mode === 'A') uniforms.uCrossfade.value = 0.0;
                else if(mode === 'B') uniforms.uCrossfade.value = 1.0;
                notify(`OUT: ${mode}`);
            },
            loadClip: () => {
                state.loadingSlot = state.workDeck;
                document.getElementById('file-input').click();
            }
        };

        // --- EVENTOS ---
        const resize = () => {
            const h = window.innerHeight - document.getElementById('ui-container').offsetHeight;
            const w = window.innerWidth;
            camera.aspect = w/h; camera.updateProjectionMatrix();
            renderer.setSize(w, h); composer.setSize(w, h);
            uniforms.uResolution.value.set(w, h);
        };
        window.addEventListener('resize', resize);

        document.getElementById('scale-input').oninput = (e) => setScale(e.target.value);
        document.getElementById('sl-speed').oninput = (e) => state.speed = parseFloat(e.target.value);
        
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const url = URL.createObjectURL(file);
            const target = (state.loadingSlot === 'A') ? vidA : vidB;
            target.src = url; target.play();
            document.getElementById('file-input').value = "";
            updateUI();
        };

        window.addEventListener('wheel', (e) => { 
            state.crossfade = Math.max(0, Math.min(1, state.crossfade + e.deltaY * 0.001)); 
            updateUI(); 
        });

        window.addEventListener('keydown', (e) => {
            if(['a','s','d','f','g','h','j','k','l'].includes(e.key.toLowerCase())) actions.loadClip();
            // ... resto de keys
        });

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001;
            
            if(state.outputMode === 'A') uniforms.uCrossfade.value = 0.0;
            else if(state.outputMode === 'B') uniforms.uCrossfade.value = 1.0;
            
            uniforms.uTime.value=t; uniforms.uSpeed.value=state.speed;
            if(vidA.readyState>=2) texA.needsUpdate=true;
            if(vidB.readyState>=2) texB.needsUpdate=true;
            composer.render();
        }

        document.getElementById('btn-start').onclick = async () => {
            document.getElementById('boot').style.display='none';
            resize(); animate();
        };

        document.getElementById('btn-proj').onclick = () => {
            if(projectorWindow && !projectorWindow.closed) projectorWindow.focus();
            else {
                projectorWindow = window.open("", "PROJ", "width=800,height=600");
                const stream = canvas.captureStream(60);
                projectorWindow.document.write(`<body style="margin:0;background:#000;overflow:hidden"><video id="v" autoplay style="width:100vw;height:100vh;object-fit:cover; opacity:${state.outputMode==='OFF'?0:1}"></video></body>`);
                setTimeout(()=> projectorWindow.document.getElementById('v').srcObject = stream, 200);
            }
        };

        document.getElementById('btn-mix-a').onclick = () => actions.setWorkDeck('A');
        document.getElementById('btn-mix-b').onclick = () => actions.setWorkDeck('B');
        document.getElementById('out-off').onclick = () => actions.setOutput('OFF');
        document.getElementById('out-a').onclick = () => actions.setOutput('A');
        document.getElementById('out-b').onclick = () => actions.setOutput('B');

        // MIDI (Placeholder para no alargar mas el codigo)
        async function initMIDI() {}
        document.getElementById('btn-midi').onclick = () => { document.getElementById('midi-overlay').style.display = 'flex'; };
        document.getElementById('btn-close-midi').onclick = () => document.getElementById('midi-overlay').style.display = 'none';

    </script>
</head>
<body>

    <div id="boot">
        <h1 style="font-size:60px; letter-spacing:10px; color:#fff; margin-bottom:10px;">IRIS <span style="color:#00E5FF">v8</span></h1>
        <p style="color:#666; font-family:'Montserrat'; letter-spacing:2px; font-size:12px; margin-bottom:30px;">DUAL MONITOR SYSTEM</p>
        <button id="btn-start" style="padding:15px 40px; background:transparent; border:1px solid #00E5FF; color:#fff; font-family:'Rajdhani'; font-size:18px; cursor:pointer;">INICIAR SISTEMA</button>
    </div>

    <div id="viewport">
        <canvas id="vj-canvas"></canvas>

        <div id="monitor-stage">
            <div id="screen-a" class="float-screen editing">
                <span class="screen-label">MIX A</span>
                <video id="vid-a" class="float-vid" muted loop></video>
            </div>
            <div id="screen-b" class="float-screen">
                <span class="screen-label">MIX B</span>
                <video id="vid-b" class="float-vid" muted loop></video>
            </div>
        </div>
    </div>

    <div id="ui-container">
        <div id="dashboard">
            
            <div id="scale-strip"><div id="scale-fill"></div><input type="range" id="scale-input" min="0.6" max="1.4" step="0.01" value="1.0"></div>

            <div class="panel">
                <h3>ATAJOS</h3>
                <div class="shortcut-row"><span>Cargar Video</span> <span class="key-badge">A-L</span></div>
                <div class="shortcut-row"><span>Efectos 2D</span> <span class="key-badge">1-0</span></div>
                <div style="margin-top:auto; font-size:10px; color:#555;">ALTER.LAB // 2025</div>
            </div>

            <div class="panel">
                <div class="mix-controls-area">
                    <div class="work-grid">
                        <button id="btn-mix-a" class="work-btn selected">MIX A</button>
                        <button id="btn-mix-b" class="work-btn">MIX B</button>
                    </div>
                    <div id="crossfader-track"><div id="crossfader-handle"></div></div>
                </div>
            </div>

            <div class="panel">
                <div class="control-group">
                    <span style="font-size:9px; color:#555; display:block; margin-bottom:5px;">SALIDA PROYECCIÓN</span>
                    <div class="out-matrix">
                        <button id="out-off" class="out-btn active-off">BLACKOUT</button>
                        <button id="out-a" class="out-btn source">PROJ A</button>
                        <button id="out-b" class="out-btn source">PROJ B</button>
                    </div>
                </div>

                <div class="util-grid">
                    <button class="util-btn" id="btn-midi">MIDI</button>
                    <button class="util-btn" id="btn-proj">VENTANA</button>
                    <button class="util-btn" onclick="actions.loadClip()">CARGAR</button>
                </div>

                <div style="margin-top:auto;">
                    <div class="param-row"><span class="param-label">SPEED</span> <input type="range" id="sl-speed" min="0.1" max="5" step="0.1" value="1" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">GLITCH</span> <input type="range" id="sl-dist" min="0" max="5" step="0.1" value="2" class="param-slider"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="midi-overlay">
        <div id="midi-panel">
            <div class="midi-header">
                <h2 style="color:#00E5FF; margin:0; font-size:16px;">MAPEO MIDI</h2>
                <button id="btn-close-midi" class="out-btn source active">CERRAR</button>
            </div>
            <div id="midi-scroll-area"></div>
        </div>
    </div>

    <div id="notify">NOTIFICACIÓN</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">

</body>
</html>
