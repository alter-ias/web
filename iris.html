<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IRIS v5 - COMMAND CENTER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: #0b0e14;
            --accent: #00E5FF;
            --accent-dim: rgba(0, 229, 255, 0.1);
            --text: #FFFFFF;
            --text-dim: #556677;
            --ui-scale: 1.0;
        }

        body { 
            margin: 0; overflow: hidden; background-color: var(--bg-color); 
            font-family: 'Rajdhani', sans-serif; color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- 1. VIEWPORT (VIDEO) --- */
        #viewport {
            flex-grow: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center; z-index: 1;
            background: #000;
        }
        #vj-canvas { width: 100%; height: 100%; object-fit: contain; }

        /* --- 2. UI CONTAINER --- */
        #ui-container {
            height: calc(300px * var(--ui-scale)); 
            background: transparent;
            flex-shrink: 0; position: relative; z-index: 10;
            transition: height 0.05s linear;
            display: flex; justify-content: center;
            border-top: 1px solid #222;
        }

        #dashboard {
            width: 100%; height: 300px; 
            background: var(--panel-bg);
            transform-origin: top center;
            transform: scale(var(--ui-scale));
            width: calc(100% / var(--ui-scale));
            display: grid; 
            grid-template-columns: 280px 1fr 380px; /* Panel Derecho más ancho para los controles nuevos */
            padding: 25px 40px; box-sizing: border-box;
            gap: 40px; position: relative;
        }

        /* --- SCALE BAR --- */
        #scale-strip {
            position: absolute; top: -6px; left: 0; width: 100%; height: 6px;
            background: #000; cursor: ew-resize; z-index: 50;
        }
        #scale-fill {
            height: 100%; width: 50%; background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }
        #scale-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: ew-resize;
        }

        /* --- PANELES --- */
        .panel { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        h3 { 
            font-family: 'Montserrat', sans-serif; font-size: 10px; letter-spacing: 3px; 
            color: var(--text-dim); margin: 0 0 15px 0; border-bottom: 1px solid #222; padding-bottom: 5px;
        }

        /* LEFT PANEL (INFO) */
        .info-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; color: #888; font-family: 'Montserrat'; }
        .info-val { color: var(--accent); font-weight: 700; }
        .key-badge { color: #666; font-size: 10px; border: 1px solid #333; padding: 1px 4px; border-radius: 3px; }

        /* CENTER PANEL (MIXER) */
        .deck-monitor {
            flex-grow: 1; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .deck-box {
            width: 45%; height: 80px; border: 1px solid #333; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.2s; position: relative;
        }
        .deck-box.active-work { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-dim); }
        .deck-letter { font-size: 40px; font-weight: 700; color: #333; line-height: 1; }
        .deck-box.active-work .deck-letter { color: #fff; }
        .deck-file { font-size: 10px; color: var(--accent); margin-top: 5px; max-width: 90%; overflow: hidden; white-space: nowrap; }

        #crossfader-track {
            width: 100%; height: 20px; background: #050505; border-radius: 10px; position: relative;
            border: 1px solid #333; margin-bottom: 10px;
        }
        #crossfader-handle {
            width: 60px; height: 100%; background: var(--accent); position: absolute; top: 0; left: 50%;
            transform: translateX(-50%); border-radius: 4px; cursor: ew-resize;
            box-shadow: 0 0 20px var(--accent);
        }

        /* RIGHT PANEL (CONTROLS) */
        .control-group { margin-bottom: 15px; }
        .group-label { font-size: 9px; color: #555; margin-bottom: 5px; display: block; letter-spacing: 1px; }
        
        /* Botones de Selección de Trabajo (Mix A / Mix B) */
        .work-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .work-btn {
            flex: 1; padding: 15px; background: transparent; border: 1px solid #444; color: #666;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 14px; cursor: pointer; transition: 0.2s;
            text-align: left; position: relative; overflow: hidden;
        }
        .work-btn::after { content: 'EDIT MODE'; position: absolute; bottom: 2px; right: 5px; font-size: 8px; opacity: 0; }
        .work-btn:hover { border-color: #666; }
        .work-btn.selected { border-color: var(--accent); color: #fff; background: var(--accent-dim); }
        .work-btn.selected::after { opacity: 1; color: var(--accent); }

        /* Botones de Salida (Output Matrix) */
        .output-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .out-btn {
            padding: 10px; border: 1px solid #333; background: #111; color: #555;
            font-family: 'Montserrat'; font-weight: 700; font-size: 10px; cursor: pointer; transition: 0.2s;
        }
        .out-btn:hover { color: #fff; border-color: #555; }
        
        .out-btn.active-a { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .out-btn.active-b { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .out-btn.active-off { background: #ff0055; color: #fff; border-color: #ff0055; box-shadow: 0 0 10px #ff0055; }

        /* Utilitarios */
        .utility-row { display: flex; gap: 10px; margin-top: 10px; }
        .util-btn { 
            flex: 1; padding: 8px; background: transparent; border: 1px solid #333; color: #888;
            font-size: 10px; cursor: pointer; font-family: 'Montserrat';
        }
        .util-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Sliders */
        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 11px; }
        .param-label { color: #666; width: 60px; }
        .param-slider { flex-grow: 1; accent-color: var(--accent); height: 2px; cursor: pointer; }

        /* NOTIFY */
        #notify {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; font-weight: 300; letter-spacing: 10px; color: var(--accent);
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 999;
            text-shadow: 0 0 30px var(--accent); background: rgba(0,0,0,0.8); padding: 20px 40px; border: 1px solid var(--accent);
        }

        /* MIDI OVERLAY */
        #midi-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        #midi-panel {
            width: 800px; height: 90vh; background: #0b0e14; border: 1px solid var(--accent);
            padding: 30px; display: flex; flex-direction: column;
        }
        #midi-scroll { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-content: start; }
        .midi-item { background: #151925; padding: 10px; border: 1px solid #222; display: flex; flex-direction: column; gap: 5px; }
        .midi-btn { background: #222; color: #fff; border: 1px solid #444; padding: 5px; cursor: pointer; font-size: 10px; }
        .midi-btn.learning { background: #ff0055; animation: blink 0.5s infinite; border-color: #ff0055; }
        @keyframes blink { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }

    </style>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        // --- ESTADO ---
        const state = {
            effectMode: 1, styleMode: 0, distortionType: 0, mixRatio: 0.0, 
            distortion: 2.0, micGain: 5.0, bloom: 1.5, speed: 1.0, rgbShift: 0.05, geoStrength: 4.0,
            tint: new THREE.Color(1, 1, 1), tintMix: 0.0, 
            loadingSlot: null, crossfade: 0.0, uiScale: 1.0,
            deckA: "VACÍO", deckB: "VACÍO",
            workDeck: 'A', // ¿Qué deck estamos editando/cargando?
            outputMode: 'MIX' // 'MIX', 'A', 'B', 'OFF'
        };

        // --- MAPEO MIDI (TODO INCLUIDO) ---
        const midiParams = {
            'crossfader': { label: 'Fader', type: 'cc', val: 1, group: 'MIXER' },
            'ui_scale': { label: 'UI Scale', type: null, val: null, group: 'MIXER' },
            
            // Botones de Trabajo
            'work_a': { label: 'Select Mix A', type: null, val: null, group: 'WORK' },
            'work_b': { label: 'Select Mix B', type: null, val: null, group: 'WORK' },

            // Botones de Salida
            'out_a': { label: 'Output A', type: null, val: null, group: 'OUTPUT' },
            'out_b': { label: 'Output B', type: null, val: null, group: 'OUTPUT' },
            'blackout': { label: 'Blackout', type: null, val: null, group: 'OUTPUT' },

            // Carga (Se aplican al workDeck activo)
            'slot_a': { label: 'Load Clip A', type: 'note', val: 36, group: 'CLIPS' },
            'slot_s': { label: 'Load Clip S', type: null, val: null, group: 'CLIPS' },
            'slot_d': { label: 'Load Clip D', type: null, val: null, group: 'CLIPS' },
            'slot_f': { label: 'Load Clip F', type: null, val: null, group: 'CLIPS' },
            'slot_g': { label: 'Load Clip G', type: null, val: null, group: 'CLIPS' },
            'slot_h': { label: 'Load Clip H', type: null, val: null, group: 'CLIPS' },
            'slot_j': { label: 'Load Clip J', type: null, val: null, group: 'CLIPS' },
            'slot_k': { label: 'Load Clip K', type: null, val: null, group: 'CLIPS' },
            'slot_l': { label: 'Load Clip L', type: null, val: null, group: 'CLIPS' },

            // Knobs
            'speed': { label: 'Knob Speed', type: null, val: null, group: 'FX' },
            'distortion': { label: 'Knob Glitch', type: null, val: null, group: 'FX' },
            'geoStrength': { label: 'Knob 3D', type: null, val: null, group: 'FX' },
            'rgbShift': { label: 'Knob RGB', type: null, val: null, group: 'FX' },
            'bloom': { label: 'Knob Bloom', type: null, val: null, group: 'FX' },
            'micGain': { label: 'Knob Mic', type: null, val: null, group: 'FX' },

            // Triggers
            'fx_next': { label: 'Next FX', type: null, val: null, group: 'TRIGGERS' },
            'style_next': { label: 'Next Style', type: null, val: null, group: 'TRIGGERS' },
            'geo_next': { label: 'Next Geo', type: null, val: null, group: 'TRIGGERS' },
            'cam_toggle': { label: 'Cam Toggle', type: null, val: null, group: 'TRIGGERS' },
            'reset': { label: 'Reset All', type: null, val: null, group: 'TRIGGERS' }
        };

        let learningKey = null;
        let projectorWindow = null;

        // --- AUDIO ---
        class AudioEngine {
            constructor() { this.ctx=null; this.analyser=null; this.data=null; this.freq=null; this.ready=false; }
            async init() {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                    this.analyser = this.ctx.createAnalyser(); this.analyser.fftSize = 512;
                    this.ctx.createMediaStreamSource(stream).connect(this.analyser);
                    this.data = new Uint8Array(this.analyser.frequencyBinCount);
                    this.freq = new Uint8Array(this.analyser.frequencyBinCount);
                    this.ready = true; return true;
                } catch(e) { return false; }
            }
            getLevels() {
                if(!this.ready) return { vol: 0, bass: 0 };
                this.analyser.getByteTimeDomainData(this.data);
                this.analyser.getByteFrequencyData(this.freq);
                const vol = Math.sqrt(this.data.reduce((a,b)=>a+((b-128)/128)**2, 0)/this.data.length) * state.micGain;
                const bass = this.freq[5] / 255.0;
                return { vol, bass };
            }
        }
        const audio = new AudioEngine();

        // --- VJ ENGINE ---
        const canvas = document.getElementById('vj-canvas');
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, preserveDrawingBuffer: true });
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 9;

        const texA = new THREE.VideoTexture(document.createElement('video'));
        const texB = new THREE.VideoTexture(document.createElement('video'));
        const webcamEl = document.createElement('video'); webcamEl.muted=true; webcamEl.playsInline=true;
        const webcamTex = new THREE.VideoTexture(webcamEl);
        
        const c=document.createElement('canvas'); c.width=64; c.height=64;
        const x=c.getContext('2d'); x.fillStyle='#000'; x.fillRect(0,0,64,64);
        const noiseTex = new THREE.CanvasTexture(c);
        texA.image = noiseTex.image; texB.image = noiseTex.image;

        const uniforms = {
            uTexA: { value: noiseTex }, uTexB: { value: noiseTex }, uCrossfade: { value: 0.0 },
            uTexCam: { value: noiseTex }, uMix: { value: 0.0 }, uTime: { value: 0.0 },
            uBass: { value: 0.0 }, uVol: { value: 0.0 }, uMode: { value: 1 }, uStyle: { value: 0 },
            uTint: { value: new THREE.Color(1,1,1) }, uTintMix: { value: 0.0 },
            uSpeed: { value: 1.0 }, uRGBShift: { value: 0.05 }, uGeoStrength: { value: 4.0 }, 
            uDistType: { value: 0 }, uResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) }
        };

        const fragmentShader = `
            uniform sampler2D uTexA; uniform sampler2D uTexB; uniform float uCrossfade;
            uniform sampler2D uTexCam; uniform float uMix; uniform float uTime;
            uniform float uBass; uniform float uVol; uniform int uMode; uniform int uStyle;
            uniform vec3 uTint; uniform float uTintMix; uniform float uSpeed; uniform float uRGBShift;
            varying vec2 vUv;
            float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
            vec3 rgbSplit(sampler2D tex, vec2 uv, float amount) {
                float r = texture2D(tex, uv - vec2(amount, 0.0)).r;
                float g = texture2D(tex, uv).g;
                float b = texture2D(tex, uv + vec2(amount, 0.0)).b;
                return vec3(r,g,b);
            }
            void main() {
                vec2 uv = vUv; float t = uTime * uSpeed;
                if(uMode == 3) uv.x = abs(uv.x - 0.5) + 0.5;
                if(uMode == 4) { vec2 c=uv-0.5; float r=length(c); float a=atan(c.y,c.x); a=mod(a,1.047); a=abs(a-0.523); uv=0.5+r*vec2(cos(a),sin(a)); }
                if(uMode == 5) { float d=length(uv-0.5); float a=atan(uv.y-0.5,uv.x-0.5)+(uBass*5.0)*(1.0-d); uv=0.5+d*vec2(cos(a),sin(a)); }
                if(uMode == 9) { uv.x+=sin(uv.y*10.0+t)*0.05*uVol; uv.y+=cos(uv.x*10.0+t)*0.05*uVol; }
                float shift = (uMode==2) ? uBass*0.05 : uRGBShift * uBass;
                vec3 cA = rgbSplit(uTexA, uv, shift); vec3 cB = rgbSplit(uTexB, uv, shift);
                
                // MEZCLA MANUAL EN SHADER
                vec3 col;
                if(uCrossfade < 0.0) { // Si es negativo, forzamos salida A o B pura (hack para Blackout)
                     // Logica manejada en JS, aquí solo mezclamos A y B normal
                     col = vec3(0.0); 
                } else {
                     col = mix(cA, cB, uCrossfade);
                }

                col = mix(col, rgbSplit(uTexCam, uv, shift), uMix);
                if(uMode == 7 && uBass > 0.6) col = 1.0 - col;
                if(uMode == 8) { vec3 c1=mix(texture2D(uTexA,uv+0.002).rgb,texture2D(uTexB,uv+0.002).rgb,uCrossfade); col=length(abs(col-c1))*vec3(0,1,1)*4.0; }
                if(uMode == 10 && rand(floor(uv*10.0)+floor(t*10.0))<uBass*0.5) col=vec3(1.0);
                if(uMode == 1) col *= (0.8 + 0.2 * (sin(uv.y*800.0+t*5.0)*0.5+0.5));
                float lum = dot(col, vec3(0.33));
                if (uStyle == 1) col *= (step(0.9, fract(uv.x*40.0+t*0.5)) + step(0.9, fract(uv.y*40.0))) * 2.0;
                if (uStyle == 2) col *= step(distance(fract(uv*80.0), vec2(0.5)), lum*0.5) * 1.5;
                if (uStyle == 3) col *= (sin(uv.x*50.0)*sin(uv.y*50.0)>0.0 ? 1.5 : 0.2);
                if (uStyle == 4) col = mix(col, vec3(0.0, 1.0, 0.8)*lum, 0.8) * step(0.5, sin(uv.y*200.0+t*10.0));
                if (uStyle == 5) col = vec3(0.0, 1.0, 0.2) * step(0.5, rand(floor(uv*vec2(40.,20.0)) + floor(t))) * lum * 2.0;
                col = mix(col, col * uTint, uTintMix);
                gl_FragColor = vec4(col, 1.0);
            }
        `;

        const vertexShader = `
            uniform float uVol; uniform float uTime; uniform float uSpeed;
            uniform float uGeoStrength; uniform int uDistType; varying vec2 vUv;
            float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
            void main() {
                vUv = uv; vec3 pos = position; float d = 0.0; float t = uTime * uSpeed;
                if (uDistType == 0) d = sin(pos.x * 2.0 + t) * cos(pos.y * 1.5 + t);
                else if (uDistType == 1) { float wave = sin(pos.y * 50.0 + t * 10.0); d = (wave > 0.0 ? 1.0 : -1.0) * 0.5 * sin(pos.x * 10.0); }
                else if (uDistType == 2) { d = sin(pos.y * 30.0 + t * 2.0) * sin(pos.x * 30.0); if (d > 0.5) d = 0.8; else if (d < -0.5) d = -0.8; else d = 0.0; }
                else if (uDistType == 3) { vec2 block = floor(uv * 10.0); float r = rand(block); d = (r > 0.7) ? r : 0.0; d *= sin(t * 5.0 + r * 10.0); }
                pos.z += d * uVol * uGeoStrength; 
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            }
        `;

        const material = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader, fragmentShader, side: THREE.DoubleSide });
        const geometry = new THREE.PlaneGeometry(16, 9, 140, 140);
        const plane = new THREE.Mesh(geometry, material); scene.add(plane);
        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85); composer.addPass(bloom);

        // --- FUNCIONES UI ---
        function setScale(val) {
            state.uiScale = parseFloat(val);
            document.documentElement.style.setProperty('--ui-scale', state.uiScale);
            document.getElementById('scale-fill').style.width = ((state.uiScale - 0.6) / 0.8) * 100 + '%';
            setTimeout(resize, 50);
        }

        function updateUI() {
            // Decks
            document.getElementById('deck-a-file').innerText = state.deckA.substring(0,20);
            document.getElementById('deck-b-file').innerText = state.deckB.substring(0,20);
            
            // Fader
            document.getElementById('crossfader-handle').style.left = (state.crossfade * 100) + '%';
            
            // Work Selector Styles
            const btnA = document.getElementById('work-btn-a');
            const btnB = document.getElementById('work-btn-b');
            const boxA = document.getElementById('deck-box-a');
            const boxB = document.getElementById('deck-box-b');
            
            if(state.workDeck === 'A') {
                btnA.classList.add('selected'); btnB.classList.remove('selected');
                boxA.classList.add('active-work'); boxB.classList.remove('active-work');
            } else {
                btnB.classList.add('selected'); btnA.classList.remove('selected');
                boxB.classList.add('active-work'); boxA.classList.remove('active-work');
            }

            // Output Buttons Styles
            document.getElementById('out-a').className = `out-btn ${state.outputMode==='A'?'active-a':''}`;
            document.getElementById('out-b').className = `out-btn ${state.outputMode==='B'?'active-b':''}`;
            document.getElementById('out-off').className = `out-btn ${state.outputMode==='OFF'?'active-off':''}`;

            // Params
            document.getElementById('sl-speed').value = state.speed;
            document.getElementById('sl-dist').value = state.distortion;
            document.getElementById('sl-geo').value = state.geoStrength;
            document.getElementById('sl-rgb').value = state.rgbShift;
            document.getElementById('sl-gain').value = state.micGain;
            document.getElementById('sl-bloom').value = state.bloom;
        }

        function notify(msg) {
            const n = document.getElementById('notify');
            n.innerText = msg; n.style.opacity = 1;
            setTimeout(()=>n.style.opacity=0, 1500);
        }

        // --- ACCIONES ---
        const actions = {
            loadDefault: () => {
                const vid = document.createElement('video');
                vid.src = 'assets/videos/iris.webm'; 
                vid.loop = true; vid.muted = true; vid.playsInline = true;
                vid.play();
                state.deckA = "IRIS_CORE"; texA.image = vid; uniforms.uTexA.value = texA;
                updateUI();
            },
            loadClip: (slot) => {
                state.loadingSlot = state.workDeck; // Cargar siempre en el deck seleccionado
                document.getElementById('file-input').click();
            },
            setWorkDeck: (deck) => { state.workDeck = deck; updateUI(); },
            setOutput: (mode) => {
                state.outputMode = (state.outputMode === mode) ? 'MIX' : mode; // Toggle to Mix
                updateUI();
                
                // Lógica de Proyección
                if(projectorWindow && !projectorWindow.closed) {
                    const v = projectorWindow.document.getElementById('v');
                    if(state.outputMode === 'OFF') v.style.opacity = 0;
                    else v.style.opacity = 1;
                }
            },
            toggleCam: () => {
                if(state.mixRatio===0) state.mixRatio=0.5; else if(state.mixRatio===0.5) state.mixRatio=1; else state.mixRatio=0;
                if(state.mixRatio>0 && !webcamEl.srcObject) navigator.mediaDevices.getUserMedia({video:{width:1280}}).then(s=>{webcamEl.srcObject=s;webcamEl.play();uniforms.uTexCam.value=webcamTex;});
                notify("CAM: " + state.mixRatio);
            },
            nextFX: () => { state.effectMode = (state.effectMode % 10) + 1; notify(`FX: ${state.effectMode}`); },
            nextStyle: () => { state.styleMode = (state.styleMode + 1) % 6; notify(`STYLE: ${state.styleMode}`); },
            nextGeo: () => { state.distortionType = (state.distortionType + 1) % 4; notify(`GEO: ${state.distortionType}`); },
            reset: () => { state.styleMode=0; state.distortionType=0; state.effectMode=1; notify("RESET"); }
        };

        // --- MIDI ---
        async function initMIDI() {
            if (!navigator.requestMIDIAccess) return;
            try {
                const midi = await navigator.requestMIDIAccess();
                for (var input of midi.inputs.values()) input.onmidimessage = handleMIDIMessage;
            } catch(e) {}
        }

        function handleMIDIMessage(msg) {
            const [cmd, note, vel] = msg.data;
            const type = (cmd >= 176 && cmd <= 191) ? 'cc' : (cmd >= 144 && cmd <= 159) ? 'note' : null;
            if(!type || (type==='note' && vel===0)) return; 

            if(learningKey) {
                midiParams[learningKey].type = type;
                midiParams[learningKey].val = note;
                notify(`MAPPED: ${midiParams[learningKey].label}`);
                learningKey = null;
                renderMidiUI();
                return;
            }

            Object.entries(midiParams).forEach(([key, map]) => {
                if(map.type === type && map.val === note) {
                    const norm = vel / 127.0;
                    
                    if(key === 'crossfader') {
                        state.crossfade = norm;
                        state.outputMode = 'MIX'; // Mover fader reactiva mezcla
                    }
                    if(key === 'ui_scale') setScale(0.6 + (norm * 0.8));
                    
                    // Knobs
                    if(key === 'speed') state.speed = norm * 5;
                    if(key === 'distortion') state.distortion = norm * 5;
                    if(key === 'geoStrength') state.geoStrength = norm * 10;
                    if(key === 'rgbShift') state.rgbShift = norm * 0.2;
                    if(key === 'bloom') state.bloom = norm * 3;
                    if(key === 'micGain') state.micGain = norm * 10;

                    // Buttons
                    if(key === 'work_a') actions.setWorkDeck('A');
                    if(key === 'work_b') actions.setWorkDeck('B');
                    if(key === 'out_a') actions.setOutput('A');
                    if(key === 'out_b') actions.setOutput('B');
                    if(key === 'blackout') actions.setOutput('OFF');
                    
                    if(key.startsWith('slot_')) actions.loadClip(); // Carga en el deck activo
                    
                    if(key === 'fx_next') actions.nextFX();
                    if(key === 'style_next') actions.nextStyle();
                    if(key === 'geo_next') actions.nextGeo();
                    if(key === 'cam_toggle') actions.toggleCam();
                    if(key === 'reset') actions.reset();
                    if(key === 'load_iris') actions.loadDefault();
                    
                    updateUI();
                }
            });
        }

        function renderMidiUI() {
            const list = document.getElementById('midi-scroll');
            list.innerHTML = '';
            
            const groups = {};
            Object.entries(midiParams).forEach(([k, v]) => {
                if(!groups[v.group]) groups[v.group] = [];
                groups[v.group].push([k,v]);
            });

            for(const [gName, items] of Object.entries(groups)) {
                const groupDiv = document.createElement('div');
                groupDiv.style.gridColumn = "span 3";
                groupDiv.innerHTML = `<h4 style="color:#00E5FF; border-bottom:1px solid #333; margin:10px 0 5px 0;">${gName}</h4>`;
                list.appendChild(groupDiv);
                
                items.forEach(([key, map]) => {
                    const div = document.createElement('div'); div.className = 'midi-item';
                    div.innerHTML = `
                        <span class="midi-label">${map.label}</span>
                        <button class="midi-btn ${learningKey===key?'learning':''}">
                            ${map.val !== null ? (map.type.toUpperCase() + ':' + map.val) : 'MAP'}
                        </button>
                    `;
                    div.querySelector('button').onclick = () => { learningKey = key; renderMidiUI(); };
                    list.appendChild(div);
                });
            }
        }

        // --- EVENTOS ---
        const resize = () => {
            const h = window.innerHeight - document.getElementById('ui-container').offsetHeight;
            const w = window.innerWidth;
            camera.aspect = w/h; camera.updateProjectionMatrix();
            renderer.setSize(w, h); composer.setSize(w, h);
            uniforms.uResolution.value.set(w, h);
        };
        window.addEventListener('resize', resize);

        // Inputs
        document.getElementById('scale-input').oninput = (e) => setScale(e.target.value);
        document.getElementById('sl-speed').oninput = (e) => state.speed = parseFloat(e.target.value);
        document.getElementById('sl-dist').oninput = (e) => state.distortion = parseFloat(e.target.value);
        document.getElementById('sl-geo').oninput = (e) => state.geoStrength = parseFloat(e.target.value);
        document.getElementById('sl-rgb').oninput = (e) => state.rgbShift = parseFloat(e.target.value);
        document.getElementById('sl-gain').oninput = (e) => state.micGain = parseFloat(e.target.value);
        document.getElementById('sl-bloom').oninput = (e) => state.bloom = parseFloat(e.target.value);

        // Loaders
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const url = URL.createObjectURL(file);
            const vid = document.createElement('video'); vid.src=url; vid.loop=true; vid.muted=true; vid.playsInline=true; vid.play();
            if(state.loadingSlot === 'A') { state.deckA=file.name; texA.image=vid; uniforms.uTexA.value=texA; }
            else { state.deckB=file.name; texB.image=vid; uniforms.uTexB.value=texB; }
            document.getElementById('file-input').value = "";
            updateUI();
        };

        // Scroll Mix
        window.addEventListener('wheel', (e) => { 
            state.crossfade = Math.max(0, Math.min(1, state.crossfade + e.deltaY * 0.001)); 
            state.outputMode = 'MIX'; // Reactivar mix
            updateUI(); 
        });

        // Keys
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if(['a','s','d','f','g','h','j','k','l'].includes(k)) actions.loadClip();
            if(!isNaN(parseInt(k))) { state.effectMode = (parseInt(k)===0)?10:parseInt(k); notify(`FX ${state.effectMode}`); }
            if(k==='m') actions.reset();
            if(k==='n') actions.toggleCam();
            if(['z','x','c','v','b'].includes(k)) { state.styleMode = {'z':1,'x':2,'c':3,'v':4,'b':5}[k]; notify("STYLE CHG"); }
            if(['i','o','p'].includes(k)) { state.distortionType = {'i':1,'o':2,'p':3}[k]; notify("GEO CHG"); }
            updateUI();
        });

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001; const lvls = audio.getLevels();
            
            // Lógica de Salida (Crossfader Override)
            let finalMix = state.crossfade;
            if(state.outputMode === 'A') finalMix = 0.0;
            if(state.outputMode === 'B') finalMix = 1.0;

            uniforms.uTime.value=t; uniforms.uVol.value=lvls.vol; uniforms.uBass.value=lvls.bass;
            uniforms.uMix.value=state.mixRatio; uniforms.uMode.value=state.effectMode;
            uniforms.uStyle.value=state.styleMode; uniforms.uDistType.value=state.distortionType;
            uniforms.uTint.value=state.tint; uniforms.uTintMix.value=state.tintMix;
            uniforms.uCrossfade.value=finalMix; // Usar el mix calculado
            uniforms.uSpeed.value=state.speed; uniforms.uRGBShift.value=state.rgbShift; 
            uniforms.uGeoStrength.value=state.geoStrength;
            
            bloom.strength = state.bloom + (lvls.vol * 1.5);
            if(lvls.bass>0.5) plane.rotation.z = (Math.random()-0.5)*0.02; else plane.rotation.z*=0.9;
            if(texA.image?.readyState>=2) texA.needsUpdate=true;
            if(texB.image?.readyState>=2) texB.needsUpdate=true;
            if(webcamTex.image?.readyState>=2) webcamTex.needsUpdate=true;
            composer.render();
        }

        // DOM BINDS
        document.getElementById('start-btn').onclick = async () => {
            await audio.init(); await initMIDI();
            document.getElementById('boot').style.display='none';
            actions.loadDefault();
            resize(); animate();
        };

        document.getElementById('btn-proj').onclick = () => {
            if(projectorWindow && !projectorWindow.closed) projectorWindow.focus();
            else {
                projectorWindow = window.open("", "PROJ", "width=800,height=600");
                const stream = canvas.captureStream(60);
                projectorWindow.document.write(`<body style="margin:0;background:#000;overflow:hidden"><video id="v" autoplay style="width:100vw;height:100vh;object-fit:cover; opacity:${state.outputMode==='OFF'?0:1}"></video></body>`);
                setTimeout(()=> projectorWindow.document.getElementById('v').srcObject = stream, 200);
            }
        };

        // UI Buttons
        document.getElementById('work-btn-a').onclick = () => actions.setWorkDeck('A');
        document.getElementById('work-btn-b').onclick = () => actions.setWorkDeck('B');
        
        document.getElementById('out-a').onclick = () => actions.setOutput('A');
        document.getElementById('out-b').onclick = () => actions.setOutput('B');
        document.getElementById('out-off').onclick = () => actions.setOutput('OFF');

        document.getElementById('btn-midi').onclick = () => { document.getElementById('midi-overlay').style.display = 'flex'; renderMidiUI(); };
        document.getElementById('btn-close-midi').onclick = () => document.getElementById('midi-overlay').style.display = 'none';

    </script>
</head>
<body>

    <div id="boot">
        <h1 style="font-size:60px; letter-spacing:10px; color:#fff; margin-bottom:10px;">IRIS <span style="color:#00E5FF">v5</span></h1>
        <p style="color:#666; font-family:'Montserrat'; letter-spacing:2px; font-size:12px; margin-bottom:30px;">COMMAND CENTER</p>
        <button id="start-btn" style="padding:15px 40px; background:transparent; border:1px solid #00E5FF; color:#fff; font-family:'Rajdhani'; font-size:18px; cursor:pointer;">INICIAR SISTEMA</button>
    </div>

    <div id="viewport">
        <canvas id="vj-canvas"></canvas>
    </div>

    <div id="ui-container">
        
        <div id="scale-strip">
            <div id="scale-fill"></div>
            <input type="range" id="scale-input" min="0.6" max="1.4" step="0.01" value="1.0">
        </div>

        <div id="dashboard">
            
            <div class="panel">
                <h3>SISTEMA</h3>
                <div class="info-row"><span>FX MODE</span> <span id="val-mode" class="info-val">1</span></div>
                <div class="info-row"><span>STYLE</span> <span id="val-style" class="info-val">NORMAL</span></div>
                <div class="info-row"><span>DEFORM</span> <span id="val-dist" class="info-val">FLOR</span></div>
                
                <div class="info-row" style="margin-top:20px;"><span>SHORTCUTS</span></div>
                <div style="font-size:10px; color:#555; line-height:1.5;">
                    <span class="key-badge">1-0</span> FX 2D<br>
                    <span class="key-badge">Z-B</span> Estilos<br>
                    <span class="key-badge">I-P</span> 3D Geo<br>
                    <span class="key-badge">A-L</span> Cargar Clip<br>
                    <span class="key-badge">N</span> Webcam
                </div>
            </div>

            <div class="panel">
                <div style="width:100%;">
                    
                    <div class="deck-monitor">
                        <div id="deck-box-a" class="deck-box active-work">
                            <span class="deck-letter">A</span>
                            <span id="deck-a-file" class="deck-file">VACÍO</span>
                        </div>
                        <div id="deck-box-b" class="deck-box">
                            <span class="deck-letter">B</span>
                            <span id="deck-b-file" class="deck-file">VACÍO</span>
                        </div>
                    </div>

                    <div id="crossfader-track">
                        <div id="crossfader-handle"></div>
                    </div>
                    <div style="text-align:center; font-size:9px; color:#444;">SCROLL MEZCLA</div>

                </div>
            </div>

            <div class="panel">
                
                <div class="control-group">
                    <span class="group-label">WORK DECK (EDIT)</span>
                    <div class="work-selector">
                        <button id="work-btn-a" class="work-btn selected">MIX A</button>
                        <button id="work-btn-b" class="work-btn">MIX B</button>
                    </div>
                </div>

                <div class="control-group">
                    <span class="group-label">PROYECCIÓN SALIDA</span>
                    <div class="output-matrix">
                        <button id="out-a" class="out-btn">SOLO A</button>
                        <button id="out-b" class="out-btn">SOLO B</button>
                        <button id="out-off" class="out-btn">OFF</button>
                    </div>
                </div>

                <div class="utility-row">
                    <button class="util-btn" id="btn-midi">MIDI</button>
                    <button class="util-btn" id="btn-proj">PROJ</button>
                    <button class="util-btn" onclick="document.getElementById('file-input').click()">LOAD</button>
                </div>

                <div style="margin-top:15px;">
                    <div class="param-row"><span class="param-label">SPEED</span> <input type="range" id="sl-speed" min="0.1" max="5" step="0.1" value="1" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">GLITCH</span> <input type="range" id="sl-dist" min="0" max="5" step="0.1" value="2" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">3D</span> <input type="range" id="sl-geo" min="0" max="10" step="0.1" value="4" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">RGB</span> <input type="range" id="sl-rgb" min="0" max="0.2" step="0.01" value="0.05" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">GAIN</span> <input type="range" id="sl-gain" min="1" max="10" step="0.1" value="5" class="param-slider"></div>
                    <div class="param-row"><span class="param-label">BLOOM</span> <input type="range" id="sl-bloom" min="0" max="3" step="0.1" value="1.5" class="param-slider"></div>
                </div>

            </div>

        </div>
    </div>

    <div id="midi-overlay">
        <div id="midi-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#00E5FF; margin:0; font-size:16px; letter-spacing:2px;">MAPEO MIDI</h2>
                <button id="btn-close-midi" class="action-btn" style="padding:5px 20px;">GUARDAR</button>
            </div>
            <div id="midi-scroll"></div>
        </div>
    </div>

    <div id="notify">NOTIFICACIÓN</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">

</body>
</html>
