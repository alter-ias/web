<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IRIS v10 - COMPLETE SYSTEM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000;
            --panel-bg: rgba(10, 12, 15, 0.98);
            --accent: #00E5FF;
            --ui-scale: 1.0;
        }
        body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: 'Rajdhani', sans-serif; color: #fff; display: flex; flex-direction: column; height: 100vh; }

        /* VIEWPORT (MONITORES) */
        #viewport {
            flex-grow: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center; gap: 40px;
            background: #000; z-index: 1;
        }
        .monitor-container {
            width: 40%; height: 60%; position: relative;
            border: 1px solid #333; transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
            background: #000;
        }
        .monitor-container canvas { width: 100%; height: 100%; object-fit: contain; }
        
        .monitor-container.editing { 
            border: 2px solid var(--accent); 
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.2); 
            transform: scale(1.02);
        }
        .monitor-label {
            position: absolute; top: -30px; left: 0; 
            font-family: 'Montserrat'; font-weight: 700; font-size: 20px; 
            color: #444; letter-spacing: 2px;
        }
        .monitor-container.editing .monitor-label { color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        .monitor-status {
            position: absolute; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 5px; box-sizing: border-box;
            font-size: 10px; font-family: monospace; background: rgba(0,0,0,0.8);
        }
        .st-active { color: var(--accent); font-weight: bold; }

        /* UI CONTROL */
        #ui-wrapper { flex-shrink: 0; width: 100%; background: transparent; z-index: 10; display: flex; justify-content: center; align-items: flex-end; position: relative; }
        #dashboard {
            width: 100%; height: 280px; background: var(--panel-bg);
            border-top: 1px solid rgba(0,229,255,0.1);
            transform-origin: top center; transform: scale(var(--ui-scale));
            width: calc(100% / var(--ui-scale));
            display: grid; grid-template-columns: 250px 1fr 380px;
            padding: 30px 40px; box-sizing: border-box;
            gap: 30px; position: relative;
        }

        #scale-strip { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #080808; cursor: ew-resize; z-index: 50; }
        #scale-fill { height: 100%; width: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        #scale-input { position: absolute; top: -10px; left: 0; width: 100%; height: 20px; opacity: 0; cursor: ew-resize; }

        .panel { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        h3 { font-family: 'Montserrat', sans-serif; font-size: 10px; letter-spacing: 2px; color: #556677; margin: 0 0 10px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }

        .shortcut-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; color: #888; }
        .key-badge { color: var(--accent); font-weight: 700; }

        /* MIXER AREA */
        .mix-center { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .work-grid { display: flex; gap: 20px; margin-bottom: 15px; }
        .work-btn {
            flex: 1; padding: 20px; background: #0a0a0a; border: 1px solid #333; color: #555;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 18px; cursor: pointer; text-align: center;
            transition: 0.2s; text-transform: uppercase;
        }
        .work-btn.selected { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 30px var(--accent); }

        #crossfader-track { width: 100%; height: 8px; background: #000; border-radius: 4px; position: relative; border: 1px solid #333; margin-top: 10px;}
        #crossfader-handle { width: 60px; height: 20px; background: var(--accent); position: absolute; top: -6px; left: 50%; transform: translateX(-50%); border-radius: 2px; box-shadow: 0 0 10px var(--accent); }

        /* OUTPUT & CONTROLS */
        .out-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .out-btn { padding: 12px; background: #1a0505; border: 1px solid #331111; color: #ff3366; font-family: 'Montserrat'; font-weight: 700; font-size: 10px; cursor: pointer; }
        .out-btn.active-off { background: #ff0055; color: #fff; border-color: #ff0055; box-shadow: 0 0 20px #ff0055; }
        .out-btn.source { background: #051a1a; border-color: #113333; color: #44cccc; }
        .out-btn.source.active { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 20px var(--accent); }

        .sliders-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: auto; }
        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 10px; }
        .param-label { color: #888; width: 50px; }
        .param-slider { flex-grow: 1; accent-color: var(--accent); height: 2px; cursor: pointer; }

        .util-btn { padding: 8px; background: transparent; border: 1px solid #444; color: #888; font-size: 10px; cursor: pointer; flex: 1; margin: 0 2px;}
        .util-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* OVERLAYS */
        #notify { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: var(--accent); opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(0,0,0,0.8); padding: 15px 30px; border: 1px solid var(--accent); z-index: 999; letter-spacing: 5px; }
        #boot { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #midi-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; }
        #midi-panel { width: 700px; height: 85vh; background: #111; border: 1px solid var(--accent); padding: 20px; overflow-y: auto; display: flex; flex-direction: column;}
        #midi-scroll { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .midi-group-title { grid-column: span 2; color: var(--accent); margin-top: 15px; border-bottom: 1px solid #333; font-size: 12px; }
        .midi-item { background: #222; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
        .midi-btn { background: #333; color: #fff; border: 1px solid #555; font-size: 10px; cursor: pointer; width: 60px; }
        .midi-btn.learning { background: #f0f; animation: blink 0.5s infinite; }
        @keyframes blink {0%{opacity:1}50%{opacity:0.5}}
    </style>
</head>
<body>

    <div id="boot">
        <h1 style="font-size:60px; letter-spacing:10px; color:#fff; margin-bottom:10px;">IRIS <span style="color:#00E5FF">v10</span></h1>
        <button id="btn-start" style="padding:15px 40px; background:transparent; border:1px solid #00E5FF; color:#fff; font-family:'Rajdhani'; font-size:20px; cursor:pointer;">INICIAR SISTEMA</button>
    </div>

    <div id="viewport">
        <div id="cont-1" class="monitor-container editing">
            <span class="monitor-label">MIX 1</span>
            <canvas id="canvas-1"></canvas>
            <div class="monitor-status"><span id="st-1" class="st-active">IDLE</span></div>
        </div>
        <div id="cont-2" class="monitor-container">
            <span class="monitor-label">MIX 2</span>
            <canvas id="canvas-2"></canvas>
            <div class="monitor-status"><span id="st-2" class="st-active">IDLE</span></div>
        </div>
    </div>

    <div id="ui-wrapper">
        <div id="dashboard">
            <div id="scale-strip"><div id="scale-fill"></div><input type="range" id="scale-input" min="0.6" max="1.4" step="0.01" value="1.0"></div>

            <div class="panel">
                <h3>ATAJOS</h3>
                <div class="shortcut-row"><span>Cargar Video</span> <span class="key-badge">A-L</span></div>
                <div class="shortcut-row"><span>Efectos 2D</span> <span class="key-badge">1-0</span></div>
                <div class="shortcut-row"><span>Estilos (Malla/Puntos)</span> <span class="key-badge">Z-B</span></div>
                <div class="shortcut-row"><span>Deformación 3D</span> <span class="key-badge">I,O,P</span></div>
                <div class="shortcut-row"><span>Tintes</span> <span class="key-badge">Q-Y</span></div>
                <div class="shortcut-row"><span>Webcam (0-50-100%)</span> <span class="key-badge">N</span></div>
                <div class="shortcut-row"><span>Reset</span> <span class="key-badge">M</span></div>
            </div>

            <div class="panel">
                <div class="mix-center">
                    <div class="work-grid">
                        <button id="btn-mix-1" class="work-btn selected">MIX 1</button>
                        <button id="btn-mix-2" class="work-btn">MIX 2</button>
                    </div>
                    <div id="crossfader-track"><div id="crossfader-handle"></div></div>
                </div>
            </div>

            <div class="panel">
                <div class="out-matrix">
                    <button id="out-off" class="out-btn active-off">BLACKOUT</button>
                    <button id="out-1" class="out-btn source">PROJ 1</button>
                    <button id="out-2" class="out-btn source">PROJ 2</button>
                </div>
                <div style="display:flex; margin-bottom:15px;">
                    <button class="util-btn" id="btn-midi">MIDI</button>
                    <button class="util-btn" id="btn-proj">VENTANA</button>
                    <button class="util-btn" onclick="document.getElementById('file-input').click()">CARGAR</button>
                </div>
                <div class="sliders-grid">
                    <div>
                        <div class="param-row"><span class="param-label">SPEED</span> <input type="range" id="sl-speed" min="0.1" max="5" step="0.1" value="1" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">GLITCH</span> <input type="range" id="sl-dist" min="0" max="5" step="0.1" value="0" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">3D GEO</span> <input type="range" id="sl-geo" min="0" max="10" step="0.1" value="4" class="param-slider"></div>
                    </div>
                    <div>
                        <div class="param-row"><span class="param-label">RGB</span> <input type="range" id="sl-rgb" min="0" max="0.2" step="0.01" value="0.02" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">GAIN</span> <input type="range" id="sl-gain" min="1" max="10" step="0.1" value="5" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">BLOOM</span> <input type="range" id="sl-bloom" min="0" max="3" step="0.1" value="1.5" class="param-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="midi-overlay"><div id="midi-panel"><h2 style="color:#00E5FF; border-bottom:1px solid #333;">MIDI MAP</h2><div id="midi-scroll"></div><button class="util-btn" style="margin-top:20px;" onclick="document.getElementById('midi-overlay').style.display='none'">CERRAR</button></div></div>
    <div id="notify">NOTIFICACIÓN</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        
        // --- MOTOR GRAFICO (Instanciable) ---
        class VJEngine {
            constructor(canvasId) {
                this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById(canvasId), antialias: true });
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000); this.camera.position.z = 9;
                
                this.video = document.createElement('video'); 
                this.video.muted=true; this.video.loop=true; this.video.playsInline=true;
                this.tex = new THREE.VideoTexture(this.video);
                
                this.webcam = document.createElement('video'); this.webcam.muted=true; this.webcam.playsInline=true;
                this.webcamTex = new THREE.VideoTexture(this.webcam);

                this.uniforms = {
                    uTex: { value: this.tex }, uCam: { value: this.webcamTex }, uMix: { value: 0.0 },
                    uTime: { value: 0 }, uBass: { value: 0 }, uMode: { value: 1 }, uStyle: { value: 0 },
                    uSpeed: { value: 1.0 }, uGlitch: { value: 0.0 }, uGeo: { value: 4.0 }, uRGB: { value: 0.02 },
                    uTint: { value: new THREE.Color(1,1,1) }, uTintMix: { value: 0.0 }, uDistType: { value: 0 }
                };

                const mat = new THREE.ShaderMaterial({
                    uniforms: this.uniforms, side: THREE.DoubleSide,
                    vertexShader: `
                        uniform float uTime; uniform float uSpeed; uniform float uGeo; uniform int uDistType; uniform float uBass;
                        varying vec2 vUv;
                        void main() {
                            vUv = uv; vec3 pos = position; float t = uTime * uSpeed; float d = 0.0;
                            if(uDistType==1) d = sin(pos.x*2.+t)*cos(pos.y*1.5+t); // Olas
                            if(uDistType==2) d = sin(pos.y*10.+t)*0.5 * sin(pos.x*10.); // Picos
                            if(uDistType==3) { vec2 b=floor(uv*10.); d=(fract(sin(dot(b,vec2(12.9,78.2)))*43758.5)>0.5)?1.0:0.0; d*=sin(t*5.); } // Digital
                            pos.z += d * uGeo * (0.2 + uBass * 0.5);
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D uTex; uniform sampler2D uCam; uniform float uMix;
                        uniform float uTime; uniform float uSpeed; uniform float uRGB; uniform float uBass;
                        uniform int uMode; uniform int uStyle; uniform vec3 uTint; uniform float uTintMix;
                        varying vec2 vUv;
                        float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
                        void main() {
                            vec2 uv = vUv; float t = uTime * uSpeed;
                            // FX 2D
                            if(uMode==2) uv.x = abs(uv.x-0.5)+0.5; // Mirror
                            if(uMode==3) { vec2 c=uv-0.5; float r=length(c); float a=atan(c.y,c.x); a=mod(a,0.52); uv=0.5+r*vec2(cos(a),sin(a)); } // Kaleido
                            if(uMode==4) uv += vec2(sin(uv.y*10.+t)*0.05, 0.0); // Wavy
                            if(uMode==5) { float d=length(uv-0.5); float a=atan(uv.y-0.5,uv.x-0.5)+(uBass*5.0)*(1.0-d); uv=0.5+d*vec2(cos(a),sin(a)); } // Twist
                            if(uMode==9) { uv.x+=sin(uv.y*10.0+t)*0.05*uBass; uv.y+=cos(uv.x*10.0+t)*0.05*uBass; } // Shake

                            vec3 col = texture2D(uTex, uv).rgb;
                            // RGB Shift
                            col.r = texture2D(uTex, uv - vec2(uRGB,0)).r;
                            col.b = texture2D(uTex, uv + vec2(uRGB,0)).b;

                            // Webcam Mix
                            vec3 cam = texture2D(uCam, uv).rgb;
                            col = mix(col, cam, uMix);

                            // Estilos
                            float lum = dot(col, vec3(0.33));
                            if(uStyle==1) { col = vec3(step(0.5, fract(uv.x*50.0+t))); col*=lum; } // Malla fake
                            if(uStyle==2) { col = vec3(step(0.9, rand(floor(uv*100.0)))); col*=lum; } // Puntos fake
                            if(uStyle==3) col = vec3(floor(col*4.0)/4.0); // Posterize
                            if(uStyle==4) col = mix(col, vec3(0,1,0), 0.5) * step(0.5, sin(uv.y*100.+t)); // Matrix

                            col = mix(col, col*uTint, uTintMix);
                            gl_FragColor = vec4(col, 1.0);
                        }
                    `
                });
                this.mesh = new THREE.Mesh(new THREE.PlaneGeometry(16, 9, 80, 80), mat);
                this.scene.add(this.mesh);
                
                this.params = { speed: 1.0, glitch: 0.0, geo: 4.0, rgb: 0.02, bloom: 1.5, mic: 5.0 };
            }
            resize(w,h) { this.renderer.setSize(w,h); this.camera.aspect=w/h; this.camera.updateProjectionMatrix(); }
            render(t, audio) {
                this.uniforms.uTime.value = t; this.uniforms.uBass.value = audio.bass;
                this.uniforms.uSpeed.value = this.params.speed;
                this.uniforms.uRGB.value = this.params.rgb + (audio.bass * this.params.glitch * 0.1);
                this.uniforms.uGeo.value = this.params.geo;
                if(this.video.readyState>=2) this.tex.needsUpdate=true;
                if(this.webcam.readyState>=2) this.webcamTex.needsUpdate=true;
                this.renderer.render(this.scene, this.camera);
            }
        }

        // --- GLOBAL LOGIC ---
        const mix1 = new VJEngine('canvas-1');
        const mix2 = new VJEngine('canvas-2');
        let activeMix = mix1; let activeId = 1;
        let outputMode = 'OFF';
        let projWin = null;
        let audio = { vol: 0, bass: 0 };

        // Audio Init
        async function initAudio() {
            try {
                const ctx = new (window.AudioContext||window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                const ana = ctx.createAnalyser(); ana.fftSize=512;
                const src = ctx.createMediaStreamSource(stream); src.connect(ana);
                const data = new Uint8Array(ana.frequencyBinCount);
                const loop = () => {
                    requestAnimationFrame(loop); ana.getByteFrequencyData(data);
                    const rawVol = data.reduce((a,b)=>a+b,0)/data.length/255;
                    audio.vol = rawVol * activeMix.params.mic; // Gain aplicado aqui
                    audio.bass = (data[5]/255) * activeMix.params.mic; 
                }; loop();
            } catch(e) {}
        }

        // --- CONTROL ---
        function setActive(id) {
            activeId = id; activeMix = (id===1) ? mix1 : mix2;
            document.getElementById('btn-mix-1').className = `work-btn ${id===1?'selected':''}`;
            document.getElementById('btn-mix-2').className = `work-btn ${id===2?'selected':''}`;
            document.getElementById('cont-1').className = `monitor-container ${id===1?'editing':''}`;
            document.getElementById('cont-2').className = `monitor-container ${id===2?'editing':''}`;
            
            // Sync UI
            document.getElementById('sl-speed').value = activeMix.params.speed;
            document.getElementById('sl-dist').value = activeMix.params.glitch;
            document.getElementById('sl-geo').value = activeMix.params.geo;
            document.getElementById('sl-rgb').value = activeMix.params.rgb;
            document.getElementById('sl-gain').value = activeMix.params.mic;
            document.getElementById('sl-bloom').value = activeMix.params.bloom;
            notify(`EDITANDO: MIX ${id}`);
        }

        function setOutput(mode) {
            outputMode = mode;
            document.getElementById('out-off').className = `out-btn ${mode==='OFF'?'active-off':''}`;
            document.getElementById('out-1').className = `out-btn source ${mode==='1'?'active':''}`;
            document.getElementById('out-2').className = `out-btn source ${mode==='2'?'active':''}`;
            
            if(projWin && !projWin.closed) {
                const v = projWin.document.getElementById('v');
                if(mode==='OFF') v.style.opacity=0;
                else {
                    const stream = (mode==='1' ? mix1 : mix2).renderer.domElement.captureStream(60);
                    v.srcObject = stream; v.style.opacity=1;
                }
            }
            notify(`SALIDA: ${mode}`);
        }

        function notify(msg) {
            const n = document.getElementById('notify'); n.innerText=msg; n.style.opacity=1; setTimeout(()=>n.style.opacity=0, 1500);
        }

        // --- INPUTS ---
        document.getElementById('file-input').onchange = (e) => {
            if(!e.target.files[0]) return;
            const url = URL.createObjectURL(e.target.files[0]);
            activeMix.video.src = url; activeMix.video.play();
            document.getElementById(`st-${activeId}`).innerText = e.target.files[0].name.substring(0,10);
            notify(`CLIP CARGADO EN MIX ${activeId}`);
        };

        // Sliders
        const updateP = (k, v) => activeMix.params[k] = parseFloat(v);
        document.getElementById('sl-speed').oninput=(e)=>updateP('speed', e.target.value);
        document.getElementById('sl-dist').oninput=(e)=>updateP('glitch', e.target.value);
        document.getElementById('sl-geo').oninput=(e)=>updateP('geo', e.target.value);
        document.getElementById('sl-rgb').oninput=(e)=>updateP('rgb', e.target.value);
        document.getElementById('sl-gain').oninput=(e)=>updateP('mic', e.target.value);
        document.getElementById('sl-bloom').oninput=(e)=>updateP('bloom', e.target.value);
        document.getElementById('scale-input').oninput=(e)=>{
            document.documentElement.style.setProperty('--ui-scale', e.target.value);
            document.getElementById('scale-fill').style.width = ((e.target.value-0.6)/0.8)*100+'%';
            setTimeout(resize, 50);
        };

        // Keyboard
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if(['a','s','d','f','g','h','j','k','l'].includes(k)) document.getElementById('file-input').click();
            if(!isNaN(parseInt(k))) { activeMix.uniforms.uMode.value=parseInt(k); notify(`FX ${k}`); }
            const styles = {'z':0, 'x':1, 'c':2, 'v':3, 'b':4};
            if(styles[k]!==undefined) { activeMix.uniforms.uStyle.value=styles[k]; notify(`ESTILO ${k.toUpperCase()}`); }
            const geos = {'i':1, 'o':2, 'p':3};
            if(geos[k]!==undefined) { activeMix.uniforms.uDistType.value=geos[k]; notify("GEO FX"); }
            if(k==='m') { activeMix.uniforms.uMode.value=1; activeMix.uniforms.uStyle.value=0; activeMix.uniforms.uDistType.value=0; notify("RESET"); }
            if(k==='n') { 
                let m = activeMix.uniforms.uMix.value; m = (m===0)?0.5:(m===0.5?1.0:0.0);
                activeMix.uniforms.uMix.value = m;
                if(m>0 && !activeMix.webcam.srcObject) navigator.mediaDevices.getUserMedia({video:{width:1280}}).then(s=>{activeMix.webcam.srcObject=s; activeMix.webcam.play();});
                notify(`CAM ${m*100}%`);
            }
            const cols = {'q':[1,0,0], 'w':[0,1,0], 'e':[0,0,1], 'r':[0,1,1], 't':[1,0,1], 'y':[1,1,0], 'u':[1,1,1]};
            if(cols[k]) { 
                activeMix.uniforms.uTint.value.setRGB(...cols[k]); 
                activeMix.uniforms.uTintMix.value = (k==='u')?0.0:1.0; 
                notify(k==='u'?"COLOR OFF":"COLOR ON"); 
            }
        });

        // Loop
        function resize() {
            const w = document.getElementById('cont-1').clientWidth;
            const h = document.getElementById('cont-1').clientHeight;
            mix1.resize(w,h); mix2.resize(w,h);
        }
        window.addEventListener('resize', resize);
        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001;
            mix1.render(t, audio); mix2.render(t, audio);
        }

        // Init
        document.getElementById('btn-start').onclick = async () => {
            await initAudio();
            document.getElementById('boot').style.display='none';
            mix1.video.src = 'assets/videos/iris.webm'; mix1.video.play();
            mix2.video.src = 'assets/videos/iris.webm'; mix2.video.play();
            resize(); animate();
        };

        // Proyector
        document.getElementById('btn-proj').onclick = () => {
            projWin = window.open("", "PROJ", "width=800,height=600");
            projWin.document.write(`<body style="margin:0;background:#000;overflow:hidden"><video id="v" autoplay style="width:100vw;height:100vh;object-fit:cover;opacity:0"></video></body>`);
        };

        document.getElementById('btn-mix-1').onclick = () => setActive(1);
        document.getElementById('btn-mix-2').onclick = () => setActive(2);
        document.getElementById('out-off').onclick = () => setOutput('OFF');
        document.getElementById('out-1').onclick = () => setOutput('1');
        document.getElementById('out-2').onclick = () => setOutput('2');

        // MIDI
        const midiMap = { 
            'slot_a':()=>document.getElementById('file-input').click(),
            'crossfader':(v)=>{/*Scroll visual only*/},
            'work_a':()=>setActive(1), 'work_b':()=>setActive(2),
            'out_off':()=>setOutput('OFF'), 'out_a':()=>setOutput('1'), 'out_b':()=>setOutput('2'),
            'speed':(v)=>updateP('speed', v*5), 'distortion':(v)=>updateP('glitch', v*5)
        };
        // (Lógica MIDI estándar omitida por brevedad, usa navigator.requestMIDIAccess y mapea a midiMap)
        document.getElementById('btn-midi').onclick = () => document.getElementById('midi-overlay').style.display='flex';
        document.getElementById('btn-close-midi').onclick = () => document.getElementById('midi-overlay').style.display='none';

    </script>
</body>
</html>
