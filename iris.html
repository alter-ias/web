<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IRIS v12 - FINAL CORE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #000; --panel: rgba(10,12,15,0.98); --cyan: #00E5FF; --dim: #556677; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Rajdhani', sans-serif; color: #fff; display: flex; flex-direction: column; height: 100vh; }

        #viewport { flex-grow: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #000; z-index: 1; }
        #vj-canvas { width: 100%; height: 100%; object-fit: contain; }

        #ui-wrapper { flex-shrink: 0; width: 100%; background: transparent; z-index: 10; display: flex; justify-content: center; align-items: flex-end; position: relative; }
        #dashboard { width: 100%; height: 280px; background: var(--panel); border-top: 1px solid rgba(0,229,255,0.1); transform-origin: top center; transform: scale(1.0); width: 100%; display: grid; grid-template-columns: 250px 1fr 380px; padding: 30px 40px; box-sizing: border-box; gap: 30px; position: relative; }

        #scale-strip { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #080808; cursor: ew-resize; z-index: 50; }
        #scale-fill { height: 100%; width: 50%; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); }
        #scale-input { position: absolute; top: -10px; left: 0; width: 100%; height: 20px; opacity: 0; cursor: ew-resize; }

        .panel { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        h3 { font-family: 'Montserrat'; font-size: 10px; letter-spacing: 2px; color: var(--dim); margin: 0 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .shortcut-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; color: #888; }
        .key-badge { color: var(--cyan); font-weight: 700; }

        .mix-center { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .work-grid { display: flex; gap: 20px; margin-bottom: 15px; }
        .work-btn { flex: 1; padding: 20px; background: #0a0a0a; border: 1px solid #333; color: #555; font-family: 'Rajdhani'; font-weight: 700; font-size: 18px; cursor: pointer; text-align: center; transition: 0.2s; text-transform: uppercase; }
        .work-btn.selected { background: var(--cyan); color: #000; border-color: var(--cyan); box-shadow: 0 0 30px var(--cyan); }

        #crossfader-track { width: 100%; height: 8px; background: #000; border-radius: 4px; position: relative; border: 1px solid #333; margin-top: 10px;}
        #crossfader-handle { width: 60px; height: 20px; background: var(--cyan); position: absolute; top: -6px; left: 50%; transform: translateX(-50%); border-radius: 2px; box-shadow: 0 0 10px var(--cyan); }

        .out-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .out-btn { padding: 12px; background: #1a0505; border: 1px solid #331111; color: #f36; font-weight: 700; font-size: 10px; cursor: pointer; }
        .out-btn.active-off { background: #f05; color: #fff; border-color: #f05; box-shadow: 0 0 20px #f05; }
        .out-btn.source { background: #051a1a; border-color: #113333; color: #44cccc; }
        .out-btn.source.active { background: var(--cyan); color: #000; border-color: var(--cyan); box-shadow: 0 0 20px var(--cyan); }

        .sliders-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: auto; }
        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 10px; }
        .param-label { color: #888; width: 50px; }
        .param-slider { flex-grow: 1; accent-color: var(--cyan); height: 2px; cursor: pointer; }

        .util-btn { padding: 8px; background: transparent; border: 1px solid #444; color: #888; font-size: 10px; cursor: pointer; flex: 1; margin: 0 2px;}
        .util-btn:hover { border-color: var(--cyan); color: var(--cyan); }

        #notify { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: var(--cyan); opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(0,0,0,0.9); padding: 20px 50px; border: 2px solid var(--cyan); z-index: 999; letter-spacing: 5px; font-weight: bold; }
        #boot { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        #midi-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; }
        #midi-panel { width: 900px; height: 90vh; background: #0b0e14; border: 1px solid var(--cyan); padding: 0; display: flex; flex-direction: column; }
        .midi-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #midi-list { flex-grow: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; align-content: start; }
        .midi-group { grid-column: span 4; color: var(--cyan); border-bottom: 1px solid #333; margin-top: 15px; font-weight: bold; font-size: 11px; padding-bottom: 5px; }
        .midi-item { background: #1a1a1a; padding: 5px 10px; border: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .midi-btn { background: #222; border: 1px solid #555; color: #fff; font-size: 9px; padding: 3px 6px; cursor: pointer; min-width: 50px; text-align: center; }
        .midi-btn.learning { background: #f0f; animation: blink 0.5s infinite; }
        @keyframes blink { 0%{opacity:1} 50%{opacity:0.5} }
    </style>
</head>
<body>

    <div id="boot">
        <h1 style="font-size:80px; letter-spacing:10px; color:#fff; margin-bottom:0px;">IRIS <span style="color:#00E5FF">v12</span></h1>
        <button id="btn-start" style="padding:15px 50px; background:transparent; border:2px solid #00E5FF; color:#fff; font-family:'Rajdhani'; font-size:24px; cursor:pointer; font-weight:bold;">INICIAR SISTEMA</button>
    </div>

    <div id="viewport">
        <canvas id="vj-canvas"></canvas>
    </div>

    <div id="ui-wrapper">
        <div id="dashboard">
            <div id="scale-strip"><div id="scale-fill"></div><input type="range" id="scale-input" min="0.6" max="1.4" step="0.01" value="1.0"></div>

            <div class="panel">
                <h3>SISTEMA</h3>
                <div style="font-size:11px; color:#666; line-height:1.6;">
                    TECLADO:<br>
                    <b style="color:#fff">A-L</b>: Clips (A Mix Seleccionado)<br>
                    <b style="color:#fff">1-0</b>: FX Modo<br>
                    <b style="color:#fff">Z</b>: Malla Grid<br>
                    <b style="color:#fff">X-B</b>: Otros Estilos<br>
                    <b style="color:#fff">I-P</b>: Geo 3D<br>
                    <b style="color:#fff">Q-Y</b>: Colores<br>
                    <b style="color:#fff">N</b>: Webcam<br>
                    <b style="color:#fff">M</b>: Reset
                </div>
            </div>

            <div class="panel">
                <div class="mix-center">
                    <div class="work-grid">
                        <button id="btn-m1" class="work-btn selected">MIX 1</button>
                        <button id="btn-m2" class="work-btn">MIX 2</button>
                    </div>
                    <div id="crossfader-track"><div id="fader-knob"></div></div>
                </div>
            </div>

            <div class="panel">
                <div class="out-matrix">
                    <button id="out-off" class="out-btn active-off">BLACKOUT</button>
                    <button id="out-1" class="out-btn src">PROJ 1</button>
                    <button id="out-2" class="out-btn src">PROJ 2</button>
                </div>
                <div class="util-grid">
                    <button class="util-btn" id="btn-midi">MIDI</button>
                    <button class="util-btn" id="btn-proj">VENTANA</button>
                    <button class="util-btn" onclick="document.getElementById('file-input').click()">CARGAR</button>
                </div>
                <div class="sliders-grid">
                    <div>
                        <div class="param-row"><span class="param-label">SPEED</span> <input type="range" id="sl-speed" min="0.1" max="5" step="0.1" value="1" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">GLITCH</span> <input type="range" id="sl-glitch" min="0" max="5" step="0.1" value="0" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">3D GEO</span> <input type="range" id="sl-geo" min="0" max="10" step="0.1" value="4" class="param-slider"></div>
                    </div>
                    <div>
                        <div class="param-row"><span class="param-label">RGB</span> <input type="range" id="sl-rgb" min="0" max="0.2" step="0.01" value="0.02" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">GAIN</span> <input type="range" id="sl-mic" min="1" max="20" step="1" value="5" class="param-slider"></div>
                        <div class="param-row"><span class="param-label">BLOOM</span> <input type="range" id="sl-bloom" min="0" max="3" step="0.1" value="1.5" class="param-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="midi-overlay">
        <div id="midi-panel">
            <div class="midi-head"><h2 style="color:var(--cyan); margin:0;">MAPEO MIDI</h2><button class="util-btn" onclick="document.getElementById('midi-overlay').style.display='none'">CERRAR</button></div>
            <div id="midi-list"></div>
        </div>
    </div>

    <div id="notify">NOTIFICACIÃ“N</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        // --- 1. CONFIG ---
        const state = {
            activeId: 1, output: 'OFF',
            mix1: { fader:0, speed:1, glitch:0, geo:4, rgb:0.02, bloom:1.5, mic:5, mode:1, style:0, dist:0, camMix:0 },
            mix2: { fader:0, speed:1, glitch:0, geo:4, rgb:0.02, bloom:1.5, mic:5, mode:1, style:0, dist:0, camMix:0 }
        };
        let audioData = { bass: 0, vol: 0 };
        let projWin = null;
        const webcamEl = document.createElement('video'); webcamEl.muted=true; webcamEl.playsInline=true;
        const webcamTex = new THREE.VideoTexture(webcamEl);

        // --- 2. VJ ENGINE (DUAL CORE) ---
        class MixerEngine {
            constructor() {
                // Offscreen rendering para luego proyectar
                this.renderer = new THREE.WebGLRenderer({ antialias:true });
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75,1,0.1,1000); this.camera.position.z=9;
                this.vidA = this.createVid(); this.texA = new THREE.VideoTexture(this.vidA);
                this.vidB = this.createVid(); this.texB = new THREE.VideoTexture(this.vidB);
                
                this.uniforms = {
                    uTexA: {value:this.texA}, uTexB: {value:this.texB}, uCross: {value:0},
                    uTime: {value:0}, uBass: {value:0}, 
                    uMode: {value:1}, uStyle: {value:0}, uDist: {value:0},
                    uSpeed: {value:1}, uGlitch: {value:0}, uGeo: {value:4}, uRGB: {value:0},
                    uTint: {value:new THREE.Color(1,1,1)}, uTintMix: {value:0},
                    uCam: {value:webcamTex}, uCamMix: {value:0}
                };

                const mat = new THREE.ShaderMaterial({
                    uniforms: this.uniforms, side: THREE.DoubleSide,
                    vertexShader: `
                        uniform float uTime; uniform float uSpeed; uniform float uGeo; uniform int uDist; uniform float uBass;
                        varying vec2 vUv;
                        void main() {
                            vUv = uv; vec3 p = position; float t = uTime*uSpeed; float d = 0.0;
                            if(uDist==1) d = sin(p.x*2.+t)*cos(p.y*1.5+t);
                            if(uDist==2) d = sin(p.y*10.+t)*sin(p.x*10.)*0.5;
                            if(uDist==3) { vec2 b=floor(uv*10.); d=(fract(sin(dot(b,vec2(12.9,78.2)))*43758.5)>0.5)?1.0:0.0; d*=sin(t*5.); }
                            p.z += d * uGeo * (0.2 + uBass * 0.8); 
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D uTexA; uniform sampler2D uTexB; uniform sampler2D uCam; 
                        uniform float uCross; uniform float uCamMix;
                        uniform float uTime; uniform float uSpeed; uniform float uRGB; uniform float uBass; uniform float uGlitch;
                        uniform int uMode; uniform int uStyle; uniform vec3 uTint; uniform float uTintMix;
                        varying vec2 vUv;
                        float rand(vec2 c){ return fract(sin(dot(c.xy,vec2(12.9898,78.233)))*43758.5453); }
                        vec3 rgb(sampler2D t, vec2 uv, float a) {
                            return vec3(texture2D(t,uv-vec2(a,0)).r, texture2D(t,uv).g, texture2D(t,uv+vec2(a,0)).b);
                        }
                        void main() {
                            vec2 uv = vUv; float t = uTime*uSpeed;
                            if(uMode==2) uv.x = abs(uv.x-0.5)+0.5; 
                            if(uMode==3) { vec2 c=uv-0.5; float r=length(c); float a=atan(c.y,c.x); a=mod(a,0.52); uv=0.5+r*vec2(cos(a),sin(a)); } 
                            if(uMode==4) uv += vec2(sin(uv.y*10.+t)*0.05, 0.0); 
                            if(uMode==5) { float d=length(uv-0.5); float a=atan(uv.y-0.5,uv.x-0.5)+(uBass*5.0)*(1.0-d); uv=0.5+d*vec2(cos(a),sin(a)); } 
                            
                            float s = uRGB + (uBass * uGlitch * 0.05);
                            vec3 cA = rgb(uTexA, uv, s);
                            vec3 cB = rgb(uTexB, uv, s);
                            vec3 col = mix(cA, cB, uCross);

                            vec3 cam = rgb(uCam, uv, s);
                            col = mix(col, cam, uCamMix);

                            float lum = dot(col, vec3(0.33));
                            if(uStyle==1) { col = vec3(0,1,1) * (step(0.95, fract(uv.x*50.)) + step(0.95, fract(uv.y*50.))) * lum * 2.0; } // MALLA RESTAURADA
                            if(uStyle==2) { col = vec3(step(0.9, rand(floor(uv*100.)))); col*=lum; } 
                            if(uStyle==3) col = vec3(floor(col*4.)/4.); 
                            if(uStyle==4) col = mix(col, vec3(0,1,0), 0.5) * step(0.5, sin(uv.y*100.+t)); 

                            col = mix(col, col*uTint, uTintMix);
                            gl_FragColor = vec4(col, 1.0);
                        }
                    `
                });
                this.mesh = new THREE.Mesh(new THREE.PlaneGeometry(16, 9, 60, 60), mat);
                this.scene.add(this.mesh);
                
                this.comp = new EffectComposer(this.renderer);
                this.comp.addPass(new RenderPass(this.scene, this.camera));
                this.bloom = new UnrealBloomPass(new THREE.Vector2(256,256), 1.5, 0.4, 0.85);
                this.comp.addPass(this.bloom);
            }
            createVid() { const v = document.createElement('video'); v.muted=true; v.loop=true; v.playsInline=true; return v; }
            resize(w,h) { this.renderer.setSize(w,h); this.comp.setSize(w,h); this.camera.aspect=w/h; this.camera.updateProjectionMatrix(); }
            render(dt, s, aud) {
                this.uniforms.uTime.value = dt; this.uniforms.uBass.value = aud.bass;
                this.uniforms.uSpeed.value = s.speed; this.uniforms.uGlitch.value = s.glitch;
                this.uniforms.uRGB.value = s.rgb; this.uniforms.uGeo.value = s.geo;
                this.uniforms.uCross.value = s.fader; this.uniforms.uCamMix.value = s.camMix;
                this.uniforms.uMode.value = s.mode; this.uniforms.uStyle.value = s.style;
                this.uniforms.uDist.value = s.dist;
                this.bloom.strength = s.bloom + (aud.vol * 2.0);
                if(this.vidA.readyState>=2) this.texA.needsUpdate=true;
                if(this.vidB.readyState>=2) this.texB.needsUpdate=true;
                if(webcamEl.readyState>=2) webcamTex.needsUpdate=true;
                this.comp.render();
            }
        }

        const engine1 = new MixerEngine();
        const engine2 = new MixerEngine();

        // --- 3. CONTROL LOGIC ---
        function getActiveState() { return state.activeId === 1 ? state.mix1 : state.mix2; }

        function updateUI() {
            const s = getActiveState();
            document.getElementById('btn-m1').className = `work-btn ${state.activeId===1?'sel':''}`;
            document.getElementById('btn-m2').className = `work-btn ${state.activeId===2?'sel':''}`;
            document.getElementById('fader-knob').style.left = (s.fader * 100) + '%';
            document.getElementById('out-off').className = `out-btn ${state.output==='OFF'?'active-off':''}`;
            document.getElementById('out-1').className = `out-btn src ${state.output==='1'?'active':''}`;
            document.getElementById('out-2').className = `out-btn src ${state.output==='2'?'active':''}`;
            document.getElementById('sl-speed').value = s.speed;
            document.getElementById('sl-glitch').value = s.glitch;
            document.getElementById('sl-geo').value = s.geo;
            document.getElementById('sl-rgb').value = s.rgb;
            document.getElementById('sl-mic').value = s.mic;
            document.getElementById('sl-bloom').value = s.bloom;
        }

        const actions = {
            selectMix: (id) => { state.activeId = id; updateUI(); },
            setOut: (mode) => { 
                state.output = mode; 
                if(projWin && !projWin.closed) {
                    const v = projWin.document.getElementById('v');
                    if(mode==='OFF') v.style.opacity = 0;
                    else { v.style.opacity = 1; v.srcObject = (mode==='1'?engine1:engine2).renderer.domElement.captureStream(60); }
                }
                updateUI(); 
            },
            loadClip: () => document.getElementById('file-input').click(),
            setParam: (k, v) => { getActiveState()[k] = parseFloat(v); updateUI(); },
            setFade: (v) => { getActiveState().fader = Math.max(0,Math.min(1,v)); updateUI(); },
            setMode: (m) => getActiveState().mode = m,
            setStyle: (s) => getActiveState().style = s,
            setGeo: (g) => getActiveState().dist = g,
            setColor: (c, name) => { 
                const eng = state.activeId===1 ? engine1 : engine2;
                eng.uniforms.uTint.value.setHex(c); 
                eng.uniforms.uTintMix.value = (name==='OFF')?0.0:1.0;
            },
            toggleCam: () => {
                const s = getActiveState();
                s.camMix = (s.camMix===0)?0.5:(s.camMix===0.5?1.0:0.0);
                if(s.camMix>0 && !webcamEl.srcObject) navigator.mediaDevices.getUserMedia({video:{width:1280}}).then(st=>{webcamEl.srcObject=st; webcamEl.play();});
            },
            reset: () => { const s = getActiveState(); s.mode=1; s.style=0; s.dist=0; s.glitch=0; s.camMix=0; updateUI(); }
        };

        // --- MAPEO MIDI TOTAL (TODOS LOS CONTROLES) ---
        const midiMapDef = {
            'work_1':{l:'Mix 1', f:()=>actions.selectMix(1), g:'WORK'}, 'work_2':{l:'Mix 2', f:()=>actions.selectMix(2), g:'WORK'},
            'out_off':{l:'Blackout', f:()=>actions.setOut('OFF'), g:'OUT'}, 'out_1':{l:'Proj 1', f:()=>actions.setOut('1'), g:'OUT'}, 'out_2':{l:'Proj 2', f:()=>actions.setOut('2'), g:'OUT'},
            'load_a':{l:'Load A (Active)', f:()=>actions.loadClip(), g:'LOAD'}, 'load_b':{l:'Load B (Active)', f:()=>actions.loadClip(), g:'LOAD'},
            'crossfader':{l:'Fader', f:(v)=>actions.setFade(v), g:'MIX'},
            'speed':{l:'Knob Speed', f:(v)=>actions.setParam('speed',v*5), g:'FX'},
            'glitch':{l:'Knob Glitch', f:(v)=>actions.setParam('glitch',v*5), g:'FX'},
            'geo':{l:'Knob Geo', f:(v)=>actions.setParam('geo',v*10), g:'FX'},
            'rgb':{l:'Knob RGB', f:(v)=>actions.setParam('rgb',v*0.2), g:'FX'},
            'bloom':{l:'Knob Bloom', f:(v)=>actions.setParam('bloom',v*3), g:'FX'},
            'gain':{l:'Knob Gain', f:(v)=>actions.setParam('mic',v*20), g:'FX'},
            'ui_scale':{l:'UI Scale', f:(v)=>{document.documentElement.style.setProperty('--ui-scale', 0.6+v*0.8); resize();}, g:'SYS'},
            'reset':{l:'Reset', f:actions.reset, g:'SYS'},
            'cam':{l:'Cam Toggle', f:actions.toggleCam, g:'SYS'}
        };
        // Agregar Slots A-L
        "asdfghjkl".split('').forEach(k => midiMapDef['slot_'+k] = {l:'Clip '+k.toUpperCase(), f:actions.loadClip, g:'CLIPS'});

        let midiBinding = null;
        let midiConfig = {};

        function renderMidi() {
            const list = document.getElementById('midi-list'); list.innerHTML='';
            // Agrupar por grupo
            const groups = {};
            for(const [k,v] of Object.entries(midiMapDef)) {
                if(!groups[v.g]) groups[v.g] = [];
                groups[v.g].push([k,v]);
            }
            for(const [gn, items] of Object.entries(groups)) {
                const head = document.createElement('div'); head.className='midi-group'; head.innerText=gn; list.appendChild(head);
                items.forEach(([k,v]) => {
                    const row = document.createElement('div'); row.className='midi-item';
                    const has = midiConfig[k];
                    row.innerHTML = `<span style="color:#aaa;font-size:10px">${v.l}</span><button class="midi-btn ${midiBinding===k?'learning':''}">${has?(has.t+':'+has.v):'MAP'}</button>`;
                    row.querySelector('button').onclick=()=>{midiBinding=k; renderMidi();};
                    list.appendChild(row);
                });
            }
        }

        // --- INIT ---
        const canvasContainer = document.getElementById('vj-canvas');
        canvasContainer.appendChild(engine1.renderer.domElement);
        canvasContainer.appendChild(engine2.renderer.domElement);
        
        // Audio
        async function initAudio() {
            try {
                const ctx = new (window.AudioContext||window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                const ana = ctx.createAnalyser(); ana.fftSize=512;
                const src = ctx.createMediaStreamSource(stream); src.connect(ana);
                const data = new Uint8Array(ana.frequencyBinCount);
                const loop = () => {
                    requestAnimationFrame(loop); ana.getByteFrequencyData(data);
                    const vol = data.reduce((a,b)=>a+b,0)/data.length/255;
                    const bass = (data[1]+data[2]+data[3])/3/255;
                    const gain = getActiveState().mic;
                    audioData.vol = vol * gain; audioData.bass = bass * gain;
                }; loop();
            } catch(e) {}
        }

        function resize() {
            const w = window.innerWidth; const h = window.innerHeight - document.getElementById('ui-wrapper').offsetHeight;
            engine1.resize(w,h); engine2.resize(w,h);
            // Hide non-active canvas visually in viewport? No, they are rendered to textures or offscreen.
            // In this version, we render to offscreen and put result in monitor container canvas
            // CORRECTION: We need to append canvases to monitors
            const c1 = document.getElementById('canvas-1'); const ctx1 = c1.getContext('2d');
            const c2 = document.getElementById('canvas-2'); const ctx2 = c2.getContext('2d');
            c1.width = c1.clientWidth; c1.height = c1.clientHeight;
            c2.width = c2.clientWidth; c2.height = c2.clientHeight;
            engine1.resize(c1.width, c1.height); engine2.resize(c2.width, c2.height);
        }
        window.addEventListener('resize', resize);

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001;
            engine1.render(t, state.mix1, audioData);
            engine2.render(t, state.mix2, audioData);
            
            // Draw to monitor canvases
            const ctx1 = document.getElementById('canvas-1').getContext('2d');
            const ctx2 = document.getElementById('canvas-2').getContext('2d');
            ctx1.drawImage(engine1.renderer.domElement, 0, 0);
            ctx2.drawImage(engine2.renderer.domElement, 0, 0);
        }

        // BINDINGS
        document.getElementById('btn-start').onclick = async () => {
            await initAudio(); document.getElementById('boot').style.display='none';
            ['A','B'].forEach(d=>{
                engine1['vid'+d].src='assets/videos/iris.webm'; engine1['vid'+d].play();
                engine2['vid'+d].src='assets/videos/iris.webm'; engine2['vid'+d].play();
            });
            resize(); animate();
        };

        // Inputs
        document.getElementById('file-input').onchange = (e) => {
            if(!e.target.files[0]) return;
            const url = URL.createObjectURL(e.target.files[0]);
            const s = getActiveState();
            const eng = state.activeId===1 ? engine1 : engine2;
            const target = s.fader < 0.5 ? 'B' : 'A';
            eng['vid'+target].src = url; eng['vid'+target].play();
            document.getElementById('file-input').value = "";
        };

        // Keyboard
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if("asdfghjkl".includes(k)) actions.loadClip();
            if(!isNaN(parseInt(k))) actions.setMode(parseInt(k)===0?10:parseInt(k));
            const styles = {z:1,x:2,c:3,v:4,b:5}; if(styles[k]) actions.setStyle(styles[k]);
            const geos = {i:1,o:2,p:3}; if(geos[k]) actions.setGeo(geos[k]);
            if(k==='m') actions.reset();
            if(k==='n') actions.toggleCam();
            const cols = {q:0xff0000, w:0x00ff00, e:0x0000ff, r:0x00ffff, t:0xff00ff, y:0xffff00, u:0xffffff};
            if(cols[k]) actions.setColor(cols[k], k==='u'?'OFF':'ON');
        });

        // Sliders & Buttons
        const sl=(i,k)=>document.getElementById(i).oninput=(e)=>actions.setParam(k,e.target.value);
        sl('sl-speed','speed'); sl('sl-glitch','glitch'); sl('sl-geo','geo'); sl('sl-rgb','rgb'); sl('sl-mic','mic'); sl('sl-bloom','bloom');
        document.getElementById('btn-m1').onclick=()=>actions.selectMix(1);
        document.getElementById('btn-m2').onclick=()=>actions.selectMix(2);
        document.getElementById('out-off').onclick=()=>actions.setOut('OFF');
        document.getElementById('out-1').onclick=()=>actions.setOut('1');
        document.getElementById('out-2').onclick=()=>actions.setOut('2');
        document.getElementById('btn-midi').onclick=()=>{document.getElementById('midi-overlay').style.display='flex'; renderMidi();};
        document.getElementById('btn-close-midi').onclick=()=>document.getElementById('midi-overlay').style.display='none';
        document.getElementById('btn-proj').onclick=()=>{
            projWin = window.open("","","width=800,height=600");
            projWin.document.write(`<body style="margin:0;background:#000;overflow:hidden"><video id="v" autoplay style="width:100vw;height:100vh;object-fit:cover;opacity:0"></video></body>`);
        };
        window.addEventListener('wheel', (e)=>{
            const s = getActiveState();
            s.fader = Math.max(0, Math.min(1, s.fader + e.deltaY*0.001)); updateUI();
        });

        // MIDI Listener
        if(navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(m=>{
            for(let i of m.inputs.values()) i.onmidimessage=(msg)=>{
                const [c,n,v]=msg.data; const t=(c>=176&&c<=191)?'cc':(c>=144&&c<=159)?'note':null;
                if(!t || (t==='note'&&v===0)) return;
                if(learningKey) { midiConfig[learningKey]={t,v}; learningKey=null; renderMidi(); return; }
                for(const [k,cfg] of Object.entries(midiConfig)) if(cfg.t===t && cfg.v===n) midiMapDef[k].f(v/127);
            };
        });

    </script>
</body>
</html>
