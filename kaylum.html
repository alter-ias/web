<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAYLUM - Canto de la Tierra</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <style>
        /* Tu CSS se mantiene igual, no necesita cambios */
        :root {
            --background-color: #0F121B;
            --text-color: #FFFFFF;
            --secondary-text-color: #b3b3b3;
            --player-border-color: rgba(255, 255, 255, 0.4);
            --text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { color: var(--text-color); font-family: 'Montserrat', sans-serif; background-color: var(--background-color); overflow-x: hidden; }
        #background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.5); transition: opacity 0.5s ease-in-out; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; position: relative; z-index: 2; }
        .page-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        .main-header { padding: 30px 0; text-align: center; }
        .logo a { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-direction: column; }
        .logo img { height: 40px; width: auto; }
        .logo .logo-text { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; text-shadow: var(--text-shadow); color: var(--text-color); }
        .logo .subtitle { font-size: 0.9rem; color: var(--secondary-text-color); font-weight: 400; margin-top: 5px; letter-spacing: 0.5px; font-style: italic; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.4; }
        main { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px 0; }
        .music-app { width: 100%; max-width: 480px; }
        .category-tabs { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; }
        .category-tabs button { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 6px; }
        .category-tabs button:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        .category-tabs button.active, .category-tabs button.pending { background-color: rgba(255, 255, 255, 0.2); border-color: var(--text-color); color: var(--text-color); font-weight: 700; }
        .search-container { margin-bottom: 25px; }
        #search-input { width: 100%; padding: 12px 15px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--player-border-color); border-radius: 25px; color: var(--text-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; outline: none; transition: border-color 0.3s ease, background-color 0.3s ease; }
        #search-input:focus { border-color: var(--text-color); }
        .player-wrapper { padding: 30px; border: 2px solid var(--player-border-color); border-radius: 15px; text-align: center; background-color: rgba(15, 18, 27, 0.3); backdrop-filter: blur(8px); }
        .album-art-container { width: 100%; max-width: 250px; margin: 0 auto 25px; }
        #album-art { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        .track-info { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 8px; }
        .track-info h2 { font-size: 1.6rem; font-weight: 700; text-shadow: var(--text-shadow); }
        #add-to-favorites-btn { background: none; border: none; color: var(--secondary-text-color); font-size: 1.5rem; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; padding: 0; line-height: 1; }
        #add-to-favorites-btn:hover { color: var(--text-color); transform: scale(1.1); }
        #add-to-favorites-btn.is-favorite { color: var(--text-color); opacity: 1; }
        #song-artist { cursor: pointer; transition: color 0.3s ease; display: inline-block; padding: 5px 10px; border-radius: 15px; margin-top: -15px; font-size: 1rem; color: var(--secondary-text-color); margin-bottom: 25px; text-shadow: var(--text-shadow); }
        #song-artist:hover { color: var(--text-color); background-color: rgba(255,255,255,0.1); }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 25px; }
        .player-controls button { background: none; border: none; color: var(--secondary-text-color); font-size: 2rem; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; }
        .player-controls button#share-btn { font-size: 1.5rem; }
        .player-controls button:hover { color: var(--text-color); transform: scale(1.1); }
        .player-controls button.active { color: var(--text-color); }
        #audio-container { width: 100%; margin-top: -10px; margin-bottom: 20px; }
        #audio-player { width: 100%; }
        #song-info-toggle-btn { display: none; width: 100%; background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; }
        #song-info-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #song-information { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; padding: 0; border-top: none; text-align: center; font-size: 0.95rem; line-height: 1.6; color: var(--secondary-text-color); text-shadow: var(--text-shadow); white-space: pre-wrap; }
        #song-information.is-open { max-height: 250px; overflow-y: auto; padding: 20px 10px 20px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .playlist-view { margin-top: 20px; min-height: 295px; border-radius: 10px; padding-right: 5px; }
        .playlist-view ol { list-style: none; padding: 0; margin: 0; }
        .playlist-view li { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.3s ease; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .playlist-view li:hover { background-color: rgba(255,255,255,0.1); }
        .playlist-view li .track-details { flex-grow: 1; min-width: 0; }
        .playlist-view li .title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playlist-view li .artist { font-size: 0.85rem; color: var(--secondary-text-color); }
        .playlist-view li .icon { font-size: 1.2rem; color: transparent; }
        .playlist-view li.playing { background-color: rgba(255, 255, 255, 0.1); }
        .playlist-view li.queued { box-shadow: 0 0 8px var(--text-color); } /* Estilo para la canción en cola */
        .playlist-view li.playing .icon { color: var(--text-color); }
        .playlist-view li.playing .title { color: var(--text-color); font-weight: 700; }
        .playlist-favorite-btn { background: none; border: none; color: var(--secondary-text-color); font-size: 1.2rem; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; padding: 5px; margin-left: 10px; flex-shrink: 0; }
        .playlist-favorite-btn:hover { color: var(--text-color); transform: scale(1.1); }
        .playlist-favorite-btn.is-favorite { color: var(--text-color); }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 20px; padding-bottom: 10px; }
        .pagination-controls button { background: none; border: none; color: var(--text-color); font-weight: 500; font-size: 1rem; cursor: pointer; transition: opacity 0.3s ease; opacity: 0.6; padding: 5px; }
        .pagination-controls button:hover:not(:disabled) { opacity: 1; }
        .pagination-controls button.active { opacity: 1; font-weight: 700; cursor: default; }
        .pagination-controls button:disabled { opacity: 0.3; cursor: not-allowed; }
        .adventure-mode-container { text-align: center; padding: 30px 0 10px; }
        #adventure-mode-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        #adventure-mode-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #adventure-mode-btn.active, #adventure-mode-btn.pending { background-color: rgba(255, 255, 255, 0.2); border-color: var(--text-color); color: var(--text-color); font-weight: 700; }
        .personalization-section { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px; padding: 20px 0; margin-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .personalization-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; font-size: 0.85rem; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .personalization-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #color-picker { opacity: 0; width: 0; height: 0; position: absolute; }
        .project-description { padding: 40px 0; text-align: center; }
        .description-wrapper { max-width: 700px; margin: 0 auto; background-color: rgba(15, 18, 27, 0.3); backdrop-filter: blur(8px); border: 1px solid var(--player-border-color); border-radius: 15px; }
        #about-toggle-btn { background-color: transparent; border: 1px solid var(--player-border-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; font-weight: 500; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; width: 100%; font-size: 1.2rem; padding: 10px 20px; }
        #about-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--text-color); }
        #about-content { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; padding: 0 30px; text-align: center; }
        #about-content p { margin-bottom: 1.5em; text-align: center; }
        #about-content p:last-child { margin-bottom: 0; }
        #about-content.is-open { max-height: 2000px; padding: 30px 30px 30px; }
        .flux-diagram { width: 100%; max-width: 500px; border-radius: 10px; margin: 25px auto; border: 1px solid var(--player-border-color); display: block; }
    </style>
</head>
<body>
    <!-- Tu HTML Body se mantiene igual -->
    <div class="page-wrapper">
        <video autoplay muted loop playsinline id="background-video"></video>
        <header class="main-header container">
            <div class="logo-container">
                <div class="logo">
                    <a href="index.html"><img src="assets/img/logo03.png" alt="Kaylum Logo"><span class="logo-text">KAYLUM</span></a>
                    <p class="subtitle">Neologismo que fusiona la raíz maya K'ay (canto) y Lum (tierra), significando 'Canto de la Tierra'.</p>
                </div>
            </div>
        </header>
        <main class="container">
            <div class="music-app">
                <div class="category-tabs" id="category-tabs"></div>
                <div class="search-container">
                    <input type="search" id="search-input" placeholder="Buscar por artista o canción...">
                </div>
                <div class="player-wrapper" id="player-wrapper">
                    <div class="album-art-container">
                        <img src="assets/img/labplay/default-cover.jpg" alt="Carátula del Álbum" id="album-art">
                    </div>
                    <div class="track-info">
                        <h2 id="song-title">Selecciona una canción</h2>
                        <button id="add-to-favorites-btn" title="Añadir a Favoritos"><i class="bi bi-heart"></i></button>
                    </div>
                    <p id="song-artist">para comenzar</p>
                    <div class="player-controls">
                        <button id="shuffle-btn" title="Aleatorio"><i class="bi bi-shuffle"></i></button>
                        <button id="prev-btn" title="Anterior"><i class="bi bi-skip-start-fill"></i></button>
                        <button id="repeat-btn" title="Repetir"><i class="bi bi-repeat"></i></button>
                        <button id="next-btn" title="Siguiente"><i class="bi bi-skip-end-fill"></i></button>
                        <button id="share-btn" title="Compartir"><i class="bi bi-share-fill"></i></button>
                    </div>
                    <div id="audio-container">
                        <audio id="audio-player" controls></audio>
                    </div>
                    <button id="song-info-toggle-btn">SOBRE ESTA ROLA</button>
                    <div id="song-information"></div>
                </div>
                <div class="playlist-view" id="playlist-view"></div>
                <div class="pagination-controls" id="pagination-controls"></div>
                <div class="adventure-mode-container">
                    <button id="adventure-mode-btn">MÁQUINA DEL TIEMPO</button>
                </div>
    
                <div class="personalization-section">
                    <button id="change-skin-btn" class="personalization-btn">
                        <i class="bi bi-easel"></i> Cambiar Skin
                    </button>
                    <label for="color-picker" id="color-picker-label" class="personalization-btn">
                        <i class="bi bi-palette-fill"></i> Color de Texto
                    </label>
                    <input type="color" id="color-picker" value="#FFFFFF">
                </div>
            </div>
        </main>
        <section class="project-description container">
            <div class="description-wrapper">
                <button id="about-toggle-btn">Acerca de este proyecto</button>
                <div id="about-content">
                    <p>
                        Daniel Ek, CEO de Spotify, ha liderado una inversión millonaria en Helsing, startup alemana especializada en drones de combate con inteligencia artificial. Este acto alimenta una infraestructura de dominación que afecta de manera desproporcionada al Sur Global.
                    </p>
                    <p>
                        Como respuesta, desde el Laboratorio de Arte Generativo impulsamos <strong>KAYLUM</strong>: una plataforma que ofrece a nuestra comunidad una alternativa para escuchar y compartir su música favorita sin suscripciones. El proyecto está potenciado por agentes automatizados que catalogan el acervo, haciendo posible que se actualice con solo subir canciones a un servidor, demostrando el poder de la automatización para liberar trabajo y no para precarizarlo.
                    </p>
                    <img src="assets/img/labplay/alterplayflux.png" alt="Diagrama de flujo del proyecto Kaylum" class="flux-diagram">
                    <p>
                        Este proyecto, como cada una de nuestras iniciativas, busca demostrar que la tecnología no es inherentemente nociva. Es una herramienta poderosa que, usada de forma colectiva, nos permite construir proyectos potentes que fortalecen la autonomía y confrontan directamente los planes de la élite tecnofeudal.
                    </p>
                    <p>
                        Mientras ell@s dicen Guerra, nosotr@s decimos Paz. Por eso, la primera selección de este reproductor se basa en música que se ha posicionado contra la industria bélica. Somos conscientes de que un proyecto así desafía las nociones de propiedad intelectual, por lo que aclaramos que <strong>no existe fin de lucro alguno</strong>. Nuestra intención es el intercambio libre de la cultura.
                    </p>
                    <p>
                        Nuestra ambición trasciende el simple intercambio; soñamos con que este espacio evolucione hacia un refugio para l@s artistas independientes que rechazan mantener los privilegios de una élite que abusa de su trabajo. Invitamos a l@s artistas, músic@s, podcaster@s y experimentador@s sonoros a alojar sus creaciones en este espacio, construido por tod@s y para tod@s.
                    </p>
                </div>
            </div>
        </section>
        <footer class="page-footer container"></footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DEL DOM ---
    const songTitleEl = document.getElementById('song-title');
    const songArtistEl = document.getElementById('song-artist');
    const albumArtEl = document.getElementById('album-art');
    const audioPlayer = document.getElementById('audio-player');
    const categoryTabsContainer = document.getElementById('category-tabs');
    const playlistViewContainer = document.getElementById('playlist-view');
    const songInformationEl = document.getElementById('song-information');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const searchInput = document.getElementById('search-input');
    const paginationControlsContainer = document.getElementById('pagination-controls');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const aboutToggleBtn = document.getElementById('about-toggle-btn');
    const aboutContent = document.getElementById('about-content');
    const songInfoToggleBtn = document.getElementById('song-info-toggle-btn');
    const adventureModeBtn = document.getElementById('adventure-mode-btn');
    const backgroundVideo = document.getElementById('background-video');
    const changeSkinBtn = document.getElementById('change-skin-btn');
    const colorPicker = document.getElementById('color-picker');
    const repeatBtn = document.getElementById('repeat-btn');
    const shareBtn = document.getElementById('share-btn');
    const addToFavoritesBtn = document.getElementById('add-to-favorites-btn');

    // --- CONFIGURACIÓN Y ESTADO ---
    const cloudinaryBaseUrl = 'https://res.cloudinary.com/dy9cywux2/video/upload/';
    const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxbKnkTFmkECMfd_cRKchEv2XGOHII6YlLj0M0ragfExCtRWB2S0qTIZYrrFCTk3sxxctY2dnVgUif/pub?output=csv';
    const skinsPath = 'assets/img/labplay/skins/';
    const defaultCover = 'assets/img/labplay/default-cover.jpg';
    const songsPerPage = 5;
    
    let playlistsData = {};
    let currentCategory = '';
    let currentPlaylist = [];
    let allSongs = [];
    let currentSongIndex = -1;
    let fuse;
    let currentPage = 1;
    let isShuffleActive = false;
    let skins = [];
    let currentSkinIndex = 0;
    let isRepeatActive = false;
    let userFavorites = [];
    let pendingPlaylistChange = null; // **CORRECCIÓN**: Esta variable es la clave. Almacenará la acción pendiente.
    
    // --- FUNCIONES AUXILIARES Y DE INICIALIZACIÓN ---
    const shuffleArray = (array) => { let newArr = [...array]; for (let i = newArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[newArr[i], newArr[j]] = [newArr[j], newArr[i]];} return newArr;};
    const parseCsvRow = (row) => { const c = []; let d = ''; let e = !1; for (let f = 0; f < row.length; f++) { const g = row[f]; if ('"' === g) e && '"' === row[f + 1] ? (d += '"', f++) : e = !e; else if (',' === g && !e) c.push(d.trim()), d = ''; else d += g } c.push(d.trim()); return c.map(h => h.startsWith('"') && h.endsWith('"') ? h.slice(1, -1) : h) };
    
    function loadUserSettings() { /* ...código sin cambios... */ }
    async function loadSkins() { /* ...código sin cambios... */ }
    
    // --- LÓGICA DEL REPRODUCTOR ---

    /**
     * **CORRECCIÓN**: Esta función ahora es el "despachador" central.
     * Se ejecuta al terminar una canción y decide qué hacer a continuación:
     * 1. Si hay un cambio de lista pendiente, lo aplica.
     * 2. Si el modo repetición está activo, reinicia la canción.
     * 3. Si no, reproduce la siguiente canción de la lista actual.
     */
    function handleSongEnd() {
        // Limpiar cualquier feedback visual de una acción pendiente
        clearPendingVisuals();

        if (pendingPlaylistChange) {
            const change = pendingPlaylistChange;
            pendingPlaylistChange = null; 
            
            // Aplicar el cambio que estaba en cola
            switch(change.type) {
                case 'category':
                    applyCategoryChange(change.value, true);
                    break;
                case 'adventure':
                    applyAdventureMode(true);
                    break;
                case 'song':
                    applySongChange(change.publicId);
                    break;
            }
            return; // Detenemos la ejecución para no llamar a playNextSong()
        }
        
        if (isRepeatActive) {
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        } else {
            playNextSong();
        }
    }

    function playNextSong() {
        if (currentPlaylist.length === 0) return;
        currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
        loadSong(currentSongIndex);
    }

    function playPrevSong() {
        if (currentPlaylist.length === 0) return;
        currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
        loadSong(currentSongIndex);
    }
    
    function toggleShuffle() { /* ...código sin cambios... */ }
    function toggleRepeat() { /* ...código sin cambios... */ }

    function loadSong(playlistIndex, fromUrl = false) {
        if (playlistIndex < 0 || playlistIndex >= currentPlaylist.length) return;
        currentSongIndex = playlistIndex;
        const song = currentPlaylist[playlistIndex];

        songTitleEl.textContent = song.title;
        songArtistEl.textContent = song.artist;
        albumArtEl.src = (song.cover && song.cover.trim() !== '') ? song.cover : defaultCover;
        songInformationEl.classList.remove('is-open');
        songInformationEl.textContent = song.information || '';
        songInfoToggleBtn.style.display = song.information ? 'block' : 'none';
        
        updatePlaylistHighlight();
        updateFavoriteButton();
        
        audioPlayer.src = song.publicUrl;
        audioPlayer.play().catch(e => console.warn("Autoplay bloqueado.", e));
        
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: song.title, artist: song.artist, album: `KAYLUM: ${song.category}`,
                artwork: [{ src: albumArtEl.src, sizes: '250x250', type: 'image/jpeg' }]
            });
        }
        
        if (fromUrl) {
            const newUrl = `${window.location.origin}${window.location.pathname}`;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
    }
    
    // --- **CORRECCIÓN**: LÓGICA DE GESTIÓN DE LA COLA DE REPRODUCCIÓN ---

    const isPlaying = () => audioPlayer.currentTime > 0 && !audioPlayer.paused;

    // Elimina los estilos "pending" o "queued" de la UI
    function clearPendingVisuals() {
        document.querySelectorAll('.pending').forEach(el => el.classList.remove('pending'));
        document.querySelectorAll('.queued').forEach(el => el.classList.remove('queued'));
    }

    /**
     * **CORRECCIÓN**: Esta función no cambia la categoría inmediatamente.
     * En su lugar, pone la petición en cola si hay una canción en curso.
     */
    function requestCategoryChange(category) {
        clearPendingVisuals();
        // Feedback visual inmediato para el usuario
        document.querySelectorAll('.category-tabs button').forEach(btn => btn.classList.remove('active', 'pending'));
        const targetBtn = document.querySelector(`.category-tabs button[data-category="${category}"]`);
        if (targetBtn) targetBtn.classList.add(isPlaying() ? 'pending' : 'active');
        adventureModeBtn.classList.remove('active', 'pending');

        if (isPlaying()) {
            pendingPlaylistChange = { type: 'category', value: category };
        } else {
            applyCategoryChange(category, true);
        }
    }

    function requestAdventureMode() {
        clearPendingVisuals();
        document.querySelectorAll('.category-tabs button').forEach(btn => btn.classList.remove('active', 'pending'));
        adventureModeBtn.classList.add(isPlaying() ? 'pending' : 'active');

        if (isPlaying()) {
            pendingPlaylistChange = { type: 'adventure' };
        } else {
            applyAdventureMode(true);
        }
    }
    
    function requestSongChange(songId, listItemElement) {
        clearPendingVisuals();
        if (listItemElement) listItemElement.classList.add('queued');
        
        if (isPlaying()) {
             pendingPlaylistChange = { type: 'song', publicId: songId };
        } else {
             applySongChange(songId);
        }
    }
    
    // --- **CORRECCIÓN**: Funciones que aplican los cambios ---

    function applyCategoryChange(category, startPlayback = true) {
        currentCategory = category;
        if (category === 'Favoritos') {
            currentPlaylist = allSongs.filter(song => userFavorites.includes(song.publicId));
        } else {
            const categorySongs = playlistsData[category] || [];
            currentPlaylist = isShuffleActive ? shuffleArray(categorySongs) : [...categorySongs];
        }
        
        currentPage = 1;
        updatePaginatedView();
        renderCategoryTabs(); // Actualiza el estado visual de los botones de categoría
        adventureModeBtn.classList.remove('active', 'pending');

        if (startPlayback && currentPlaylist.length > 0) {
            loadSong(0); 
        } else if (startPlayback) {
            songTitleEl.textContent = "Sin canciones";
            songArtistEl.textContent = "Categoría vacía";
            audioPlayer.src = "";
            albumArtEl.src = defaultCover;
            updatePlaylistHighlight();
            updateFavoriteButton();
        }
    }
    
    function applyAdventureMode(startPlayback = true) {
        const adventureCategoryName = 'Aventura Musical';
        if (!playlistsData[adventureCategoryName]) {
            playlistsData[adventureCategoryName] = [];
        }
        playlistsData[adventureCategoryName] = shuffleArray(allSongs);
        applyCategoryChange(adventureCategoryName, startPlayback);
    }

    function applySongChange(songId) {
        const songToPlay = allSongs.find(s => s.publicId === songId);
        if (!songToPlay) return;
        
        // Cambia a la categoría de la canción sin iniciar la reproducción aún
        applyCategoryChange(songToPlay.category, false);

        // Encuentra la canción en la nueva lista y la reproduce
        const newIndex = currentPlaylist.findIndex(s => s.publicId === songToPlay.publicId);
        if(newIndex > -1) {
            loadSong(newIndex);
        }
    }

    // --- LÓGICA DE LA INTERFAZ (UI) ---
    function renderCategoryTabs() { /* ...código sin cambios... */ }
    function toggleFavoriteStatus(songId) { /* ...código sin cambios... */ }
    function updateFavoriteButton() { /* ...código sin cambios... */ }
    function shareSong() { /* ...código sin cambios... */ }
    function updatePaginatedView() { /* ...código sin cambios... */ }
    function renderPlaylistView(playlistToRender) { /* ...código sin cambios... */ }
    function renderPaginationControls(totalItems) { /* ...código sin cambios... */ }
    function updatePlaylistHighlight() {
        document.querySelectorAll('.playlist-view li').forEach(li => {
            li.classList.remove('playing');
        });
        if (currentSongIndex < 0 || !currentPlaylist[currentSongIndex]) return;
        const currentSong = currentPlaylist[currentSongIndex];
        const currentLi = document.querySelector(`.playlist-view li[data-public-id="${currentSong.publicId}"]`);
        if (currentLi) {
            currentLi.classList.add('playing');
        }
    }

    // --- FUNCIÓN DE INICIALIZACIÓN PRINCIPAL ---

    async function init() {
        loadUserSettings();
        await loadSkins();

        try {
            const response = await fetch(`${googleSheetCsvUrl}&_=${new Date().getTime()}`);
            const csvText = await response.text();
            const rows = csvText.trim().replace(/\r/g, '').split('\n').slice(1);
            
            rows.forEach(row => {
                const [title, artist, category, publicId, cover, information] = parseCsvRow(row);
                if (!category || !publicId || !title) return;
                const songObject = { title, artist, category, publicId, cover, information, publicUrl: `${cloudinaryBaseUrl}${publicId}` };
                if (!playlistsData[category]) playlistsData[category] = [];
                playlistsData[category].push(songObject);
                allSongs.push(songObject);
            });
            
            fuse = new Fuse(allSongs, { keys: ['title', 'artist'], threshold: 0.4 });
            
            if (allSongs.length > 0) {
                const urlParams = new URLSearchParams(window.location.search);
                const songIdFromUrl = urlParams.get('song');
                let initialCategory = Object.keys(playlistsData).find(cat => cat !== 'Favoritos') || Object.keys(playlistsData)[0];
                
                if (songIdFromUrl) {
                    const songToPlay = allSongs.find(s => s.publicId === songIdFromUrl);
                    if (songToPlay) {
                        applyCategoryChange(songToPlay.category, false); // Carga la categoría
                        const indexToPlay = currentPlaylist.findIndex(s => s.publicId === songIdFromUrl);
                        if (indexToPlay !== -1) loadSong(indexToPlay, true); // Reproduce la canción
                    } else {
                        applyCategoryChange(initialCategory, false);
                    }
                } else {
                    applyCategoryChange(initialCategory, false); // No reproducir al cargar la página
                    updatePaginatedView();
                }
            } else {
                 songTitleEl.textContent = "Sin datos";
                 songArtistEl.textContent = "La base de datos está vacía.";
            }

            // --- LISTENERS (SECCIÓN CORREGIDA) ---
            audioPlayer.addEventListener('ended', handleSongEnd);
            categoryTabsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.category) requestCategoryChange(btn.dataset.category);
            });
            adventureModeBtn.addEventListener('click', requestAdventureMode);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            prevBtn.addEventListener('click', playPrevSong);
            nextBtn.addEventListener('click', playNextSong);
            shareBtn.addEventListener('click', shareSong);
            addToFavoritesBtn.addEventListener('click', () => { if(currentSongIndex > -1 && currentPlaylist[currentSongIndex]) toggleFavoriteStatus(currentPlaylist[currentSongIndex].publicId); });
            searchInput.addEventListener('input', () => { currentPage = 1; updatePaginatedView(); });

            /**
             * **CORRECCIÓN**: El listener de la lista ahora decide si reproducir,
             * cambiar inmediatamente o poner en cola la canción.
             */
            playlistViewContainer.addEventListener('click', (e) => {
                const favoriteBtn = e.target.closest('.playlist-favorite-btn');
                const listItem = e.target.closest('li');

                if (favoriteBtn) {
                    toggleFavoriteStatus(favoriteBtn.dataset.publicId);
                    return; // Detenemos para no disparar el click de la canción
                } 
                
                if (listItem) {
                    const clickedSongId = listItem.dataset.publicId;
                    const clickedSong = allSongs.find(s => s.publicId === clickedSongId);
                    if (!clickedSong) return;

                    const songIsInCurrentPlaylist = currentPlaylist.some(s => s.publicId === clickedSongId);

                    if (songIsInCurrentPlaylist) {
                        // Si la canción está en la lista actual, la reproducimos inmediatamente.
                        const localIndex = currentPlaylist.findIndex(s => s.publicId === clickedSongId);
                        if (localIndex !== -1) loadSong(localIndex);
                    } else {
                        // Si la canción NO está en la lista, la solicitamos (se pondrá en cola si es necesario)
                        requestSongChange(clickedSongId, listItem);
                    }
                }
            });

            paginationControlsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button || button.disabled) return;
                let playlistToPaginate = currentPlaylist;
                if (searchInput.value.trim()){
                    const searchResults = fuse.search(searchInput.value.trim());
                    const searchResultIds = new Set(searchResults.map(result => result.item.publicId));
                    playlistToPaginate = currentPlaylist.filter(song => searchResultIds.has(song.publicId));
                }
                const totalPages = Math.ceil(playlistToPaginate.length / songsPerPage);
                const pageAction = button.dataset.page;
                if (pageAction === 'prev' && currentPage > 1) currentPage--;
                else if (pageAction === 'next' && currentPage < totalPages) currentPage++;
                else if (!isNaN(pageAction)) currentPage = parseInt(pageAction);
                updatePaginatedView();
            });

            // ... resto de listeners sin cambios
            aboutToggleBtn.addEventListener('click', () => aboutContent.classList.toggle('is-open'));
            songInfoToggleBtn.addEventListener('click', () => songInformationEl.classList.toggle('is-open'));
            changeSkinBtn.addEventListener('click', () => { /* ...código sin cambios... */ });
            colorPicker.addEventListener('input', (e) => { document.documentElement.style.setProperty('--text-color', e.target.value); localStorage.setItem('kaylum_textColor', e.target.value); });
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => audioPlayer.play());
                navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause());
                navigator.mediaSession.setActionHandler('previoustrack', playPrevSong);
                navigator.mediaSession.setActionHandler('nexttrack', playNextSong);
            }
        } catch (error) {
            console.error("Error al inicializar:", error);
            songTitleEl.textContent = "Error al cargar";
            songArtistEl.textContent = "No se pudo conectar a la base de datos.";
        }
    }
    
    // Funciones auxiliares completas que se omitieron arriba por brevedad.
    function loadUserSettings() {
        const savedColor = localStorage.getItem('kaylum_textColor');
        if (savedColor) { document.documentElement.style.setProperty('--text-color', savedColor); colorPicker.value = savedColor; }
        const savedSkinIndex = localStorage.getItem('kaylum_skinIndex');
        if (savedSkinIndex !== null) { currentSkinIndex = parseInt(savedSkinIndex, 10); }
        const savedFavorites = localStorage.getItem('kaylum_favorites');
        if (savedFavorites) { userFavorites = JSON.parse(savedFavorites); }
        if (userFavorites.length > 0) { playlistsData['Favoritos'] = []; }
    }
    async function loadSkins() {
        try {
            const response = await fetch(`${skinsPath}skins.json?_=${new Date().getTime()}`);
            if (!response.ok) throw new Error('No se encontró skins.json');
            const skinFiles = await response.json();
            skins = skinFiles.map(file => `${skinsPath}${file}`);
            if (skins.length > 0) {
                if (isNaN(currentSkinIndex) || currentSkinIndex < 0 || currentSkinIndex >= skins.length) currentSkinIndex = 0;
                const initialSkin = skins[currentSkinIndex];
                const extension = initialSkin.split('.').pop().toLowerCase();
                if (['webm', 'mp4'].includes(extension)) {
                    const source = document.createElement('source');
                    source.src = initialSkin;
                    source.type = `video/${extension}`;
                    backgroundVideo.innerHTML = '';
                    backgroundVideo.appendChild(source);
                    backgroundVideo.style.backgroundImage = 'none';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
                    backgroundVideo.style.backgroundImage = `url('${initialSkin}')`;
                    backgroundVideo.innerHTML = '';
                }
                backgroundVideo.load();
                backgroundVideo.play().catch(e => {});
            }
        } catch (error) {
            console.warn("No se pudo cargar la lista de skins:", error.message);
            const source = document.createElement('source');
            source.src = "assets/img/labplay/skins/skin03.webm";
            source.type = "video/webm";
            backgroundVideo.innerHTML = '';
            backgroundVideo.appendChild(source);
            backgroundVideo.load();
        }
    }
    function toggleShuffle() {
        isShuffleActive = !isShuffleActive;
        shuffleBtn.classList.toggle('active', isShuffleActive);
        
        const currentlyPlayingSong = currentPlaylist[currentSongIndex];
        let basePlaylist;
        if (currentCategory === 'Favoritos') {
            basePlaylist = allSongs.filter(song => userFavorites.includes(song.publicId));
        } else if (currentCategory === 'Aventura Musical') {
             basePlaylist = allSongs; // Aventura siempre usa todas las canciones
        } else {
            basePlaylist = playlistsData[currentCategory] || [];
        }
        
        currentPlaylist = isShuffleActive ? shuffleArray(basePlaylist) : [...basePlaylist];
        
        if (currentlyPlayingSong) {
            const newIndex = currentPlaylist.findIndex(s => s.publicId === currentlyPlayingSong.publicId);
            currentSongIndex = newIndex > -1 ? newIndex : (currentPlaylist.length > 0 ? 0 : -1);
        } else {
            currentSongIndex = -1;
        }
        updatePaginatedView();
    }
    function toggleRepeat() {
        isRepeatActive = !isRepeatActive;
        repeatBtn.classList.toggle('active', isRepeatActive);
    }
    function renderCategoryTabs() {
        const categories = Object.keys(playlistsData);
        if (!categories.includes('Aventura Musical') && allSongs.length > 0) {
            // Asegurarse de que 'Aventura Musical' no se muestre como una pestaña normal
        }
        categoryTabsContainer.innerHTML = Object.keys(playlistsData).filter(c => c !== 'Aventura Musical').map(c => 
            `<button data-category="${c}" class="${c === currentCategory ? 'active' : ''}">
                ${c === 'Favoritos' ? '<i class="bi bi-star"></i>' : ''} ${c}
             </button>`
        ).join('');
    }
    function toggleFavoriteStatus(songId) {
        if (!songId) return;
        const favoriteIndex = userFavorites.indexOf(songId);
        const hadFavoritesCategory = !!playlistsData['Favoritos'];
        if (favoriteIndex > -1) {
            userFavorites.splice(favoriteIndex, 1);
        } else {
            userFavorites.push(songId);
        }
        localStorage.setItem('kaylum_favorites', JSON.stringify(userFavorites));
        
        const hasFavoritesNow = userFavorites.length > 0;
        if (hasFavoritesNow && !hadFavoritesCategory) {
            playlistsData['Favoritos'] = [];
        } else if (!hasFavoritesNow && hadFavoritesCategory) {
            delete playlistsData['Favoritos'];
            if (currentCategory === 'Favoritos') {
                const firstCategory = Object.keys(playlistsData).find(cat => cat !== 'Favoritos' && cat !== 'Aventura Musical') || Object.keys(playlistsData)[0];
                if (firstCategory) requestCategoryChange(firstCategory);
            }
        }
        
        if(currentCategory === 'Favoritos') {
           applyCategoryChange('Favoritos', false);
        } else {
           updatePaginatedView();
        }
        updateFavoriteButton();
        renderCategoryTabs();
    }
    function updateFavoriteButton() {
        if (currentSongIndex < 0 || !currentPlaylist[currentSongIndex]) {
            addToFavoritesBtn.innerHTML = '<i class="bi bi-heart"></i>';
            addToFavoritesBtn.classList.remove('is-favorite');
            return;
        }
        const songId = currentPlaylist[currentSongIndex].publicId;
        const isFavorite = userFavorites.includes(songId);
        addToFavoritesBtn.innerHTML = isFavorite ? '<i class="bi bi-heart-fill"></i>' : '<i class="bi bi-heart"></i>';
        addToFavoritesBtn.classList.toggle('is-favorite', isFavorite);
    }
    function shareSong() {
        if (currentSongIndex < 0 || !currentPlaylist[currentSongIndex]) { alert("Selecciona una canción para compartir."); return; }
        const songId = currentPlaylist[currentSongIndex].publicId;
        const shareUrl = `${window.location.origin}${window.location.pathname}?song=${songId}`;
        navigator.clipboard.writeText(shareUrl).then(() => {
            const originalHTML = shareBtn.innerHTML;
            shareBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
            setTimeout(() => { shareBtn.innerHTML = originalHTML; }, 2000);
        }).catch(err => {
            console.error('Error al copiar el enlace: ', err);
            alert("No se pudo copiar el enlace.");
        });
    }
    function updatePaginatedView() {
        let playlistToDisplay = currentPlaylist;
        if (searchInput.value.trim()){
            const searchResults = fuse.search(searchInput.value.trim());
            const searchResultIds = new Set(searchResults.map(result => result.item.publicId));
            playlistToDisplay = currentPlaylist.filter(song => searchResultIds.has(song.publicId));
        }
        const startIndex = (currentPage - 1) * songsPerPage;
        const paginatedSongs = playlistToDisplay.slice(startIndex, startIndex + songsPerPage);
        renderPlaylistView(paginatedSongs);
        renderPaginationControls(playlistToDisplay.length);
    }
    function renderPlaylistView(playlistToRender) {
        if (!playlistToRender || playlistToRender.length === 0) {
            playlistViewContainer.innerHTML = `<p style="text-align:center; padding: 20px 0; color:var(--secondary-text-color);">${searchInput.value.trim() ? 'No se encontraron resultados.' : 'No hay canciones en esta categoría.'}</p>`;
            return;
        }
        const listHTML = `<ol>${playlistToRender.map((song) => {
            const isFavorite = userFavorites.includes(song.publicId);
            const heartIconClass = isFavorite ? 'bi-heart-fill' : 'bi-heart';
            return `
                <li data-public-id="${song.publicId}">
                    <i class="bi bi-music-note-beamed icon"></i>
                    <div class="track-details">
                        <div class="title">${song.title}</div>
                        <div class="artist">${song.artist}</div>
                    </div>
                    <button class="playlist-favorite-btn ${isFavorite ? 'is-favorite' : ''}" data-public-id="${song.publicId}" title="Añadir/Quitar de Favoritos">
                        <i class="bi ${heartIconClass}"></i>
                    </button>
                </li>`;
        }).join('')}</ol>`;
        playlistViewContainer.innerHTML = listHTML;
        updatePlaylistHighlight();
    }
    function renderPaginationControls(totalItems) {
        const totalPages = Math.ceil(totalItems / songsPerPage);
        paginationControlsContainer.style.display = totalPages > 1 ? 'flex' : 'none';
        if (totalPages <= 1) { paginationControlsContainer.innerHTML = ''; return; }
        let buttonsHTML = `<button data-page="prev" ${currentPage === 1 ? 'disabled' : ''}><</button>`;
        let startPage, endPage;
        if (totalPages <= 5) { startPage = 1; endPage = totalPages; }
        else {
            if (currentPage <= 3) { startPage = 1; endPage = 5; }
            else if (currentPage >= totalPages - 2) { startPage = totalPages - 4; endPage = totalPages; }
            else { startPage = currentPage - 2; endPage = currentPage + 2; }
        }
        for (let i = startPage; i <= endPage; i++) {
            buttonsHTML += `<button data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        buttonsHTML += `<button data-page="next" ${currentPage === totalPages ? 'disabled' : ''}>></button>`;
        paginationControlsContainer.innerHTML = buttonsHTML;
    }
    changeSkinBtn.addEventListener('click', () => {
        if(skins.length === 0) return;
        currentSkinIndex = (currentSkinIndex + 1) % skins.length;
        localStorage.setItem('kaylum_skinIndex', currentSkinIndex);
        const newSkinSrc = skins[currentSkinIndex];
        const extension = newSkinSrc.split('.').pop().toLowerCase();
        backgroundVideo.style.opacity = 0;
        setTimeout(() => {
            if (['webm', 'mp4'].includes(extension)) {
                backgroundVideo.style.backgroundImage = 'none';
                const source = document.createElement('source');
                source.src = newSkinSrc;
                source.type = `video/${extension}`;
                backgroundVideo.innerHTML = '';
                backgroundVideo.appendChild(source);
                backgroundVideo.load();
                backgroundVideo.play().catch(e => {});
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
                backgroundVideo.innerHTML = '';
                backgroundVideo.style.backgroundImage = `url('${newSkinSrc}')`;
            }
            backgroundVideo.style.opacity = 1;
        }, 500);
    });

    init();
});
</script>
</body>
</html>
