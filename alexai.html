<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEX | SYSTEM ONLINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Montserrat:wght@400;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-color: #1a1a1a; 
            --text-main: #E8E4D9;
            --text-sub: #888888;
            --accent: #FF6600; 
        }

        [data-theme="ultra"] {
            --bg-color: #900a00; 
            --text-main: #000000;
            --text-sub: #2a0000;
            --accent: #FFFFFF; 
        }

        body {
            margin: 0; background: var(--bg-color); color: var(--text-main);
            font-family: 'Montserrat', sans-serif; overflow: hidden;
            transition: background 0.5s ease;
        }

        /* --- BOTONES Y UI --- */
        .controls-container {
            position: fixed; top: 30px; right: 10%; z-index: 100;
            display: flex; gap: 10px;
        }

        #mic-toggle {
            background: rgba(0,0,0,0.5); border: 2px solid var(--accent); color: var(--accent);
            padding: 15px 30px; font-family: 'Rajdhani'; font-weight: 700; font-size: 14px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s; min-width: 160px;
        }
        #mic-toggle:hover { background: var(--accent); color: var(--bg-color); }
        #mic-toggle.listening { 
            background: var(--accent); color: var(--bg-color); 
            box-shadow: 0 0 20px var(--accent); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #theme-toggle {
            position: fixed; top: 30px; left: 10%; z-index: 100;
            background: transparent; border: 1px solid var(--text-sub); color: var(--text-sub);
            padding: 5px 10px; font-family: 'Rajdhani'; font-size: 10px; cursor: pointer;
        }

        #ai-status {
            position: fixed; bottom: 100px; width: 100%; text-align: center;
            z-index: 100; pointer-events: none;
        }
        #ai-text {
            font-family: 'Rajdhani'; font-weight: 600; font-size: 20px; 
            color: var(--text-main); text-shadow: 0 0 10px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 4px;
        }

        /* --- 3D CANVAS --- */
        #canvas-container {
            position: fixed; top: 0; right: 0; width: 65%; height: 100vh; z-index: 10;
            mask-image: linear-gradient(to right, transparent 0%, black 20%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%);
        }

        /* --- CONTENIDO LATERAL --- */
        #content-sidebar {
            position: relative; width: 45%; height: 100vh; overflow-y: auto; z-index: 20;
            scrollbar-width: none;
        }
        section {
            min-height: 80vh; display: flex; flex-direction: column; justify-content: center;
            padding: 0 10% 0 15%;
        }
        h1 { font-size: 80px; margin: 0; line-height: 0.85; letter-spacing: -3px; text-transform: uppercase; }
        h2 { font-family: 'Rajdhani'; font-size: 14px; letter-spacing: 6px; color: var(--accent); }
        p { font-family: 'Rajdhani'; font-size: 18px; color: var(--text-sub); margin-top: 20px; max-width: 400px; }

        @media (max-width: 768px) {
            #canvas-container { width: 100%; height: 50vh; mask-image: none; border-bottom: 1px solid #333;}
            #content-sidebar { width: 100%; height: 50vh; top: 50vh; background: var(--bg-color); }
            section { min-height: 50vh; padding: 20px; }
            h1 { font-size: 40px; }
        }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://cdn.skypack.dev/three@0.136.0", "three/addons/": "https://cdn.skypack.dev/three@0.136.0/examples/jsm/" } }
    </script>
</head>
<body data-theme="ludovico">

    <button id="theme-toggle">CAMBIAR TEMA</button>
    <div class="controls-container">
        <button id="mic-toggle">● HABLAR</button>
    </div>
    
    <div id="canvas-container"></div>
    <div id="ai-status"><span id="ai-text">Sistema preparado</span></div>

    <div id="content-sidebar">
        <section>
            <h2>ASISTENTE REAL</h2>
            <h1>ALEX</h1>
            <h1>LIVE</h1>
            <p>Conectado a Google Gemini (1.5 Flash) y ElevenLabs. Pulsa 'HABLAR' y pide lo que quieras.</p>
        </section>
        <div style="height: 20vh;"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        /* ======================================================== */
        /* === 1. TUS LLAVES DE ACCESO (YA INTEGRADAS) === */
        /* ======================================================== */
        
        // Usamos .trim() para limpiar espacios invisibles que causan errores
        const ELEVEN_API_KEY = "sk_59fc0224b40d892bf32845d0542ca89f89119ea789fcec0c".trim(); 
        const GEMINI_API_KEY = "AIzaSyDHT_af99TNDXIt-yq1iNIft_DIXO87ViI".trim();
        
        const VOICE_ID = "pNInz6obpgDQGcFmaJgB"; // Voz: Adam

        // --- VALIDACIÓN EN CONSOLA ---
        console.log("Comprobando llaves...");
        if(ELEVEN_API_KEY.startsWith("sk_")) console.log("✅ ElevenLabs Key parece correcta.");
        else console.warn("❌ ElevenLabs Key tiene formato extraño.");
        
        if(GEMINI_API_KEY.startsWith("AIza")) console.log("✅ Google Key parece correcta.");
        else console.warn("❌ Google Key tiene formato extraño.");


        /* ======================================================== */
        /* === 2. ESCENA 3D (LIGERA) === */
        /* ======================================================== */
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth * 0.65, window.innerHeight);
        if(window.innerWidth < 768) renderer.setSize(window.innerWidth, window.innerHeight * 0.5);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);
        
        const scene = new THREE.Scene(); 
        const camera = new THREE.PerspectiveCamera(35, container.clientWidth/container.clientHeight, 0.1, 100);
        camera.position.set(-0.5, 3.5, 18.0);
        
        const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
        
        // Materiales
        const matArmor = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
        const matCore = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, emissive: 0xFF4400, emissiveIntensity: 2, wireframe: true });
        
        // Luces
        scene.add(new THREE.AmbientLight(0xffffff, 0.3));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1); dirLight.position.set(5,5,8); scene.add(dirLight);

        // Robot
        const robotGroup = new THREE.Group(); scene.add(robotGroup);
        const head = new THREE.Mesh(new THREE.SphereGeometry(1.7, 32, 32), matArmor); head.position.y = 0.5; robotGroup.add(head);
        const core = new THREE.Mesh(new THREE.IcosahedronGeometry(0.6, 0), matCore); core.position.y = 3.0; robotGroup.add(core);

        // Render Loop
        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.5, 0.4));

        function animate() {
            requestAnimationFrame(animate); controls.update();
            const time = Date.now() * 0.001;
            robotGroup.position.y = (Math.sin(time) * 0.1) + 1.0;
            core.rotation.y += 0.02;
            
            if(isSpeaking) matCore.emissiveIntensity = 3 + Math.random()*3;
            else if(isThinking) matCore.emissiveIntensity = 2 + Math.sin(time*10)*2;
            else matCore.emissiveIntensity = 2;
            
            composer.render();
        }
        animate();
        window.onresize = () => { 
            const w = window.innerWidth < 768 ? window.innerWidth : window.innerWidth * 0.65;
            const h = window.innerWidth < 768 ? window.innerHeight * 0.5 : window.innerHeight;
            renderer.setSize(w, h); composer.setSize(w, h);
            camera.aspect = w/h; camera.updateProjectionMatrix(); 
        };


        /* ======================================================== */
        /* === 3. LÓGICA DE IA (GEMINI 1.5 FLASH + WEB SEARCH) === */
        /* ======================================================== */

        const btn = document.getElementById('mic-toggle');
        const status = document.getElementById('ai-text');
        
        let isListening = false;
        let isThinking = false;
        let isSpeaking = false;
        let chatHistory = [];
        let recognition;

        // --- RECONOCIMIENTO DE VOZ ---
        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.lang = 'es-MX';
            recognition.continuous = false; // Parar al detectar silencio
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true; btn.classList.add('listening'); btn.innerText = "ESCUCHANDO..."; status.innerText = "Te escucho...";
            };
            recognition.onend = () => {
                isListening = false; btn.classList.remove('listening'); btn.innerText = "● HABLAR";
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                status.innerText = `"${transcript}"`;
                processGemini(transcript);
            };
        } else {
            alert("Navegador no soporta micrófono. Usa Chrome.");
        }

        btn.addEventListener('click', () => {
            if(isSpeaking) { window.currentAudio.pause(); isSpeaking = false; return; }
            if(isListening) recognition.stop();
            else recognition.start();
        });

        // --- CEREBRO GOOGLE GEMINI ---
        async function processGemini(text) {
            isThinking = true;
            status.innerText = "Alex está pensando...";

            chatHistory.push({ role: "user", parts: [{ text: text }] });
            // Mantener historial corto para ahorrar tokens
            if(chatHistory.length > 8) chatHistory = chatHistory.slice(-8);

            const systemPrompt = `Eres Alex (de La Naranja Mecánica). 
            Personalidad: Intelectual, cínico, violento, usa jerga Nadsat (drog, videar, gulever).
            REGLAS:
            1. Eres un líder, no un asistente.
            2. Sé conciso (máx 40 palabras).
            3. Si te preguntan algo actual (noticias, clima, hora), usa tu capacidad de búsqueda.
            4. Responde siempre en Español.`;

            // URL PARA GEMINI 1.5 FLASH (Soporta Búsqueda)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [
                    { role: "user", parts: [{ text: systemPrompt }] },
                    ...chatHistory
                ],
                // HERRAMIENTA DE BÚSQUEDA GOOGLE
                tools: [
                    { google_search_retrieval: { dynamic_retrieval_config: { mode: "MODE_DYNAMIC", dynamic_threshold: 0.7 } } }
                ]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(!response.ok) {
                    const errTxt = await response.text();
                    console.error("Error Google:", errTxt);
                    throw new Error("Error API Google: " + response.status);
                }

                const data = await response.json();
                let aiReply = "";

                // Extraer respuesta (puede variar si usó búsqueda o no)
                if (data.candidates && data.candidates[0].content) {
                    aiReply = data.candidates[0].content.parts[0].text;
                } else {
                    aiReply = "No pude procesar eso, mi drog.";
                }

                chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
                
                isThinking = false;
                status.innerText = "Alex respondiendo...";
                speakElevenLabs(aiReply);

            } catch (e) {
                console.error(e);
                isThinking = false;
                status.innerText = "Error de conexión (Ver consola)";
                speakElevenLabs("Algo falla en mis circuitos, revisa la consola.");
            }
        }

        // --- VOZ ELEVENLABS ---
        async function speakElevenLabs(text) {
            if(!text) return;
            isSpeaking = true;
            if(window.currentAudio) window.currentAudio.pause();

            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'xi-api-key': ELEVEN_API_KEY,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });

                if(!response.ok) {
                    const errTxt = await response.text();
                    console.error("Error ElevenLabs:", errTxt);
                    throw new Error("Error Voz");
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                window.currentAudio = audio;

                audio.onended = () => {
                    isSpeaking = false;
                    status.innerText = "En espera...";
                };
                audio.play();

            } catch (e) {
                console.warn("Fallo ElevenLabs, usando voz navegador");
                isSpeaking = false;
                // Fallback
                const u = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(u);
            }
        }
    </script>
</body>
</html>
