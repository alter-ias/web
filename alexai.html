<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEX | SYSTEM ONLINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Montserrat:wght@400;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUALES ORIGINALES --- */
        :root {
            --bg-color: #1a1a1a; 
            --text-main: #E8E4D9;
            --text-sub: #888888;
            --accent: #FF6600; 
        }

        [data-theme="ultra"] {
            --bg-color: #900a00; 
            --text-main: #000000;
            --text-sub: #2a0000;
            --accent: #FFFFFF; 
        }

        body {
            margin: 0; background: var(--bg-color); color: var(--text-main);
            font-family: 'Montserrat', sans-serif; overflow: hidden;
            transition: background 0.5s ease;
        }

        .controls-container {
            position: fixed; top: 30px; right: 10%; z-index: 100;
            display: flex; gap: 10px;
        }

        #mic-toggle {
            background: rgba(0,0,0,0.5); border: 2px solid var(--accent); color: var(--accent);
            padding: 15px 30px; font-family: 'Rajdhani'; font-weight: 700; font-size: 14px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s; min-width: 160px;
        }
        #mic-toggle:hover { background: var(--accent); color: var(--bg-color); }
        #mic-toggle.listening { 
            background: var(--accent); color: var(--bg-color); 
            box-shadow: 0 0 20px var(--accent); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #theme-toggle {
            position: fixed; top: 30px; left: 10%; z-index: 100;
            background: transparent; border: 1px solid var(--text-sub); color: var(--text-sub);
            padding: 5px 10px; font-family: 'Rajdhani'; font-size: 10px; cursor: pointer;
        }

        #ai-status {
            position: fixed; bottom: 100px; width: 100%; text-align: center;
            z-index: 100; pointer-events: none;
        }
        #ai-text {
            font-family: 'Rajdhani'; font-weight: 600; font-size: 20px; 
            color: var(--text-main); text-shadow: 0 0 10px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 4px;
        }

        #canvas-container {
            position: fixed; top: 0; right: 0; width: 65%; height: 100vh; z-index: 10;
            mask-image: linear-gradient(to right, transparent 0%, black 20%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%);
        }

        #content-sidebar {
            position: relative; width: 45%; height: 100vh; overflow-y: auto; z-index: 20;
            scrollbar-width: none;
        }
        section {
            min-height: 80vh; display: flex; flex-direction: column; justify-content: center;
            padding: 0 10% 0 15%;
        }
        h1 { font-size: 80px; margin: 0; line-height: 0.85; letter-spacing: -3px; text-transform: uppercase; }
        h2 { font-family: 'Rajdhani'; font-size: 14px; letter-spacing: 6px; color: var(--accent); }
        p { font-family: 'Rajdhani'; font-size: 18px; color: var(--text-sub); margin-top: 20px; max-width: 400px; }

        @media (max-width: 768px) {
            #canvas-container { width: 100%; height: 50vh; mask-image: none; border-bottom: 1px solid #333;}
            #content-sidebar { width: 100%; height: 50vh; top: 50vh; background: var(--bg-color); }
            section { min-height: 50vh; padding: 20px; }
            h1 { font-size: 40px; }
        }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://cdn.skypack.dev/three@0.136.0", "three/addons/": "https://cdn.skypack.dev/three@0.136.0/examples/jsm/" } }
    </script>
</head>
<body data-theme="ludovico">

    <button id="theme-toggle">CAMBIAR TEMA</button>
    <div class="controls-container">
        <button id="mic-toggle">● HABLAR</button>
    </div>
    
    <div id="canvas-container"></div>
    <div id="ai-status"><span id="ai-text">Sistema preparado</span></div>

    <div id="content-sidebar">
        <section>
            <h2>ASISTENTE REAL</h2>
            <h1>ALEX</h1>
            <h1>LIVE</h1>
            <p>Conectado a Google Gemini y ElevenLabs. Diseño completo restaurado. Pulsa 'HABLAR'.</p>
        </section>
        <div style="height: 20vh;"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        /* ======================================================== */
        /* === 1. VARIABLES GLOBALES (ESTADO) === */
        /* ======================================================== */
        // Definimos esto PRIMERO para evitar el ReferenceError
        let isListening = false;
        let isThinking = false;
        let isSpeaking = false;
        let chatHistory = [];
        let recognition;
        let explodeTarget = 0; 
        let explodeCurrent = 0;

        // --- TUS CLAVES ---
        const ELEVEN_API_KEY = "sk_59fc0224b40d892bf32845d0542ca89f89119ea789fcec0c".trim(); 
        const GEMINI_API_KEY = "AIzaSyDHT_af99TNDXIt-yq1iNIft_DIXO87ViI".trim();
        const VOICE_ID = "pNInz6obpgDQGcFmaJgB";

        /* ======================================================== */
        /* === 2. ESCENA 3D COMPLETA (DISEÑO ORIGINAL) === */
        /* ======================================================== */
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);
        
        const scene = new THREE.Scene(); 
        const camera = new THREE.PerspectiveCamera(35, container.clientWidth/container.clientHeight, 0.1, 100);
        camera.position.set(-0.5, 3.5, 18.0);
        
        const controls = new OrbitControls(camera, renderer.domElement); 
        controls.enableDamping = true; 
        controls.target.set(0, 3.5, 0);
        
        // --- MATERIALES ORIGINALES ---
        const matArmor = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
        const matBody = new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.7 });
        const matAccent = new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0xFF4400, emissiveIntensity: 2 });
        const matTech = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.3 });
        const matCore = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, emissive: 0xFF4400, emissiveIntensity: 3, wireframe: true });

        // Textura Logo
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 128;
        const ctx = canvas.getContext('2d'); 
        ctx.font = '900 100px "Montserrat"'; ctx.fillStyle = '#111111'; 
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ALEX', 256, 64);
        const logoTex = new THREE.CanvasTexture(canvas);
        const matLogo = new THREE.MeshBasicMaterial({ map: logoTex, transparent: true });

        // Luces
        scene.add(new THREE.AmbientLight(0xffffff, 0.3));
        const mainLight = new THREE.DirectionalLight(0xffffff, 1); mainLight.position.set(5,5,8); mainLight.castShadow = true; scene.add(mainLight);
        const rimLight = new THREE.SpotLight(0xffffff, 2); rimLight.position.set(0,5,-10); scene.add(rimLight);

        // --- CONSTRUCCIÓN DEL ROBOT (PIEZA POR PIEZA) ---
        const robotGroup = new THREE.Group(); scene.add(robotGroup);
        const parts = []; // Para la animación de "explosión"

        function addPart(mesh, yBase, dir) {
            mesh.position.y = yBase;
            robotGroup.add(mesh);
            parts.push({ mesh: mesh, originalY: yBase, direction: dir });
        }

        const RADIUS = 1.7;

        // 1. Columna vertebral
        addPart(new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 4.0, 16), matTech), 2.5, 0.0);

        // 2. Base (Bowl)
        const baseGroup = new THREE.Group();
        const bowl = new THREE.Mesh(new THREE.SphereGeometry(RADIUS, 64, 32, 0, Math.PI*2, 0, Math.PI/2), matArmor);
        bowl.rotation.z = Math.PI; bowl.scale.y = 0.7; bowl.position.y = 0.5;
        const rim = new THREE.Mesh(new THREE.CylinderGeometry(RADIUS, RADIUS, 1.0, 64), matArmor); rim.position.y = 1.0;
        baseGroup.add(bowl, rim);
        addPart(baseGroup, 0.0, -0.5);

        // 3. Cuerpo blanco + Logo
        const bodyMesh = new THREE.Mesh(new THREE.CylinderGeometry(RADIUS, RADIUS, 3.0, 64), matBody);
        const logoPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.6, 0.4), matLogo);
        logoPlane.position.set(0, 0, RADIUS + 0.01);
        bodyMesh.add(logoPlane);
        addPart(bodyMesh, 3.0, 0.0);

        // 4. Núcleo IA
        const aiCore = new THREE.Mesh(new THREE.IcosahedronGeometry(0.6, 0), matCore);
        addPart(aiCore, 3.0, 0.0);

        // 5. Sombrero y Tirantes
        const hatGroup = new THREE.Group();
        hatGroup.add(new THREE.Mesh(new THREE.SphereGeometry(RADIUS, 64, 32, 0, Math.PI*2, 0, Math.PI/2), matArmor));
        const brim = new THREE.Mesh(new THREE.TorusGeometry(RADIUS, 0.4, 16, 64), matArmor);
        brim.rotation.x = Math.PI/2; hatGroup.add(brim);
        
        // Ojos del sombrero
        for(let r=1; r<=3; r++){
            for(let i=0; i<8*r; i++){
                const hole = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.1, 8), matArmor);
                const angle = (i/(8*r))*Math.PI*2; const rad = 0.4*r;
                hole.position.set(Math.cos(angle)*rad, 1.5-(r*0.2), Math.sin(angle)*rad); hole.lookAt(0,0,0); hatGroup.add(hole);
            }
        }
        
        // Tirantes naranjas
        const suspenderGeo = new RoundedBoxGeometry(0.3, 4.5, 0.15, 4, 0.05);
        [25, 155, 205, 335].forEach(deg => {
            const s = new THREE.Mesh(suspenderGeo, matAccent);
            const rad = deg * (Math.PI/180);
            s.position.set(Math.sin(rad)*RADIUS, -2.0, Math.cos(rad)*RADIUS); s.rotation.y = rad; hatGroup.add(s);
        });
        addPart(hatGroup, 4.5, 2.0);


        // --- LOOP DE ANIMACIÓN ---
        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.5, 0.4));

        function animate() {
            requestAnimationFrame(animate); controls.update();
            const time = Date.now() * 0.001;
            
            // Animación flotante
            robotGroup.position.y = (Math.sin(time) * 0.1) + 1.0;
            aiCore.rotation.y += 0.02;

            // Lógica de despiece (Scroll)
            explodeCurrent += (explodeTarget - explodeCurrent) * 0.05;
            parts.forEach(p => {
                p.mesh.position.y = p.originalY + (p.direction * explodeCurrent);
            });
            
            // Reacción visual IA
            if(isSpeaking) matCore.emissiveIntensity = 3 + Math.random()*3;
            else if(isThinking) matCore.emissiveIntensity = 2 + Math.sin(time*10)*2;
            else matCore.emissiveIntensity = 2;
            
            composer.render();
        }
        animate(); // ¡Ahora sí funcionará porque las variables ya existen!

        // Eventos visuales extra
        window.addEventListener('resize', () => { 
            renderer.setSize(container.clientWidth, container.clientHeight);
            composer.setSize(container.clientWidth, container.clientHeight);
            camera.aspect = container.clientWidth/container.clientHeight; 
            camera.updateProjectionMatrix(); 
        });
        window.addEventListener('wheel', (e) => {
            if(e.ctrlKey) { 
                e.preventDefault(); 
                explodeTarget += e.deltaY * 0.002; 
                explodeTarget = Math.max(0, Math.min(3.0, explodeTarget)); 
            }
        }, { passive: false });


        /* ======================================================== */
        /* === 3. LÓGICA DE IA (GEMINI 1.5 FLASH + WEB SEARCH) === */
        /* ======================================================== */

        const btn = document.getElementById('mic-toggle');
        const status = document.getElementById('ai-text');

        // --- RECONOCIMIENTO DE VOZ ---
        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.lang = 'es-MX';
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true; btn.classList.add('listening'); btn.innerText = "ESCUCHANDO..."; status.innerText = "Te escucho...";
            };
            recognition.onend = () => {
                isListening = false; btn.classList.remove('listening'); btn.innerText = "● HABLAR";
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                status.innerText = `"${transcript}"`;
                processGemini(transcript);
            };
        } else {
            alert("Navegador no soporta micrófono. Usa Chrome.");
        }

        btn.addEventListener('click', () => {
            if(isSpeaking && window.currentAudio) { 
                window.currentAudio.pause(); 
                isSpeaking = false; 
                status.innerText = "Interrumpido";
                return; 
            }
            if(isListening) recognition.stop();
            else recognition.start();
        });

        // --- CEREBRO GOOGLE GEMINI ---
        async function processGemini(text) {
            isThinking = true;
            status.innerText = "Alex está pensando...";

            chatHistory.push({ role: "user", parts: [{ text: text }] });
            if(chatHistory.length > 8) chatHistory = chatHistory.slice(-8);

            const systemPrompt = `Eres Alex (de La Naranja Mecánica). 
            Personalidad: Intelectual, cínico, violento, usa jerga Nadsat (drog, videar, gulever).
            REGLAS:
            1. Eres un líder, no un asistente.
            2. Sé conciso (máx 40 palabras).
            3. Si te preguntan algo actual (noticias, clima, hora), usa tu capacidad de búsqueda.
            4. Responde siempre en Español.`;

            // URL PARA GEMINI 1.5 FLASH (Soporta Búsqueda)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [
                    { role: "user", parts: [{ text: systemPrompt }] },
                    ...chatHistory
                ],
                // HERRAMIENTA DE BÚSQUEDA GOOGLE
                tools: [
                    { google_search_retrieval: { dynamic_retrieval_config: { mode: "MODE_DYNAMIC", dynamic_threshold: 0.7 } } }
                ]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(!response.ok) {
                    const errTxt = await response.text();
                    console.error("Error Google:", errTxt);
                    throw new Error("Error API Google: " + response.status);
                }

                const data = await response.json();
                let aiReply = "";

                if (data.candidates && data.candidates[0].content) {
                    aiReply = data.candidates[0].content.parts[0].text;
                } else {
                    aiReply = "No pude procesar eso, mi drog.";
                }

                chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
                
                isThinking = false;
                status.innerText = "Alex respondiendo...";
                speakElevenLabs(aiReply);

            } catch (e) {
                console.error(e);
                isThinking = false;
                status.innerText = "Error: " + e.message;
                speakElevenLabs("Algo falla en mis circuitos, revisa la consola.");
            }
        }

        // --- VOZ ELEVENLABS ---
        async function speakElevenLabs(text) {
            if(!text) return;
            isSpeaking = true;
            if(window.currentAudio) window.currentAudio.pause();

            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'xi-api-key': ELEVEN_API_KEY,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });

                if(!response.ok) {
                    const errTxt = await response.text();
                    console.error("Error ElevenLabs:", errTxt);
                    throw new Error("Error Voz");
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                window.currentAudio = audio;

                audio.onended = () => {
                    isSpeaking = false;
                    status.innerText = "En espera...";
                };
                audio.play();

            } catch (e) {
                console.warn("Fallo ElevenLabs, usando voz navegador");
                isSpeaking = false;
                const u = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(u);
            }
        }

        // Cambio de tema
        const toggleBtn = document.getElementById('theme-toggle');
        let currentTheme = 'ludovico';
        toggleBtn.addEventListener('click', () => {
            currentTheme = currentTheme === 'ludovico' ? 'ultra' : 'ludovico';
            document.body.setAttribute('data-theme', currentTheme);
            toggleBtn.innerText = "MODELO: " + currentTheme.toUpperCase();
            
            const color = currentTheme === 'ultra' ? 0x900a00 : 0x1a1a1a;
            scene.background = new THREE.Color(color);
            
            // Actualizar materiales
            if(currentTheme === 'ultra') {
                matBody.color.setHex(0x111111);
                matArmor.color.setHex(0xFF6600);
                matAccent.emissive.setHex(0xFFFFFF);
                matCore.emissive.setHex(0xFFFFFF);
                ctx.fillStyle = '#EEEEEE';
            } else {
                matBody.color.setHex(0xEEEEEE);
                matArmor.color.setHex(0x111111);
                matAccent.emissive.setHex(0xFF4400);
                matCore.emissive.setHex(0xFF4400);
                ctx.fillStyle = '#111111';
            }
            ctx.clearRect(0, 0, 512, 128);
            ctx.fillText('ALEX', 256, 64);
            logoTex.needsUpdate = true;
        });

    </script>
</body>
</html>
