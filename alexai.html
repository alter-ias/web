<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEX ASSISTANT | V.FINAL STABLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Montserrat:wght@400;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-color: #1a1a1a; 
            --text-main: #E8E4D9;
            --text-sub: #888888;
            --accent: #FF6600; 
            --glass-panel: rgba(20, 20, 20, 0.8);
            --border-color: #333;
        }

        [data-theme="ultra"] {
            --bg-color: #900a00; 
            --text-main: #000000;
            --text-sub: #2a0000;
            --accent: #FFFFFF; 
            --glass-panel: rgba(255, 60, 0, 0.8);
            --border-color: #aa1100;
        }

        body {
            margin: 0;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }

        #theme-toggle {
            position: fixed; top: 30px; left: 10%; z-index: 100;
            background: transparent; border: 2px solid var(--text-main); color: var(--text-main);
            padding: 10px 20px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; font-size: 10px; transition: 0.3s;
        }
        #theme-toggle:hover { background: var(--text-main); color: var(--bg-color); }

        .controls-container {
            position: fixed; top: 30px; right: 10%; z-index: 100;
            display: flex; align-items: center; gap: 10px;
        }

        #mic-toggle {
            background: transparent; border: 2px solid var(--accent); color: var(--accent);
            padding: 10px 20px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; font-size: 10px; transition: 0.3s;
            display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center;
        }
        #mic-toggle:hover { background: rgba(255, 102, 0, 0.2); }
        
        #mic-toggle.active-mode { 
            background: var(--accent); color: var(--bg-color); 
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 102, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 102, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 102, 0, 0); }
        }
        
        #cmd-input {
            background: rgba(0,0,0,0.3); border: 1px solid var(--text-sub); 
            color: var(--text-main); padding: 8px 15px;
            font-family: 'Rajdhani'; font-weight: 600; font-size: 14px;
            width: 200px; outline: none; transition: 0.3s;
            text-transform: uppercase;
        }
        #cmd-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }

        #ai-status {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center; width: 80%; pointer-events: none;
        }
        #ai-text {
            font-family: 'Rajdhani'; font-weight: 600; font-size: 18px; 
            color: var(--text-main); text-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px;
            display: inline-block; opacity: 0; transition: opacity 0.5s;
        }
        
        #session-bar {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            width: 0%; height: 2px; background: var(--accent);
            z-index: 100; transition: width 0.2s linear; opacity: 0;
        }

        #canvas-container {
            position: fixed; top: 0; right: 0; width: 65%; height: 100vh; z-index: 10;
            mask-image: linear-gradient(to right, transparent 0%, black 20%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%);
        }

        #content-sidebar {
            position: relative; width: 45%; height: 100vh; overflow-y: auto; z-index: 20;
            background: transparent; scrollbar-width: none;
        }
        #content-sidebar::-webkit-scrollbar { display: none; }

        section {
            min-height: 100vh; display: flex; flex-direction: column; justify-content: center;
            padding: 0 10% 0 20%; box-sizing: border-box;
        }

        .content-box {
            border-left: 4px solid var(--accent); padding-left: 30px;
            opacity: 0; transform: translateY(30px); transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .content-box.visible { opacity: 1; transform: translateY(0); }

        h1 { font-weight: 900; font-size: 85px; margin: 0; line-height: 0.85; letter-spacing: -3px; text-transform: uppercase; }
        h2 { font-family: 'Rajdhani'; font-weight: 700; font-size: 14px; letter-spacing: 6px; color: var(--accent); text-transform: uppercase; }
        p { font-family: 'Rajdhani'; font-weight: 600; font-size: 18px; color: var(--text-sub); max-width: 420px; }

        .btn-cta {
            padding: 15px 35px; background: var(--text-main); color: var(--bg-color);
            border: 2px solid var(--text-main); font-family: 'Montserrat'; font-weight: 800;
            font-size: 12px; cursor: pointer; transition: 0.3s; text-decoration: none;
            display: inline-block; letter-spacing: 1px; margin-right: 10px; text-transform: uppercase;
        }
        .btn-cta:hover { background: var(--accent); border-color: var(--accent); color: #fff; }

        @media (max-width: 768px) {
            #canvas-container { width: 100%; height: 50vh; top: 0; mask-image: none; }
            #content-sidebar { width: 100%; height: 50vh; top: 50vh; background: var(--bg-color); }
            h1 { font-size: 50px; }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.skypack.dev/three@0.136.0",
                "three/addons/": "https://cdn.skypack.dev/three@0.136.0/examples/jsm/"
            }
        }
    </script>
</head>
<body data-theme="ludovico">

    <button id="theme-toggle">MODELO: LUDOVICO</button>
    
    <div class="controls-container">
        <input type="text" id="cmd-input" placeholder="ESCRIBE AQUÍ..." autocomplete="off">
        <button id="mic-toggle">● INICIAR SESIÓN</button>
    </div>
    
    <div id="canvas-container"></div>
    <div id="session-bar"></div>
    <div id="ai-status"><span id="ai-text">Sistema preparado...</span></div>

    <div id="content-sidebar">
        <section id="sec-intro">
            <div class="content-box visible">
                <h2>AI ASSISTANT V.1.6</h2>
                <h1>ALEX</h1>
                <h1>NEURAL</h1>
                <p>Diseño 'Minimalist Bottle'. Inteligencia Contextual: Breve en saludos, profundo en debate.</p>
                <br>
                <a href="#" class="btn-cta">COMPRAR AHORA</a>
            </div>
        </section>

        <section id="sec-design">
            <div class="content-box">
                <h2>INGENIERÍA ACÚSTICA</h2>
                <h3>PROYECCIÓN SUPERIOR</h3>
                <p>Dispersión de sonido de 360 grados con base de graves anclada.</p>
            </div>
        </section>

        <section id="sec-tech">
            <div class="content-box">
                <h2>ESTRUCTURA ARAÑA</h2>
                <h3>ANCLAJE MECÁNICO</h3>
                <p>Tirantes que aseguran la base por tensión, sin tornillos visibles.</p>
            </div>
        </section>
        <div style="height: 20vh;"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        /* === CONFIGURACIÓN API === */
        const ELEVEN_API_KEY = "sk_59fc0224b40d892bf32845d0542ca89f89119ea789fcec0c"; 
        const GEMINI_API_KEY = "AIzaSyCCs9TcWRgwQNgENnDVlspfNDSobp3MRaE";
        const VOICE_ID = "pNInz6obpgDQGcFmaJgB";

        // --- GESTIÓN DE TEMAS ---
        const themes = {
            ludovico: { label: "LUDOVICO (DARK)", bg: 0x1a1a1a, fogDensity: 0.02, rimIntensity: 2.0 },
            ultra: { label: "ULTRAVIOLENCIA", bg: 0x900a00, fogDensity: 0.015, rimIntensity: 0.8 }
        };
        let currentThemeKey = 'ludovico';

        // --- ESCENA 3D ---
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 0.7;
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(-0.5, 3.5, 18.0);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.target.set(0, 3.5, 0);

        // --- MATERIALES ---
        const matArmor = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
        const matBody = new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.7 });
        const matAccent = new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0xFF4400, emissiveIntensity: 2.0 });
        const matCore = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, emissive: 0xFF4400, emissiveIntensity: 3.0, wireframe: true });

        // --- MODELO 3D ---
        const robotGroup = new THREE.Group(); scene.add(robotGroup);
        const parts = [];
        function addPart(mesh, explodeDir) { robotGroup.add(mesh); parts.push({ mesh, originalY: mesh.position.y, direction: explodeDir }); }

        const RADIUS = 1.7;
        const bodyMesh = new THREE.Mesh(new THREE.CylinderGeometry(RADIUS, RADIUS, 3.0, 64), matBody);
        bodyMesh.position.y = 3.0; addPart(bodyMesh, 0);

        const aiCore = new THREE.Mesh(new THREE.IcosahedronGeometry(0.6, 0), matCore);
        aiCore.position.y = 3.0; addPart(aiCore, 0);

        const hatGroup = new THREE.Group();
        hatGroup.add(new THREE.Mesh(new THREE.SphereGeometry(RADIUS, 64, 32, 0, Math.PI*2, 0, Math.PI/2), matArmor));
        hatGroup.position.y = 4.5; addPart(hatGroup, 2.0);

        // --- LUCES ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.3));
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.0); mainLight.position.set(5, 5, 8); scene.add(mainLight);

        // --- TEMAS Y POST-PROCESADO ---
        function applyTheme3D(key) {
            const t = themes[key]; document.body.setAttribute('data-theme', key);
            scene.background = new THREE.Color(t.bg); scene.fog = new THREE.FogExp2(t.bg, t.fogDensity);
        }
        applyTheme3D(currentThemeKey);

        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.5, 0.4);
        composer.addPass(bloomPass);

        /* ========================================= */
        /* === LÓGICA IA: GEMINI + ELEVENLABS === */
        /* ========================================= */
        const micBtn = document.getElementById('mic-toggle');
        const cmdInput = document.getElementById('cmd-input');
        const statusText = document.getElementById('ai-text');
        const sessionBar = document.getElementById('session-bar');

        let isListening = false, isThinking = false, isSpeaking = false;
        let sessionActive = false, sessionEndTime = 0;
        const sessionDuration = 60000;
        let chatHistory = [];

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;

        if (recognition) {
            recognition.lang = 'es-MX';
            recognition.onstart = () => { isListening = true; updateUI("Escuchando...", "active"); };
            recognition.onend = () => { 
                isListening = false; 
                if (sessionActive && !isThinking && !isSpeaking) {
                    updateUI("Sesión activa", "active");
                    try { recognition.start(); } catch(e) {}
                }
            };
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                if (text.toLowerCase().includes("basta") || text.toLowerCase().includes("adiós")) {
                    closeSession(); speakResponse("Hasta nunca."); return;
                }
                if (sessionActive || text.toLowerCase().includes("alex")) {
                    if (!sessionActive) openSession();
                    refreshSession();
                    updateUI(`"${text}"`, "");
                    processWithGemini(text.replace(/alex/gi, ""));
                }
            };
        }

        async function processWithGemini(userText) {
            isThinking = true; updateUI("Analizando...", "active");
            chatHistory.push({ role: "user", parts: [{ text: userText }] });
            
            const systemText = "Eres 'Alex' de la Naranja Mecánica. Intelectual, cínico, refinado. Habla con un 2% de jerga Nadsat (drog, videar, orrorshou). Máximo 40 palabras.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        system_instruction: { parts: [{ text: systemText }] }
                    })
                });
                const data = await res.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                isThinking = false;
                speakResponse(aiResponse);
            } catch (err) {
                isThinking = false; updateUI("Error", "error");
            }
        }

        async function speakResponse(text) {
            isSpeaking = true; updateUI("Alex responde", "speaking");
            try {
                const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                    method: 'POST',
                    headers: { 'xi-api-key': ELEVEN_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, model_id: "eleven_multilingual_v2" })
                });
                const blob = await res.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.onended = () => { isSpeaking = false; if(sessionActive) recognition.start(); };
                audio.play();
            } catch (e) { 
                isSpeaking = false; // Fallback simple
                const u = new SpeechSynthesisUtterance(text); window.speechSynthesis.speak(u);
            }
        }

        function openSession() { sessionActive = true; micBtn.classList.add("active-mode"); sessionBar.style.opacity = 1; updateSessionBar(); }
        function refreshSession() { sessionEndTime = Date.now() + sessionDuration; }
        function closeSession() { sessionActive = false; micBtn.classList.remove("active-mode"); sessionBar.style.opacity = 0; recognition?.stop(); }

        function updateSessionBar() {
            if (!sessionActive) return;
            const pct = Math.max(0, (sessionEndTime - Date.now()) / sessionDuration) * 100;
            sessionBar.style.width = pct + "%";
            if (pct <= 0) closeSession(); else requestAnimationFrame(updateSessionBar);
        }

        function updateUI(text, state) {
            statusText.innerText = text.toUpperCase(); statusText.style.opacity = 1;
            statusText.style.color = state === "active" ? "var(--accent)" : "var(--text-main)";
        }

        cmdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && cmdInput.value.trim()) {
                if (!sessionActive) openSession(); refreshSession();
                processWithGemini(cmdInput.value); cmdInput.value = "";
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            robotGroup.position.y = (Math.sin(time) * 0.1) + 1.0;
            aiCore.rotation.y += isThinking ? 0.2 : 0.01;
            matCore.emissiveIntensity = isThinking ? 5 + Math.sin(time * 20) * 2 : 2;
            composer.render();
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    </script>
</body>
</html>
