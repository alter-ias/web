<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEX | LUDOVICO TREATMENT</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Montserrat:wght@400;800;900&display=swap" rel="stylesheet">
    <style>
        /* === ESTILOS VISUALES === */
        :root { --bg: #1a1a1a; --main: #E8E4D9; --sub: #888; --accent: #FF6600; }
        [data-theme="ultra"] { --bg: #900a00; --main: #000; --sub: #2a0000; --accent: #FFF; }
        body { margin: 0; background: var(--bg); color: var(--main); font-family: 'Montserrat', sans-serif; overflow: hidden; transition: 0.5s; }
        
        /* UI LAYOUT */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .pointer-events-auto { pointer-events: auto; }
        
        .top-bar { display: flex; justify-content: space-between; padding: 30px 5%; }
        button { 
            background: transparent; border: 2px solid var(--main); color: var(--main);
            padding: 8px 15px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; font-size: 10px; transition: 0.3s;
        }
        #mic-btn { border-color: var(--accent); color: var(--accent); min-width: 140px; }
        #mic-btn:hover, #mic-btn.active { background: var(--accent); color: var(--bg); box-shadow: 0 0 15px var(--accent); }
        
        #ai-status { position: fixed; bottom: 80px; width: 100%; text-align: center; }
        #status-text { 
            background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 4px; 
            font-family: 'Rajdhani'; font-weight: 600; color: var(--main); 
            text-transform: uppercase; letter-spacing: 1px; font-size: 14px;
        }

        /* --- PANTALLA DE CARGA "LUDOVICO" --- */
        #ludovico-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #ludovico-loader.active { opacity: 1; pointer-events: auto; }
        
        .loader-content { text-align: center; width: 80%; max-width: 400px; }
        .loader-title { font-size: 24px; font-weight: 900; letter-spacing: -1px; margin-bottom: 20px; color: var(--accent); }
        .loader-bar-bg { width: 100%; height: 4px; background: #333; margin-bottom: 15px; position: relative; overflow: hidden; }
        .loader-bar-fill { 
            position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
            background: var(--accent); transition: width 0.3s linear; 
            box-shadow: 0 0 10px var(--accent);
        }
        .loader-text { font-family: 'Rajdhani'; font-size: 12px; color: var(--sub); letter-spacing: 2px; text-transform: uppercase; min-height: 20px;}

        /* 3D CANVAS */
        #canvas-container { position: fixed; top: 0; right: 0; width: 100%; height: 100vh; z-index: 1; }
        
        /* INPUT DE TEXTO FALLBACK */
        #cmd-input {
            position: fixed; top: 30px; right: 20%; pointer-events: auto;
            background: rgba(0,0,0,0.5); border: 1px solid var(--sub); color: var(--main);
            padding: 8px; font-family: 'Rajdhani'; text-transform: uppercase; outline: none; display: none;
        }
        
        @media (max-width: 768px) {
            .top-bar { padding: 20px 5%; flex-direction: column; gap: 10px; align-items: flex-end; }
            #cmd-input { top: 70px; right: 5%; }
        }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://cdn.skypack.dev/three@0.136.0", "three/addons/": "https://cdn.skypack.dev/three@0.136.0/examples/jsm/" } }
    </script>
</head>
<body data-theme="ludovico">

    <div id="ludovico-loader">
        <div class="loader-content">
            <div class="loader-title">TRATAMIENTO LUDOVICO</div>
            <div class="loader-bar-bg"><div class="loader-bar-fill" id="ludovico-bar"></div></div>
            <div class="loader-text" id="ludovico-text">INICIALIZANDO SUJETO...</div>
        </div>
    </div>

    <div id="ui-layer">
        <div class="top-bar">
            <button id="theme-btn" class="pointer-events-auto">MODELO: LUDOVICO</button>
            <div style="display:flex; gap:10px;">
                <input id="cmd-input" placeholder="CMD...">
                <button id="mic-btn" class="pointer-events-auto">● INICIAR SISTEMA</button>
            </div>
        </div>
        <div id="ai-status"><span id="status-text">PRESIONA INICIAR...</span></div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONEXIÓN A TU BACKEND ---
        const API_URL = "https://alex-voice-backend.onrender.com"; 
        
        let isSystemReady = false; 
        let isSpeaking = false;
        let isThinking = false;
        let currentAudio = null;

        // --- SECUENCIA DE INICIO (LUDOVICO) ---
        const micBtn = document.getElementById('mic-btn');
        const loader = document.getElementById('ludovico-loader');
        const loaderBar = document.getElementById('ludovico-bar');
        const loaderText = document.getElementById('ludovico-text');

        const bootPhrases = [
            "Administrando Suero 114...",
            "Asegurando pinzas oculares...",
            "Forzando apertura de párpados...",
            "Calibrando respuesta emocional...",
            "Proyectando ultra-violencia...",
            "Sincronizando sinapsis..."
        ];

        micBtn.addEventListener('click', async () => {
            if (isSystemReady) {
                if(recognition) try { recognition.start(); } catch(e){}
                return;
            }

            // Inicia secuencia de espera
            loader.classList.add('active');
            updateStatus("INICIANDO PROTOCOLO...", "active");
            
            // 1. Despertar servidor
            const wakeUpPromise = fetch(`${API_URL}/wakeup`)
                .then(res => res.json())
                .catch(err => console.log("Servidor despertando..."));

            // 2. Animación de carga
            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += (Math.random() * 5); 
                    loaderBar.style.width = progress + "%";
                    if (Math.random() > 0.7) {
                        loaderText.innerText = bootPhrases[Math.floor(Math.random() * bootPhrases.length)];
                    }
                }
            }, 500);

            try {
                // Esperar respuesta del servidor
                await wakeUpPromise;
                
                clearInterval(interval);
                loaderBar.style.width = "100%";
                loaderText.innerText = "SUJETO CURADO. SISTEMA ONLINE.";
                
                setTimeout(() => {
                    loader.classList.remove('active');
                    isSystemReady = true;
                    micBtn.innerText = "● HABLAR CON ALEX";
                    updateStatus("LISTO PARA VIDEAR", "");
                    // Hack para habilitar audio en iOS/Android
                    const dummy = new Audio(); 
                    
                    if(recognition) recognition.start();
                }, 1000);

            } catch (error) {
                clearInterval(interval);
                loaderText.innerText = "ERROR EN TRATAMIENTO. MODO OFFLINE.";
                setTimeout(() => { loader.classList.remove('active'); isSystemReady = true; micBtn.innerText = "● MODO TEXTO"; }, 2000);
            }
        });

        // --- SISTEMA DE AUDIO ---
        async function speak(text) {
            if(!text) return;
            if(currentAudio) currentAudio.pause();
            isSpeaking = true;
            updateStatus("TRANSMITIENDO...", "active");

            try {
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, voice: "es-NI-FedericoNeural" })
                });
                
                if (!response.ok) throw new Error("API Error");
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                currentAudio = new Audio(url);
                
                currentAudio.onended = () => { isSpeaking = false; updateStatus("ESPERANDO...", ""); URL.revokeObjectURL(url); };
                await currentAudio.play();
                
            } catch (e) {
                console.warn("Fallo en red, usando fallback");
                fallbackSpeak(text);
            }
        }

        function fallbackSpeak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-MX'; u.pitch = 0.8; u.rate = 1.0;
            u.onend = () => { isSpeaking = false; updateStatus("ESPERANDO...", ""); };
            window.speechSynthesis.speak(u);
        }

        // --- IA (Pollinations) ---
        let chatHistory = [];
        async function askAI(input) {
            isThinking = true;
            updateStatus("PENSANDO...", "");
            
            chatHistory.push({role: "user", content: input});
            const histTxt = chatHistory.slice(-4).map(m => m.content).join("\n");
            
            // Prompt ajustado para Alex
            const prompt = `Eres Alex DeLarge (La Naranja Mecánica). Responde en español. 
            Personalidad: Intelectual, arrogante, violento pero culto. 
            Vocabulario: Usa palabras Nadsat (drogos, videar, gullever, siny).
            Longitud: Máximo 30 palabras.
            
            Historial: ${histTxt}
            Usuario: ${input}
            Alex:`;
            
            const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}`;

            try {
                const res = await fetch(url);
                const text = await res.text();
                chatHistory.push({role: "assistant", content: text});
                isThinking = false;
                speak(text);
            } catch(e) { 
                isThinking = false; 
                speak("Mis circuitos sangran, drogo."); 
            }
        }

        // --- RECONOCIMIENTO VOZ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX'; recognition.interimResults = false;
            
            recognition.onstart = () => { updateStatus("ESCUCHANDO...", "active"); micBtn.classList.add('active'); };
            recognition.onend = () => { if(!isThinking && !isSpeaking) micBtn.classList.remove('active'); };
            recognition.onresult = (e) => { askAI(e.results[0][0].transcript); };
        } else {
            micBtn.style.display = 'none'; 
            document.getElementById('cmd-input').style.display = 'block';
        }
        
        const cmdInput = document.getElementById('cmd-input');
        cmdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { askAI(cmdInput.value); cmdInput.value = ""; }
        });

        function updateStatus(text, state) {
            const el = document.getElementById('status-text');
            el.innerText = text;
            el.style.color = state === "active" ? "var(--accent)" : "var(--main)";
        }

        // --- ESCENA 3D (OJO) ---
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.z = 8;
        
        const eyeGroup = new THREE.Group();
        const sclera = new THREE.Mesh(new THREE.IcosahedronGeometry(1.2, 3), new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.4 }));
        const iris = new THREE.Mesh(new THREE.TorusGeometry(0.6, 0.15, 16, 32), new THREE.MeshStandardMaterial({ color: 0x222222, emissive: 0xff6600, emissiveIntensity: 2 }));
        const pupil = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), new THREE.MeshBasicMaterial({ color: 0x000000 }));
        iris.position.z = 1.0; pupil.position.z = 1.1;
        eyeGroup.add(sclera, iris, pupil);
        scene.add(eyeGroup);

        const light = new THREE.PointLight(0xff6600, 1, 100); light.position.set(5, 5, 5); scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.1));
        
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));

        function animate() {
            requestAnimationFrame(animate);
            const t = Date.now() * 0.001;
            
            if (isSpeaking) {
                eyeGroup.rotation.x = Math.sin(t * 10) * 0.2;
                eyeGroup.rotation.y = Math.sin(t * 5) * 0.3;
                iris.material.emissiveIntensity = 2 + Math.sin(t * 20);
                iris.scale.setScalar(1 + Math.sin(t * 15) * 0.1);
            } else if (isThinking) {
                eyeGroup.rotation.z += 0.15;
                iris.material.emissiveIntensity = 0.5;
            } else {
                eyeGroup.rotation.y = Math.sin(t) * 0.5;
                iris.material.emissiveIntensity = 1.5;
                iris.scale.setScalar(1);
            }
            composer.render();
        }
        animate();
        
        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            composer.setSize(window.innerWidth, window.innerHeight); 
        });
        
        // Theme Toggle
        let isUltra = false;
        document.getElementById('theme-btn').addEventListener('click', (e) => {
            isUltra = !isUltra;
            document.body.setAttribute('data-theme', isUltra ? 'ultra' : 'ludovico');
            iris.material.emissive.setHex(isUltra ? 0xffffff : 0xff6600);
            light.color.setHex(isUltra ? 0xffffff : 0xff6600);
            e.target.innerText = isUltra ? "MODO ULTRA" : "MODO LUDOVICO";
        });
    </script>
</body>
</html>
