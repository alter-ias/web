<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pa'l Hueso | Herramienta de Ensayo - Alter.Lab</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alter: { bg: '#0F121B', cyan: '#00E5FF', dark: '#1a1d26', glass: 'rgba(255, 255, 255, 0.05)' }
                    },
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], mono: ['Inter', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --background-color: #0F121B; --text-color: #FFFFFF; --accent-color: #00E5FF; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Montserrat', sans-serif; overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .glass-card { background: rgba(15, 18, 27, 0.65); backdrop-filter: blur(16px); border: 1px solid rgba(0, 229, 255, 0.15); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-card-header { background: linear-gradient(90deg, rgba(0,229,255,0.15) 0%, rgba(0,0,0,0) 100%); border-bottom: 1px solid rgba(0, 229, 255, 0.1); }
        select, .custom-radio { background-color: rgba(0, 0, 0, 0.6); color: white; border: 1px solid rgba(255, 255, 255, 0.2); }
        select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 15px rgba(0, 229, 255, 0.25); }
        select option { background-color: #0F121B; }
        .note-chip { display: inline-block; padding: 0.35rem 0.85rem; margin: 0.25rem; border-radius: 9999px; font-size: 0.95rem; font-weight: 600; transition: all 0.3s ease; }
        .main-note { background-color: rgba(0, 229, 255, 0.1); color: #00E5FF; border: 1px solid rgba(0, 229, 255, 0.5); text-shadow: 0 0 5px rgba(0, 229, 255, 0.5); }
        .passing-note { background-color: rgba(255, 171, 0, 0.1); color: #ffab00; border: 1px dashed #ffab00; }
        
        /* SVG Styles */
        #guitar-diagram-svg .fret-line { stroke: #4b5563; stroke-width: 2; }
        #guitar-diagram-svg .string { stroke: rgba(255, 255, 255, 0.3); stroke-width: 1; }
        #guitar-diagram-svg .nut { fill: #00E5FF; opacity: 0.3; }
        #guitar-diagram-svg .note-dot { fill: #00E5FF; stroke: #fff; stroke-width: 1px; filter: drop-shadow(0 0 3px #00E5FF); }
        #piano-diagram-svg .white-key { fill: rgba(255, 255, 255, 0.05); stroke: rgba(255, 255, 255, 0.2); stroke-width: 1; }
        #piano-diagram-svg .black-key { fill: #0F121B; stroke: rgba(255, 255, 255, 0.1); stroke-width: 1; }
        #piano-diagram-svg .highlight-key { fill: #00E5FF; filter: drop-shadow(0 0 5px #00E5FF); }
        
        /* Scrollbar & Animation */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0F121B; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00E5FF; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        
        @keyframes pulse-cyan { 0% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 229, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); } }
        .playing-pulse { animation: pulse-cyan 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-between">

    <audio id="audio-player" preload="auto"></audio>
    <div id="canvas-container"></div>

    <header class="w-full py-6 z-10 relative">
        <div class="container mx-auto px-4 flex flex-col items-center">
            <a href="index.html" class="flex items-center gap-3 mb-2 animate-fade-in hover:opacity-80 transition-opacity group">
                <svg class="w-8 h-8 text-alter-cyan filter drop-shadow-[0_0_8px_rgba(0,229,255,0.8)] group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <span class="logo-text font-bold text-xl md:text-2xl text-white tracking-[0.2em]">ALTER.LAB</span>
            </a>
            <div class="h-0.5 w-24 bg-alter-cyan shadow-[0_0_15px_#00E5FF] rounded-full"></div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 z-10 relative flex-grow max-w-5xl">
        <div class="text-center mb-12 animate-fade-in">
            <h1 class="text-5xl md:text-7xl font-bold mb-4 tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white via-alter-cyan to-gray-400" style="text-shadow: 0 0 30px rgba(0,229,255,0.2);">Pa'l Hueso</h1>
            <p class="text-gray-400 text-lg md:text-xl font-light tracking-widest uppercase">La herramienta para no perder más tiempo en los ensayos</p>
        </div>

        <div class="space-y-8">
            <div class="glass-card rounded-xl p-6 md:p-8 animate-fade-in" style="animation-delay: 0.1s;">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="col-span-1 md:col-span-2">
                        <label for="song-selector" class="block text-sm font-bold text-alter-cyan mb-2 uppercase tracking-wider"><i class="bi bi-music-note-beamed mr-2"></i>Selecciona la Pieza</label>
                        <select id="song-selector" onchange="updateAnalysis()" class="w-full p-3 rounded-lg text-white focus:ring-2 focus:ring-alter-cyan transition-all cursor-pointer">
                            <option value="" disabled selected>-- Repertorio Cargado --</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-alter-cyan mb-2 uppercase tracking-wider"><i class="bi bi-person-badge mr-2"></i>Instrumento</label>
                        <div class="flex flex-col gap-2 p-3 rounded-lg bg-black/20 border border-white/10">
                            <label class="flex items-center cursor-pointer hover:text-alter-cyan transition-colors group"><input type="radio" name="instrument" value="Concert" checked onchange="updateAnalysis()" class="mr-3 accent-alter-cyan w-4 h-4"><span class="text-sm group-hover:translate-x-1 transition-transform">Concierto (C)</span></label>
                            <label class="flex items-center cursor-pointer hover:text-alter-cyan transition-colors group"><input type="radio" name="instrument" value="Bb" onchange="updateAnalysis()" class="mr-3 accent-alter-cyan w-4 h-4"><span class="text-sm group-hover:translate-x-1 transition-transform">Sax Tenor (B♭)</span></label>
                            <label class="flex items-center cursor-pointer hover:text-alter-cyan transition-colors group"><input type="radio" name="instrument" value="Eb" onchange="updateAnalysis()" class="mr-3 accent-alter-cyan w-4 h-4"><span class="text-sm group-hover:translate-x-1 transition-transform">Sax Alto (E♭)</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-output" class="hidden space-y-6">
                <div class="glass-card rounded-xl overflow-hidden animate-fade-in">
                    <div class="glass-card-header p-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h2 class="text-lg font-bold text-white tracking-widest uppercase"><i class="bi bi-cpu-fill mr-2"></i>Análisis Armónico</h2>
                            <button id="play-btn" onclick="toggleAudio()" class="w-10 h-10 rounded-full bg-alter-cyan text-black flex items-center justify-center hover:scale-110 hover:bg-white transition-all duration-300 shadow-[0_0_15px_rgba(0,229,255,0.6)] group"><i id="play-icon" class="bi bi-play-fill text-2xl group-hover:text-alter-bg"></i></button>
                        </div>
                        <span id="instrument-display" class="text-xs font-mono bg-alter-cyan text-black px-2 py-1 rounded font-bold shadow-[0_0_10px_#00E5FF]">CONCERT</span>
                    </div>
                    <div class="p-6 md:p-8">
                        <div class="mb-8 text-center">
                            <p class="text-xs text-gray-400 uppercase tracking-[0.3em] mb-2">Tonalidad Transpuesta</p>
                            <p id="transposed-key" class="text-6xl md:text-8xl font-black text-white filter drop-shadow-[0_0_15px_rgba(0,229,255,0.4)] transition-all hover:scale-105 duration-300"></p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-gray-900/40 rounded-lg p-4 border border-gray-700/50 hover:border-alter-cyan/30 transition-colors">
                                <p class="text-xs text-alter-cyan uppercase tracking-wider mb-3 font-bold">Progresión Base</p>
                                <div class="font-mono text-lg md:text-xl text-gray-200 overflow-x-auto whitespace-nowrap pb-2"><span id="transposed-chords"></span></div>
                            </div>
                            <div class="bg-gray-900/40 rounded-lg p-4 border border-gray-700/50 hover:border-alter-cyan/30 transition-colors">
                                <p class="text-xs text-alter-cyan uppercase tracking-wider mb-3 font-bold">Escala Improvisación</p>
                                <div class="font-mono text-lg md:text-xl text-gray-200"><span id="transposed-scale"></span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6 md:p-8 animate-fade-in" style="animation-delay: 0.1s;">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center"><i class="bi bi-music-note-list mr-3 text-alter-cyan"></i>Mapa de Notas</h3>
                    <div class="mb-6"><p class="text-xs font-semibold text-gray-400 uppercase mb-3 ml-1">Notas de Escala (Seguras)</p><div id="main-notes" class="flex flex-wrap gap-2"></div></div>
                    <div><p class="text-xs font-semibold text-gray-400 uppercase mb-3 ml-1">Cromatismos / Paso (Tensión)</p><div id="passing-notes" class="flex flex-wrap gap-2"></div></div>
                </div>

                <div class="glass-card rounded-xl p-6 md:p-8 animate-fade-in" style="animation-delay: 0.15s;">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center"><i class="bi bi-mic-fill mr-3 text-alter-cyan"></i>Letra & Progresión</h3>
                    <div class="bg-gray-900/40 rounded-lg p-6 border border-gray-700/50 overflow-x-auto max-h-[500px] overflow-y-auto custom-scrollbar">
                        <pre id="lyrics-content" class="font-mono text-sm md:text-base text-gray-300 whitespace-pre-wrap leading-relaxed"></pre>
                    </div>
                </div>
                
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in" style="animation-delay: 0.2s;">
                    <div class="glass-card rounded-xl p-6 border-l-4 border-l-alter-cyan">
                        <h3 class="text-lg font-bold text-white mb-2 flex items-center"><i class="bi bi-guitar mr-2"></i>Acorde Tónica (Guitarra)</h3>
                        <p class="text-xs text-gray-400 mb-4">Posición: <span id="guitar-chord-name" class="font-bold text-alter-cyan text-base ml-1"></span></p>
                        <div class="w-full max-w-xs mx-auto py-2"><svg id="guitar-diagram-svg" viewBox="0 0 200 150" class="w-full h-auto drop-shadow-[0_0_10px_rgba(0,229,255,0.2)]" xmlns="http://www.w3.org/2000/svg"></svg></div>
                    </div>
                    <div class="glass-card rounded-xl p-6 border-l-4 border-l-purple-500">
                        <h3 class="text-lg font-bold text-white mb-2 flex items-center"><i class="bi bi-keyboard mr-2"></i>Acorde Tónica (Teclado)</h3>
                        <p class="text-xs text-gray-400 mb-4">Voicing: <span id="piano-chord-name" class="font-bold text-alter-cyan text-base ml-1"></span></p>
                        <div class="w-full max-w-sm mx-auto py-2"><svg id="piano-diagram-svg" viewBox="0 0 350 120" class="w-full h-auto drop-shadow-[0_0_10px_rgba(0,229,255,0.2)]" xmlns="http://www.w3.org/2000/svg"></svg></div>
                    </div>
                </div>
                
                                
                
                <div class="glass-card rounded-xl p-6 md:p-8 border-l-4 border-l-yellow-500 animate-fade-in" style="animation-delay: 0.25s;">
                    <h3 class="text-lg font-bold mb-3 text-yellow-500 uppercase tracking-wider"><i class="bi bi-lightbulb-fill mr-2"></i>Data de Ejecución</h3>
                    <p id="execution-advice" class="text-gray-300 leading-relaxed font-mono text-sm md:text-base"></p>
                    <div id="critical-chord-section" class="mt-4 pt-4 border-t border-gray-700 hidden">
                        <p class="text-xs text-red-400 font-bold uppercase mb-1 flex items-center"><i class="bi bi-exclamation-triangle-fill mr-2"></i>Punto Crítico</p>
                        <p id="critical-chord-advice" class="text-sm font-mono bg-red-900/20 text-red-100 p-3 rounded border border-red-500/30"></p>
                    </div>
                </div>
            </div>

            <div id="initial-message" class="glass-card p-12 text-center text-gray-500 rounded-xl animate-fade-in">
                <i class="bi bi-vinyl-fill text-6xl mb-6 block text-gray-700/50"></i>
                <p class="text-lg font-medium">Selecciona una canción y ajusta tu instrumento para cargar la data.</p>
            </div>
        </div>
    </main>

    <footer class="relative z-10 py-8 mt-12 border-t border-gray-800 bg-gray-900/80 backdrop-blur-md">
        <div class="container mx-auto text-center">
            <p class="text-gray-600 text-xs uppercase tracking-widest">© 2025 Alter.Lab | Generative Art & Code</p>
        </div>
    </footer>

    <script>
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const SCALE_STEPS = { 'Jónica':[0,2,4,5,7,9,11], 'Eólica':[0,2,3,5,7,8,10], 'Dórica':[0,2,3,5,7,9,10], 'Armónica':[0,2,3,5,7,8,11], 'Pentatónica':[0,3,5,7,10], 'Mayor':[0,2,4,5,7,9,11], 'Mixolidia':[0,2,4,5,7,9,10], 'Blues':[0,3,5,6,7,10], 'Natural':[0,2,4,5,7,9,11], 'Lidia':[0,2,4,6,7,9,11] };
        const CHORD_INTERVALS = { 'm':[0,3,7], 'maj7':[0,4,7,11], 'm7':[0,3,7,10], '7':[0,4,7,10], 'M':[0,4,7], 'dim':[0,3,6], 'sus4':[0,5,7], 'add9':[0,4,7,14] };
        const GUITAR_TUNING = [4, 9, 2, 7, 11, 4];

        // BASE DE DATOS ACTUALIZADA CON LETRAS DEL CSV
        const SONGS_DATA = {
            'aint-no-sunshine': { title: "Ain't no sunshine", concertKey: 'Am', baseChords: 'Am–Em–G–Am', improvScale: 'A Menor Pentatónica', advice: 'El E7 (V) es tensión pura. Usa A Armónica ahí.', criticalChord: 'Em7', chordType: 'm', steps: SCALE_STEPS['Pentatónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735908/Bill_Withers_-_Ain_t_No_Sunshine_t94x1j.flac', lyrics: `[Am]Ain't no sunshine [Em]when she's [G]gone [Am]It's not warm [Em]when she's [G]away [Am]Ain't no sunshine [Em]when she's [G]gone And she's [Dm]always gone too long Any[Am]time she goes a[Am]way [Am]Wonder this time [Em]where she's [G]gone [Am]Wonder if she's [Em]gone to [G]stay [Am]Ain't no sunshine [Em]when she's [G]gone And this [Dm]house just ain't no home Any[Am]time she goes a[Am]way (Interludio: I know, I know...) [Am]Ain't no sunshine [Em]when she's [G]gone...` },
            'baby-come-back': { title: 'Baby Come Back', concertKey: 'Cm', baseChords: 'Abmaj7–Gm7–Cm7–Fm7', improvScale: 'C Menor Natural', advice: 'Cuidado con la modulación en el estribillo. Soft Rock.', criticalChord: 'Abmaj7', chordType: 'maj7', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735920/Player_-_Baby_Come_Back_lnpmbf.flac', lyrics: `[Abmaj7]Spending all my [Gm7]nights, all my [Cm7]money going [Fm7]out on the town [Bb/C] [Abmaj7]Doing any[Gm7]thing just to [Cm7]get you off of my [Fm7]mind [Bb/C] [Abmaj7]But when the morning [Gm7]comes, I'm right [Cm7]back where I [Fm7]started again [Bb/C] [Abmaj7]Trying to for[Gm7]get you is [Cm7]just a waste of [Fm7]time [Bb/C] (Estribillo) [Abmaj7]Baby come [Gm7]back, any kind of [Cm7]fool could [Fm7]see [Gm7] [Fm7]There was [Gm7]something [Cm7]in [Fm7]everything about [Bb]you [Abmaj7]Baby come [Gm7]back, you can blame it [Cm7]all on [Fm7]me [Gm7] [Fm7]I was [Gm7]wrong and [Cm7]I [Fm7]just can't live with[Bb]out you` },
            'bad-moon-rising': { title: 'Bad Moon Rising', concertKey: 'D', baseChords: 'D–A–G', improvScale: 'D Pentatónica Mayor', advice: 'Rock simple. Articulación rítmica precisa.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735908/Creedence_Clearwater_Revival_-_Bad_Moon_Rising_uvsds2.flac', lyrics: `[D]I see the [A]bad moon [G]a-[D]rising [D]I see [A]trouble [G]on the [D]way [D]I see [A]earth[G]quakes and [D]lightning [D]I see [A]bad [G]times to[D]day (Estribillo) [G]Don't go around tonight Well it's [D]bound to take your life [A]There's a [G]bad moon on the [D]rise` },
            'band-on-the-run': { title: 'Band on the Run', concertKey: 'Am / C', baseChords: 'Am–G–F–C', improvScale: 'C Jónica', advice: 'Suite de 3 partes. Atento al cambio de mentalidad modal.', criticalChord: 'Fmaj7', chordType: 'm', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735917/Paul_McCartney_Wings_-_Band_On_The_Run_ouk572.flac', lyrics: `(Parte 1: Balada) [Am]Stuck inside these [G]four walls [F]Sent inside forever [C]more [Am]Never seeing no one [G]nice again [F]Like you, mama, you, mama, [C]you... (Parte 2: Rock) [Am]If I ever get out of here [D]Thought of giving it all away [D]To a registered charity [D]All I need is a pint a day... (Parte 3: Folk/Pop) [C]Well, the [Fmaj7]rain exploded with a [C]mighty crash as we [Fmaj7]fell into the [C]sun [C]And the [Fmaj7]first one said to the [C]second one there, I [Em]hope you're having [Am]fun [G]Band on the [C]run, [Fmaj7]band on the [C]run` },
            'black-magic-woman': { title: 'Black Magic Woman', concertKey: 'Dm', baseChords: 'Dm–Am–Gm–Dm', improvScale: 'D Armónica', advice: 'El A7 exige la escala Armónica (C#). Ritmo latino clave.', criticalChord: 'A7', chordType: 'm', steps: SCALE_STEPS['Armónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735904/Santana_-_Black_Magic_Woman_svhmye.flac', lyrics: `[Dm]Got a black magic [Am7]woman [Dm]Got a black magic [Am7]woman I got a [Dm]black magic [Am7]woman Got me so [Gm7]blind [Dm]Got a black magic [A7]woman She's [A7]trying to make a devil out of [Dm]me [Dm]Turn your back on me [Am7]baby... (Sigue estructura de Blues menor en D)` },
            'born-on-the-bayou': { title: 'Born on the Bayou', concertKey: 'E7', baseChords: 'E7–D–A', improvScale: 'E Blues', advice: 'Groove pantanoso. Mantener el E7 vibrante.', criticalChord: 'E7#9', chordType: '7', steps: SCALE_STEPS['Blues'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735904/Santana_-_Black_Magic_Woman_svhmye.flac', lyrics: `[E7]Now, when I was just a little boy [E7]Standin' to my Daddy's knee [E7]My poppa said, "Son, don't let the man get you [E7]Do what he done to me" [E7]'Cause he'll [D]get [A]you [E7]'Cause he'll [D]get [A]you now, now (Estribillo) [E7]And I can remember the fourth of July [E7]Runnin' through the backwood, bare [A7]And I can still hear my old hound dog barkin' [E7]Chasin' down a hoodoo there [E7]Chasin' down a [D]hoodoo [A]there [E7]Born on the bayou...` },
            'carry-that-weight': { title: 'Carry That Weight', concertKey: 'C', baseChords: 'C–G', improvScale: 'C Jónica', advice: 'Ritmo marcial. Unísono en el coro.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735870/The_Beatles_-_Carry_That_Weight_Remastered_2009_i3pd5k.flac', lyrics: `[C]Boy, you're gonna [G]carry that [C]weight Carry that [C]weight a [F]long [C]time [C]Boy, you're gonna [G]carry that [C]weight Carry that [C]weight a [F]long [C]time [Am7]I never give you my [Dm7]pillow [G7]I only send you my [C]invitations [Fmaj7]And in the middle of the [Bm7b5]celebrations [E7]I break [Am]down` },
            'coming-back-to-life': { title: 'Coming back to life', concertKey: 'C', baseChords: 'C–Fmaj7–Am–G', improvScale: 'C Mayor', advice: 'Sustain infinito. Intro en C, verso en G.', criticalChord: 'Fmaj7', chordType: 'M', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735879/Pink_Floyd_-_Coming_Back_to_Life_luo2kv.flac', lyrics: `(Intro Synth Pad C) [C]Where were you when [Fmaj7]I was burned and [Am]broken [F]While the days slipped [C]by [G]from my window watching [C]And where were you when [Fmaj7]I was hurt and [Am]helpless [Bb]Because the things you [F]say and the things you [C]do surround me [Am]While you were hanging your[F]self on some[G]one else's words [Am]Dying to believe in [Bb]what you [F]heard [Am]I was staring straight in[G]to the shining [C]sun` },
            'dont-let-me-down': { title: "Don't Let Me Down", concertKey: 'E', baseChords: 'E–F#m7', improvScale: 'E Mixolidia', advice: 'Clave: El paso B7 - C#m - A y la métrica irregular.', criticalChord: 'F#m7', chordType: 'M', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735898/The_Beatles_-_Don_t_Let_Me_Down_Remastered_2009_tkooln.flac', lyrics: `[E]Don't let me [F#m]down [F#m7/E] [E]Don't let me [F#m]down [F#m7/E] [E]Don't let me [F#m]down [F#m7/E] [E]Don't let me [F#m]down [E]Nobody ever loved me like [F#m]she does, [F#m7/E]oh, she does, [E]yeah, she does [E]And if somebody loved me like [F#m]she do me, [F#m7/E]oh, she do me, [E]yes, she does [E]I'm in [B]love for the [B7]first time [C#m]Don't you know it's [A]gonna last [E]It's a love that [B]lasts for[E]ever` },
            'dreams-fleetwood': { title: 'Dreams (Fleetwood Mac)', concertKey: 'F', baseChords: 'Fmaj7–G6', improvScale: 'F Lidio', advice: 'Sonido Jangle Pop. Mucha reverb.', criticalChord: 'G6', chordType: 'maj7', steps: SCALE_STEPS['Lidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735897/Fleetwood_Mac_-_Dreams_2001_Remaster_mrpopb.flac', lyrics: `[Fmaj7]Now here you go again, you say [G6]you want your freedom [Fmaj7]Well, who am I to keep you [G6]down [Fmaj7]It's only right that you should [G6]play the way you feel it [Fmaj7]But listen carefully to the [G6]sound of your loneliness (Estribillo) [Fmaj7]Like a heartbeat drives you [G6]mad In the [Fmaj7]stillness of remembering what you [G6]had [Fmaj7]And what you lost... [G6] [Fmaj7]And what you had... [G6]` },
            'dreams-cranberries': { title: 'Dreams (Cranberries)', concertKey: 'E', baseChords: 'E–A–B', improvScale: 'E Mayor', advice: 'Sólo dos acordes principales (E - A) todo el tema.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735898/The_Cranberries_-_Dreams_lnrcsg.flac', lyrics: `[E]Oh, my [A]life is changing every[B]day, in every possible [E]way [E]And oh, my [A]dreams, it's never quite as it [B]seems, never quite as it [E]seems [E]I know I've felt like this be[A]fore, but now I'm feeling it [B]even more Because it [E]came from you [E]Then I open up and [A]see, the person falling here is [B]me A different way to [E]be` },
            'everybody-wants-to-rule': { title: 'Everybody Wants to Rule', concertKey: 'D', baseChords: 'D–G/D', improvScale: 'D Mixolidia', advice: 'El riff es D - G/D. El estribillo va al relativo menor.', criticalChord: 'G/D', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735896/Tears_For_Fears_-_Everybody_Wants_To_Rule_The_World_zuyf4k.flac', lyrics: `[D]Welcome to your [G/D]life, there's no turning [D]back [G/D] [D]Even while we [G/D]sleep, we will find [D]you [G/D] [Em]Acting on your [F#m]best behaviour, [G]turn your back on [F#m]Mother Nature [Em]Everybody [F#m]wants to [G]rule the [D]world` },
            'eye-in-the-sky': { title: 'Eye in the Sky', concertKey: 'Bm', baseChords: 'Bm–G–D–F#m', improvScale: 'D Mayor', advice: 'Pulso constante. La armonía es muy diatónica en B menor.', criticalChord: 'Gm', chordType: 'm', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735897/The_Alan_Parsons_Project_-_Eye_In_The_Sky_kwunpj.flac', lyrics: `[Bm]Don't think sorry's [G]easily said [Bm]Don't try turning [G]tables instead [Bm]You've taken all my [G]chances and there's nowhere [Em]left to [Bm]hide [Bm]Believe me I'm looking from the [G]other [D]side (Estribillo) [D]I am the [F#m]eye in the sky, [G]looking at you, [Em]I can read your [Bm]mind [D]I am the [F#m]maker of rules, [G]dealing with fools, [Em]I can cheat you [Bm]blind` },
            'fortunate-son': { title: 'Fortunate Son', concertKey: 'G', baseChords: 'G–F–C–G', improvScale: 'G Mixolidia', advice: 'Rock clásico con bVII (F) para sabor mixolidio/blues.', criticalChord: 'F', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735883/Creedence_Clearwater_Revival_-_Fortunate_Son_f3zmx2.flac', lyrics: `[G]Some folks are born [F]made to wave the [C]flag [C]Ooh, they're red, white and [G]blue [G]And when the band plays [F]"Hail to the [C]chief" [C]Ooh, they point the cannon at [G]you, Lord (Estribillo) [G]It ain't me, [D]it ain't me [C]I ain't no senator's [G]son, son [G]It ain't me, [D]it ain't me [C]I ain't no fortunate [G]one, no` },
            'get-back': { title: 'Get Back', concertKey: 'A', baseChords: 'A–G–D', improvScale: 'A Mixolidia', advice: 'El ritmo de batería "gallop" y el G (bVII) son clave.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735878/The_Beatles_-_Get_Back_Remastered_2009_hlcyh6.flac', lyrics: `[A]Jojo was a man who [A7]thought he was a loner [D]But he knew it wouldn't [A]last [A]Jojo left his home in [A7]Tucson, Arizona [D]For some California [A]grass (Estribillo) [A]Get back, [A7]get back [D]Get back to where you once be[A]longed [G] [D] [A]Get back, [A7]get back [D]Get back to where you once be[A]longed` },
            'golden-slumbers': { title: 'Golden Slumbers', concertKey: 'Am / C', baseChords: 'Am7–Dm–G7–C', improvScale: 'C Jónica', advice: 'Balada de piano muy lírica.', criticalChord: 'E7', chordType: 'M', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735861/The_Beatles_-_Golden_Slumbers_Remastered_2009_eoqjzx.flac', lyrics: `[Am7]Once there was a way [Dm]to get back homeward [G7]Once there was a way [C]to get back home [E7]Sleep pretty darling, [Am]do not [Dm]cry [G7]And I will sing a lulla[C]by [C]Golden [F]slumbers [C]fill your [E7]eyes [Am]Smiles a[Dm]wake you [G7]when you [C]rise [E7]Sleep pretty darling, [Am]do not [Dm]cry [G7]And I will sing a lulla[C]by` },
            'gypsy-queen': { title: 'Gypsy Queen', concertKey: 'D', baseChords: 'D–C–G/B–A', improvScale: 'D Mixolidia', advice: 'Principalmente instrumental. Improvisación modal.', criticalChord: 'D', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735878/Santana_-_Black_Magic_Woman___Gypsy_Queen_xlslzw.flac', lyrics: `(Instrumental - Jam sobre Am y Dm) (Cierre de Black Magic Woman) [Dm]Gypsy [Am]Queen [Gm]She's a [Dm]gypsy [A7]queen [Dm]She's a [Am]gypsy [Gm]queen [Dm] [Dm]Got a [Am]spell on [Gm]me [Dm]` },
            'here-today': { title: 'Here Today', concertKey: 'G', baseChords: 'G–Bm–C–F', improvScale: 'G Mayor', advice: 'Acústica. Cambios sutiles entre mayor y relativo menor.', criticalChord: 'C#dim7', chordType: 'maj7', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735862/Paul_McCartney_-_Here_Today_Remixed_2015_r0bchh.flac', lyrics: `[G]And if I [Bm]say I really [Em]knew you well, [A7]what would your answer be? [G]If you were [Bm]here to[C]day [D] [G] [G]And if I [Bm]say I really [Em]loved you [A7]and I'm glad you came along [G]If you were [Bm]here to[C]day [D] [G] [Cm]For you were in my [G]song [G] [Cm]Here to[G]day` },
            'hold-the-line': { title: 'Hold the Line', concertKey: 'F#m', baseChords: 'F#m–C#m–D–E', improvScale: 'F# Menor', advice: 'Riff de piano en tresillos. Acordes con bajos descendentes.', criticalChord: 'C#m', chordType: 'm', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735879/TOTO_-_Hold_the_Line_ojsxff.flac', lyrics: `[F#m]It's not in the way that you [C#m]hold me [F#m]It's not in the way you [D]say you [E]care [F#m]It's not in the way you've [C#m]been treating my friends [F#m]It's not in the way that you [D]stayed 'till the [E]end (Estribillo) [F#m]Hold the line, [A]love isn't [D]always on [E]time [F#m]Hold the line, [A]love isn't [D]always on [E]time [F#m]Hold the line, [A]love isn't [D]always on [E]time` },
            'hotel-california': { title: 'Hotel California', concertKey: 'Bm', baseChords: 'Bm–F#7–A–E', improvScale: 'B Armónica', advice: 'Progresión icónica. El F#7 (V) usa A#.', criticalChord: 'F#7', chordType: 'm', steps: SCALE_STEPS['Armónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735875/Eagles_-_Hotel_California_2013_Remaster_u1bdcw.flac', lyrics: `[Bm]On a dark desert [F#7]highway, cool wind in my [A]hair [E]Warm smell of co[G]litas, rising up through the [D]air [Em]Up ahead in the [F#7]distance, I saw a shimmering [Bm]light [Bm]My head grew heavy and my [F#7]sight grew dim, I had to stop for the [A]night (Estribillo) [G]Welcome to the [D]Hotel Cali[F#7]fornia Such a [Bm]lovely place (such a lovely place) Such a [Bm7]lovely face [G]Plenty of room at the [D]Hotel Cali[Em]fornia Any [F#7]time of year (any time of year), you can find it [Bm]here` },
            'in-my-life': { title: 'In my life', concertKey: 'A', baseChords: 'A–E–F#m–Dm', improvScale: 'A Jónica', advice: 'El Dm (iv) prestado en el coro es la firma armónica.', criticalChord: 'Dm', chordType: 'M', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735861/The_Beatles_-_In_My_Life_Remastered_2009_snplpd.flac', lyrics: `[A]There are [E]places [F#m]I'll re[A7]member [D]All my [Dm]life, though [A]some have changed [A]Some forever, [E]not for [F#m]better [A7] [D]Some have [Dm]gone and [A]some remain [F#m]All these [D]places had their [G]moments [A]With lovers and friends I [F#m]still can recall [F#m]Some are [B7]dead and some are [D]living [Dm]In my [A]life, I've [E]loved them [A]all` },
            'just-the-two-of-us': { title: 'Just the two of us', concertKey: 'C', baseChords: 'Dbmaj7–C7–Fm7', improvScale: 'C Jónica', advice: 'El Ebm7 es un paso cromático de lujo. Jazz R&B.', criticalChord: 'C7', chordType: 'maj7', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735874/Grover_Washington_Jr._-_Just_the_Two_of_Us_tt9tu8.flac', lyrics: `[Cmaj7]I see the crystal [B7]raindrops fall [Em7]And the beauty of it [Ebm7] [Dm7]all Is when the [G7]sun comes shining [Cmaj7]through [Cmaj7]To make those rainbows [B7]in my mind [Em7]When I think of you some[Ebm7] [Dm7]time And I want to [G7]spend some time with [Cmaj7]you (Estribillo) [Cmaj7]Just the two [B7]of us [Em7]We can [Ebm7]make it [Dm7]if we [G7]try [Cmaj7]Just the two [B7]of us [Em7]Just the [Ebm7]two of [Dm7]us [G7]` },
            'mala-bad-bunny': { title: 'Mala (Vete)', concertKey: 'Cm', baseChords: 'Cm–Ab–Eb–Bb', improvScale: 'C Menor Natural', advice: 'Loop: Cm - Ab - Eb - Bb. Simpleza armónica.', criticalChord: 'Ab', chordType: 'm', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735920/America_-_Tin_Man_wjt4sg.flac', lyrics: `[Cm]Ella es mala, [Ab]tiene fuego [Eb]Ella es una [Bb]diabla [Cm]Si me mira, [Ab]yo me pego [Eb]Y ella no se [Bb]cala [Cm]Ojos café y un [Ab]cuerpo de modelo, espectacular [Eb]No sé qué fue pero [Bb]noté [Cm]Usted tiene el pa[Ab]quete completo y me hipno[Eb]ticé [Bb] [Cm]Mala, mala, mala, [Ab]mala y peligrosa [Eb]Tiene una mirada sen[Bb]sual y una carita hermosa` },
            'michelle': { title: 'Michelle', concertKey: 'F', baseChords: 'F–Fm–Bb7', improvScale: 'F Mayor', advice: 'Uso magistral del intercambio modal (Fm en el verso).', criticalChord: 'C#dim7', chordType: 'M', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735860/The_Beatles_-_Michelle_Remastered_2009_kxgxcn.flac', lyrics: `[F]Michelle, [Bbm7]ma belle [Eb6]These are words that [Ddim7]go together [C7]well [C7]My Mi[F]chelle [F]Michelle, [Bbm7]ma belle [Eb6]Sont des mots qui [Ddim7]vont très bien en[C7]semble [C7]Très bien en[F]semble [Fm]I love you, I love you, I love you [Ab7]That's all I want to [Db]say [C7]Until I find a [Fm]way I will [Fm]say the [Fm7]only [Fm6]words I [Bbm]know that [C7]you'll under[F]stand` },
            'overkill': { title: 'Overkill', concertKey: 'D', baseChords: 'D–A–C–G', improvScale: 'D Mixolidia', advice: 'Acordes sus4 crean la tensión nocturna. Bajo sincopado.', criticalChord: 'C', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735934/Men_At_Work_-_Overkill_kwvcxn.flac', lyrics: `[D]I can't get to [A]sleep [C]I think about the [G]implications [D]Of diving in too [A]deep [C]And possibly the [G]complications [D]Especially at [A]night [C]I worry over [G]situations [D]I know will be all [A]right [C]Perhaps it's just i[G]magination (Estribillo) [Bm]Day [Asus4]after [G]day it reappe[A]ars [Bm]Night [Asus4]after [G]night my heartbeat shows the [F#sus4] [F#]fear [Bm]Ghosts [Asus4]appear and [G]fade a[A]way [Bm]Alone [Asus4]between the [G]sheets [F#sus4] [F#]only brings exasperation` },
            'quien-fuera-bunkers': { title: 'Quien Fuera', concertKey: 'G', baseChords: 'G–Em–C–D', improvScale: 'G Mayor', advice: 'Versos en Mayor, Coro en Menor. Rock vibrante.', criticalChord: 'B7', chordType: 'm', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735933/Los_Bunkers_-_Qui%C3%A9n_Fuera_nriiye.flac', lyrics: `(Verso - A Mayor) [A]Estoy buscando una pa[F#m]labra [A]En el umbral de tu mis[F#m]terio [D]Quién fuera Alí Ba[Bm]bá [Bm]Quién fuera el mítico Sim[C#m]bad [D]Quién fuera un poderoso sor[E]tilegio [E]Quién fuera encanta[A]dor (Estribillo - A Menor) [Am]Quién [G]fuera [C]sol [F]Para entrar por tu [E7]ventana [Am]Quién [G]fuera [C]mar [F]Para mojar tu [E7]cama [Am]Quién [G]fuera [C]sol...` },
            'smooth-operator': { title: 'Smooth Operator', concertKey: 'Dm', baseChords: 'Dm7–Am7–Gm7', improvScale: 'D Dórica', advice: 'El bajo lleva la melodía. Sophisti-pop elegante.', criticalChord: 'Gm7', chordType: 'm7', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735926/Sade_-_Smooth_Operator_2011_Remastered_hxznit.flac', lyrics: `[Dm7]Diamond life, [Am7]lover boy [Dm7]He move in space with [Am7]minimum waste and [Gm7]maximum joy [Gm7]City lights and [Am7]business nights [Dm7]When you require [Am7]streetcar desire for [Gm7]higher heights [Dm7]No place for be[Am7]ginners or [Gm7]sensitive hearts [Am7] [Dm7]Sentiment is [Am7]left to [Gm7]chance [Dm7]No place to be [Am7]ending but [Gm7]somewhere to start [Dm7]Smooth [Am7]operator [Gm7]Smooth [Am7]operator` },
            'shape-of-my-heart': { title: 'Shape of my heart', concertKey: 'F#m', baseChords: 'F#m–E6–D6–C#7', improvScale: 'F# Eólica', advice: 'Arpegio complejo. C#7sus4 dominante.', criticalChord: 'C#7', chordType: 'm', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735927/Sting_-_Shape_Of_My_Heart_llbb9e.flac', lyrics: `[F#m]He deals the [E6]cards as a [D6]meditation [C#sus4]And those he [C#7]plays never sus[F#m]pect [D]He doesn't [A]play for the [E]money he wins [D]He doesn't [C#7]play for res[F#m]pect (Estribillo) [D]I know that [A]the spades are the [E]swords of a soldier [D]I know that [A]the clubs are weapons of [E]war [D]I know that [A]diamonds mean [E]money for this art [D]But that's not the [C#7]shape of my [F#m]heart` },
            'sirius': { title: 'Sirius', concertKey: 'Am', baseChords: 'Bm–G', improvScale: 'A Menor', advice: 'Instrumental. Delay en corcheas con puntillo en el Clavinet.', criticalChord: 'G', chordType: 'm', steps: SCALE_STEPS['Eólica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735919/The_Alan_Parsons_Project_-_Sirius_d84rn3.flac', lyrics: `(Instrumental - Clavinet/Synth Riff) [Bm] (Pedal) [G] [Fmaj7] [E7] (Crescendo y transición a "Eye in the Sky")` },
            'the-end': { title: 'The End', concertKey: 'A / C', baseChords: 'A–D–C–F', improvScale: 'A Blues', advice: 'Solo de batería -> Solos de guitarra (A Blues) -> Piano Final (C).', criticalChord: 'F', chordType: 'M', steps: SCALE_STEPS['Jónica'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735910/The_Beatles_-_The_End_Remastered_2009_iu8sii.flac', lyrics: `(Solos de Guitarra en A7 Blues) (Piano Entrada) [C]And in the [G]end The [F]love you [C]take Is [Dm]equal [G]to the love [C]you make. [Dm] [Em] [F] [G] [A] (Fade out)` },
            'tin-man': { title: 'Tin Man', concertKey: 'G', baseChords: 'Gmaj7–Cmaj7', improvScale: 'G Jónica', advice: 'Acordes maj7 esenciales. El paso Gmaj7 a Cmaj7 es todo el verso.', criticalChord: 'Cmaj7', chordType: 'maj7', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735920/America_-_Tin_Man_wjt4sg.flac', lyrics: `[Gmaj7]Sometimes late when things are [Cmaj7]real [Gmaj7]And people share the gift of gab be[Cmaj7]tween themselves [Gmaj7]Some are quick to take the [Cmaj7]bait [Gmaj7]And catch the perfect prize that waits a[Cmaj7]mong the shells (Estribillo) [Em7]But Oz never did give nothing to the [Gmaj7]Tin Man [Gmaj7]That he didn't, didn't already [Bm7]have And [Cmaj7]Cause never was the reason for the [Bm7]evening Or the [Cmaj7]tropic of Sir Gala[Gmaj7]had (Puente) [C/D]So [D7]please believe in me...` },
            'up-around-the-bend': { title: 'Up Around the Bend', concertKey: 'D', baseChords: 'D–A–G', improvScale: 'D Mayor Pentatónica', advice: 'Riff de guitarra en D. Shuffle energético.', criticalChord: 'A7', chordType: 'M', steps: SCALE_STEPS['Mayor'], audioUrl: 'https://res.cloudinary.com/dmhdcqlqu/video/upload/v1764735873/Creedence_Clearwater_Revival_-_Up_Around_The_Bend_qnktfe.flac', lyrics: `[D]There's a place up ahead and I'm [A]goin' [A]Just as fast as my feet can [D]fly [D]Come away, come away if you're [A]goin' [A]Leave the sinking ship be[D]hind (Estribillo) [G]Come on the rising [D]wind, [G]We're goin' up around the [A]bend [A]Ooh! [D]` }
        };

        function getNoteIndex(note) { let baseNote = note.replace(/[^A-G#♭♯b]/g, '').trim().replace('♭', 'b').replace('♯', '#'); baseNote = {'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'}[baseNote] || baseNote; return NOTES.indexOf(baseNote); }
        function transposeNote(note, semitones) { 
            const baseNote = note.replace(/[^A-G#♭♯b]/g, '').trim(); 
            const suffix = note.substring(baseNote.length); 
            let startIndex = getNoteIndex(baseNote); 
            if (startIndex === -1) return note; 
            let newIndex = (startIndex + semitones) % 12; if (newIndex < 0) newIndex += 12; 
            let newNote = NOTES[newIndex]; 
            if (note.includes('b') || note.includes('♭') || ['F','Bb','Eb','Ab','Db'].includes(newNote)) { newNote = {'A#':'Bb','C#':'Db','D#':'Eb','F#':'Gb','G#':'Ab'}[newNote] || newNote; }
            return newNote + suffix; 
        }
        function generateChordNotes(rootNote, chordType, semitonesTranspose) {
            const rootIndex = getNoteIndex(rootNote);
            const intervals = CHORD_INTERVALS[chordType] || CHORD_INTERVALS['M'];
            if (rootIndex === -1) return [];
            return intervals.map(interval => {
                const noteIndex = (rootIndex + interval + semitonesTranspose) % 12;
                return NOTES[noteIndex];
            });
        }
        function generateGuitarDiagram(chordNotes) {
            const SVG_WIDTH = 200, SVG_HEIGHT = 150, NUM_STRINGS = 6, NUM_FRETS = 4;
            const FRET_WIDTH = SVG_WIDTH / (NUM_FRETS + 1), STRING_SPACING = (SVG_HEIGHT - 20) / (NUM_STRINGS - 1);
            let svgContent = `<rect x="5" y="10" width="${FRET_WIDTH/2}" height="${SVG_HEIGHT - 20}" class="nut" />`;
            for (let i = 0; i <= NUM_FRETS; i++) svgContent += `<line x1="${5+(FRET_WIDTH/2)+i*FRET_WIDTH}" y1="10" x2="${5+(FRET_WIDTH/2)+i*FRET_WIDTH}" y2="${SVG_HEIGHT - 10}" class="fret-line" />`;
            for (let i = 0; i < NUM_STRINGS; i++) svgContent += `<line x1="5" y1="${10+i*STRING_SPACING}" x2="${SVG_WIDTH-5}" y2="${10+i*STRING_SPACING}" class="string" />`;
            for (let s = 0; s < NUM_STRINGS; s++) {
                const openIdx = GUITAR_TUNING[s], sY = 10 + s * STRING_SPACING;
                for (let f = 1; f <= NUM_FRETS; f++) {
                    const fretNote = NOTES[(openIdx + f) % 12];
                    if (chordNotes.some(cn => getNoteIndex(cn) === getNoteIndex(fretNote))) svgContent += `<circle cx="${(f*FRET_WIDTH)+5}" cy="${sY}" r="6" class="note-dot" />`;
                }
            }
            return svgContent;
        }
        function generatePianoDiagram(chordNotes) {
            const pianoMap = [{n:'C',t:'w'},{n:'C#',t:'b'},{n:'D',t:'w'},{n:'D#',t:'b'},{n:'E',t:'w'},{n:'F',t:'w'},{n:'F#',t:'b'},{n:'G',t:'w'},{n:'G#',t:'b'},{n:'A',t:'w'},{n:'A#',t:'b'},{n:'B',t:'w'},{n:'C',t:'w'},{n:'C#',t:'b'}];
            let svgContent = '', wIdx = 0;
            pianoMap.forEach(k => { if(k.t==='w') { svgContent += `<rect x="${wIdx*25}" y="0" width="25" height="100" class="${chordNotes.some(cn=>getNoteIndex(cn)===getNoteIndex(k.n))?'highlight-key':'white-key'}" />`; wIdx++; } });
            wIdx = 0;
            pianoMap.forEach(k => { if(k.t==='w') wIdx++; else svgContent += `<rect x="${(wIdx-1)*25+17.5}" y="0" width="15" height="70" class="${chordNotes.some(cn=>getNoteIndex(cn)===getNoteIndex(k.n))?'highlight-key':'black-key'}" />`; });
            return svgContent;
        }
        function generateScaleNotes(rootNote, steps, semitones) {
            const rootIndex = getNoteIndex(rootNote); if (rootIndex === -1) return { main:[], passing:[] };
            const transposedNotes = NOTES.map((n, i) => NOTES[(i + semitones) % 12]);
            const mainNotes = steps.map(step => transposedNotes[(rootIndex + step + semitones) % 12]);
            return { main: mainNotes, passing: transposedNotes.filter(n => !mainNotes.includes(n)) };
        }
        function transposeLyrics(lyrics, semitones) {
            return lyrics.replace(/\[(.*?)\]/g, (match, chord) => `<span class="text-alter-cyan font-bold">[${transposeNote(chord, semitones)}]</span>`);
        }
        
        function getTransposedData(data, instrument) {
            let semitones = instrument === 'Bb' ? 2 : (instrument === 'Eb' ? 9 : 0);
            let instrumentName = instrument === 'Bb' ? 'SAX TENOR (B♭)' : (instrument === 'Eb' ? 'SAX ALTO (E♭)' : 'CONCIERTO (C)');
            
            const trNote = (n) => transposeNote(n.trim(), semitones);
            const trKey = data.concertKey.split('/').map(trNote).join(' / ');
            const rootKey = data.concertKey.split('/')[0].replace(/m(aj)?\d*/, '').trim();
            
            let trChords = data.baseChords.replace(/(\w[#♭b]?\/?\w[#♭b]?)(m|maj|sus|add|\d|M)?\d*/g, (m) => trNote(m));
            let trScale = data.improvScale.replace(/(\w[#♭b]?)\s/, (m, r) => trNote(r) + " ");
            let trCritical = data.criticalChord ? data.criticalChord.replace(/(\w[#♭b]?\/?\w[#♭b]?)(m|maj|sus|add|\d|M)?\d*/g, (m) => trNote(m)) : '';
            
            const scaleNotes = generateScaleNotes(data.improvScale.match(/(\w[#♭b]?)\s/)?.[1] || 'C', data.steps || SCALE_STEPS['Natural'], semitones);
            const tonicNotes = generateChordNotes(rootKey, data.chordType || 'M', semitones);
            
            return {
                key: trKey, chords: trChords, scale: trScale, critical: trCritical, instrumentName: instrumentName,
                scaleNotes: scaleNotes, tonicChordNotes: tonicNotes,
                tonicChordName: trNote(rootKey) + (data.chordType === 'm' ? 'm' : ''),
                lyrics: transposeLyrics(data.lyrics, semitones),
                audioUrl: data.audioUrl
            };
        }

        const audioPlayer = document.getElementById('audio-player'), playBtn = document.getElementById('play-btn'), playIcon = document.getElementById('play-icon');
        function toggleAudio() {
            if (audioPlayer.paused) { audioPlayer.play(); playIcon.classList.replace('bi-play-fill', 'bi-pause-fill'); playBtn.classList.add('playing-pulse'); }
            else { audioPlayer.pause(); playIcon.classList.replace('bi-pause-fill', 'bi-play-fill'); playBtn.classList.remove('playing-pulse'); }
        }

        function updateAnalysis() {
            const songKey = document.getElementById('song-selector').value, instrument = document.querySelector('input[name="instrument"]:checked').value;
            if (!songKey) return;
            const originalData = SONGS_DATA[songKey], data = getTransposedData(originalData, instrument);
            
            document.getElementById('initial-message').classList.add('hidden');
            document.getElementById('analysis-output').classList.remove('hidden');
            document.getElementById('instrument-display').textContent = data.instrumentName;
            document.getElementById('transposed-key').textContent = data.key;
            document.getElementById('transposed-chords').textContent = data.chords;
            document.getElementById('transposed-scale').textContent = data.scale;
            document.getElementById('lyrics-content').innerHTML = data.lyrics;
            document.getElementById('execution-advice').innerHTML = originalData.advice;
            document.getElementById('critical-chord-advice').innerHTML = `Atención: <strong>${data.critical}</strong>`;
            document.getElementById('critical-chord-section').classList.toggle('hidden', !data.critical);
            
            const mainDiv = document.getElementById('main-notes'), passDiv = document.getElementById('passing-notes');
            mainDiv.innerHTML = data.scaleNotes.main.map(n => `<span class="note-chip main-note">${n}</span>`).join('');
            passDiv.innerHTML = data.scaleNotes.passing.map(n => `<span class="note-chip passing-note">${n}</span>`).join('');
            
            document.getElementById('guitar-chord-name').textContent = data.tonicChordName;
            document.getElementById('piano-chord-name').textContent = data.tonicChordName;
            document.getElementById('guitar-diagram-svg').innerHTML = generateGuitarDiagram(data.tonicChordNotes);
            document.getElementById('piano-diagram-svg').innerHTML = generatePianoDiagram(data.tonicChordNotes);
            
            if (originalData.audioUrl && audioPlayer.src !== originalData.audioUrl) {
                audioPlayer.src = originalData.audioUrl; audioPlayer.load();
                playIcon.classList.replace('bi-pause-fill', 'bi-play-fill'); playBtn.classList.remove('playing-pulse', 'hidden');
            } else if (!originalData.audioUrl) { audioPlayer.pause(); playBtn.classList.add('hidden'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('song-selector');
            Object.keys(SONGS_DATA).sort().forEach(key => {
                const option = document.createElement('option'); option.value = key; option.textContent = SONGS_DATA[key].title; selector.appendChild(option);
            });
        });

        // 3D BACKGROUND
        const scene = new THREE.Scene(), camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight); document.getElementById('canvas-container').appendChild(renderer.domElement);
        const particles = new THREE.Points(new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(new Float32Array(2700).map(()=>(Math.random()-0.5)*25), 3)), new THREE.PointsMaterial({size:0.035, color:0x00E5FF, transparent:true, opacity:0.7}));
        scene.add(particles); scene.add(new THREE.Mesh(new THREE.IcosahedronGeometry(4,1), new THREE.MeshBasicMaterial({color:0x00E5FF, wireframe:true, transparent:true, opacity:0.07})));
        camera.position.z = 6;
        function animate() { requestAnimationFrame(animate); particles.rotation.y += 0.001; renderer.render(scene, camera); } animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
