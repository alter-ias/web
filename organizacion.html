<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Organización del Colectivo ALTER.IAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --green-board: #388E3C;
            --blue-grey-board: #546E7A;
            --white-lines: #F5F5F5;
            --yellow-note: #FFEB3B;
            --red-note: #EF5350;
            --light-blue-note: #A7D9FF;
            --note-shadow-color: #21215B;
            --delete-button-bg: #D32F2F;
            --delete-button-hover: #E57373; /* Más suave para el hover del delete board */
            --add-button-bg: #4CAF50;
            --add-button-hover: #45a049;
            --select-bg: #f8f8f8;
            --select-border: #ccc;
            --dark-background: #2C3E50;
            --text-on-dark: #ECF0F1;
            --title-color: #BDC3C7;
            --add-board-button-bg: #3498DB;
            --add-board-button-hover: #2980B9;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--dark-background);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            font-family: 'Fredoka', sans-serif;
            overflow-y: auto;
            padding-top: 20px;
            padding-bottom: 20px;
            color: var(--text-on-dark);
        }

        .main-header {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-on-dark);
            margin-bottom: 40px;
            text-align: center;
            padding: 0 20px;
            max-width: 1200px;
        }

        .boards-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .board-section {
            width: 90%;
            max-width: 1200px;
            margin-bottom: 50px;
            position: relative; /* Para posicionar el botón de cerrar tablero */
        }

        .board-section h2 {
            font-size: 2em;
            color: var(--title-color);
            margin-bottom: 20px;
            text-align: left;
            padding-left: 10px;
            display: flex; /* Para alinear el título y el botón */
            justify-content: space-between; /* Espacio entre título y botón */
            align-items: center;
        }

        .delete-board-button {
            background-color: var(--delete-button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            margin-left: 15px; /* Espacio respecto al título */
        }
        .delete-board-button:hover {
            background-color: var(--delete-button-hover);
            transform: scale(1.1);
        }


        .kanban-board-container {
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: auto auto 1fr;
            color: var(--white-lines);
        }

        .kanban-board.internal-theme { background-color: var(--green-board); }
        .kanban-board.projects-theme { background-color: var(--blue-grey-board); }

        .kanban-cell {
            padding: 15px;
            text-align: center;
            box-sizing: border-box;
            border-right: 2px solid var(--white-lines);
            border-bottom: 2px solid var(--white-lines);
        }

        .kanban-board > .kanban-cell:nth-child(5n) { border-right: none; }
        .kanban-board > .kanban-cell:nth-child(n + 11) { border-bottom: none; }

        .kanban-header {
            grid-row: 1;
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-task-controls-wrapper {
            grid-row: 2;
            grid-column: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            justify-content: center;
            background-color: inherit;
        }

        .empty-control-cell {
            grid-row: 2;
            background-color: inherit;
        }

        .kanban-content {
            grid-row: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            min-height: 150px;
            flex-grow: 1;
            position: relative;
        }

        .priority-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--select-border);
            border-radius: 5px;
            background-color: var(--select-bg);
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9em;
            color: #333;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000%22%20d%3D%22M287%2C114.7L158.4%2C243.3c-2.8%2C2.8-6%2C4.3-9.5%2C4.3s-6.7-1.5-9.5-4.3L5.4%2C114.7c-5.6-5.6-5.6-14.1%2C0-19.6s14.1-5.6%2C19.6%2C0l133.7%2C133.7l133.7-133.7c5.6-5.6%2C14.1-5.6%2C19.6%2C0s5.6%2C14.1%2C0%2C19.6L287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
            cursor: pointer;
            z-index: 1;
            position: relative;
        }
        .priority-select:focus {
            outline: 2px solid var(--add-button-bg);
            outline-offset: 1px;
        }

        .add-note-button {
            background-color: var(--add-button-bg);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .add-note-button:hover { background-color: var(--add-button-hover); }

        .sticky-note {
            width: 120px;
            height: 120px;
            position: relative;
            cursor: grab;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            box-shadow: 4px 4px 0px 0px var(--note-shadow-color),
                        2px 2px 5px rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.3;
        }
        .sticky-note:active {
            cursor: grabbing;
            transform: scale(1.05) !important;
            z-index: 100;
            box-shadow: 6px 6px 0px 0px var(--note-shadow-color),
                        4px 4px 8px rgba(0, 0, 0, 0.4);
        }
        .sticky-note.yellow { background-color: var(--yellow-note); }
        .sticky-note.red { background-color: var(--red-note); }
        .sticky-note.light-blue {
            background-color: var(--light-blue-note);
            color: #444;
        }
        .sticky-note.yellow .note-content { color: black; }

        .note-content {
            flex-grow: 1;
            text-align: left;
            color: inherit;
            outline: none;
            cursor: text;
            max-height: 75px;
            overflow-y: auto;
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .note-content[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #888;
            pointer-events: none;
        }

        .delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--delete-button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
            z-index: 10;
        }
        .sticky-note:hover .delete-button { opacity: 1; }
        .delete-button:hover {
            background-color: var(--delete-button-hover);
            transform: scale(1.1);
        }

        .rotate-0 { transform: rotate(0deg); }
        .rotate-1 { transform: rotate(2deg); }
        .rotate-2 { transform: rotate(-3deg); }
        .rotate-3 { transform: rotate(1deg); }
        .rotate-4 { transform: rotate(-1deg); }
        .rotate-5 { transform: rotate(4deg); }
        .rotate-6 { transform: rotate(-2.5deg); }
        .rotate-7 { transform: rotate(3.5deg); }
        .rotate-8 { transform: rotate(-1.5deg); }
        .rotate-9 { transform: rotate(2.8deg); }

        .sortable-ghost {
            opacity: 0.2;
            background-color: var(--white-lines) !important;
            border: 2px dashed var(--note-shadow-color);
        }
        .sortable-drag { opacity: 1; }

        .add-board-button-container {
            width: 90%;
            max-width: 1200px;
            margin-top: 20px;
            margin-bottom: 50px;
            display: flex;
            justify-content: center;
        }
        #add-new-board-button {
            background-color: var(--add-board-button-bg);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #add-new-board-button:hover {
            background-color: var(--add-board-button-hover);
        }

        @media (max-width: 768px) {
            .main-header { font-size: 2em; margin-bottom: 30px; }
            .board-section h2 { font-size: 1.7em; margin-bottom: 15px; }
            .kanban-board {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: auto;
            }
            .kanban-board > .kanban-header,
            .kanban-board > .add-task-controls-wrapper,
            .kanban-board > .empty-control-cell,
            .kanban-board > .kanban-content {
                grid-row: unset !important;
                grid-column: unset !important;
            }
            .kanban-board > .kanban-cell:nth-child(3n) { border-right: none; }
            .kanban-board > .kanban-cell:nth-last-child(-n+3) { border-bottom: none; }
            .add-task-controls-wrapper { grid-column: 1 / span 1 !important; }
            .empty-control-cell:not(:first-of-type) { display: none; }
            .kanban-header { font-size: 1.1em; padding: 15px 10px;}
            .sticky-note { width: 100px; height: 100px; padding: 8px;}
            .note-content { max-height: 60px;}
            .delete-button { width: 18px; height: 18px; font-size: 0.7em;}
            .add-task-controls-wrapper { max-width: 120px; }
            #add-new-board-button { font-size: 1em; padding: 10px 20px; }
        }

        @media (max-width: 480px) {
            .main-header { font-size: 1.5em; margin-bottom: 20px; }
            .board-section h2 { font-size: 1.4em; margin-bottom: 10px; }
            .kanban-board {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .kanban-cell {
                border-right: none !important;
                border-bottom: 2px solid var(--white-lines);
            }
            .kanban-board > .kanban-cell:last-child { border-bottom: none; }
            .add-task-controls-wrapper, .empty-control-cell { display: block; grid-column: 1 / -1 !important; }
            .kanban-header { font-size: 1em; padding: 10px; }
            .sticky-note { width: 90px; height: 90px; margin: 5px; padding: 6px;}
            .note-content { max-height: 50px; font-size: 0.8em; }
            .delete-button { width: 16px; height: 16px; font-size: 0.6em;}
            .add-task-controls-wrapper { max-width: 100%; }
            .priority-select { font-size: 0.8em; padding: 6px;}
            .add-note-button { font-size: 0.9em; padding: 8px;}
        }
    </style>
</head>
<body>
    <header class="main-header">
        <h1>TABLERO DE ORGANIZACIÓN DEL COLECTIVO ALTER.IAS</h1>
    </header>

    <div class="boards-container">
        <!-- Los tableros se generarán aquí por JavaScript o se cargarán desde localStorage -->
    </div>

    <div class="add-board-button-container">
        <button id="add-new-board-button">Añadir Nuevo Tablero de Proyecto</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const LOCAL_STORAGE_KEY = 'kanbanBoardState_ALTERIAS_v6'; // Nueva clave para asegurar limpieza
            let newBoardCounter = 0;
            const boardsContainer = document.querySelector('.boards-container');

            const rotationClasses = ['rotate-0', 'rotate-1', 'rotate-2', 'rotate-3', 'rotate-4', 'rotate-5', 'rotate-6', 'rotate-7', 'rotate-8', 'rotate-9'];

            function getRandomRotationClass() {
                return rotationClasses[Math.floor(Math.random() * rotationClasses.length)];
            }

            function saveBoardState() {
                const boardDataToSave = {
                    boards: [],
                    nextBoardCounter: newBoardCounter // Guardar el contador para IDs únicos
                };
                document.querySelectorAll('.board-section').forEach(boardSectionEl => {
                    const boardId = boardSectionEl.dataset.boardId;
                    const boardTitle = boardSectionEl.querySelector('h2 .board-title-text').innerText; // Obtener solo el texto del título
                    const themeClass = boardSectionEl.querySelector('.kanban-board').classList.contains('internal-theme') ? 'internal-theme' : 'projects-theme';
                    const columns = {};

                    boardSectionEl.querySelectorAll('.kanban-content').forEach(column => {
                        const columnId = column.dataset.columnId;
                        if (!columnId) return;
                        columns[columnId] = [];
                        column.querySelectorAll('.sticky-note').forEach(noteElement => {
                            const text = noteElement.querySelector('.note-content').innerText;
                            let color = 'yellow';
                            if (noteElement.classList.contains('red')) color = 'red';
                            else if (noteElement.classList.contains('light-blue')) color = 'light-blue';
                            columns[columnId].push({ text, color });
                        });
                    });
                    boardDataToSave.boards.push({ id: boardId, title: boardTitle, theme: themeClass, columns });
                });

                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(boardDataToSave));
                } catch (e) {
                    console.error("Error al guardar en localStorage:", e);
                }
            }


            function createStickyNote(text = '', color = 'yellow', isInitialLoad = false) {
                const note = document.createElement('div');
                note.classList.add('sticky-note', color, getRandomRotationClass());
                const content = document.createElement('div');
                content.classList.add('note-content');
                content.setAttribute('contenteditable', 'true');
                content.setAttribute('data-placeholder', 'Escribe aquí...');
                content.innerText = text;
                if (text === '' && !isInitialLoad) { setTimeout(() => content.focus(), 0); }

                content.addEventListener('blur', saveBoardState);
                content.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        content.blur();
                    }
                });

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.innerText = 'X';
                deleteButton.setAttribute('aria-label', 'Eliminar nota');
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('¿Estás seguro de que quieres eliminar esta nota?')) {
                        note.remove();
                        saveBoardState();
                    }
                });
                note.appendChild(deleteButton);
                note.appendChild(content);
                return note;
            }

            function initializeSortableForColumn(columnElement) {
                 if (!columnElement || !columnElement.dataset.columnId) return;
                 new Sortable(columnElement, {
                    group: 'kanban-notes',
                    animation: 150,
                    handle: '.sticky-note',
                    filter: '.delete-button',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    forceFallback: true,
                    fallbackOnBody: true,
                    swapThreshold: 0.65,
                    onEnd: function (evt) {
                        saveBoardState();
                    }
                });
            }

            function addEventListenersToControls(controlsWrapper) {
                const addButton = controlsWrapper.querySelector('.add-note-button');
                if (addButton) {
                    addButton.addEventListener('click', (e) => {
                        const currentControlsWrapper = e.target.closest('.add-task-controls-wrapper');
                        if (!currentControlsWrapper) return;

                        const targetColumnId = currentControlsWrapper.dataset.columnTarget;
                        const prioritySelect = currentControlsWrapper.querySelector('.priority-select');
                        const noteColor = prioritySelect ? prioritySelect.value : 'yellow';
                        const targetColumn = document.querySelector(`.kanban-content[data-column-id="${targetColumnId}"]`);

                        if (targetColumn) {
                            const newNote = createStickyNote('', noteColor, false);
                            targetColumn.appendChild(newNote);
                            newNote.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            saveBoardState();
                        }
                    });
                }
            }

            function createBoardElement(title, boardIdPrefix, themeClass, isNewBoard = false) {
                const boardSection = document.createElement('div');
                boardSection.classList.add('board-section');
                boardSection.dataset.boardId = boardIdPrefix;

                const boardTitleH2 = document.createElement('h2');
                const titleTextSpan = document.createElement('span'); // Para separar el texto del botón
                titleTextSpan.classList.add('board-title-text');
                titleTextSpan.innerText = title;
                boardTitleH2.appendChild(titleTextSpan);

                // Botón de eliminar tablero
                const deleteBoardBtn = document.createElement('button');
                deleteBoardBtn.classList.add('delete-board-button');
                deleteBoardBtn.innerHTML = '×'; // Símbolo X
                deleteBoardBtn.setAttribute('aria-label', 'Eliminar tablero');
                deleteBoardBtn.addEventListener('click', () => {
                    if (confirm(`¿Estás seguro de que quieres eliminar el tablero "${title}"? Esta acción no se puede deshacer.`)) {
                        boardSection.remove();
                        saveBoardState();
                    }
                });
                boardTitleH2.appendChild(deleteBoardBtn);
                boardSection.appendChild(boardTitleH2);


                const boardContainer = document.createElement('div');
                boardContainer.classList.add('kanban-board-container');
                boardSection.appendChild(boardContainer);

                const kanbanBoard = document.createElement('div');
                kanbanBoard.classList.add('kanban-board', themeClass);
                boardContainer.appendChild(kanbanBoard);

                const columnTitles = ["Lista de Pendientes", "Historias", "Por Hacer", "En Curso", "Completado"];
                const columnIdsSuffix = ["backlog", "story", "todo", "doing", "done"];

                columnTitles.forEach(colTitle => {
                    const headerCell = document.createElement('div');
                    headerCell.classList.add('kanban-cell', 'kanban-header');
                    headerCell.innerText = colTitle;
                    kanbanBoard.appendChild(headerCell);
                });

                columnIdsSuffix.forEach((idSuffix, index) => {
                    const cell = document.createElement('div');
                    cell.classList.add('kanban-cell'); // Aplicar la clase base

                    if (index === 0) {
                        cell.classList.add('add-task-controls-wrapper');
                        cell.dataset.columnTarget = `${boardIdPrefix}-${idSuffix}`;

                        const select = document.createElement('select');
                        select.classList.add('priority-select');
                        select.innerHTML = `
                            <option value="yellow">Importante</option>
                            <option value="red">Urgente</option>
                            <option value="light-blue">No Importante</option>
                        `;
                        cell.appendChild(select);

                        const addButton = document.createElement('button');
                        addButton.classList.add('add-note-button');
                        addButton.innerText = 'Añadir Tarea';
                        cell.appendChild(addButton);
                        addEventListenersToControls(cell);
                    } else {
                        cell.classList.add('empty-control-cell');
                    }
                    kanbanBoard.appendChild(cell);
                });

                columnIdsSuffix.forEach(idSuffix => {
                    const contentCell = document.createElement('div');
                    contentCell.classList.add('kanban-cell', 'kanban-content');
                    contentCell.dataset.columnId = `${boardIdPrefix}-${idSuffix}`;
                    kanbanBoard.appendChild(contentCell);
                    if (!isNewBoard) { // No inicializar sortable si es un tablero cargado (se hará después)
                        initializeSortableForColumn(contentCell);
                    }
                });
                return boardSection;
            }


            function loadBoardState() {
                try {
                    const savedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (savedStateJSON) {
                        const data = JSON.parse(savedStateJSON);
                        if (data && data.boards && Array.isArray(data.boards)) {
                            // Limpiar tableros existentes antes de cargar
                            boardsContainer.innerHTML = '';
                            newBoardCounter = data.nextBoardCounter || 0;

                            data.boards.forEach(boardData => {
                                const newBoardElement = createBoardElement(boardData.title, boardData.id, boardData.theme, false);
                                boardsContainer.appendChild(newBoardElement);

                                Object.keys(boardData.columns).forEach(columnId => {
                                    const columnElement = newBoardElement.querySelector(`.kanban-content[data-column-id="${columnId}"]`);
                                    if (columnElement) {
                                        boardData.columns[columnId].forEach(noteData => {
                                            const newNote = createStickyNote(noteData.text, noteData.color, true);
                                            columnElement.appendChild(newNote);
                                        });
                                    }
                                });
                                // Asegurar que Sortable se inicialice para todas las columnas de contenido
                                newBoardElement.querySelectorAll('.kanban-content').forEach(col => initializeSortableForColumn(col));
                            });
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("Error al cargar desde localStorage:", e);
                }
                return false;
            }

            function initializeDefaultBoards() {
                const initialBoardsData = [
                    { id: "internal", title: "Organización Interna", theme: "internal-theme", columnsData: [
                        { columnIdSuffix: "backlog", notes: [{ text: 'Planificar reunión semanal', color: 'yellow' }, { text: 'Revisar informes de gastos', color: 'red' }, { text: 'Actualizar manual de bienvenida', color: 'light-blue' }] },
                        { columnIdSuffix: "story", notes: [{ text: 'Como miembro, quiero un sistema de votación', color: 'red' }, { text: 'Como líder, quiero ver el progreso del equipo', color: 'yellow' }] },
                        { columnIdSuffix: "todo", notes: [{ text: 'Preparar agenda reunión próxima', color: 'yellow' }, { text: 'Recopilar feedback de encuestas', color: 'light-blue' }] },
                        { columnIdSuffix: "doing", notes: [{ text: 'Redactar comunicado interno', color: 'yellow' }, { text: 'Organizar archivo de documentos', color: 'red' }] },
                        { columnIdSuffix: "done", notes: [{ text: 'Reunión de planificación completada', color: 'yellow' }, { text: 'Base de datos de contactos actualizada', color: 'red' }] }
                    ]},
                    { id: "animations", title: "Proyectos: Animaciones", theme: "projects-theme", columnsData: [
                        { columnIdSuffix: "backlog", notes: [{ text: 'Nueva idea para corto animado', color: 'yellow' }, { text: 'Investigar software de render', color: 'light-blue' }] },
                        { columnIdSuffix: "story", notes: [{ text: 'Como cliente, quiero una intro animada para mi marca', color: 'red' }] },
                        { columnIdSuffix: "todo", notes: [{ text: 'Bocetar personajes 3D', color: 'yellow' }] },
                        { columnIdSuffix: "doing", notes: [{ text: 'Renderizando escena final', color: 'yellow' }] },
                        { columnIdSuffix: "done", notes: [{ text: 'Animación de logotipo completada', color: 'yellow' }] }
                    ]},
                    { id: "webpages", title: "Proyectos: Páginas Web", theme: "projects-theme", columnsData: [
                         { columnIdSuffix: "backlog", notes: [{ text: 'Investigar framework JS para web', color: 'red'}] },
                         { columnIdSuffix: "story", notes: [{ text: 'Como cliente, quiero una web que muestre mi portfolio', color: 'yellow' }] },
                         { columnIdSuffix: "todo", notes: [{ text: 'Bocetar diseño de homepage', color: 'yellow' }] },
                         { columnIdSuffix: "doing", notes: [{ text: 'Codificar módulo de búsqueda web', color: 'red' }] },
                         { columnIdSuffix: "done", notes: [{ text: 'Wireframes web aprobados', color: 'yellow' }] }
                    ]},
                    { id: "aiagents", title: "Proyectos: Agentes AI", theme: "projects-theme", columnsData: [
                        { columnIdSuffix: "backlog", notes: [{ text: 'Explorar APIs de generación de texto', color: 'yellow' }, { text: 'Como usuario, quiero un chatbot que responda preguntas frecuentes', color: 'yellow' }] },
                        { columnIdSuffix: "story", notes: [] },
                        { columnIdSuffix: "todo", notes: [{ text: 'Definir alcance del chatbot', color: 'light-blue' }] },
                        { columnIdSuffix: "doing", notes: [{ text: 'Entrenar modelo de NLU', color: 'yellow' }] },
                        { columnIdSuffix: "done", notes: [{ text: 'Diseño de diálogo para bot de ventas', color: 'red' }] }
                    ]}
                ];

                initialBoardsData.forEach(boardDef => {
                    const boardElement = createBoardElement(boardDef.title, boardDef.id, boardDef.theme, false);
                    boardsContainer.appendChild(boardElement);
                    boardDef.columnsData.forEach(colData => {
                        const columnContent = boardElement.querySelector(`.kanban-content[data-column-id="${boardDef.id}-${colData.columnIdSuffix}"]`);
                        if(columnContent){
                            colData.notes.forEach(note => {
                                columnContent.appendChild(createStickyNote(note.text, note.color, true));
                            });
                        }
                    });
                     // Asegurar que Sortable se inicialice para todas las columnas de contenido
                    boardElement.querySelectorAll('.kanban-content').forEach(col => initializeSortableForColumn(col));
                });
            }


            if (!loadBoardState()) {
                console.log("No hay estado guardado, poblando tableros iniciales por defecto.");
                initializeDefaultBoards();
                saveBoardState();
            } else {
                console.log("Estado del tablero cargado desde localStorage.");
                 // Los listeners de los controles se añaden al crear el elemento,
                 // y sortable se inicializa al final de loadBoardState o initializeDefaultBoards
            }


            const addNewBoardButton = document.getElementById('add-new-board-button');
            addNewBoardButton.addEventListener('click', () => {
                const boardTitle = prompt("Introduce el título para el nuevo tablero de proyecto:", "Nuevo Proyecto");
                if (boardTitle && boardTitle.trim() !== "") {
                    newBoardCounter = parseInt(localStorage.getItem('nextBoardCounter') || newBoardCounter) + 1;
                    localStorage.setItem('nextBoardCounter', newBoardCounter);

                    const boardIdPrefix = `newboard${newBoardCounter}`;
                    const newBoardElement = createBoardElement(boardTitle, boardIdPrefix, "projects-theme", true);
                    boardsContainer.appendChild(newBoardElement); // Añadir al contenedor principal
                    newBoardElement.querySelectorAll('.kanban-content').forEach(col => initializeSortableForColumn(col)); // Inicializar Sortable para el nuevo tablero
                    saveBoardState();
                }
            });
        });
    </script>
</body>
</html>
