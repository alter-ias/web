<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtros de Video V2 (Corregido)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { text-align: center; font-weight: 300; letter-spacing: 1px;}

        .controls {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            width: 90%;
            max-width: 800px;
            text-align: center;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 20px;
        }

        .btn-upload {
            border: 2px solid #00a8ff;
            color: #00a8ff;
            background-color: transparent;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        button.filter-btn {
            padding: 10px 18px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button.filter-btn:hover { background-color: #666; transform: translateY(-2px); }
        button.filter-btn.active { background-color: #00a8ff; box-shadow: 0 0 10px #00a8ff; }

        .canvas-container {
            position: relative;
            max-width: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #outputCanvas {
            max-width: 100%;
            display: block; /* Importante para evitar espacios extra */
            border-radius: 4px;
            background-color: #000;
        }

        /* Mensaje de estado por si algo falla */
        #statusMessage {
            color: #ff4757;
            margin-top: 10px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>

    <h1>Editor de Video IA (Estilo)</h1>

    <div class="controls">
        <div class="upload-btn-wrapper">
            <button class="btn-upload">游늭 Seleccionar Video</button>
            <input type="file" id="videoUpload" accept="video/mp4, video/webm, video/ogg">
        </div>
        
        <p>Selecciona un filtro:</p>
        <div class="filter-buttons" id="buttonContainer"></div>
        <div id="statusMessage"></div>
    </div>

    <div class="canvas-container">
        <canvas id="outputCanvas"></canvas>
    </div>

    <video id="sourceVideo" playsinline loop muted style="display:none;"></video>

    <script>
        const videoUpload = document.getElementById('videoUpload');
        const sourceVideo = document.getElementById('sourceVideo');
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d', { willReadFrequently: true });
        const buttonContainer = document.getElementById('buttonContainer');
        const statusMessage = document.getElementById('statusMessage');

        let currentFilterStr = 'Original';
        let animationId;
        let isProcessing = false;

        // --- DEFINICI칍N DE FILTROS ---
        const filters = {
            'Original': (data) => {}, // Pass through
            'Noir': (data) => {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    let val = gray > 100 ? 255 : 0;
                    data[i] = data[i+1] = data[i+2] = val;
                }
            },
            'Toxic': (data) => {
                 for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    let gray = (r + g + b) / 3;
                    if (gray < 85) { // Oscuro -> Verde Toxico
                         data[i] = 0; data[i+1] = 50; data[i+2] = 0;
                    } else if (gray < 170) { // Medio -> Magenta
                         data[i] = 200; data[i+1] = 0; data[i+2] = 200;
                    } else { // Claro -> Amarillo Neon
                         data[i] = 200; data[i+1] = 255; data[i+2] = 0;
                    }
                }
            },
            'Sketch': (data) => {
                for (let i = 0; i < data.length; i += 4) {
                    let avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    // Invertir colores para efecto negativo/sketch
                    let val = avg > 120 ? 240 : 20; 
                    data[i] = data[i+1] = data[i+2] = val; 
                }
            },
             'Matrix': (data) => {
                for (let i = 0; i < data.length; i += 4) {
                    let green = data[i+1];
                    data[i] = 0; // Sin rojo
                    data[i+1] = green * 1.5; // Potenciar verde
                    data[i+2] = 0; // Sin azul
                }
            }
        };

        // --- CREAR BOTONES ---
        for (const key in filters) {
            const btn = document.createElement('button');
            btn.innerText = key;
            btn.className = 'filter-btn';
            if(key === 'Original') btn.classList.add('active');
            
            btn.addEventListener('click', () => {
                currentFilterStr = key;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
            buttonContainer.appendChild(btn);
        }

        // --- L칍GICA DE CARGA Y REPRODUCCI칍N ---
        videoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            statusMessage.style.display = 'none';
            
            // Crear URL local
            const fileURL = URL.createObjectURL(file);
            sourceVideo.src = fileURL;
            
            // Forzar carga
            sourceVideo.load();
        });

        // Usamos 'canplay' que es m치s seguro que 'loadedmetadata'
        sourceVideo.addEventListener('canplay', function() {
            // Ajustar canvas al tama침o del video
            outputCanvas.width = sourceVideo.videoWidth;
            outputCanvas.height = sourceVideo.videoHeight;
            
            // Intentar reproducir
            const playPromise = sourceVideo.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // La reproducci칩n autom치tica comenz칩
                    if (!isProcessing) {
                        isProcessing = true;
                        processVideoFrame();
                    }
                })
                .catch(error => {
                    // Auto-play fue prevenido. 
                    console.error("Autoplay prevenido:", error);
                    statusMessage.innerText = "丘멆잺 El navegador bloque칩 el autoplay. Haz clic en la p치gina para iniciar.";
                    statusMessage.style.display = 'block';
                    
                    // Intentamos reproducir de nuevo si el usuario toca la pantalla
                    document.body.addEventListener('click', () => {
                         sourceVideo.play();
                         if (!isProcessing) {
                            isProcessing = true;
                            processVideoFrame();
                        }
                    }, { once: true });
                });
            }
        });

        // --- BUCLE DE PROCESAMIENTO ---
        function processVideoFrame() {
            if (sourceVideo.paused || sourceVideo.ended) {
                animationId = requestAnimationFrame(processVideoFrame);
                return;
            }

            // 1. Dibujar video en canvas
            ctx.drawImage(sourceVideo, 0, 0, outputCanvas.width, outputCanvas.height);

            // 2. Aplicar filtro
            if (currentFilterStr !== 'Original') {
                const frameData = ctx.getImageData(0, 0, outputCanvas.width, outputCanvas.height);
                const data = frameData.data;
                
                try {
                    filters[currentFilterStr](data);
                    ctx.putImageData(frameData, 0, 0);
                } catch (err) {
                    console.error("Error en filtro:", err);
                }
            }

            // 3. Siguiente frame
            animationId = requestAnimationFrame(processVideoFrame);
        }
    </script>
</body>
</html>
