<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Artimotion - Video Glitch Reactor</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
            transition: opacity 0.5s ease;
        }
        
        button {
            padding: 15px 40px; font-size: 18px; color: #0ff; background: transparent;
            border: 2px solid #0ff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,255,255,0.2); text-transform: uppercase; letter-spacing: 2px;
            margin: 10px; transition: all 0.3s;
        }
        button:hover { background: #0ff; color: #000; box-shadow: 0 0 50px rgba(0,255,255,0.8); }

        #ui-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 10; align-items: center;
        }

        /* Input de archivo oculto pero funcional */
        #file-input { display: none; }
        
        .label-upload {
            padding: 10px 20px; background: rgba(255, 0, 80, 0.2); 
            border: 1px solid #ff0050; color: #ff0050; border-radius: 30px; 
            cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase;
            transition: 0.3s;
        }
        .label-upload:hover { background: #ff0050; color: white; box-shadow: 0 0 15px #ff0050; }

        .lil-gui { --background-color: rgba(10, 10, 10, 0.9); }
    </style>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';
        import { GlitchPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/GlitchPass.js'; // Efecto extra
        import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.17.0/dist/lil-gui.esm.min.js';

        const params = {
            distortion: 3.5,     // Qu茅 tanto se deforma el video
            bloomStrength: 1.5,
            speed: 1.0,
            wireframe: false,
            micGain: 5.0,
            colorSpeed: 0.5
        };

        // --- AUDIO SYSTEM (RAW) ---
        class AudioEngine {
            constructor() {
                this.ctx = null; this.analyser = null; this.data = null; this.isReady = false;
            }
            async init() {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    // Importante: Sin cancelaci贸n de eco para captar m煤sica cruda
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, autoGainControl: false } });
                    this.analyser = this.ctx.createAnalyser();
                    this.analyser.fftSize = 512; 
                    const src = this.ctx.createMediaStreamSource(stream);
                    src.connect(this.analyser);
                    this.data = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isReady = true;
                    return true;
                } catch(e) { console.error(e); alert("Error de Micr贸fono"); return false; }
            }
            getVolume() {
                if(!this.isReady) return 0;
                this.analyser.getByteTimeDomainData(this.data);
                let sum = 0;
                for(let i=0; i<this.data.length; i++) {
                    const v = (this.data[i]-128)/128;
                    sum += v*v;
                }
                return Math.sqrt(sum/this.data.length) * params.micGain;
            }
            getWaveData() {
                if(!this.isReady) return new Uint8Array(256);
                this.analyser.getByteFrequencyData(this.data); // Usamos Frecuencia para deformar malla
                return this.data;
            }
        }
        const audio = new AudioEngine();

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 10;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- MESH & VIDEO TEXTURE ---
        // Creamos un plano con MUCHOS segmentos (100x100) para poder deformarlo bien
        const geometry = new THREE.PlaneGeometry(16, 9, 120, 120); 
        
        // Shader Material personalizado "Inline" para efectos visuales potentes sin texturas
        // O usaremos MeshStandard simple y manipulamos v茅rtices manualmente para facilidad
        const videoElement = document.createElement('video');
        videoElement.loop = true;
        videoElement.muted = true; 
        videoElement.crossOrigin = "anonymous";
        videoElement.playsInline = true;
        
        let videoTexture = new THREE.VideoTexture(videoElement);
        let defaultTexture = createPlasmaTexture(); // Textura por defecto si no hay video

        const material = new THREE.MeshBasicMaterial({ 
            map: defaultTexture,
            color: 0xffffff,
            side: THREE.DoubleSide,
            wireframe: false
        });

        const plane = new THREE.Mesh(geometry, material);
        scene.add(plane);

        // --- POST PROCESSING ---
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.strength = params.bloomStrength;
        bloomPass.radius = 0.5;
        bloomPass.threshold = 0.1;
        composer.addPass(bloomPass);

        // --- FUNCIONES AUXILIARES ---
        function createPlasmaTexture() {
            // Crea una textura generativa temporal
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,512,512);
            return new THREE.CanvasTexture(canvas);
        }

        function updatePlasma(time) {
            // Si no hay video, dibujamos ruido de colores
            if(material.map === videoTexture) return;
            
            const tex = material.map;
            const ctx = tex.image.getContext('2d');
            const w = 512; const h = 512;
            
            // Efecto "Barrido" simple para rendimiento
            const grad = ctx.createLinearGradient(0,0,w,h);
            grad.addColorStop(0, `hsl(${time*50 % 360}, 100%, 50%)`);
            grad.addColorStop(0.5, `hsl(${(time*50 + 180) % 360}, 100%, 50%)`);
            grad.addColorStop(1, `hsl(${time*50 % 360}, 100%, 50%)`);
            
            ctx.globalAlpha = 0.1;
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,w,h);
            
            // Rayas aleatorias
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = '#fff';
            if(Math.random()>0.9) ctx.fillRect(0, Math.random()*h, w, 2);
            
            tex.needsUpdate = true;
        }

        // --- ANIMACIN PRINCIPAL ---
        const positionAttribute = geometry.attributes.position;
        const originalPositions = positionAttribute.array.slice(); // Copia de seguridad

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001 * params.speed;
            
            // 1. Audio Data
            const vol = audio.getVolume(); // Volumen general (0 a 1+)
            const freqs = audio.getWaveData(); // Array de frecuencias (bajos a agudos)

            // 2. Efectos Visuales
            if(!material.map.image) updatePlasma(time);
            else if (material.map !== videoTexture) updatePlasma(time);

            bloomPass.strength = params.bloomStrength + (vol * 1.5); // Bloom explota con volumen
            material.wireframe = params.wireframe;

            // 3. DEFORMACIN DE VRTICES (Lo estilo TouchDesigner)
            // Recorremos todos los v茅rtices del plano
            for (let i = 0; i < positionAttribute.count; i++) {
                const x = originalPositions[i * 3];
                const y = originalPositions[i * 3 + 1];
                
                // Mapear posici贸n Y del v茅rtice a una frecuencia del audio
                // Esto hace que la parte de abajo reaccione a bajos y arriba a agudos (o viceversa)
                const freqIndex = Math.floor(((y + 4.5) / 9) * 100); // Mapeo aprox
                const audioVal = freqs[freqIndex % freqs.length] / 255.0;

                // Calculamos el desplazamiento en Z (Profundidad)
                // Usamos ruido Perlin simple (Math.sin combinados) + Audio
                const noise = Math.sin(x * 2 + time) * Math.cos(y * 1.5 + time);
                
                // Si el volumen es alto, la distorsi贸n es masiva
                const distortion = noise * (audioVal * params.distortion * params.micGain);

                // Aplicamos nueva Z
                positionAttribute.setZ(i, distortion);
            }
            
            positionAttribute.needsUpdate = true;
            geometry.computeVertexNormals(); // Para que la luz (si hubiera) reaccione bien

            // Rotaci贸n sutil de c谩mara con el "Kick"
            if(vol > 0.4) {
                plane.rotation.z = (Math.random()-0.5) * 0.05;
                plane.scale.setScalar(1.0 + vol * 0.1);
            } else {
                plane.rotation.z *= 0.9; // Volver suavemente
                plane.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
            }

            composer.render();
        }

        // --- CONTROLADORES UI ---
        document.getElementById('start-btn').onclick = async () => {
            if(await audio.init()) {
                document.getElementById('overlay').style.opacity = 0;
                setTimeout(()=>document.getElementById('overlay').style.display='none', 500);
                animate();
            }
        };

        const fileInput = document.getElementById('file-input');
        
        document.querySelector('.label-upload').onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const url = URL.createObjectURL(file);
            videoElement.src = url;
            videoElement.play().then(() => {
                material.map = videoTexture;
                material.color.setHex(0xffffff); // Reset color a blanco puro para video
                console.log("Video cargado");
            });
        };

        // Resize
        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
        };

        // GUI
        const gui = new GUI({ title: 'Visual Controls' });
        gui.add(params, 'distortion', 0, 10).name('Nivel Glitch');
        gui.add(params, 'micGain', 1, 10).name('Sensibilidad Audio');
        gui.add(params, 'bloomStrength', 0, 4).name('Brillo Ne贸n');
        gui.add(params, 'wireframe').name('Modo Malla');

    </script>
</head>
<body>
    <div id="overlay">
        <h1 style="color:white; letter-spacing: 5px; text-transform:uppercase; margin-bottom:30px;">Neon Glitch Reactor</h1>
        <button id="start-btn">ACTIVAR SISTEMA</button>
    </div>

    <div id="ui-container">
        <input type="file" id="file-input" accept="video/*">
        <div class="label-upload"> Cargar Video Local</div>
    </div>
</body>
</html>
