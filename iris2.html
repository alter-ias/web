<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IRIS v18 - PRO KEYBOARD LAYOUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000;
            --panel-bg: rgba(10, 12, 15, 0.98);
            --accent: #00E5FF;
            --premium: #FFD700;
            --net-color: #00ff88;
            --text-dim: #556677;
            --ui-scale: 1.0;
        }
        body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: 'Rajdhani', sans-serif; color: #fff; display: flex; flex-direction: column; height: 100vh; }

        /* VIEWPORT */
        #viewport {
            flex-grow: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center; gap: 40px;
            background: #000; z-index: 1;
        }
        .monitor-container {
            width: 45%; height: 70%; position: relative;
            border: 1px solid #333; transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
            background: #050505; overflow: hidden;
        }
        .monitor-container canvas { width: 100%; height: 100%; object-fit: contain; }
        
        .monitor-container.editing { 
            border: 2px solid var(--accent); 
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.2); 
            transform: scale(1.01);
        }
        .monitor-label {
            position: absolute; top: 10px; left: 10px; 
            font-family: 'Montserrat'; font-weight: 700; font-size: 20px; 
            color: #444; letter-spacing: 2px; text-shadow: 0 0 5px #000; z-index: 2;
        }
        .monitor-container.editing .monitor-label { color: var(--accent); text-shadow: 0 0 10px var(--accent); }

        .deck-status-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 5px 10px; box-sizing: border-box;
            background: rgba(0,0,0,0.8); font-size: 10px; font-family: monospace; z-index: 2;
        }
        .ds-active { color: #fff; font-weight: bold; text-shadow: 0 0 5px var(--accent); }
        .ds-inactive { color: #444; }
        .fader-visual { color: var(--accent); font-weight: bold; }

        /* UI CONTROL */
        #ui-wrapper { flex-shrink: 0; width: 100%; background: transparent; z-index: 10; display: flex; justify-content: center; align-items: flex-end; position: relative; }
        #dashboard {
            width: 100%; height: 300px; 
            background: var(--panel-bg);
            border-top: 1px solid rgba(0,229,255,0.1);
            transform-origin: top center; transform: scale(var(--ui-scale));
            width: calc(100% / var(--ui-scale));
            display: grid; grid-template-columns: 200px 1fr 300px;
            padding: 20px 40px; box-sizing: border-box;
            gap: 20px; position: relative;
        }

        #scale-strip { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #080808; z-index: 50; }
        #scale-fill { height: 100%; width: 50%; background: var(--accent); box-shadow: 0 0 10px var(--accent); pointer-events: none; }
        #scale-input { 
            position: absolute; top: -10px; left: 0; width: 100%; height: 30px; 
            opacity: 0; cursor: ew-resize; z-index: 100; margin: 0; 
        }

        .panel { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        h3 { font-family: 'Montserrat', sans-serif; font-size: 10px; letter-spacing: 2px; color: var(--text-dim); margin: 0 0 10px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .shortcut-row { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 2px; color: #888; }
        .key-badge { color: var(--accent); font-weight: 700; }
        .mod-badge { color: var(--premium); font-weight: 700; font-size: 9px; border: 1px solid #444; padding: 0 3px; border-radius: 2px;}

        .mix-center { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .work-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .work-btn {
            flex: 1; padding: 15px; background: #0a0a0a; border: 1px solid #333; color: #555;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 20px; cursor: pointer; text-align: center;
            transition: 0.2s; text-transform: uppercase;
        }
        .work-btn.selected { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 30px var(--accent); }

        #crossfader-track { width: 100%; height: 8px; background: #000; border-radius: 4px; position: relative; border: 1px solid #333; margin-top: 10px;}
        #crossfader-handle { width: 60px; height: 20px; background: var(--accent); position: absolute; top: -6px; left: 50%; transform: translateX(-50%); border-radius: 2px; box-shadow: 0 0 10px var(--accent); transition: left 0.1s; }

        .out-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .out-btn { padding: 8px; background: #1a0505; border: 1px solid #331111; color: #ff3366; font-family: 'Montserrat'; font-weight: 700; font-size: 9px; cursor: pointer; }
        .out-btn.active-off { background: #ff0055; color: #fff; border-color: #ff0055; box-shadow: 0 0 20px #ff0055; }
        .out-btn.source { background: #051a1a; border-color: #113333; color: #44cccc; }
        .out-btn.source.active { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 20px var(--accent); }

        .sliders-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: auto; width: 100%; box-sizing: border-box; }
        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 10px; width: 100%; }
        .param-label { color: #888; width: 50px; flex-shrink: 0; }
        
        .param-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 2px; background: #333;
            outline: none; flex-grow: 1; min-width: 0; margin: 0;
        }
        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 12px; height: 12px; border-radius: 50%; 
            background: #556677; cursor: pointer; border: 2px solid #000;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .param-slider::-moz-range-thumb {
            width: 12px; height: 12px; border-radius: 50%;
            background: #556677; cursor: pointer; border: 2px solid #000;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); border: none;
        }
        .param-slider:hover::-webkit-slider-thumb { background: var(--accent); }
        .param-slider:hover::-moz-range-thumb { background: var(--accent); }

        .util-btn { padding: 6px; background: transparent; border: 1px solid #444; color: #888; font-size: 9px; cursor: pointer; flex: 1; margin: 0 2px;}
        .util-btn:hover { border-color: var(--accent); color: var(--accent); }
        .net-btn { border-color: var(--net-color); color: var(--net-color); }
        .net-btn:hover { background: var(--net-color); color: #000; }
        
        .store-btn { border-color: var(--premium); color: var(--premium); }
        .store-btn:hover { background: var(--premium); color: #000; box-shadow: 0 0 15px var(--premium); }

        #notify { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: var(--accent); opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(0,0,0,0.8); padding: 15px 30px; border: 1px solid var(--accent); z-index: 999; letter-spacing: 5px; }
        
        #boot { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; }
        .overlay-panel { width: 700px; background: #111; border: 1px solid var(--accent); padding: 20px; display: flex; flex-direction: column; max-height: 90vh; }
        
        .midi-head { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        #midi-list { height: 60vh; flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .midi-group { grid-column: span 2; color: var(--accent); border-bottom: 1px solid #222; margin-top: 15px; font-weight: bold; font-size: 11px; }
        .midi-row { display: flex; justify-content: space-between; background: #151515; padding: 5px 10px; align-items: center; border: 1px solid #222; }
        .midi-btn { background: #222; border: 1px solid #444; color: #fff; font-size: 9px; padding: 4px 8px; cursor: pointer; min-width: 60px; }
        .midi-btn.learning { background: #f0f; animation: blink 0.5s infinite; }
        @keyframes blink {0%{opacity:1}50%{opacity:0.5}}

        .net-stat { font-family: monospace; color: var(--net-color); margin-bottom: 10px; font-size: 12px; }
        .net-input { background: #000; border: 1px solid #333; color: #fff; padding: 10px; width: 70%; font-family: monospace; }
        .net-action { padding: 10px 20px; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; margin-left: 10px;}
        .net-action:hover { border-color: var(--net-color); color: var(--net-color); }
        .peer-list { margin-top: 10px; color: #666; font-size: 10px; }

        .pack-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .pack-card { border: 1px solid #333; padding: 15px; background: #080808; text-align: center; transition: 0.3s; }
        .pack-card:hover { border-color: var(--premium); transform: translateY(-5px); }
        .pack-icon { font-size: 40px; color: #444; margin-bottom: 10px; }
        .pack-title { font-family: 'Rajdhani'; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .pack-desc { font-size: 10px; color: #888; margin-bottom: 15px; height: 30px;}
        .btn-install { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; cursor: pointer; font-family: 'Rajdhani'; font-weight: 700; }
        .btn-install.installed { background: var(--premium); color: #000; border-color: var(--premium); cursor: default; }
        .premium-lock { filter: grayscale(1) opacity(0.5); pointer-events: none; }
    </style>
</head>
<body>

    <div id="boot">
        <h1 style="font-size:70px; letter-spacing:15px; color:#fff; margin: 0 0 10px 0; font-family: 'Rajdhani'; font-weight: 700;">IRIS</h1>
        <h2 style="font-size: 14px; font-family: 'Montserrat'; letter-spacing: 5px; color: #667788; text-transform: uppercase; font-weight: 400; margin-bottom: 40px;">Marketplace Edition v18</h2>
        
        <button id="btn-start" style="padding:15px 50px; background:transparent; border:1px solid #00E5FF; color:#fff; font-family:'Rajdhani'; font-size:18px; letter-spacing: 2px; cursor:pointer; transition: 0.3s;">INICIAR SISTEMA</button>
        
        <div style="position: absolute; bottom: 30px; color: #445566; font-family: 'Rajdhani'; font-size: 12px; letter-spacing: 1px;">
            Un proyecto del Laboratorio de Arte Generativo - <span style="color: #00E5FF; font-weight: bold;">ALTERLAB</span>
        </div>
    </div>

    <div id="viewport">
        <div id="cont-1" class="monitor-container editing">
            <span class="monitor-label">MIX 1</span>
            <canvas id="canvas-1"></canvas>
            <div class="deck-status-bar">
                <span id="st-1-a" class="ds-active">A: VACÍO</span>
                <span class="fader-visual" id="fd-1">|||</span>
                <span id="st-1-b" class="ds-inactive">B: VACÍO</span>
            </div>
        </div>
        <div id="cont-2" class="monitor-container">
            <span class="monitor-label">MIX 2</span>
            <canvas id="canvas-2"></canvas>
            <div class="deck-status-bar">
                <span id="st-2-a" class="ds-active">A: VACÍO</span>
                <span class="fader-visual" id="fd-2">|||</span>
                <span id="st-2-b" class="ds-inactive">B: VACÍO</span>
            </div>
        </div>
    </div>

    <div id="ui-wrapper">
        <div id="dashboard">
            <div id="scale-strip"><div id="scale-fill"></div><input type="range" id="scale-input" min="0.6" max="1.4" step="0.01" value="1.0"></div>

            <div class="panel">
                <h3>ATAJOS</h3>
                <div class="shortcut-row"><span>Cargar Video</span> <span class="key-badge">A-L</span></div>
                <div class="shortcut-row"><span>Efectos 2D</span> <div><span class="key-badge">1-0</span> <span class="mod-badge">SHIFT +10</span></div></div>
                <div class="shortcut-row"><span>Deformación 3D</span> <div><span class="key-badge">Q-P</span> <span class="mod-badge">SHIFT +10</span></div></div>
                <div class="shortcut-row"><span>Capa Banco 3</span> <span class="mod-badge">ALT +20</span></div>
                <div class="shortcut-row"><span>Estilo Malla</span> <span class="key-badge">Z</span></div>
                <div class="shortcut-row"><span>Webcam</span> <span class="key-badge">N</span></div>
                <div class="shortcut-row"><span>Salida / Win</span> <span class="key-badge">Ñ</span></div>
                <div class="shortcut-row"><span>Reset</span> <span class="key-badge">M</span></div>
            </div>

            <div class="panel">
                <div class="mix-center">
                    <div class="work-grid">
                        <button id="btn-mix-1" class="work-btn selected">MIX 1</button>
                        <button id="btn-mix-2" class="work-btn">MIX 2</button>
                    </div>
                    <div id="crossfader-track"><div id="crossfader-handle"></div></div>
                    <div style="text-align:center; font-size:9px; color:#444; margin-top:5px;">SCROLL PARA MEZCLAR</div>
                </div>
            </div>

            <div class="panel">
                <div class="out-matrix">
                    <button id="out-off" class="out-btn active-off">BLACKOUT</button>
                    <button id="out-1" class="out-btn source">PROJ 1</button>
                    <button id="out-2" class="out-btn source">PROJ 2</button>
                </div>
                <div style="display:flex; margin-bottom:15px; gap:2px;">
                    <button class="util-btn" id="btn-midi">MIDI</button>
                    <button class="util-btn" id="btn-proj">WIN</button>
                    <button class="util-btn" onclick="document.getElementById('file-input').click()">VID</button>
                    <button class="util-btn" onclick="exportPreset()">SAVE P</button>
                    <button class="util-btn" onclick="document.getElementById('json-input').click()">LOAD P</button>
                    <button class="util-btn net-btn" id="btn-net">DUO</button>
                    <button class="util-btn store-btn" id="btn-store">STORE</button>
                </div>
                <div class="sliders-grid">
                    <div>
                        <div class="param-row"><span class="param-label">SPEED</span> <input type="range" id="sl-speed" min="0.1" max="5" step="0.1" value="1" class="param-slider" oninput="uiUpdate('speed', this.value)"></div>
                        <div class="param-row"><span class="param-label">GLITCH</span> <input type="range" id="sl-dist" min="0" max="5" step="0.1" value="0" class="param-slider" oninput="uiUpdate('glitch', this.value)"></div>
                        <div class="param-row"><span class="param-label">3D GEO</span> <input type="range" id="sl-geo" min="0" max="10" step="0.1" value="4" class="param-slider" oninput="uiUpdate('geo', this.value)"></div>
                    </div>
                    <div>
                        <div class="param-row"><span class="param-label">RGB</span> <input type="range" id="sl-rgb" min="0" max="1" step="0.01" value="0" class="param-slider" oninput="uiUpdate('color', this.value)"></div>
                        <div class="param-row"><span class="param-label">GAIN</span> <input type="range" id="sl-gain" min="1" max="10" step="0.1" value="5" class="param-slider" oninput="uiUpdate('gain', this.value)"></div>
                        <div class="param-row"><span class="param-label">BLOOM</span> <input type="range" id="sl-bloom" min="0" max="3" step="0.1" value="1.5" class="param-slider" oninput="uiUpdate('bloom', this.value)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="store-overlay" class="overlay">
        <div class="overlay-panel">
            <div class="midi-head">
                <h2 style="color:var(--premium); margin:0; font-size:18px;">IRIS MARKETPLACE</h2>
                <button class="util-btn" onclick="document.getElementById('store-overlay').style.display='none'">CERRAR</button>
            </div>
            
            <div style="background:#222; padding:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <span id="license-status" style="font-size:12px; color:#aaa;">LICENCIA: FREE (Duo Mode Only)</span>
                <div>
                    <input type="text" id="premium-code" placeholder="CÓDIGO" style="background:#000; border:1px solid #444; color:#fff; padding:5px; width:100px;">
                    <button class="util-btn store-btn" onclick="activatePremium()">ACTIVAR</button>
                </div>
            </div>

            <div id="packs-container" class="pack-grid premium-lock">
                <div class="pack-card">
                    <div class="pack-icon"><i class="fas fa-microchip"></i></div>
                    <div class="pack-title">CYBER PUNK</div>
                    <div class="pack-desc">5 Nuevos Glitches agresivos y distorsión digital.</div>
                    <button class="btn-install" onclick="installPack('cyber')">INSTALAR</button>
                </div>
                <div class="pack-card">
                    <div class="pack-icon"><i class="fas fa-water"></i></div>
                    <div class="pack-title">FLUID DREAMS</div>
                    <div class="pack-desc">Simulación de fluidos y warping orgánico.</div>
                    <button class="btn-install" onclick="installPack('fluid')">INSTALAR</button>
                </div>
                <div class="pack-card">
                    <div class="pack-icon"><i class="fas fa-cube"></i></div>
                    <div class="pack-title">DARK MATTER</div>
                    <div class="pack-desc">Deformaciones de vértices extremas y agujeros negros.</div>
                    <button class="btn-install" onclick="installPack('dark')">INSTALAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="midi-overlay" class="overlay">
        <div class="overlay-panel">
            <div class="midi-head"><h2 style="color:#00E5FF; margin:0; font-size:18px;">MAPEO MIDI</h2><button class="util-btn" onclick="document.getElementById('midi-overlay').style.display='none'">CERRAR</button></div>
            <div id="midi-list"></div>
        </div>
    </div>

    <div id="net-overlay" class="overlay">
        <div class="overlay-panel" style="border-color:var(--net-color);">
            <div class="midi-head"><h2 style="color:var(--net-color); margin:0; font-size:18px;">RED P2P</h2><button class="util-btn" onclick="document.getElementById('net-overlay').style.display='none'">CERRAR</button></div>
            <div style="padding: 20px 0;">
                <div class="net-stat" id="my-id-display">CONECTANDO...</div>
                <div style="border-top:1px solid #333; margin: 10px 0;"></div>
                <div style="display:flex;">
                    <input type="text" id="remote-id" class="net-input" placeholder="ID REMOTO">
                    <button class="net-action" id="btn-connect-p2p">CONECTAR</button>
                </div>
                <div class="net-stat" id="connection-status" style="margin-top:20px; color:#fff;">ESTADO: OFFLINE</div>
                <div class="peer-list" id="peers-list">Usuarios: 0 (Max: 1 en Free)</div>
            </div>
        </div>
    </div>
    
    <div id="notify">NOTIFICACIÓN</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">
    <input type="file" id="json-input" accept=".json" style="display:none">

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        // --- SISTEMA DE LICENCIAS & LIBRERÍA ---
        window.isPremium = false;
        
        window.activatePremium = function() {
            const code = document.getElementById('premium-code').value;
            if(code === 'ALTERLAB') {
                window.isPremium = true;
                document.getElementById('license-status').innerText = "LICENCIA: PREMIUM (Party Mode + Packs)";
                document.getElementById('license-status').style.color = "var(--premium)";
                document.getElementById('packs-container').classList.remove('premium-lock');
                document.getElementById('peers-list').innerText = "Usuarios: " + connections.length + " (ILIMITADO)";
                document.getElementById('btn-net').innerText = "PARTY";
                document.getElementById('btn-net').style.color = "var(--net-color)";
                window.notify("PREMIUM ACTIVADO");
            } else {
                window.notify("CÓDIGO INVÁLIDO");
            }
        };

        // --- DEFINICIÓN DE PACKS (GLSL Code Injection) ---
        const PACKS = {
            'cyber': {
                name: 'CYBER PUNK', installed: false,
                glsl_2d: `if(uMode==11) { uv.x += sin(uv.y * 100.0 + t*10.0) * 0.01; } if(uMode==12) { uv = floor(uv*32.0)/32.0; uv += step(0.5, sin(t*20.0))*0.05; } if(uMode==13) { float r = sin(t)*0.5; uv.x+=r; if(uv.x>1.0)uv.x-=1.0; } if(uMode==14) { uv.y = 1.0-uv.y; } if(uMode==15) { uv.x = pow(uv.x, 2.0); }`,
                glsl_geo: `if(uDistType==11) d = tan(pos.y * 10.0 + t) * 0.5; if(uDistType==12) d = cos(pos.x * 20.0) * cos(pos.y * 20.0); if(uDistType==13) d = pos.z * sin(t*10.0); if(uDistType==14) d = mod(pos.x, 0.5); if(uDistType==15) d = tan(pos.x+pos.y);`
            },
            'fluid': {
                name: 'FLUID DREAMS', installed: false,
                glsl_2d: `if(uMode==16) { uv += vec2(sin(uv.y*10.0+t), cos(uv.x*10.0+t)) * 0.05; } if(uMode==17) { float d = length(uv-0.5); uv += (uv-0.5) * sin(d*10.0 - t*2.0) * 0.1; } if(uMode==18) { uv.x += sin(uv.y*50.0)*0.01; } if(uMode==19) { uv.y += cos(uv.x*50.0)*0.01; } if(uMode==20) { uv += vec2(sin(t), cos(t))*0.1; }`,
                glsl_geo: `if(uDistType==16) d = sin(length(pos.xy)*5.0 - t); if(uDistType==17) d = sin(pos.x * 5.0 + t) * sin(pos.y * 5.0 + t); if(uDistType==18) d = sin(pos.x * 10.0 - t) + cos(pos.y * 10.0 - t); if(uDistType==19) d = 1.0/(length(pos.xy)+0.1) * sin(t); if(uDistType==20) d = sin(pos.x*2.0)*cos(pos.y*2.0);` 
            },
            'dark': {
                name: 'DARK MATTER', installed: false,
                glsl_2d: `if(uMode==21) { uv = abs(uv-0.5); } if(uMode==22) { uv = fract(uv * 4.0); } if(uMode==23) { uv.x = 1.0-uv.x; } if(uMode==24) { uv = floor(uv*10.0)/10.0; } if(uMode==25) { uv += rand(uv+t)*0.1; }`,
                glsl_geo: `if(uDistType==21) d = (1.0 / length(pos.xy)) * sin(t); if(uDistType==22) d = rand(pos.xy + t) * 2.0; if(uDistType==23) d = tan(pos.x*5.0); if(uDistType==24) d = cos(length(pos.xy)*10.0); if(uDistType==25) d = sin(pos.x*20.0)*0.5;`
            }
        };

        window.installPack = function(packId) {
            if(!window.isPremium) return;
            const pack = PACKS[packId];
            if(pack.installed) return;
            pack.installed = true;
            window.notify(pack.name + " INSTALADO");
            recompileMixer(mix1); recompileMixer(mix2);
            event.target.innerText = "INSTALADO"; event.target.classList.add("installed");
            document.getElementById('sl-dist').max = 25; document.getElementById('sl-geo').max = 25;
        };

        function getDynamicShader(type) {
            let injection2D = ""; let injectionGeo = "";
            for(let key in PACKS) {
                if(PACKS[key].installed) { injection2D += PACKS[key].glsl_2d; injectionGeo += PACKS[key].glsl_geo; }
            }
            if(type === 'vert') {
                return `uniform float uTime; uniform float uSpeed; uniform float uGeoStrength; uniform int uDistType; uniform float uBass;
                    uniform sampler2D uTexA; uniform sampler2D uTexB; uniform float uCrossfade; uniform sampler2D uTexCam; uniform float uMix; uniform int uStyle;
                    varying vec2 vUv;
                    float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
                    void main() {
                        vUv = uv; vec3 pos = position; float t = uTime * uSpeed; float d = 0.0;
                        float str = uGeoStrength * (0.1 + uBass * 0.8);
                        if(uDistType==1) d = sin(pos.x*2.+t)*cos(pos.y*1.5+t);
                        if(uDistType==2) d = sin(pos.y*10.+t)*0.5 * sin(pos.x*10.);
                        if(uDistType==3) { vec2 b=floor(uv*10.); d=(fract(sin(dot(b,vec2(12.9,78.2)))*43758.5)>0.5)?1.0:0.0; d*=sin(t*5.); }
                        if(uDistType==4) d = sin(length(pos.xy)*5.0 - t*3.0);
                        if(uDistType==5) d = cos(pos.x*5.0 + t) + sin(pos.y*5.0 + t);
                        if(uDistType==6) d = sin(pos.y*20.0 + t*10.0) * 0.2;
                        if(uDistType==7) d = (sin(pos.x*3.0+t) * sin(pos.y*3.0+t)) * sin(t);
                        if(uDistType==8) d = tan(pos.x + t) * 0.1;
                        if(uDistType==9) d = abs(sin(pos.x*4.0+t)) * abs(cos(pos.y*4.0));
                        if(uDistType==10) d = fract(pos.x*2.0+t) * fract(pos.y*2.0+t);
                        ${injectionGeo}
                        pos.z += d * str;
                        if(uStyle == 1) {
                            vec3 cA = texture2D(uTexA, uv).rgb; vec3 cB = texture2D(uTexB, uv).rgb;
                            vec3 col = mix(cA, cB, uCrossfade);
                            vec3 cam = texture2D(uTexCam, uv).rgb; col = mix(col, cam, uMix);
                            float lum = dot(col, vec3(0.333)); pos.z += lum * 3.5;
                        }
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }`;
            } else {
                return `uniform sampler2D uTexA; uniform sampler2D uTexB; uniform float uCrossfade;
                    uniform sampler2D uTexCam; uniform float uMix;
                    uniform float uTime; uniform float uSpeed; uniform float uBass; uniform float uRGBShift;
                    uniform int uMode; uniform int uStyle; uniform vec3 uTint; uniform float uTintMix;
                    varying vec2 vUv;
                    float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
                    vec3 rgbSplit(sampler2D t, vec2 uv, float a) { return vec3(texture2D(t, uv-vec2(a,0)).r, texture2D(t, uv).g, texture2D(t, uv+vec2(a,0)).b); }
                    void main() {
                        vec2 uv = vUv; float t = uTime * uSpeed;
                        if(uMode==2) uv.x = abs(uv.x-0.5)+0.5;
                        if(uMode==3) { vec2 c=uv-0.5; float r=length(c); float a=atan(c.y,c.x); a=mod(a,0.52); uv=0.5+r*vec2(cos(a),sin(a)); }
                        if(uMode==4) uv += vec2(sin(uv.y*10.+t)*0.05, 0.0);
                        if(uMode==5) { float d=length(uv-0.5); float a=atan(uv.y-0.5,uv.x-0.5)+(uBass*5.0)*(1.0-d); uv=0.5+d*vec2(cos(a),sin(a)); }
                        if(uMode==6) { float pixels = 50.0 + uBass*50.0; uv = floor(uv * pixels) / pixels; }
                        if(uMode==7) { uv.x += sin(uv.y * 20.0 + t) * 0.02; uv.y += cos(uv.x * 20.0 + t) * 0.02; }
                        if(uMode==8) { vec2 p = uv - 0.5; uv = 0.5 + vec2(abs(p.x), abs(p.y)); }
                        if(uMode==9) { uv = fract(uv * 2.0); }
                        if(uMode==10) { float angle = t; mat2 rot = mat2(cos(angle), -sin(angle), sin(angle), cos(angle)); uv = (uv-0.5)*rot + 0.5; }
                        ${injection2D}
                        float shift = uRGBShift;
                        vec3 cA = rgbSplit(uTexA, uv, shift); vec3 cB = rgbSplit(uTexB, uv, shift);
                        vec3 col = mix(cA, cB, uCrossfade);
                        vec3 cam = rgbSplit(uTexCam, uv, shift); col = mix(col, cam, uMix);
                        float lum = dot(col, vec3(0.333));
                        if(uStyle==1) { vec2 grid = fract(vUv * vec2(160.0, 90.0)); float mask = step(0.15, grid.x) * step(0.15, grid.y) * step(grid.x, 0.85) * step(grid.y, 0.85); col *= mask; if(lum < 0.1) col *= 0.1; } 
                        if(uStyle==2) { col = vec3(step(0.9, rand(floor(uv*100.0)))); col*=lum; }
                        if(uStyle==3) { col = vec3(floor(lum*4.0)/4.0); }
                        if(uStyle==4) { float g = step(0.5, sin(uv.y*100.0+t*10.0)); col *= g; }
                        col = mix(col, col*uTint, uTintMix);
                        gl_FragColor = vec4(col, 1.0);
                    }`;
            }
        }

        // --- 0. UTILIDADES GLOBALES ---
        window.notify = function(msg) { const n = document.getElementById('notify'); n.innerText = msg; n.style.opacity = 1; setTimeout(()=>n.style.opacity=0, 1500); }
        window.exportPreset = function() {
            const preset = { mix1: mix1.state, mix2: mix2.state, global: { micGain: micGain }, timestamp: Date.now() };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(preset));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr); dlAnchorElem.setAttribute("download", "iris_patch_" + Date.now() + ".json");
            dlAnchorElem.click(); window.notify("PRESET GUARDADO");
        }
        function recompileMixer(mixer) {
            mixer.mesh.material.vertexShader = getDynamicShader('vert');
            mixer.mesh.material.fragmentShader = getDynamicShader('frag');
            mixer.mesh.material.needsUpdate = true;
        }

        // --- 1. MOTOR DE MEZCLA ---
        class MixerEngine {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true });
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000); this.camera.position.z = 9;
                this.deckA = this.createVideoTexture(); this.deckB = this.createVideoTexture(); this.webcam = this.createVideoTexture();
                this.state = { nameA: "VACÍO", nameB: "VACÍO", crossfade: 0.0, speed: 1.0, glitch: 0.0, geo: 4.0, rgb: 0.0, bloom: 1.5, mode: 1, style: 0, distType: 0, tint: new THREE.Color(1,1,1), tintMix: 0.0, camMix: 0.0 };
                this.uniforms = { uTexA: { value: this.deckA.tex }, uTexB: { value: this.deckB.tex }, uCrossfade: { value: 0.0 }, uTexCam: { value: this.webcam.tex }, uMix: { value: 0.0 }, uTime: { value: 0 }, uBass: { value: 0 }, uMode: { value: 1 }, uStyle: { value: 0 }, uDistType: { value: 0 }, uSpeed: { value: 1.0 }, uGeoStrength: { value: 4.0 }, uRGBShift: { value: 0.0 }, uTint: { value: new THREE.Color(1,1,1) }, uTintMix: { value: 0.0 } };
                this.mesh = new THREE.Mesh(new THREE.PlaneGeometry(16, 9, 160, 90), new THREE.ShaderMaterial({ uniforms: this.uniforms, vertexShader: getDynamicShader('vert'), fragmentShader: getDynamicShader('frag'), side: THREE.DoubleSide }));
                this.scene.add(this.mesh);
            }
            createVideoTexture() { const v = document.createElement('video'); v.muted = true; v.loop = true; v.playsInline = true; const c = document.createElement('canvas'); c.width=2; c.height=2; const x=c.getContext('2d'); x.fillStyle='#000'; x.fillRect(0,0,2,2); const t = new THREE.CanvasTexture(c); return { vid: v, tex: t }; }
            loadClip(url) { const target = (this.state.crossfade < 0.5) ? 'B' : 'A'; const deck = (target === 'A') ? this.deckA : this.deckB; deck.vid.src = url; deck.vid.play(); deck.tex = new THREE.VideoTexture(deck.vid); if(target === 'A') { this.uniforms.uTexA.value = deck.tex; this.state.nameA = "CARGADO"; } else { this.uniforms.uTexB.value = deck.tex; this.state.nameB = "CARGADO"; } }
            resize(w,h) { this.renderer.setSize(w,h); this.camera.aspect = w/h; this.camera.updateProjectionMatrix(); }
            render(t, audio) { this.uniforms.uTime.value = t; this.uniforms.uBass.value = audio.bass; this.uniforms.uSpeed.value = this.state.speed; this.uniforms.uGeoStrength.value = this.state.geo; this.uniforms.uCrossfade.value = this.state.crossfade; this.uniforms.uMode.value = this.state.mode; this.uniforms.uStyle.value = this.state.style; this.uniforms.uDistType.value = this.state.distType; this.uniforms.uRGBShift.value = this.state.rgb; this.uniforms.uTint.value = this.state.tint; this.uniforms.uTintMix.value = this.state.tintMix; this.uniforms.uMix.value = this.state.camMix; this.renderer.render(this.scene, this.camera); }
        }

        // --- 2. SISTEMA GLOBAL ---
        const mix1 = new MixerEngine('canvas-1'); const mix2 = new MixerEngine('canvas-2');
        let activeMix = mix1; let activeId = 1; let outputMode = 'OFF'; let projWin = null; let audio = { vol: 0, bass: 0 }; let micGain = 5.0;

        // --- 3. RED P2P MULTI-USUARIO ---
        let peer = null; let connections = []; let myPeerId = null;
        function broadcastData(type, payload, excludeConn = null) { connections.forEach(conn => { if (conn !== excludeConn && conn.open) { conn.send({ type: type, payload: payload }); } }); }
        function initNetwork() { peer = new Peer(); peer.on('open', (id) => { myPeerId = id; document.getElementById('my-id-display').innerText = "TU ID: " + id; document.getElementById('connection-status').innerText = "ESPERANDO..."; }); peer.on('connection', (c) => setupConnection(c)); peer.on('error', (err) => { console.error(err); window.notify("ERROR DE RED"); }); }
        function setupConnection(c) {
            if (connections.length >= 1 && !window.isPremium) { setTimeout(() => { c.send({ type: 'error', payload: 'HOST IS NOT PREMIUM' }); c.close(); }, 500); window.notify("LIMITE DE USUARIOS (FREE)"); return; }
            connections.push(c); updatePeerCount(); window.notify("NUEVO USUARIO");
            c.on('data', (data) => handleRemoteData(data, c));
            c.on('close', () => { connections = connections.filter(conn => conn !== c); updatePeerCount(); });
            c.on('open', () => { c.send({ type: 'preset_load', payload: { obj: getCurrentState() } }); });
        }
        function updatePeerCount() { document.getElementById('connection-status').innerText = "ONLINE"; document.getElementById('connection-status').style.color = window.isPremium ? "#FFD700" : "#00ff88"; let max = window.isPremium ? "ILIMITADO" : "1"; document.getElementById('peers-list').innerText = `Usuarios: ${connections.length} (Max: ${max})`; }
        function getCurrentState() { return { mix1: mix1.state, mix2: mix2.state, global: { micGain: micGain }, timestamp: Date.now() }; }
        document.getElementById('btn-connect-p2p').onclick = () => { const remoteId = document.getElementById('remote-id').value; if(remoteId) { const c = peer.connect(remoteId); setupConnection(c); } };
        function handleRemoteData(data, sourceConn) {
            if(data.type === 'error') { window.notify(data.payload); return; }
            const p = data.payload;
            if(data.type === 'ui_param') updateParam(p.key, p.value, true); 
            else if (data.type === 'setActive') setActive(p.id, true);
            else if (data.type === 'crossfader') { activeMix.state.crossfade = p.val; updateFader(true); }
            else if (data.type === 'mode') { activeMix.state.mode = p.val; window.notify("REMOTE: FX " + p.val); }
            else if (data.type === 'style') { activeMix.state.style = p.val; window.notify("REMOTE: STYLE"); }
            else if (data.type === 'dist') { activeMix.state.distType = p.val; window.notify("REMOTE: DEFORM"); }
            else if (data.type === 'preset_load') applyPresetObj(p.obj, true);
            broadcastData(data.type, p, sourceConn);
        }

        // --- 4. FUNCIONES DE INTERFAZ ---
        window.uiUpdate = function(key, value, isRemote = false) {
            const val = parseFloat(value);
            if(key === 'speed') activeMix.state.speed = val; if(key === 'glitch') activeMix.state.glitch = val; if(key === 'geo') activeMix.state.geo = val; if(key === 'bloom') activeMix.state.bloom = val; if(key === 'gain') micGain = val;
            if(key === 'color') { activeMix.state.rgb = val; if(val > 0) { activeMix.state.tint.setHSL(val, 1.0, 0.5); activeMix.state.tintMix = 1.0; } else { activeMix.state.tint.setRGB(1,1,1); activeMix.state.tintMix = 0.0; } }
            if(isRemote) {
                if(key==='speed') document.getElementById('sl-speed').value = val; if(key==='glitch') document.getElementById('sl-dist').value = val; if(key==='geo') document.getElementById('sl-geo').value = val; if(key==='bloom') document.getElementById('sl-bloom').value = val; if(key==='gain') document.getElementById('sl-gain').value = val; if(key==='color') document.getElementById('sl-rgb').value = val;
            } else { broadcastData('ui_param', { key: key, value: val }); }
        };
        window.updateParam = window.uiUpdate; 

        function setActive(id, isRemote = false) {
            activeId = id; activeMix = (id===1) ? mix1 : mix2;
            document.getElementById('btn-mix-1').className = `work-btn ${id===1?'selected':''}`; document.getElementById('btn-mix-2').className = `work-btn ${id===2?'selected':''}`;
            document.getElementById('cont-1').className = `monitor-container ${id===1?'editing':''}`; document.getElementById('cont-2').className = `monitor-container ${id===2?'editing':''}`;
            document.getElementById('sl-speed').value = activeMix.state.speed; document.getElementById('sl-dist').value = activeMix.state.glitch; document.getElementById('sl-geo').value = activeMix.state.geo; document.getElementById('sl-rgb').value = activeMix.state.rgb; document.getElementById('sl-bloom').value = activeMix.state.bloom;
            updateFader(true); if(!isRemote) { window.notify(`EDITANDO: MIX ${id}`); broadcastData('setActive', { id: id }); }
        }

        function cycleWebcam(engine) {
            let m = engine.state.camMix; let next = 0.0; if(m === 0.0) next = 0.5; else if(m === 0.5) next = 1.0; else next = 0.0; engine.state.camMix = next;
            if(next > 0) {
                if(engine.webcam.vid.srcObject) { engine.webcam.vid.play(); } else {
                    navigator.mediaDevices.getUserMedia({video:{width:1280, height:720}}).then(s => {
                        engine.webcam.vid.srcObject = s; engine.webcam.vid.onloadedmetadata = () => { engine.webcam.vid.play(); const newTex = new THREE.VideoTexture(engine.webcam.vid); engine.uniforms.uTexCam.value = newTex; engine.webcam.tex = newTex; };
                    }).catch(e => { console.error(e); window.notify("ERROR CAMARA"); });
                }
            }
            let label = (next === 0.0) ? "OFF" : (next === 0.5 ? "MIX" : "ONLY"); window.notify(`WEBCAM: ${label}`);
        }

        function updateFader(isRemote = false) {
            document.getElementById('crossfader-handle').style.left = (activeMix.state.crossfade * 100) + '%'; const pre = activeId;
            document.getElementById(`st-${pre}-a`).className = activeMix.state.crossfade < 0.5 ? 'ds-active' : 'ds-inactive'; document.getElementById(`st-${pre}-b`).className = activeMix.state.crossfade > 0.5 ? 'ds-active' : 'ds-inactive';
            if(!isRemote) broadcastData('crossfader', { val: activeMix.state.crossfade });
        }

        function applyPresetObj(obj, isRemote = false) {
             Object.assign(mix1.state, obj.mix1); if(obj.mix1.tint) mix1.state.tint = new THREE.Color(obj.mix1.tint.r, obj.mix1.tint.g, obj.mix1.tint.b);
             Object.assign(mix2.state, obj.mix2); if(obj.mix2.tint) mix2.state.tint = new THREE.Color(obj.mix2.tint.r, obj.mix2.tint.g, obj.mix2.tint.b);
             micGain = obj.global.micGain; document.getElementById('sl-gain').value = micGain; setActive(activeId, true);
             window.notify(isRemote ? "PRESET REMOTO CARGADO" : "PRESET CARGADO"); if(!isRemote) broadcastData('preset_load', { obj: obj });
        }

        function importPreset(file) {
            const reader = new FileReader(); reader.onload = (event) => { try { const obj = JSON.parse(event.target.result); applyPresetObj(obj, false); } catch(e) { console.error(e); window.notify("ERROR DE ARCHIVO"); } }; reader.readAsText(file);
        }
        document.getElementById('json-input').onchange = (e) => importPreset(e.target.files[0]);

        async function initAudio() { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const stream = await navigator.mediaDevices.getUserMedia({audio:true}); const ana = ctx.createAnalyser(); ana.fftSize=512; const src = ctx.createMediaStreamSource(stream); src.connect(ana); const data = new Uint8Array(ana.frequencyBinCount); const loop = () => { requestAnimationFrame(loop); ana.getByteFrequencyData(data); let b = 0; for(let i=0; i<10; i++) b+=data[i]; audio.bass = (b/10/255) * micGain; }; loop(); } catch(e) {} }
        function resize() { const w = document.getElementById('cont-1').clientWidth; const h = document.getElementById('cont-1').clientHeight; mix1.resize(w,h); mix2.resize(w,h); }
        window.addEventListener('resize', resize);
        function animate() { requestAnimationFrame(animate); const t = performance.now()*0.001; mix1.render(t, audio); mix2.render(t, audio); }

        document.getElementById('btn-start').onclick = async () => { await initAudio(); initNetwork(); document.getElementById('boot').style.display='none'; mix1.loadClip('assets/videos/iris.webm'); mix1.state.crossfade=1.0; mix1.loadClip('assets/videos/iris.webm'); mix1.state.crossfade=0.0; mix2.loadClip('assets/videos/iris.webm'); mix2.state.crossfade=1.0; mix2.loadClip('assets/videos/iris.webm'); mix2.state.crossfade=0.0; resize(); animate(); };
        document.getElementById('scale-input').oninput = (e) => { document.documentElement.style.setProperty('--ui-scale', e.target.value); document.getElementById('scale-fill').style.width = ((e.target.value - 0.6) / 0.8) * 100 + '%'; setTimeout(resize, 50); };
        window.addEventListener('wheel', (e) => { activeMix.state.crossfade = Math.max(0, Math.min(1, activeMix.state.crossfade + e.deltaY * 0.001)); updateFader(false); });

        // --- GESTOR DE TECLADO MEJORADO (BANCOS) ---
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            
            // PREVENIR SHORTCUTS PELIGROSOS
            if ((e.ctrlKey || e.metaKey) && (k === 'r' || k === 'p' || k === 's')) { e.preventDefault(); return; }

            // VIDEO LOAD
            if(['a','s','d','f','g','h','j','k','l'].includes(k)) document.getElementById('file-input').click();
            
            // CALCULAR OFFSET DE BANCO
            let offset = 0;
            if(e.shiftKey) offset = 10;
            if(e.altKey) { offset = 20; e.preventDefault(); } // Prevenir alt-tab focus loss

            // 1. EFECTOS (1-0)
            const num = parseInt(k);
            if(!isNaN(num)) {
                const base = num === 0 ? 10 : num;
                const mode = base + offset;
                activeMix.state.mode = mode; 
                window.notify(`FX ${mode} (BANK ${offset/10 + 1})`); 
                broadcastData('mode', {val: mode});
            }
            
            // 2. DISTORSIONES (Q-P)
            const deformMap = {'q':1, 'w':2, 'e':3, 'r':4, 't':5, 'y':6, 'u':7, 'i':8, 'o':9, 'p':10};
            if(deformMap[k]) { 
                const dist = deformMap[k] + offset;
                activeMix.state.distType = dist; 
                window.notify(`DEFORM ${dist} (BANK ${offset/10 + 1})`); 
                broadcastData('dist', {val: dist});
            }

            // OTROS
            if(k==='z') { activeMix.state.style=1; window.notify("ESTILO MALLA"); broadcastData('style', {val: 1}); }
            if(k==='m') { activeMix.state.mode=1; activeMix.state.style=0; activeMix.state.distType=0; document.getElementById('sl-rgb').value=0; window.uiUpdate('color', 0); window.notify("RESET"); }
            if(k==='n') { cycleWebcam(activeMix); }
            if(k==='ñ') { if(outputMode === 'OFF') setOutput('1'); else if(outputMode === '1') setOutput('2'); else setOutput('OFF'); }
        });

        document.getElementById('btn-mix-1').onclick = () => setActive(1);
        document.getElementById('btn-mix-2').onclick = () => setActive(2);
        document.getElementById('file-input').onchange = (e) => { if(!e.target.files[0]) return; const url = URL.createObjectURL(e.target.files[0]); activeMix.loadClip(url); };
        document.getElementById('btn-net').onclick = () => document.getElementById('net-overlay').style.display = 'flex';
        document.getElementById('btn-midi').onclick = () => { renderMidi(); document.getElementById('midi-overlay').style.display='flex'; };
        document.getElementById('btn-store').onclick = () => document.getElementById('store-overlay').style.display='flex';
        document.getElementById('out-off').onclick = () => setOutput('OFF');
        document.getElementById('out-1').onclick = () => setOutput('1');
        document.getElementById('out-2').onclick = () => setOutput('2');
        
        function setOutput(mode) {
             outputMode = mode;
             document.getElementById('out-off').className = `out-btn ${mode==='OFF'?'active-off':''}`;
             document.getElementById('out-1').className = `out-btn source ${mode==='1'?'active':''}`;
             document.getElementById('out-2').className = `out-btn source ${mode==='2'?'active':''}`;
             if(projWin && !projWin.closed) {
                const v = projWin.document.getElementById('v');
                if(mode === 'OFF') v.style.opacity = 0;
                else { v.style.opacity = 1; const stream = (mode==='1'?mix1:mix2).renderer.domElement.captureStream(60); v.srcObject = stream; }
            }
            window.notify(`SALIDA: ${mode}`);
        }

        document.getElementById('btn-proj').onclick = () => {
            projWin = window.open("", "PROJ", "width=800,height=600");
            if(!projWin) { window.notify("POPUP BLOQUEADO"); alert("Permite ventanas emergentes."); return; }
            const btnFs = `<div style="position:absolute; top:20px; right:20px; z-index:100; cursor:pointer; color: #00E5FF; opacity:0.5;" onclick="document.body.requestFullscreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></div>`;
            projWin.document.write(`<body style="margin:0;background:#000;overflow:hidden">${btnFs}<video id="v" autoplay style="width:100vw;height:100vh;object-fit:cover;opacity:0"></video></body>`);
            projWin.focus(); if(outputMode !== 'OFF') setOutput(outputMode);
        };

        const midiMapDef = {
            'work_a':{l:'Select Mix 1', f:()=>setActive(1)}, 'work_b':{l:'Select Mix 2', f:()=>setActive(2)},
            'crossfader':{l:'Fader', f:(v)=>{activeMix.state.crossfade=v; updateFader();}},
            'reset':{l:'Reset FX', f:()=>{activeMix.state.mode=1; activeMix.state.style=0; activeMix.state.distType=0; activeMix.state.rgb=0; activeMix.state.tintMix=0; document.getElementById('sl-rgb').value=0;}},
            'load_clip':{l:'Cargar Video', f:()=>document.getElementById('file-input').click()},
            'out_off':{l:'Blackout', f:()=>setOutput('OFF')}, 'out_1':{l:'Proj 1', f:()=>setOutput('1')}, 'out_2':{l:'Proj 2', f:()=>setOutput('2')},
            'out_cycle':{l:'Cycle Out (Ñ)', f:(v)=>{ if(v>0.5){ if(outputMode==='OFF') setOutput('1'); else if(outputMode==='1') setOutput('2'); else setOutput('OFF'); }}},
            'webcam':{l:'Webcam Cycle', f:(v)=>{ if(v>0.5) cycleWebcam(activeMix); }},
            'speed':{l:'Knob Speed', f:(v)=>window.uiUpdate('speed', v*5)}, 'glitch':{l:'Knob Glitch', f:(v)=>window.uiUpdate('glitch', v*5)},
            'geo':{l:'Knob Geo', f:(v)=>window.uiUpdate('geo', v*10)}, 'color':{l:'Knob Color', f:(v)=>window.uiUpdate('color', v)},
            'gain':{l:'Knob Audio Gain', f:(v)=>window.uiUpdate('gain', v*10)}, 'bloom':{l:'Knob Bloom', f:(v)=>window.uiUpdate('bloom', v*3)},
            'fx_1':{l:'FX 2D 1', f:()=>activeMix.state.mode=1}, 'fx_2':{l:'FX 2D 2', f:()=>activeMix.state.mode=2}, 'fx_3':{l:'FX 2D 3', f:()=>activeMix.state.mode=3}, 'fx_4':{l:'FX 2D 4', f:()=>activeMix.state.mode=4}, 'fx_5':{l:'FX 2D 5', f:()=>activeMix.state.mode=5},
            'fx_6':{l:'FX 2D 6 (Pixel)', f:()=>activeMix.state.mode=6}, 'fx_7':{l:'FX 2D 7 (Liquid)', f:()=>activeMix.state.mode=7}, 'fx_8':{l:'FX 2D 8 (Quad)', f:()=>activeMix.state.mode=8}, 'fx_9':{l:'FX 2D 9 (Tile)', f:()=>activeMix.state.mode=9}, 'fx_10':{l:'FX 2D 10 (Rot)', f:()=>activeMix.state.mode=10},
            'style_z':{l:'Estilo Malla (Z)', f:()=>activeMix.state.style=1}, 'style_x':{l:'Estilo 2', f:()=>activeMix.state.style=2}, 'style_c':{l:'Estilo 3', f:()=>activeMix.state.style=3}, 'style_v':{l:'Estilo 4', f:()=>activeMix.state.style=4}, 'style_b':{l:'Reset Estilo (B)', f:()=>activeMix.state.style=0},
            'def_1':{l:'Deform 1', f:()=>activeMix.state.distType=1}, 'def_2':{l:'Deform 2', f:()=>activeMix.state.distType=2}, 'def_3':{l:'Deform 3', f:()=>activeMix.state.distType=3}, 'def_4':{l:'Deform 4', f:()=>activeMix.state.distType=4}, 'def_5':{l:'Deform 5', f:()=>activeMix.state.distType=5},
            'def_6':{l:'Deform 6', f:()=>activeMix.state.distType=6}, 'def_7':{l:'Deform 7', f:()=>activeMix.state.distType=7}, 'def_8':{l:'Deform 8', f:()=>activeMix.state.distType=8}, 'def_9':{l:'Deform 9', f:()=>activeMix.state.distType=9}, 'def_10':{l:'Deform 10', f:()=>activeMix.state.distType=10}
        };

        let midiBinding = null; const midiConfig = {}; 
        function renderMidi() {
            const list = document.getElementById('midi-list'); list.innerHTML='';
            const groups = {
                'GENERAL': ['work_a','work_b','crossfader','reset','load_clip','webcam'],
                'SALIDAS': ['out_off','out_1','out_2','out_cycle'],
                'AJUSTES': ['speed','glitch','geo','color','gain','bloom'],
                'EFECTOS 2D': ['fx_1','fx_2','fx_3','fx_4','fx_5','fx_6','fx_7','fx_8','fx_9','fx_10'],
                'ESTILOS': ['style_z','style_x','style_c','style_v','style_b'],
                'DEFORMACION 3D': ['def_1','def_2','def_3','def_4','def_5','def_6','def_7','def_8','def_9','def_10']
            };
            for(const [grpName, keys] of Object.entries(groups)) {
                const gHeader = document.createElement('div'); gHeader.className='midi-group'; gHeader.innerText=grpName; list.appendChild(gHeader);
                keys.forEach(k => {
                    const v = midiMapDef[k]; const row = document.createElement('div'); row.className='midi-row'; const hasMap = midiConfig[k];
                    row.innerHTML = `<span style="color:#aaa">${v.l}</span><button class="midi-btn ${midiBinding===k?'learning':''}">${hasMap ? (hasMap.t+':'+hasMap.v) : 'MAP'}</button>`;
                    row.querySelector('button').onclick = () => { midiBinding = k; renderMidi(); }; list.appendChild(row);
                });
            }
        }
        
        try {
            if(navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(m => {
                    for(let i of m.inputs.values()) i.onmidimessage = (msg) => {
                        const [c, n, v] = msg.data; const type = (c>=176 && c<=191)?'cc':(c>=144 && c<=159)?'note':null;
                        if(!type || (type==='note' && v===0)) return;
                        if(midiBinding) { midiConfig[midiBinding] = { t:type, v:n }; window.notify(`MAPPED: ${midiMapDef[midiBinding].l}`); midiBinding = null; renderMidi(); return; }
                        for(const [key, map] of Object.entries(midiConfig)) { if(map.t === type && map.v === n) midiMapDef[key].f(v/127.0); }
                    };
                }).catch(e => console.log("MIDI access denied"));
            }
        } catch(e) {}
    </script>
</body>
</html>
