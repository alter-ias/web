<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pa'l Hueso | Alter.Lab</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alter: { bg: '#0F121B', cyan: '#00E5FF', dark: '#1a1d26' }
                    },
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], mono: ['Inter', 'monospace'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0F121B; color: #FFF; font-family: 'Montserrat', sans-serif; overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        /* Glassmorphism */
        .glass-card {
            background: rgba(15, 18, 27, 0.85); /* Un poco más opaco para contraste */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 229, 255, 0.2);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Controles */
        select, .btn-control {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: white;
            transition: all 0.3s;
        }
        select:focus, .btn-control:hover { border-color: #00E5FF; box-shadow: 0 0 10px rgba(0,229,255,0.3); }
        option { background: #0F121B; }

        /* Chips y Highlights */
        .note-chip { padding: 4px 12px; margin: 2px; border-radius: 20px; font-weight: 600; display: inline-block; }
        .main-note { background: rgba(0, 229, 255, 0.15); color: #00E5FF; border: 1px solid #00E5FF; }
        .passing-note { background: rgba(255, 171, 0, 0.15); color: #FFAB00; border: 1px dashed #FFAB00; }
        
        .chord-highlight {
            color: #00E5FF; font-weight: bold; background: rgba(0, 229, 255, 0.1);
            padding: 2px 6px; border-radius: 4px; box-shadow: 0 0 5px rgba(0, 229, 255, 0.2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0F121B; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00E5FF; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="canvas-container"></div>

    <header class="py-6 border-b border-white/10 bg-black/20 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 group">
                <i class="bi bi-cpu text-3xl text-alter-cyan group-hover:scale-110 transition-transform"></i>
                <div class="flex flex-col">
                    <span class="font-bold text-xl tracking-[0.2em] text-white">ALTER.LAB</span>
                    <span class="text-xs text-alter-cyan tracking-widest">PA'L HUESO</span>
                </div>
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="glass-card p-6 rounded-xl">
                    <label class="block text-xs font-bold text-alter-cyan mb-2 uppercase tracking-wider">
                        <i class="bi bi-music-note-beamed mr-2"></i>Repertorio
                    </label>
                    <select id="song-selector" onchange="updateAnalysis()" class="w-full p-3 rounded-lg cursor-pointer text-lg">
                        <option value="" disabled selected>-- Selecciona una Pieza --</option>
                    </select>
                </div>

                <div class="glass-card p-6 rounded-xl space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-alter-cyan mb-2 uppercase">Instrumento Base</label>
                        <div class="flex gap-2">
                            <label class="btn-control flex-1 p-2 rounded text-center cursor-pointer text-sm">
                                <input type="radio" name="instrument" value="0" checked onchange="updateAnalysis()" class="hidden">
                                <span>Concierto (C)</span>
                            </label>
                            <label class="btn-control flex-1 p-2 rounded text-center cursor-pointer text-sm">
                                <input type="radio" name="instrument" value="2" onchange="updateAnalysis()" class="hidden">
                                <span>Bb (Tenor/Trpt)</span>
                            </label>
                            <label class="btn-control flex-1 p-2 rounded text-center cursor-pointer text-sm">
                                <input type="radio" name="instrument" value="9" onchange="updateAnalysis()" class="hidden">
                                <span>Eb (Alto/Bar)</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-yellow-500 mb-2 uppercase flex justify-between">
                            <span>Ajuste Manual de Tono</span>
                            <span id="pitch-val" class="bg-yellow-500/20 px-2 rounded text-yellow-500">0</span>
                        </label>
                        <div class="flex items-center gap-4">
                            <button onclick="changePitch(-1)" class="btn-control w-10 h-10 rounded-full font-bold text-xl">-</button>
                            <div class="flex-grow h-1 bg-gray-700 rounded overflow-hidden">
                                <div id="pitch-bar" class="h-full bg-yellow-500 w-1/2 transition-all duration-300"></div>
                            </div>
                            <button onclick="changePitch(1)" class="btn-control w-10 h-10 rounded-full font-bold text-xl">+</button>
                        </div>
                    </div>
                </div>

                <div id="harmonic-hud" class="hidden space-y-6 animate-fade-in">
                    <div class="glass-card p-6 rounded-xl text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-alter-cyan to-transparent"></div>
                        <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Tonalidad Resultante</p>
                        <h2 id="display-key" class="text-6xl font-black text-white drop-shadow-[0_0_15px_rgba(0,229,255,0.5)]">C</h2>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <p class="text-xs text-alter-cyan uppercase font-bold mb-2">Escala Sugerida</p>
                            <p id="display-scale" class="font-mono text-lg text-gray-200">C Mayor</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-card p-3 rounded-xl flex flex-col items-center">
                            <span class="text-xs text-gray-400 mb-2"><i class="bi bi-guitar text-alter-cyan"></i> Guitarra</span>
                            <div id="guitar-container" class="w-full"></div> 
                            <p id="guitar-chord-name" class="text-xs font-bold mt-2 text-alter-cyan"></p>
                        </div>
                        <div class="glass-card p-3 rounded-xl flex flex-col items-center">
                            <span class="text-xs text-gray-400 mb-2"><i class="bi bi-keyboard text-purple-400"></i> Piano</span>
                            <div id="piano-container" class="w-full"></div>
                            <p id="piano-chord-name" class="text-xs font-bold mt-2 text-purple-400"></p>
                        </div>
                    </div>

                    <div class="glass-card p-5 rounded-xl">
                        <h3 class="text-sm font-bold text-white mb-3 border-b border-white/10 pb-2">Notas Seguras (Improvisación)</h3>
                        <div id="scale-notes-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 h-full min-h-[500px]">
                <div class="glass-card h-full rounded-xl p-6 flex flex-col relative overflow-hidden">
                    
                    <div id="welcome-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-10 text-center p-8">
                        <i class="bi bi-vinyl-fill text-6xl text-gray-600 mb-4"></i>
                        <h3 class="text-2xl font-bold text-white mb-2">Selecciona una Canción</h3>
                        <p class="text-gray-400">Visualiza acordes, letras y escalas transpuestos en tiempo real.</p>
                    </div>

                    <div class="flex justify-between items-start mb-4 border-b border-gray-700 pb-4">
                        <div>
                            <h2 id="song-title" class="text-2xl font-bold text-white">Título</h2>
                            <p id="song-advice" class="text-sm text-yellow-500 mt-1 font-mono"></p>
                        </div>
                        <div id="crit-chord-box" class="hidden bg-red-900/30 border border-red-500/50 px-3 py-1 rounded">
                            <span class="text-xs text-red-300 block uppercase font-bold">Ojo al cambio</span>
                            <span id="crit-chord-val" class="text-lg font-bold text-red-100"></span>
                        </div>
                    </div>

                    <div class="mb-4 bg-black/30 p-3 rounded border-l-2 border-alter-cyan">
                        <span class="text-xs text-alter-cyan font-bold uppercase block mb-1">Progresión:</span>
                        <div id="transposed-chords" class="font-mono text-lg text-white overflow-x-auto whitespace-nowrap"></div>
                    </div>

                    <div id="lyrics-area" class="lyrics-container flex-grow overflow-y-auto pr-2 custom-scrollbar text-gray-300 text-sm md:text-base">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONSTANTES ---
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const ENHARMONICS = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb", "Db": "C#", "Eb": "D#", "Gb": "F#", "Ab": "G#", "Bb": "A#" };
        
        const SCALE_STEPS = {
            'Jónica': [0, 2, 4, 5, 7, 9, 11], 'Eólica': [0, 2, 3, 5, 7, 8, 10], 
            'Dórica': [0, 2, 3, 5, 7, 9, 10], 'Armónica': [0, 2, 3, 5, 7, 8, 11],
            'Pentatónica': [0, 3, 5, 7, 10], 'Mayor': [0, 2, 4, 7, 9], 
            'Mixolidia': [0, 2, 4, 5, 7, 9, 10], 'Blues': [0, 3, 5, 6, 7, 10],
            'Natural': [0, 2, 4, 5, 7, 9, 11], 'Lidia': [0, 2, 4, 6, 7, 9, 11]
        };

        const CHORD_INTERVALS = {
            'm': [0, 3, 7], 'maj7': [0, 4, 7, 11], 'm7': [0, 3, 7, 10], 
            '7': [0, 4, 7, 10], 'M': [0, 4, 7], 'dim': [0, 3, 6], 'sus4': [0, 5, 7]
        };

        const GUITAR_TUNING = [4, 9, 2, 7, 11, 4]; // E A D G B E

        // --- BASE DE DATOS COMPLETA ---
        const SONGS_DATA = {
            'up-around-the-bend': { title: 'Up Around the Bend (CCR)', concertKey: 'D', baseChords: 'D–A–G', improvScale: 'D Mayor Pentatónica', advice: 'Tonalidad Re (D). Riff con cuerdas al aire.', criticalChord: 'A7 (V)', chordType: 'M', steps: SCALE_STEPS['Mayor'], lyrics: `[Intro] (Riff en D)\n\n[Verso 1]\nThere's a place up ahead and I'm [A]goin'\nJust as fast as my feet can fly\nCome away, come away if you're [A]goin'\nLeave the sinkin' ship behind\n\n[Estribillo]\n[G]C'mon the risin'wind\n[G]We're goin' up around the [A]bend\n[A7]Ooh!` },
            'born-on-the-bayou': { title: 'Born on the Bayou (CCR)', concertKey: 'E', baseChords: 'E7–D–A', improvScale: 'E Mixolidia / Blues', advice: 'Todo gira sobre el E7 "vamp". Acordes de paso D y A.', criticalChord: 'E7#9', chordType: '7', steps: SCALE_STEPS['Blues'], lyrics: `[Intro] (E7 Vamp)\n\n[Verso 1]\n[E7]Now, when I was just a little boy\n[E7]Standin' to my Daddy's knee\n[E7]My poppa said, "Son, don't let the man get you\n[E7]Do what he done to me"` },
            'fortunate-son': { title: 'Fortunate Son (CCR)', concertKey: 'G', baseChords: 'G–F–C–G', improvScale: 'G Mixolidia', advice: 'Movimiento G -> F -> C -> G. El F natural (bVII) es clave.', criticalChord: 'F (bVII)', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], lyrics: `[Intro] [G][F][C][G]\n\n[Verso 1]\n[G]Some folks are born [F]made to wave the flag\n[C]Ooh, they're red, white and [G]blue\n[G]And when the band plays [F]"Hail to the chief"\n[C]Ooh, they point the cannon at [G]you, Lord` },
            'get-back': { title: 'Get Back (The Beatles)', concertKey: 'A', baseChords: 'A–G–D', improvScale: 'A Mixolidia', advice: 'Ritmo "Pony". D7/A crea tensión.', criticalChord: 'G (bVII)', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], lyrics: `[Intro] (Ritmo A)\n\n[Verso 1]\n[A]Jojo was a man who thought he was a loner\n[A]But he knew it couldn't last\n[A]Jojo left his home in Tucson, Arizona\n[A]For some California grass\n\n[Estribillo]\n[A]Get back, get back\n[A]Get back to where you once be-longed` },
            'dreams-fleetwood': { title: 'Dreams (Fleetwood Mac)', concertKey: 'F', baseChords: 'Fmaj7–G6', improvScale: 'A Menor Pentatónica / F Lidio', advice: 'Oscila entre Fmaj7 y G6. Melodía vocal en La menor.', criticalChord: 'G6', chordType: 'maj7', steps: SCALE_STEPS['Lidia'], lyrics: `[Verso 1]\n[Fmaj7]Now here you go again, you say [G6]you want your freedom\n[Fmaj7]Well, who am I to keep you [G6]down?\n[Fmaj7]It's only right that you should [G6]play the way you feel it\n[Fmaj7]But listen carefully to the [G6]sound` },
            'dreams-cranberries': { title: 'Dreams (The Cranberries)', concertKey: 'E', baseChords: 'E–A–B', improvScale: 'E Mayor', advice: 'Tonalidad Mi Mayor (E). El puente modula.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Mayor'], lyrics: `[Verso 1]\n[E]Oh, my life is changing [A]everyday\nIn every possible [E]way\n[E]And oh, my dreams, it's never quite as it [A]seems\nNever quite as it [E]seems` },
            'tin-man': { title: 'Tin Man (America)', concertKey: 'G', baseChords: 'Gmaj7–Cmaj7', improvScale: 'G Mayor', advice: 'Uso de extensiones Maj7.', criticalChord: 'Cmaj7', chordType: 'maj7', steps: SCALE_STEPS['Mayor'], lyrics: `[Intro] [Gmaj7][Cmaj7]\n\n[Verso 1]\n[Gmaj7]Sometimes late when things are real\n[Cmaj7]And people share the gift of gab between themselves` },
            'everybody-wants-to-rule': { title: 'Everybody Wants to Rule the World', concertKey: 'D', baseChords: 'D–G/D–A/D', improvScale: 'D Mixolidia', advice: 'Bajo pedal en D. El estribillo rompe a Em - F#m.', criticalChord: 'G/D', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], lyrics: `[Intro] (Riff D)\n\n[Verso 1]\nWelcome to your life\nThere's no turning back\nEven while we sleep\nWe will find you\n\n[Estribillo]\n[Em]Acting on your [F#m]best behaviour\n[G]Turn your back on [F#m]mother nature\n[Em]Every-[F#m]body [G]wants to [A]rule the world` },
            'overkill': { title: 'Overkill (Men at Work)', concertKey: 'D', baseChords: 'D–A–C–G', improvScale: 'D Mixolidia', advice: 'Tonalidad D. Progresión clave: D - A - C - G.', criticalChord: 'C (bVII)', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], lyrics: `[Verso 1]\nI can't get to [A]sleep\n[C]I think about the impli-[G]cations\nOf diving in too [A]deep\n[C]And possibly the compli-[G]cations` },
            'hold-the-line': { title: 'Hold the Line (Toto)', concertKey: 'F#m', baseChords: 'F#m–C#m–D–E', improvScale: 'F# Menor', advice: 'Tonalidad F#m. Progresión F#m - C#m - D - E.', criticalChord: 'C#m', chordType: 'm', steps: SCALE_STEPS['Eólica'], lyrics: `[Intro] [F#m][C#m][E]\n\n[Estribillo]\n[F#m]Hold the [C#m]line\n[E]Love isn't always on [F#m]time [C#m][E]` },
            'baby-come-back': { title: 'Baby Come Back (Player)', concertKey: 'Cm', baseChords: 'Abmaj7–Gm7–Cm7', improvScale: 'C Menor Natural', advice: 'Yacht Rock. Estribillo usa Abmaj7.', criticalChord: 'Abmaj7', chordType: 'maj7', steps: SCALE_STEPS['Eólica'], lyrics: `[Intro] [Abmaj7][Gm7][Cm7]\n\n[Verso 1]\nSpending all my nights, all my [Gm7]money going out on the town\nDoing anything just to [Gm7]get you off of my mind` },
            'shape-of-my-heart': { title: 'Shape of my heart (Sting)', concertKey: 'F#m', baseChords: 'F#m–E6–D6–C#7', improvScale: 'F# Menor', advice: 'Tonalidad F#m. Bajada diatónica: F#m - E - D - C#7.', criticalChord: 'C#7', chordType: 'm', steps: SCALE_STEPS['Eólica'], lyrics: `[Verso 1]\n[F#m]He deals the [C#m]cards as a medi-tation [C#sus4][C#7]\n[F#m]And those he [C#m]plays never sus-pect [C#sus4][C#7]` },
            'michelle': { title: 'Michelle (The Beatles)', concertKey: 'F', baseChords: 'F–Fm–Bb7', improvScale: 'F Mayor / F Menor', advice: 'Intercambio modal F Mayor/Menor. Acorde disminuido clave.', criticalChord: 'C#dim7', chordType: 'M', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso 1]\n[F]Michelle, [Gm7]ma belle\n[C]These are words that [C#dim7]go together [C]well\n[C#dim7]My Mi-[C]-chelle` },
            'here-today': { title: 'Here Today (Paul McCartney)', concertKey: 'G', baseChords: 'G–Bm–C–F', improvScale: 'G Mayor', advice: 'Tonalidad Sol (G). Usa acordes prestados como Fmaj7.', criticalChord: 'C#dim7', chordType: 'maj7', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso 1]\n[G]And if I said\nI really knew you well\nWhat would your [C]answer be\nIf you were [Am]here to-day?` },
            'in-my-life': { title: 'In my life (The Beatles)', concertKey: 'A', baseChords: 'A–E–F#m–Dm', improvScale: 'A Jónica', advice: 'Uso del iv menor (Dm) en tonalidad mayor.', criticalChord: 'Dm (iv)', chordType: 'M', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso 1]\n[A]There are [E]places [F#m]I re-[A7]member\nAll my life, though [A]some have changed` },
            'hotel-california': { title: 'Hotel California (Eagles)', concertKey: 'Bm', baseChords: 'Bm–F#7–A–E–G', improvScale: 'B Menor Armónica', advice: 'Nota clave A# sobre F#7. Ciclo flamenco.', criticalChord: 'F#7 (V)', chordType: 'm', steps: SCALE_STEPS['Armónica'], lyrics: `[Verso 1]\nOn a dark desert highway, [F#7]cool wind in my hair\n[A]Warm smell of colitas, [E]rising up through the air` },
            'band-on-the-run': { title: 'Band on the Run (Wings)', concertKey: 'D -> Am -> C', baseChords: 'Dmaj7 / Am / C-F-G', improvScale: 'C Jónica', advice: 'Tres partes: Balada D/G, Rock Am, Folk C.', criticalChord: 'Fmaj7', chordType: 'm', steps: SCALE_STEPS['Eólica'], lyrics: `[Parte 1]\nStuck inside these four walls\n[G6]Sent inside forever\n\n[Parte 2]\n[Am]If I ever get out of here\nThought of giving it all away` },
            'quien-fuera-bunkers': { title: 'Quien Fuera (Los Bunkers)', concertKey: 'G', baseChords: 'G–Em–C–D', improvScale: 'G Mayor', advice: 'Versión rockera en G. Intro guitarra eléctrica.', criticalChord: 'B7', chordType: 'm', steps: SCALE_STEPS['Mayor'], lyrics: `[Intro]\n(Riff G - Em - C - D)\n\n[Verso 1]\n[G]Estoy buscando una [Em]palabra\n[C]En el umbral de tu mis-terio` },
            'bad-moon-rising': { title: 'Bad Moon Rising (CCR)', concertKey: 'D', baseChords: 'D–A–G', improvScale: 'D Mayor', advice: 'Ritmo rápido y cortado. Cuidado con el cambio A-G.', criticalChord: 'Ninguno', chordType: 'M', steps: SCALE_STEPS['Mayor'], lyrics: `[Verso 1]\nI see the [A]bad [G]moon a-rising\nI see [A]trouble [G]on the way\nI see [A]earth-[G]quakes and lightning\nI see [A]bad [G]times to-day` },
            'mala-bad-bunny': { title: 'Vete (Bad Bunny)', concertKey: 'Bbm', baseChords: 'Gbmaj7–Fm7–Bbm7', improvScale: 'Bb Menor', advice: 'Jazz/Neo-Soul chords: Gbmaj7, Fm7, Bbm7.', criticalChord: 'Gbmaj7', chordType: 'm', steps: SCALE_STEPS['Eólica'], lyrics: `[Intro]\n[Gbmaj7][Fm7]\nYeh, yeh, yeh, yeh\n\n[Estribillo]\n[Gbmaj7]Vete, eh, eh, eh\n[Fm7]Nadie te está aguantando y la puerta está a-bierta, eh` },
            'dont-let-me-down': { title: 'Don\'t Let Me Down (The Beatles)', concertKey: 'E', baseChords: 'E–F#m7', improvScale: 'E Mayor', advice: 'Compás de 5/4 en estrofa. F#m7 sobre bajo de E.', criticalChord: 'F#m7', chordType: 'M', steps: SCALE_STEPS['Mayor'], lyrics: `[Estribillo]\n[F#m7]Don't let me [E]down\n[F#m7]Don't let me [E]down\n\n[Verso 1]\n[E]Nobody ever loved me like she does\n[F#m7]Ooh, she does, yeah, she does` },
            'black-magic-woman': { title: 'Black Magic Woman (Santana)', concertKey: 'Dm', baseChords: 'Dm–Am–Gm–Dm', improvScale: 'D Dórica', advice: 'Ritmo Latino/Rock. El A7 altera la escala a D Armónica.', criticalChord: 'A7', chordType: 'm', steps: SCALE_STEPS['Dórica'], lyrics: `[Verso 1]\nGot a black magic [Am]woman\nGot a black magic [Am]woman\nI got a black magic woman\n[Gm]Got me so blind I can't see\nThat she's a black magic [A7]woman` },
            'gypsy-queen': { title: 'Gypsy Queen (Santana)', concertKey: 'D', baseChords: 'D–C–G/B–A', improvScale: 'D Mixolidia', advice: 'Instrumental. Modula a Re Mayor. Ritmo frenético.', criticalChord: 'D (Vamp)', chordType: 'M', steps: SCALE_STEPS['Mixolidia'], lyrics: `[Instrumental]\n(Transición rápida)\n\n| D | D | D | D |\n(Improvisación guitarra y percusión)` },
            'sirius': { title: 'Sirius (APP)', concertKey: 'Bm', baseChords: 'Bm–G', improvScale: 'B Menor', advice: 'Intro icónica. Arpegio de Clavinet con Delay.', criticalChord: 'G', chordType: 'm', steps: SCALE_STEPS['Eólica'], lyrics: `[Instrumental]\n(Arpegio en Bm)\n\n| Bm | G | Bm | G |\n(Entran cuerdas y solo de guitarra eléctrica melódico)` },
            'eye-in-the-sky': { title: 'Eye in the Sky (APP)', concertKey: 'Bm / D', baseChords: 'Bm–G–D–F#m', improvScale: 'D Mayor', advice: 'Estribillo usa Bm - G - D - F#m. Producción cristalina.', criticalChord: 'Gm', chordType: 'm', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso 1]\nDon't think sorry's easily said\nDon't try turning tables in-stead\n[G]You've taken lots of chances be-[Gm]fore\nBut I ain't gonna give any [Em]more` },
            'golden-slumbers': { title: 'Golden Slumbers (The Beatles)', concertKey: 'Am / C', baseChords: 'Am7–Dm–G7–C', improvScale: 'C Mayor', advice: 'Piano balada. Am7 abre, resuelve en C.', criticalChord: 'E7', chordType: 'M', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso 1]\n[Am7]Once there was a way to get back homeward\n[Am7]Once there was a way to get back [G7]home\n[C]Sleep pretty darling, [Am]do not cry\n[G7]And I will sing a lulla-[C]by` },
            'carry-that-weight': { title: 'Carry That Weight (The Beatles)', concertKey: 'C', baseChords: 'C–G', improvScale: 'C Mayor', advice: 'Coro himno. Unísono vocal.', criticalChord: 'G', chordType: 'M', steps: SCALE_STEPS['Jónica'], lyrics: `[Estribillo]\n[C]Boy, you're gonna [G]carry that weight\n[G]Carry that weight a long [C]time\n[C]Boy, you're gonna [G]carry that weight` },
            'the-end': { title: 'The End (The Beatles)', concertKey: 'A -> C', baseChords: 'A–D / C–F–G', improvScale: 'A Blues / C Mayor', advice: 'Duelo de guitarras sobre A7-D7. Final majestuoso en Do.', criticalChord: 'F', chordType: 'M', steps: SCALE_STEPS['Jónica'], lyrics: `[Verso]\n[A]Oh yeah, all right\nAre you gonna be in my dreams\n[A]Tonight?\n\n| A7 | D7 | A7 | D7 | (x N veces)` },
            'coming-back-to-life': { title: 'Coming back to life (Pink Floyd)', concertKey: 'C', baseChords: 'C–Fmaj7–Am–G', improvScale: 'C Mayor', advice: 'Tonalidad C Mayor. Intro etérea.', criticalChord: 'Fmaj7', chordType: 'M', steps: SCALE_STEPS['Mayor'], lyrics: `[Verso 1]\n[C]Where were you when I was burned and [Fmaj7]broken?\n[Am]While the days slipped by [G]from my window [F]watching` },
            'just-the-two-of-us': { title: 'Just the Two of Us', concertKey: 'Fm', baseChords: 'Dbmaj7–C7–Fm7', improvScale: 'F Menor', advice: 'Corrección: Tonalidad Fm. Progression: Dbmaj7 - C7alt - Fm7 - Ebm7 - Ab7.', criticalChord: 'C7alt', chordType: 'maj7', steps: SCALE_STEPS['Eólica'], lyrics: `[Verso 1]\nI see the crystal [C7]raindrops fall\n[Fm7]And the beauty of it [Ebm7]all [Ab7]\nIs when the sun [C7]comes shining [Fm7]through\nTo make those rainbows [C7]in my mind\n[Fm7]When I think of you some-[Ebm7]time [Ab7]\nAnd I want to spend [C7]some time with [Fm7]you` },
            'aint-no-sunshine': { title: 'Ain\'t No Sunshine (Bill Withers)', concertKey: 'Am', baseChords: 'Am–Em–G–Am', improvScale: 'A Menor Pentatónica', advice: 'Minimalismo. Am - Em - G - Am constante.', criticalChord: 'Em7', chordType: 'm', steps: SCALE_STEPS['Pentatónica'], lyrics: `[Verso 1]\n[Am]Ain't no sunshine [Em]when she's [Am]gone\n[Am]It's not warm [Em]when she's [Am]away\n[Am]Ain't no sunshine [Em]when she'sgone\nAnd she's always gone too [Am]long\nAnytime she [Em]goes a-[Am]way` },
            'smooth-operator': { title: 'Smooth Operator (Sade)', concertKey: 'Dm', baseChords: 'Dm7–Am7–Gm7', improvScale: 'D Menor Natural', advice: 'Tonalidad Dm. Línea de bajo icónica Dm7 - Am7 - Gm7.', criticalChord: 'Gm7', chordType: 'm7', steps: SCALE_STEPS['Eólica'], lyrics: `[Verso 1]\nDiamond life, [Am7]lover boy\n[Gm7]We move in space with [Am7]minimum waste and maximum joy\nCity lights [Am7]and business nights\n[Gm7]When you require [Am7]streetcar desire for higher heights` },
        };

        // --- ESTADO ---
        let manualShift = 0;

        // --- FUNCIONES CORE ---
        function getNoteIndex(note) {
            let baseNote = note.replace(/[^A-G#♭♯b]/g, '').trim().replace('♭', 'b').replace('♯', '#');
            const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
            baseNote = flatToSharp[baseNote] || baseNote;
            return NOTES.indexOf(baseNote);
        }

        function transposeNote(note, semitones) {
            let idx = getNoteIndex(note);
            if (idx === -1) return note;
            
            let newIdx = (idx + semitones) % 12;
            if (newIdx < 0) newIdx += 12;
            let newNote = NOTES[newIdx];

            const useFlat = note.includes('b') || ['F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb'].includes(newNote);
            if (useFlat) {
                const flats = { 'A#': 'Bb', 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab' };
                if(flats[newNote]) newNote = flats[newNote];
            }
            return newNote;
        }

        function getFullTransposedNote(fullChordStr, semitones) {
            const match = fullChordStr.match(/^([A-G][#b]?)(.*)$/);
            if(!match) return fullChordStr;
            return transposeNote(match[1], semitones) + match[2];
        }

        function generateChordNotes(root, type, semitones) {
            let idx = getNoteIndex(root);
            if(idx === -1) return [];
            let intervals = CHORD_INTERVALS[type] || CHORD_INTERVALS['M'];
            return intervals.map(i => NOTES[(idx + i + semitones) % 12]);
        }

        // --- RENDERERS SVG (CON ESTILOS INLINE PARA ROBUSTEZ) ---
        function drawGuitar(notes) {
            const W=200, H=140, FRETS=4, STRINGS=6;
            const fw = W/(FRETS+1), sh = (H-20)/(STRINGS-1);
            let s = `<rect x="5" y="10" width="${fw/2}" height="${H-20}" fill="rgba(0, 229, 255, 0.5)"/>`;
            
            for(let i=0; i<=FRETS; i++) {
                let x = 5 + fw/2 + i*fw;
                s+=`<line x1="${x}" y1="10" x2="${x}" y2="${H-10}" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>`;
            }
            for(let i=0; i<STRINGS; i++) {
                let y = 10 + i*sh;
                s+=`<line x1="5" y1="${y}" x2="${W-5}" y2="${y}" stroke="rgba(0, 229, 255, 0.3)" stroke-width="1"/>`;
            }
            for(let str=0; str<STRINGS; str++) {
                let openIdx = GUITAR_TUNING[str];
                let y = 10 + str*sh;
                for(let f=1; f<=FRETS; f++) {
                    let noteIdx = (openIdx + f) % 12;
                    let note = NOTES[noteIdx];
                    if(notes.some(n => getNoteIndex(n) === noteIdx)) {
                        s+=`<circle cx="${5 + fw/2 + f*fw - fw/2}" cy="${y}" r="6" fill="#00E5FF" stroke="#fff" stroke-width="1"/>`;
                    }
                }
            }
            return s;
        }

        function drawPiano(notes) {
            const keys = [
                {n:'C',t:0},{n:'C#',t:1},{n:'D',t:0},{n:'D#',t:1},{n:'E',t:0},{n:'F',t:0},
                {n:'F#',t:1},{n:'G',t:0},{n:'G#',t:1},{n:'A',t:0},{n:'A#',t:1},{n:'B',t:0},
                {n:'C',t:0},{n:'C#',t:1}
            ];
            let s='', wx=0;
            keys.forEach((k, i) => {
                if(k.t===0) {
                    let active = notes.some(n => getNoteIndex(n) === getNoteIndex(k.n));
                    let fill = active ? '#00E5FF' : 'rgba(255,255,255,0.05)';
                    s+=`<rect x="${wx*25}" y="0" width="25" height="100" fill="${fill}" stroke="rgba(0,229,255,0.3)" stroke-width="1"/>`;
                    wx++;
                }
            });
            wx=0;
            keys.forEach((k, i) => {
                if(k.t===0) wx++;
                else {
                    let active = notes.some(n => getNoteIndex(n) === getNoteIndex(k.n));
                    let fill = active ? '#00E5FF' : 'rgba(0,0,0,0.8)';
                    s+=`<rect x="${(wx-1)*25 + 17.5}" y="0" width="15" height="60" fill="${fill}" stroke="rgba(0,229,255,0.2)" stroke-width="1"/>`;
                }
            });
            return s;
        }

        // --- APP LOGIC ---
        function changePitch(delta) {
            manualShift += delta;
            document.getElementById('pitch-val').innerText = (manualShift > 0 ? '+' : '') + manualShift;
            let percent = 50 + (manualShift * 4); 
            document.getElementById('pitch-bar').style.width = Math.min(100, Math.max(0, percent)) + '%';
            updateAnalysis();
        }

        function updateAnalysis() {
            const key = document.getElementById('song-selector').value;
            if(!key) return;
            const song = SONGS_DATA[key];
            
            const instShift = parseInt(document.querySelector('input[name="instrument"]:checked').value);
            const totalShift = instShift + manualShift;

            document.getElementById('welcome-msg').classList.add('hidden');
            document.getElementById('harmonic-hud').classList.remove('hidden');
            document.getElementById('right-panel-content').classList.remove('hidden');

            document.getElementById('song-title').innerText = song.title;
            document.getElementById('song-advice').innerText = song.advice;
            
            const rootKey = song.concertKey.split(' ')[0]; 
            const newKey = getFullTransposedNote(rootKey, totalShift);
            document.getElementById('display-key').innerText = newKey;
            
            // Transponer Progresión Base (Regex para separar acordes)
            const newChords = song.baseChords.replace(/([A-G][#b]?)([^–\s]*)/g, (m, r, s) => getFullTransposedNote(r+s, totalShift));
            document.getElementById('transposed-chords').innerHTML = newChords;

            const scaleRoot = song.improvScale.match(/^[A-G][#b]?/)[0];
            const scaleType = song.improvScale.replace(/^[A-G][#b]?\s*/, '');
            const newScaleRoot = transposeNote(scaleRoot, totalShift);
            document.getElementById('display-scale').innerText = newScaleRoot + " " + scaleType;

            if(song.lyrics) {
                const newLyrics = song.lyrics.replace(/\[([A-G][#b]?)(.*?)\]/g, (match, r, s) => {
                    return `<span class="chord-highlight">[${transposeNote(r, totalShift)}${s}]</span>`;
                });
                document.getElementById('lyrics-area').innerHTML = newLyrics;
            }

            const scaleIdx = getNoteIndex(scaleRoot);
            const stepArr = song.steps || SCALE_STEPS['Natural'];
            let scaleNotesHTML = "";
            stepArr.forEach(s => {
                let n = NOTES[(scaleIdx + s + totalShift)%12];
                scaleNotesHTML += `<span class="note-chip main-note">${n}</span>`;
            });
            document.getElementById('scale-notes-container').innerHTML = scaleNotesHTML;

            if(song.criticalChord && !song.criticalChord.includes('Ninguno')) {
                const critRoot = song.criticalChord.match(/^[A-G][#b]?/);
                let displayCrit = song.criticalChord;
                if(critRoot) {
                    let transCrit = transposeNote(critRoot[0], totalShift);
                    displayCrit = song.criticalChord.replace(critRoot[0], transCrit);
                }
                document.getElementById('crit-chord-val').innerText = displayCrit;
                document.getElementById('crit-chord-box').classList.remove('hidden');
            } else {
                document.getElementById('crit-chord-box').classList.add('hidden');
            }

            const tonicNotes = generateChordNotes(rootKey, song.chordType, totalShift);
            const tonicName = newKey + (song.chordType === 'm' ? 'm' : '');
            
            document.getElementById('guitar-svg').innerHTML = drawGuitar(tonicNotes);
            document.getElementById('guitar-chord-name').innerText = tonicName;
            
            document.getElementById('piano-svg').innerHTML = drawPiano(tonicNotes);
            document.getElementById('piano-chord-name').innerText = tonicName;
        }

        const sel = document.getElementById('song-selector');
        Object.keys(SONGS_DATA).sort((a,b) => SONGS_DATA[a].title.localeCompare(SONGS_DATA[b].title)).forEach(k => {
            let opt = document.createElement('option');
            opt.value = k;
            opt.innerText = SONGS_DATA[k].title;
            sel.appendChild(opt);
        });

        // ANIMACIÓN DE FONDO
        const scene = new THREE.Scene();
        const cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const ren = new THREE.WebGLRenderer({alpha:true, antialias:true});
        ren.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(ren.domElement);
        
        const partGeo = new THREE.BufferGeometry();
        const pos = [];
        for(let i=0;i<600;i++) pos.push((Math.random()-0.5)*20, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
        partGeo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        const partMat = new THREE.PointsMaterial({color:0x00E5FF, size:0.02, transparent:true, opacity:0.5});
        const parts = new THREE.Points(partGeo, partMat);
        scene.add(parts);
        cam.position.z = 5;

        const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(3,1), new THREE.MeshBasicMaterial({color:0x00E5FF, wireframe:true, transparent:true, opacity:0.05}));
        scene.add(sphere);

        function animate() {
            requestAnimationFrame(animate);
            parts.rotation.y += 0.001;
            sphere.rotation.x -= 0.002;
            ren.render(scene, cam);
        }
        animate();
        window.onresize = () => {
            cam.aspect = window.innerWidth/window.innerHeight;
            cam.updateProjectionMatrix();
            ren.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
