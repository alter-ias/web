<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALEX CONTROL | V.2.1 FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Montserrat:wght@400;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES DE TEMA --- */
        :root {
            /* Default: LUDOVICO (DARK) */
            --bg-color: #050505;
            --text-main: #E8E4D9;
            --text-sub: #888888;
            --accent: #FF3300;
            --border-color: #333;
        }

        /* TEMA MOLOKO (CLARO) - Ajustado para contraste */
        [data-theme="moloko"] {
            --bg-color: #d8d4cd; /* Gris cálido un poco más oscuro para que resalte el blanco */
            --text-main: #101010;
            --text-sub: #444444;
            --accent: #FF4400;
            --border-color: #bbb;
        }

        /* TEMA ULTRAVIOLENCIA */
        [data-theme="ultra"] {
            --bg-color: #FF3300;
            --text-main: #000000;
            --text-sub: #3a0000;
            --accent: #FFFFFF;
            --border-color: #aa1100;
        }

        body {
            margin: 0;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden; /* El scroll lo maneja el div interno */
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* BOTÓN TEMA */
        #theme-toggle {
            position: fixed; top: 30px; left: 8%; z-index: 100;
            background: transparent; border: 2px solid var(--text-main);
            color: var(--text-main); padding: 10px 20px;
            font-family: 'Rajdhani'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; font-size: 10px;
            transition: 0.3s;
        }
        #theme-toggle:hover { background: var(--text-main); color: var(--bg-color); }

        /* CANVAS */
        #canvas-container {
            position: fixed; top: 0; right: 0; width: 60%; height: 100vh; z-index: 10;
            /* Máscara suave para integrar con el texto */
            mask-image: linear-gradient(to right, transparent 0%, black 15%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 15%);
        }

        /* SCROLLABLE CONTENT */
        #content-sidebar {
            position: relative; width: 50%; height: 100vh; overflow-y: auto; z-index: 20;
            background: transparent; scrollbar-width: none;
        }
        #content-sidebar::-webkit-scrollbar { display: none; }

        section {
            min-height: 90vh; display: flex; flex-direction: column; justify-content: center;
            padding: 0 10% 0 15%; box-sizing: border-box;
        }

        /* TEXTOS */
        .content-box {
            border-left: 3px solid var(--accent); padding-left: 25px;
            opacity: 0; transform: translateY(40px); transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .content-box.visible { opacity: 1; transform: translateY(0); }

        h1 { font-family: 'Montserrat'; font-weight: 900; font-size: 80px; margin: 0; line-height: 0.8; letter-spacing: -2px; text-transform: uppercase; }
        h2 { font-family: 'Rajdhani'; font-weight: 700; font-size: 13px; letter-spacing: 4px; margin: 0 0 15px 0; color: var(--accent); text-transform: uppercase; }
        h3 { font-family: 'Montserrat'; font-weight: 800; font-size: 28px; margin: 10px 0; }
        p { font-family: 'Rajdhani'; font-weight: 600; font-size: 16px; line-height: 1.5; color: var(--text-sub); margin-bottom: 20px; max-width: 400px; }

        /* UI */
        .interaction-hint {
            position: fixed; bottom: 30px; right: 30px; z-index: 30; text-align: right;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 10px; color: var(--text-sub);
            letter-spacing: 1px; pointer-events: none; padding: 10px; border-right: 2px solid var(--accent);
        }

        .btn-cta {
            padding: 12px 30px; background: var(--text-main); color: var(--bg-color);
            border: 2px solid var(--text-main); font-family: 'Montserrat'; font-weight: 800;
            font-size: 11px; cursor: pointer; transition: 0.3s; text-decoration: none;
            display: inline-block; letter-spacing: 1px; margin-right: 10px; text-transform: uppercase;
        }
        .btn-cta:hover { background: var(--accent); border-color: var(--accent); color: #fff; }
        .btn-cta.secondary { background: transparent; color: var(--text-main); }
        .btn-cta.secondary:hover { background: var(--text-main); color: var(--bg-color); }

        @media (max-width: 768px) {
            #canvas-container { width: 100%; height: 50vh; mask-image: none; -webkit-mask-image: none; border-bottom: 1px solid var(--border-color); }
            #content-sidebar { width: 100%; height: 50vh; top: 50vh; background: var(--bg-color); }
            section { min-height: 50vh; padding: 30px; }
            h1 { font-size: 45px; }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.skypack.dev/three@0.136.0",
                "three/addons/": "https://cdn.skypack.dev/three@0.136.0/examples/jsm/"
            }
        }
    </script>
</head>
<body data-theme="ludovico">

    <button id="theme-toggle">CAMBIAR TEMA: LUDOVICO (DARK)</button>

    <div id="canvas-container"></div>

    <div class="interaction-hint">
        SCROLL &darr; : VISTA<br>
        CTRL + SCROLL : EXPLOSIONAR<br>
        DRAG : ORBITAR
    </div>

    <div id="content-sidebar">
        <section id="sec-intro">
            <div class="content-box visible">
                <h2>HARDWARE V.2.0</h2>
                <h1>ALEX</h1>
                <h1>CONTROL</h1>
                <br>
                <p>Interfaz física de alta densidad. Diseñada para la oscuridad. Ejecuta Alex Vision, Synth y Cine Libre con tacto analógico.</p>
                <br>
                <a href="#" class="btn-cta">RESERVAR</a>
                <a href="#" class="btn-cta secondary">VER DETALLES</a>
            </div>
        </section>

        <section id="sec-contrast">
            <div class="content-box">
                <h2>VISIBILIDAD TOTAL</h2>
                <h3>MODO NOCTURNO NATIVO</h3>
                <p>El chasis se adapta a tu entorno. En la oscuridad, Alex Control es una sombra de metal negro donde solo existe la información.</p>
                <p>Retroiluminación de <span style="color:var(--accent); font-weight:bold;">fósforo activo</span> que no fatiga la vista.</p>
            </div>
        </section>

        <section id="sec-grid">
            <div class="content-box">
                <h2>MODULARIDAD</h2>
                <h3>GRID MAGNÉTICO DE 9 PUNTOS</h3>
                <p>Intercambia faders por knobs en caliente. El bus de datos óptico elimina la latencia mecánica.</p>
                <p>Aluminio aeroespacial anodizado para disipación térmica.</p>
            </div>
        </section>

        <div style="height: 10vh;"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIGURACIÓN DE TEMAS ---
        const themes = {
            ludovico: { 
                label: "LUDOVICO (DARK)",
                bg: 0x050505,
                chassis: 0x111111,
                plate: 0x080808,
                details: 0x333333,
                led: 0xFF3300,
                ambient: 0.5,
                lightIntensity: 1.0,
                fog: 0.035
            },
            moloko: { 
                label: "MOLOKO (LIGHT)",
                bg: 0xd8d4cd,      /* Fondo un poco más oscuro para contraste */
                chassis: 0xffffff, /* Chasis blanco puro */
                plate: 0xeeeeee,   /* Placa gris muy claro */
                details: 0x888888,
                led: 0xFF4400,
                ambient: 0.15,     /* LUZ AMBIENTAL BAJA para crear SOMBRAS DURAS */
                lightIntensity: 1.5, /* LUZ PRINCIPAL FUERTE para definir bordes */
                fog: 0.01          /* Poca niebla para no lavar el blanco */
            },
            ultra: { 
                label: "ULTRAVIOLENCIA",
                bg: 0xFF3300,
                chassis: 0x101010,
                plate: 0x000000,
                details: 0x440000,
                led: 0xFFFFFF,
                ambient: 0.4,
                lightIntensity: 1.0,
                fog: 0.02
            }
        };

        let currentThemeKey = 'ludovico';
        const toggleBtn = document.getElementById('theme-toggle');
        const bodyEl = document.body;

        // --- ESCENA ---
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        
        // CÁMARA INICIAL - Ángulo más "picado" para ver bien la grilla
        const camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(8, 10, 8); 

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false;

        // --- ILUMINACIÓN ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 12, 5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.bias = -0.00005;
        scene.add(dirLight);

        // --- MATERIALES ---
        // Usamos materiales físicos para mejor respuesta a la luz
        const matChassis = new THREE.MeshStandardMaterial({ roughness: 0.5, metalness: 0.1 });
        const matPlate = new THREE.MeshStandardMaterial({ roughness: 0.3, metalness: 0.2 });
        const matDetail = new THREE.MeshStandardMaterial({ roughness: 0.8, metalness: 0.1 });
        const matLed = new THREE.MeshStandardMaterial({ emissiveIntensity: 2.0, toneMapped: false });

        // --- APLICAR TEMA ---
        function applyTheme(key) {
            const t = themes[key];
            bodyEl.setAttribute('data-theme', key);
            toggleBtn.innerText = "CAMBIAR TEMA: " + t.label;

            // Escena
            scene.background = new THREE.Color(t.bg);
            scene.fog = new THREE.FogExp2(t.bg, t.fog);

            // Luces (Clave para que el blanco se vea bien)
            ambientLight.intensity = t.ambient;
            dirLight.intensity = t.lightIntensity;

            // Materiales
            matChassis.color.setHex(t.chassis);
            matPlate.color.setHex(t.plate);
            matDetail.color.setHex(t.details);
            matLed.color.setHex(t.led);
            matLed.emissive.setHex(t.led);
        }
        
        applyTheme(currentThemeKey);

        toggleBtn.addEventListener('click', () => {
            if(currentThemeKey === 'ludovico') currentThemeKey = 'moloko';
            else if(currentThemeKey === 'moloko') currentThemeKey = 'ultra';
            else currentThemeKey = 'ludovico';
            applyTheme(currentThemeKey);
        });

        // --- GEOMETRÍA DEL CONTROL ---
        const moduleGroup = new THREE.Group();
        scene.add(moduleGroup);

        const modSize = 1.8;
        const gap = 0.15; // Gap físico inicial

        function createModule(gx, gz, type) {
            const g = new THREE.Group();
            
            // 1. Chasis Base
            const geoBase = new RoundedBoxGeometry(modSize, 0.6, modSize, 4, 0.04);
            const base = new THREE.Mesh(geoBase, matChassis);
            base.position.y = 0;
            base.castShadow = true; base.receiveShadow = true;
            g.add(base);

            // 2. Placa Superior
            const geoPlate = new RoundedBoxGeometry(modSize - 0.2, 0.05, modSize - 0.2, 2, 0.02);
            const plate = new THREE.Mesh(geoPlate, matPlate);
            plate.position.y = 0.32; // Un poco más arriba
            plate.receiveShadow = true;
            g.add(plate);

            // 3. Controles
            if (type === 'knob') {
                const kGeo = new THREE.CylinderGeometry(0.35, 0.35, 0.4, 32);
                const knob = new THREE.Mesh(kGeo, matChassis);
                knob.position.y = 0.55; knob.castShadow = true;
                g.add(knob);
                // Marca LED
                const mark = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.04, 0.2), matLed);
                mark.position.set(0, 0.76, 0.12);
                g.add(mark);
            } else if (type === 'fader') {
                const track = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.05, 1.2), matDetail);
                track.position.y = 0.35;
                g.add(track);
                const cap = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.25, 0.6), matChassis);
                cap.position.y = 0.5; cap.castShadow = true;
                g.add(cap);
                const line = new THREE.Mesh(new THREE.BoxGeometry(0.41, 0.02, 0.02), matLed);
                line.position.y = 0.63;
                g.add(line);
            } else if (type === 'pad') {
                const pGeo = new RoundedBoxGeometry(0.45, 0.15, 0.45, 2, 0.02);
                const pDist = 0.45;
                const pos = [[-pDist,-pDist],[pDist,-pDist],[-pDist,pDist],[pDist,pDist]];
                pos.forEach(p => {
                    const pad = new THREE.Mesh(pGeo, matDetail);
                    pad.position.set(p[0], 0.4, p[1]);
                    g.add(pad);
                    // Led dot
                    const dot = new THREE.Mesh(new THREE.CircleGeometry(0.04, 12), matLed);
                    dot.rotation.x = -Math.PI/2;
                    dot.position.set(p[0], 0.48, p[1]);
                    g.add(dot);
                });
            }

            // Posición en grilla
            g.position.set(gx * (modSize + gap), 0, gz * (modSize + gap));
            
            // Guardamos datos para animación
            g.userData = { 
                origX: g.position.x, 
                origZ: g.position.z 
            };

            return g;
        }

        const layout = [
            ['knob', 'fader', 'knob'],
            ['pad', 'knob', 'pad'],
            ['fader', 'pad', 'fader']
        ];

        const modules = [];
        for(let r=0; r<3; r++){
            for(let c=0; c<3; c++){
                const m = createModule(c-1, r-1, layout[r][c]);
                moduleGroup.add(m);
                modules.push(m);
            }
        }

        // --- POST PROCESS (GLOW) ---
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.5, 0.8);
        composer.addPass(bloom);

        // --- LOGICA INTERACCIÓN ---
        const sidebar = document.getElementById('content-sidebar');
        const boxes = document.querySelectorAll('.content-box');
        
        let scrollY = 0;
        let scrollPercent = 0;
        let explodeFactor = 0; // Valor actual de explosión (suavizado)
        let explodeTarget = 0; // Valor objetivo (input usuario)

        // Escuchar scroll del div
        sidebar.addEventListener('scroll', () => {
            scrollY = sidebar.scrollTop;
            const h = sidebar.scrollHeight - sidebar.clientHeight;
            scrollPercent = scrollY / h; // 0 a 1

            // Mostrar textos
            boxes.forEach(b => {
                const r = b.getBoundingClientRect();
                if(r.top < window.innerHeight * 0.75) b.classList.add('visible');
            });
        });

        // Escuchar Ctrl+Wheel para explosión
        window.addEventListener('wheel', (e) => {
            if(e.ctrlKey || e.metaKey) {
                e.preventDefault();
                controls.enabled = false; // Desactivar órbita mientras explota
                
                // Normalizar delta para que sea suave
                const delta = e.deltaY * 0.003; 
                explodeTarget += delta;
                
                // Clampear entre 0 (cerrado) y 1.5 (muy abierto)
                explodeTarget = Math.max(0, Math.min(1.5, explodeTarget));
            } else {
                controls.enabled = true;
            }
        }, { passive: false });

        window.addEventListener('keyup', (e) => {
            if (e.key === 'Control' || e.key === 'Meta') controls.enabled = true;
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // 1. ROTACIÓN SCROLL SUAVE Y LIMITADA
            // Limitamos a Math.PI * 0.25 (45 grados) para no perder la cara frontal
            const targetRotX = scrollPercent * (Math.PI * 0.2); 
            const targetRotY = scrollPercent * (Math.PI * 0.25);

            // Lerp más rápido (0.1) para que no se sienta "laggy"
            moduleGroup.rotation.x += (targetRotX - moduleGroup.rotation.x) * 0.1;
            moduleGroup.rotation.y += (targetRotY - moduleGroup.rotation.y) * 0.1;

            // 2. ANIMACIÓN DE EXPLOSIÓN
            // Interpolación suave hacia el target
            explodeFactor += (explodeTarget - explodeFactor) * 0.15;

            // Aplicar expansión a cada módulo
            modules.forEach(m => {
                // Expansión horizontal (X, Z) desde el centro (0,0)
                // Se multiplican las posiciones originales por (1 + factor)
                m.position.x = m.userData.origX * (1 + explodeFactor * 0.5); 
                m.position.z = m.userData.origZ * (1 + explodeFactor * 0.5);

                // Expansión vertical de los componentes internos (hijos del grupo)
                // children[0] es base, children[1] placa, resto componentes
                m.children.forEach((child, i) => {
                    if (i > 0) { // Si no es la base
                        // Calcular altura original aproximada
                        let baseH = 0.32; // Placa
                        if (i > 1) baseH = 0.5; // Componentes
                        
                        // Levitar componentes basado en explosión
                        child.position.y = baseH + (explodeFactor * i * 0.3);
                    }
                });
            });

            composer.render();
        }

        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            const w = container.clientWidth;
            const h = container.clientHeight;
            camera.aspect = w/h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
            composer.setSize(w, h);
        });

        // Trigger inicial
        sidebar.dispatchEvent(new Event('scroll'));

    </script>
</body>
</html>
